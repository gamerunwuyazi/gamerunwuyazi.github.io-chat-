(function(){"use strict";var e={302:function(e,t,n){n.d(t,{y0:function(){return j},oj:function(){return Ge},wN:function(){return P},ES:function(){return N},hf:function(){return Tt},JA:function(){return q},v8:function(){return Me},vH:function(){return G},aS:function(){return Ce},hT:function(){return Ie},NV:function(){return de},fz:function(){return re},uD:function(){return jt},jC:function(){return Ne},K9:function(){return Y},QF:function(){return $t},Sf:function(){return R},iD:function(){return Ft},qR:function(){return Rt},eA:function(){return d},setActiveChat:function(){return yt},updateUnreadCountsDisplay:function(){return mt}});n(4114),n(8111),n(2489),n(7588),n(1701),n(3579),n(9112),n(3110),n(7642),n(8004),n(3853),n(5876),n(2475),n(5024),n(1698);function s(){let e=document.getElementById("toast-container");return e||(e=document.createElement("div"),e.id="toast-container",e.style.position="fixed",e.style.top="20px",e.style.right="20px",e.style.zIndex="9999",e.style.display="flex",e.style.flexDirection="column",e.style.alignItems="flex-end",e.style.gap="10px",document.body.appendChild(e)),e}function o(e,t="info",n=3e3){const o=s(),i=document.createElement("div");switch(i.className=`toast toast-${t}`,i.style.padding="10px 15px",i.style.borderRadius="4px",i.style.color="white",i.style.fontSize="14px",i.style.fontWeight="500",i.style.boxShadow="0 2px 8px rgba(0, 0, 0, 0.15)",i.style.transition="all 0.3s ease",i.style.transform="translateX(100%)",i.style.opacity="0",t){case"success":i.style.backgroundColor="#52c41a";break;case"error":i.style.backgroundColor="#f5222d";break;case"warning":i.style.backgroundColor="#faad14";break;default:i.style.backgroundColor="#1890ff"}return i.textContent=e,o.appendChild(i),setTimeout(()=>{i.style.transform="translateX(0)",i.style.opacity="1"},10),setTimeout(()=>{i.style.transform="translateX(100%)",i.style.opacity="0",setTimeout(()=>{i.parentNode===o&&o.removeChild(i)},300)},n),i}const i={success:(e,t)=>o(e,"success",t),error:(e,t)=>o(e,"error",t),warning:(e,t)=>o(e,"warning",t),info:(e,t)=>o(e,"info",t)};var a=i;const r=n(357),l=n(6226),c="https://back.hs.airoe.cn";let d={currentGroupId:null,currentGroupName:"",currentPrivateChatUserId:null,currentPrivateChatUsername:"",currentPrivateChatNickname:"",currentPrivateChatAvatarUrl:"",currentActiveChat:"main",currentSendChatType:"main",selectedGroupIdForCard:null},u={global:0,groups:{},private:{}},p=null,m=localStorage.getItem("currentSessionToken")||null;window.currentUser=p,window.currentSessionToken=m;let g=!1,f=d.currentGroupId,y=d.currentGroupName,h=d.currentPrivateChatUserId,v=d.currentPrivateChatUsername,b=d.currentPrivateChatNickname,w=[],k=[],x=!1,I=!1,E=!1,S=document.title,C=!0,$=d.currentActiveChat,B={},L=d.currentSendChatType,M=d.selectedGroupIdForCard,T=null,A=null,U=[];function N(e){const t=e.querySelector(".delete-button");t&&t.addEventListener("click",function(e){e.stopPropagation();const t=this.getAttribute("data-id");t&&window.chatSocket.emit("delete-message",{messageId:t,sessionToken:m,userId:p.id})})}function j(){const e=document.querySelectorAll("#messageContainer .message");e.forEach(e=>{const t=e.querySelector(".user-avatar");if(t){const n=t.cloneNode(!0);t.parentNode.replaceChild(n,t);const s=e.getAttribute("data-user-id"),o=e.querySelector(".message-sender"),i=o?o.textContent:"æœªçŸ¥ç”¨æˆ·",a={id:s,nickname:i,avatarUrl:""};n.addEventListener("click",e=>{e.stopPropagation(),se(e,a)})}})}function P(){const e=["#messageContainer","#groupMessageContainer","#privateMessageContainer"];e.forEach(e=>{const t=document.querySelectorAll(`${e} .group-card-container`);t.forEach(e=>{const t=e.cloneNode(!0);e.parentNode.replaceChild(t,e);let n=t.getAttribute("data-group-id");const s=t.querySelector(".group-card-header"),o=t.querySelector(".group-card-description"),i=t.querySelector("img"),a=s?s.textContent.trim():"æœªçŸ¥ç¾¤ç»„",r=o?o.textContent.trim():"æš‚æ— å…¬å‘Š";let l="";if(i){const e=i.src;e&&(l=e.includes(c)?e.replace(c,""):e)}if(!n)try{if(l.includes("/group-avatars/")){const e=l.match(/group-avatars\/(\d+)\./);e&&e[1]&&(n=e[1])}}catch(u){console.error("è§£æç¾¤ç»„IDå¤±è´¥:",u)}const d={group_id:n,group_name:a,group_description:r,avatar_url:l};t.addEventListener("click",function(e){e.stopPropagation(),Te(e,d)})})})}function G(){const e=document.querySelectorAll(".message-image");e.forEach(e=>{e.addEventListener("click",function(){const e=this.src;openImagePreview(e)})});const t=document.querySelectorAll(".group-card-container img");t.forEach(e=>{e.addEventListener("click",function(e){e.stopPropagation();const t=this.src;openImagePreview(t)})});const n=document.querySelectorAll("#privateUserAvatar");n.forEach(e=>{e.addEventListener("click",function(e){e.stopPropagation()})})}function q(){if(!p||!m){const e=localStorage.getItem("chatUserId"),t=localStorage.getItem("chatSessionToken"),n=localStorage.getItem("chatUserNickname"),s=localStorage.getItem("chatUserAvatar");if(!e||!t)return void console.warn("æœªæ‰¾åˆ°ç”¨æˆ·ä¿¡æ¯ï¼Œåˆå§‹åŒ–èŠå¤©å¤±è´¥");p={id:e,nickname:n,avatarUrl:s},m=t,window.currentUser=p,window.currentSessionToken=m}try{"function"===typeof me?me():(console.warn("å†…éƒ¨åˆå§‹åŒ–å‡½æ•°ä¸å­˜åœ¨ï¼Œæ‰§è¡ŒåŸºæœ¬åˆå§‹åŒ–"),"function"===typeof fe&&fe(),"function"===typeof Ce&&Ce(),"function"===typeof ye&&ye()),setTimeout(()=>{if(h){console.log("è‡ªåŠ¨åº”ç”¨ä¿å­˜çš„ç§ä¿¡ä¼šè¯çŠ¶æ€:",{userId:h,username:v,nickname:b,activeChat:$}),yt("private",h,!1);const e=document.getElementById("privateEmptyState"),t=document.getElementById("privateChatInterface"),n=document.getElementById("privateUserName");e&&(e.style.display="none"),t&&(t.style.display="flex",t.style.flexDirection="column"),n&&(n.textContent=b),R(h)}},500)}catch(e){console.error("åˆå§‹åŒ–èŠå¤©å¤±è´¥:",e)}}function H(){const e=document.getElementById("currentUserAvatar"),t=document.getElementById("userInitials");if(!p||!e||!t)return;let n="";p.avatar&&"string"===typeof p.avatar?n=p.avatar.trim():p.avatarUrl&&"string"===typeof p.avatarUrl&&(n=p.avatarUrl.trim());const s=n&&/\.svg$/i.test(n);if(n&&!s){const s=`${c}${n}`;e.src=s,e.style.display="block",t.style.display="none"}else{const n=p.nickname?p.nickname.charAt(0).toUpperCase():"U";t.textContent=n,t.style.display="block",e.style.display="none"}}function _(){X(),Y(),Z(),re(),de()}function z(){p&&m&&fetch(`${c}/user/friends`,{headers:{"user-id":p.id,"session-token":m}}).then(e=>e.json()).then(e=>{if("success"===e.status)D(e.friends);else{const t=document.getElementById("friendsList");t&&(t.innerHTML="<li>åŠ è½½å¥½å‹åˆ—è¡¨å¤±è´¥: "+e.message+"</li>")}}).catch(()=>{const e=document.getElementById("friendsList");e&&(e.innerHTML="<li>åŠ è½½å¥½å‹åˆ—è¡¨å¤±è´¥: ç½‘ç»œé”™è¯¯</li>")})}function O(e){const t=document.getElementById("friendsList");if(!t)return;const n=t.querySelectorAll(".friend-item");for(const s of n)if(String(s.getAttribute("data-user-id"))===String(e)){t.insertBefore(s,t.firstChild);const n=k.findIndex(t=>String(t.id)===String(e));if(n>0){const e=k.splice(n,1)[0];k.unshift(e)}break}}function D(e){const t=document.getElementById("friendsList");t&&(t.innerHTML="",k=e,0!==e.length?(e.forEach(e=>{const n=document.createElement("li");n.className="friend-item",n.dataset.userId=e.id,n.dataset.userNickname=e.nickname;let s,o="";if(e.avatarUrl&&"string"===typeof e.avatarUrl?o=e.avatarUrl.trim():e.avatar_url&&"string"===typeof e.avatar_url&&(o=e.avatar_url.trim()),o){const t=/\.svg$/i.test(o);if(t){const t=e.nickname?e.nickname.charAt(0).toUpperCase():"U";s=`<span class="user-avatar">${t}</span>`}else{const t=`${c}${o}`;s=`<span class="user-avatar"><img src="${t}" alt="${e.nickname}"></span>`}}else{const t=e.nickname?e.nickname.charAt(0).toUpperCase():"U";s=`<span class="user-avatar">${t}</span>`}const i=w.some(t=>String(t.id)===String(e.id));n.innerHTML=`\n            ${s}\n            <span class="friend-name">${e.nickname}</span>\n            <span class="friend-status ${i?"online":"offline"}"></span>\n            <div class="unread-count private-unread-count" id="privateUnreadCount_${e.id}"></div>\n        `,n.addEventListener("click",()=>{F(e.id,e.nickname,e.username,o)}),t.appendChild(n)}),mt(),ie()):t.innerHTML='<li class="empty-friends">æš‚æ— å¥½å‹ï¼Œè¯·å…ˆæ·»åŠ å¥½å‹</li>')}function F(e,t,n,s){h=e,v=n,b=t,$=`private_${e}`,d.currentPrivateChatUserId=h,d.currentPrivateChatUsername=v,d.currentPrivateChatNickname=b,d.currentPrivateChatAvatarUrl=s,d.currentActiveChat=$;const o=document.getElementById("privateChatInterface"),i=document.getElementById("privateEmptyState"),a=document.getElementById("privateUserName"),r=document.getElementById("privateUserAvatar"),l=document.getElementById("privateUserInitials"),u=document.getElementById("privateUserStatus");if(o&&i&&a&&r&&l){if(o.style.display="flex",o.style.flexDirection="column",i.style.display="none",a.textContent=t?ut(t):"",s){const e=`${c}${s}`;r.src=e,r.style.display="block",r.style.visibility="visible",l.style.display="none",l.style.visibility="hidden"}else{const e=t?t.charAt(0).toUpperCase():"U";l.textContent=e,l.style.display="flex",l.style.visibility="visible",r.style.display="none",r.style.visibility="hidden",r.src=""}if(u){const t=w.some(t=>String(t.id)===String(e));u.textContent=t?"åœ¨çº¿":"ç¦»çº¿",u.className="user-status "+(t?"online":"offline")}}R(e),yt("private",e,!0),de()}function R(e){if(!p||!m)return;const t=document.getElementById("privateMessageContainer");t&&(t.innerHTML='\n            <div class="loading-messages">\n                <div class="loading-spinner"></div>\n                <div class="loading-text">æ­£åœ¨åŠ è½½èŠå¤©è®°å½•...</div>\n            </div>\n        ',window.chatSocket?window.chatSocket.emit("join-private-chat",{userId:p.id,friendId:e,sessionToken:m}):t.innerHTML=`\n                <div class="empty-state error-state">\n                    <div class="error-icon">âŒ</div>\n                    <h3>è¿æ¥å¤±è´¥</h3>\n                    <p>æ— æ³•è¿æ¥åˆ°èŠå¤©æœåŠ¡å™¨ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥åé‡è¯•</p>\n                    <button class="retry-button" onclick="loadPrivateChatHistory(${e})">é‡è¯•</button>\n                </div>\n            `)}function W(e,t=!1){const n=document.getElementById("privateMessageContainer");if(!n)return;if(!e)return;const s=String(e.senderId),o=String(e.receiverId),i=String(h);if(s!==i&&o!==i)return;if(document.querySelector(`#privateMessageContainer [data-id="${e.id}"]`))return;const a=n.querySelector(".loading-messages");a&&a.remove();const r=n.querySelector(".empty-state");if(r&&r.remove(),!e.messageType&&!e.content&&!e.imageUrl&&!e.fileUrl&&!e.text)return;const l={id:e.senderId,nickname:e.senderNickname||e.sender||"æœªçŸ¥ç”¨æˆ·",avatarUrl:e.senderAvatarUrl||e.avatarUrl},d=l.id,u=p&&String(p.id)===String(d),m=document.createElement("div");function g(e){if("string"!==typeof e)return e;const t=document.createElement("div");return t.textContent=e,t.innerHTML}m.className="message "+(u?"own-message":"other-message"),m.setAttribute("data-id",e.id),m.setAttribute("data-user-id",d),void 0!==e.sequence&&m.setAttribute("data-sequence",e.sequence),u?(m.style.marginLeft="20%",m.style.marginRight="10px",m.style.backgroundColor="#E8F5E8",m.style.borderRadius="18px",m.style.padding="10px 15px",m.style.maxWidth="80%",m.style.minWidth="70px",m.style.alignSelf="flex-end",m.style.position="relative",m.style.transition="all 0.2s"):(m.style.marginLeft="10px",m.style.marginRight="20%",m.style.backgroundColor="#FFFFFF",m.style.borderRadius="18px",m.style.padding="10px 15px",m.style.maxWidth="80%",m.style.minWidth="70px",m.style.alignSelf="flex-start",m.style.border="1px solid #E0E0E0",m.style.position="relative"),m.style.display="flex",m.style.flexDirection="column",m.style.marginBottom="10px";let f="";const y=new Date(e.timestampISO||e.created_at||e.timestamp).toLocaleTimeString();switch(u?(f+='<div class="message-header" style="display: flex; justify-content: flex-end; margin-bottom: 5px;">',f+=`<span class="message-time" style="color: #999; font-size: 12px;">${y}</span>`,f+="</div>"):(f+='<div class="message-header" style="display: flex; justify-content: flex-start; margin-bottom: 5px;">',f+=`<span class="message-time" style="color: #999; font-size: 12px;">${y}</span>`,f+="</div>"),m.style.minWidth="70px",f+='<div class="message-content">',e.messageType){case 1:if(e.imageUrl){const t=e.imageUrl.startsWith("http")?e.imageUrl:`${c}${e.imageUrl}`;let n="",s="";e.width&&e.height&&(n=`width="${e.width}"`,s=`height="${e.height}"`),f+=`<img src="${t}" alt="å›¾ç‰‡" ${n} ${s} class="message-image" onclick="openImagePreview('${t}')" style="max-width: 100%; height: auto; border-radius: 10px; cursor: pointer;">`}else try{const t=JSON.parse(e.content);if(t&&t.url){const e=t.url.startsWith("http")?t.url:`${c}${t.url}`;let n="",s="";t.width&&t.height&&(n=`width="${t.width}"`,s=`height="${t.height}"`),f+=`<img src="${e}" alt="å›¾ç‰‡" ${n} ${s} class="message-image" onclick="openImagePreview('${e}')" style="max-width: 100%; height: auto; border-radius: 10px; cursor: pointer;">`}}catch(v){f+=`<div class="message-text">${g(e.content)}</div>`}break;case 2:if(e.fileUrl){const t=e.fileUrl.startsWith("http")?e.fileUrl:`${c}${e.fileUrl}`;f+='<div class="file-link-container" style="display: flex; align-items: center; gap: 10px; padding: 10px; background: #f5f5f5; border-radius: 8px;">',f+='<span class="file-icon" style="font-size: 20px;">ğŸ“</span>',f+=`<a href="${t}" target="_blank" class="message-link" style="text-decoration: none; color: #0d6efd; word-break: break-all;">${e.fileName||"æ–‡ä»¶"}</a>`,e.fileSize&&(f+=`<span class="file-size" style="color: #666; font-size: 12px;">(${J(e.fileSize)})</span>`),f+="</div>"}else try{const t=JSON.parse(e.content);if(t&&t.url&&t.name){const e=t.url.startsWith("http")?t.url:`${c}${t.url}`;f+='<div class="file-link-container" style="display: flex; align-items: center; gap: 10px; padding: 10px; background: #f5f5f5; border-radius: 8px;">',f+='<span class="file-icon" style="font-size: 20px;">ğŸ“</span>',f+=`<a href="${e}" target="_blank" class="message-link" style="text-decoration: none; color: #0d6efd; word-break: break-all;">${t.name}</a>`,t.size&&(f+=`<span class="file-size" style="color: #666; font-size: 12px;">(${J(t.size)})</span>`),f+="</div>"}}catch(v){f+=`<div class="message-text">${g(e.content)}</div>`}break;case 3:try{const t=JSON.parse(e.content);f+=`\n                        <div class="group-card-container" style="background-color: #f0f8ff; border: 1px solid #3498db; border-radius: 8px; padding: 10px; cursor: pointer; margin-top: 5px;">\n                            <div class="group-card-header" style="font-weight: bold; color: #3498db; margin-bottom: 5px; display: flex; align-items: center; gap: 8px;">\n                                ${t.avatar_url?`<img src="${c}${t.avatar_url}" alt="${t.group_name}" style="width: 20px; height: 20px; border-radius: 50%; object-fit: cover; cursor: pointer;">`:`<div style="width: 20px; height: 20px; border-radius: 50%; background-color: #3498db; color: white; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold;">${t.group_name.charAt(0).toUpperCase()}</div>`}\n                                ${g(t.group_name)}\n                            </div>\n                            <div class="group-card-description" style="color: #666; font-size: 14px; margin-bottom: 5px;">\n                                ${t.group_description||"æš‚æ— å…¬å‘Š"}\n                            </div>\n                            <div class="group-card-footer" style="font-size: 12px; color: #999;">\n                                ç‚¹å‡»æŸ¥çœ‹ç¾¤ç»„è¯¦æƒ…\n                            </div>\n                        </div>\n                    `}catch(v){f+=`<div class="message-text">${g(e.content)}</div>`}break;default:{let t=e.content||e.text||"";if(t=g(t),window.marked&&"function"===typeof window.marked.parse)try{window.marked.setOptions({breaks:!0,gfm:!0}),t=window.marked.parse(t)}catch(b){t=g(t)}else t=g(t);f+=`<div class="message-text" style="word-break: break-word;">${t}</div>`}break}if(f+="</div>",u&&(f+=`<button class="message-action-button withdraw-button" onclick="withdrawPrivateMessage(${e.id})" style="position: absolute; top: 8px; right: 8px; background: transparent; border: none; color: #666; font-size: 16px; cursor: pointer; padding: 0; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; border-radius: 50%; opacity: 1;">Ã—</button>`),m.innerHTML=f,3===e.messageType){const t=m.querySelector(".group-card-container");if(t)try{const n=JSON.parse(e.content);t.addEventListener("click",function(e){e.stopPropagation(),Te(e,n)})}catch(v){console.error("è§£æç¾¤åç‰‡æ•°æ®å¤±è´¥:",v)}}if(t)return m;n.appendChild(m),_t(),n.scrollTop=n.scrollHeight}function J(e){return e<1024?e+" B":e<1048576?(e/1024).toFixed(2)+" KB":e<1073741824?(e/1048576).toFixed(2)+" MB":(e/1073741824).toFixed(2)+" GB"}function V(e){if(!p||!m||!h)return;const t=k.some(e=>String(e.id)===String(h));if(!t)return void a.error("æ‚¨ä¸è¯¥ç”¨æˆ·ä¸æ˜¯å¥½å‹ï¼Œæ— æ³•å‘é€ç§ä¿¡");const n=new FormData;n.append("image",e),n.append("userId",p.id),n.append("privateChat",!0);const s=document.getElementById("privateUploadProgress"),o=document.getElementById("privateUploadProgressBar");s&&o&&(s.style.display="block",o.style.width="0%"),fetch(`${c}/upload`,{method:"POST",headers:{"user-id":p.id,"session-token":m},body:n}).then(e=>e.json()).then(t=>{if("success"===t.status){const n={userId:p.id,content:JSON.stringify({url:t.url,name:e.name}),receiverId:h,sessionToken:m,messageType:1};window.chatSocket&&window.chatSocket.emit("private-message",n)}else Bt(t.message||"å›¾ç‰‡ä¸Šä¼ å¤±è´¥")}).catch(()=>{Bt("å›¾ç‰‡ä¸Šä¼ å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•")}).finally(()=>{s&&(s.style.display="none");const e=document.getElementById("privateImageInput");e&&(e.value="")})}function K(e){if(!p||!m||!h)return;const t=k.some(e=>String(e.id)===String(h));if(!t)return void a.error("æ‚¨ä¸è¯¥ç”¨æˆ·ä¸æ˜¯å¥½å‹ï¼Œæ— æ³•å‘é€ç§ä¿¡");const n=new FormData;n.append("image",e),n.append("userId",p.id),n.append("privateChat",!0);const s=document.getElementById("privateUploadProgress"),o=document.getElementById("privateUploadProgressBar");s&&o&&(s.style.display="block",o.style.width="0%"),fetch(`${c}/upload`,{method:"POST",headers:{"user-id":p.id,"session-token":m},body:n}).then(e=>e.json()).then(t=>{if("success"===t.status){const n={userId:p.id,content:JSON.stringify({url:t.url,name:e.name,size:e.size}),receiverId:h,sessionToken:m,messageType:2};window.chatSocket&&window.chatSocket.emit("private-message",n)}else Bt(t.message||"æ–‡ä»¶ä¸Šä¼ å¤±è´¥")}).catch(()=>{Bt("æ–‡ä»¶ä¸Šä¼ å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•")}).finally(()=>{s&&(s.style.display="none");const e=document.getElementById("privateFileInput");e&&(e.value="")})}function X(){const e=document.getElementById("privateChatSearchInput"),t=document.getElementById("clearPrivateChatSearch");e&&t&&(e.addEventListener("input",()=>{const n=e.value.toLowerCase(),s=document.querySelectorAll(".friend-item");s.forEach(e=>{const t=e.dataset.userNickname.toLowerCase();t.includes(n)?e.style.display="flex":e.style.display="none"}),t.style.display=n?"inline":"none"}),t.addEventListener("click",()=>{e.value="",t.style.display="none";const n=document.querySelectorAll(".friend-item");n.forEach(e=>{e.style.display="flex"})}));const n=document.getElementById("searchUserButton");n&&n.addEventListener("click",()=>{document.getElementById("userSearchModal").style.display="flex"})}function Y(){const e=document.getElementById("closeUserProfileModal"),t=document.getElementById("closeUserProfileButton");e&&e.addEventListener("click",()=>{document.getElementById("userProfileModal").style.display="none"}),t&&t.addEventListener("click",()=>{document.getElementById("userProfileModal").style.display="none"})}function Z(){const e=document.getElementById("closeUserSearchModal"),t=document.getElementById("cancelUserSearch");e&&e.addEventListener("click",()=>{document.getElementById("userSearchModal").style.display="none"}),t&&t.addEventListener("click",()=>{document.getElementById("userSearchModal").style.display="none"});const n=document.getElementById("confirmUserSearch");n&&n.addEventListener("click",()=>{const e=document.getElementById("searchKeyword").value;e.trim()&&Q(e.trim())})}function Q(e){p&&m&&fetch(`${c}/user/search?keyword=${encodeURIComponent(e)}`,{headers:{"user-id":p.id,"session-token":m}}).then(e=>e.json()).then(e=>{if("success"===e.status)ee(e.users);else{const t=document.getElementById("searchResults");t&&(t.innerHTML='<div class="search-result-item">æœç´¢å¤±è´¥: '+e.message+"</div>")}}).catch(()=>{const e=document.getElementById("searchResults");e&&(e.innerHTML='<div class="search-result-item">æœç´¢å¤±è´¥: ç½‘ç»œé”™è¯¯</div>')})}function ee(e){const t=document.getElementById("searchResults");t&&(t.innerHTML="",0!==e.length?e.forEach(e=>{const n=document.createElement("div");n.className="search-result-item";let s="";if(e.avatarUrl&&"string"===typeof e.avatarUrl?s=e.avatarUrl.trim():e.avatar_url&&"string"===typeof e.avatar_url?s=e.avatar_url.trim():e.avatar&&"string"===typeof e.avatar&&(s=e.avatar.trim()),s){const e=/\.(jpg|jpeg|png|gif|webp|bmp)$/i;s.match(e)||s.includes("/avatar/")||s.includes("/upload/")||(s="")}if(s){const e=/\.(jpg|jpeg|png|gif|webp|bmp)$/i;s.match(e)||s.includes("/avatar/")||s.includes("/upload/")||(s="")}let o="";if(s){const t=/\.svg$/i.test(s);if(t){const t=e.nickname?e.nickname.charAt(0).toUpperCase():"U";o=`<span class="user-avatar">${t}</span>`}else{const t=`${c}${s}`;o=`<span class="user-avatar"><img src="${t}" alt="${e.nickname}"></span>`}}else{const t=e.nickname?e.nickname.charAt(0).toUpperCase():"U";o=`<span class="user-avatar">${t}</span>`}n.innerHTML=`\n            ${o}\n            <div class="search-result-info">\n                <div class="search-result-nickname">${e.nickname}</div>\n                <div class="search-result-username">@${e.username}</div>\n            </div>\n            <button class="add-friend-btn" data-user-id="${e.id}" data-user-nickname="${e.nickname}" data-user-avatar="${s}">+</button>\n        `;const i=n.querySelector(".add-friend-btn");i.addEventListener("click",()=>{ae(e.id)});const a=n.querySelector(".user-avatar");a.addEventListener("click",t=>{t.stopPropagation(),se(t,e)}),n.addEventListener("click",t=>{t.target.classList.contains("add-friend-btn")||t.target.closest(".user-avatar")||te(e)}),t.appendChild(n)}):t.innerHTML='<div class="search-result-item">æœªæ‰¾åˆ°åŒ¹é…çš„ç”¨æˆ·</div>')}function te(e){const t=document.getElementById("userProfileModal");if(!t)return;const n=document.getElementById("modalUserAvatar"),s=document.getElementById("modalUserInitials"),o=document.getElementById("modalUserNickname"),i=document.getElementById("modalUsername"),a=document.getElementById("modalUserId"),r=document.getElementById("modalUserStatus");if(!n||!s||!o||!i||!a||!r)return;o.textContent="åŠ è½½ä¸­...",i.textContent="",a.textContent=e.id||"",r.textContent="";const l=document.querySelector("#userProfileModal .signature-section");l&&(l.style.display="none"),t.style.display="none",fetch(`${c}/user/${e.id}`,{headers:{"user-id":p?.id||"","session-token":m||""}}).then(e=>e.json()).then(n=>{"success"===n.status&&n.user?ne(n.user):ne(e),t.style.display="flex"}).catch(n=>{console.error("è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥:",n),ne(e),t.style.display="flex"});const d=t.querySelector(".modal-content");d&&d.addEventListener("click",e=>{e.stopPropagation()}),t.addEventListener("click",()=>{t.style.display="none"})}function ne(e){const t=document.getElementById("userProfileModal");if(!t)return;const n=document.getElementById("modalUserAvatar"),s=document.getElementById("modalUserInitials"),o=document.getElementById("modalUserNickname"),i=document.getElementById("modalUsername"),a=document.getElementById("modalUserId"),r=document.getElementById("modalUserStatus");if(!n||!s||!o||!i||!a||!r)return;let l="";if(e.avatarUrl&&"string"===typeof e.avatarUrl?l=e.avatarUrl.trim():e.avatar_url&&"string"===typeof e.avatar_url?l=e.avatar_url.trim():e.avatar&&"string"===typeof e.avatar&&(l=e.avatar.trim()),l){const e=/\.(jpg|jpeg|png|gif|webp|bmp)$/i;l.match(e)||l.includes("/avatar/")||l.includes("/upload/")||(l="")}const d=/\.svg$/i.test(l);if(l&&!d){let e=l.startsWith("http://")||l.startsWith("https://")?l:`${c}${l}`;n.src=e,n.style.display="block",n.style.width="120px",n.style.height="120px",n.style.visibility="visible",s.style.display="none",s.style.visibility="hidden"}else{const t=e.nickname?e.nickname.charAt(0).toUpperCase():"U";s.textContent=t,s.style.display="flex",s.style.alignItems="center",s.style.justifyContent="center",s.style.width="80px",s.style.height="80px",s.style.fontSize="32px",s.style.borderRadius="50%",s.style.backgroundColor="#f0f0f0",s.style.color="#333",s.style.border="2px solid #e0e0e0",s.style.visibility="visible",s.style.position="relative",s.style.zIndex="1",n.style.display="none",n.style.visibility="hidden",n.src=""}o.textContent=e.nickname?ut(e.nickname):"æœªçŸ¥æ˜µç§°";const u=e.username||e.name||"æœªçŸ¥ç”¨æˆ·å";i.textContent="string"===typeof u?ut(u):u,a.textContent=e.id;const p=w.some(t=>String(t.id)===String(e.id));r.textContent=p?"åœ¨çº¿":"ç¦»çº¿";const m=document.querySelector("#userProfileModal .signature-section"),g=document.getElementById("modalUserSignature");if(m&&g){const t=e.signature||"";t&&t.trim()?(g.textContent=ut(t),m.style.display="block"):m.style.display="none"}}function se(e,t){e.stopPropagation();const n=document.getElementById("userAvatarPopup"),s=document.getElementById("popupAvatarImg"),o=document.getElementById("popupInitials"),i=document.getElementById("popupNickname"),a=document.getElementById("popupUsername"),r=document.getElementById("popupAddFriend");if(!n||!s||!o||!i||!a||!r)return;n.style.display="none",n.dataset.userId=t.id;const l=k.some(e=>String(e.id)===String(t.id)),d=p&&String(p.id)===String(t.id);l||d?(r.textContent="å·²æ·»åŠ ",r.style.backgroundColor="#ccc",r.style.cursor="not-allowed",r.disabled=!0,r.onclick=null):(r.textContent="æ·»åŠ å¥½å‹",r.style.backgroundColor="#3498db",r.style.cursor="pointer",r.disabled=!1,r.onclick=function(){ae(t.id),oe()});const u=()=>fetch(`${c}/user/${t.id}`,{headers:{"user-id":p.id,"session-token":m}}).then(e=>e.json()).then(e=>{if("success"===e.status)return e.user;throw new Error("è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥")}).catch(e=>(console.error("è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥:",e),null));function g(t){i.textContent=t.nickname||"æœªçŸ¥æ˜µç§°",t.username?(a.textContent=t.username,a.style.display="block"):(a.textContent="",a.style.display="none");const r=document.getElementById("popupSignatureSection"),l=document.getElementById("popupSignature");if(r&&l){const e=t.signature||"";e&&e.trim()?(l.textContent=ut(e),r.style.display="block"):r.style.display="none"}let d="";if(t.avatarUrl&&"string"===typeof t.avatarUrl?d=t.avatarUrl.trim():t.avatar_url&&"string"===typeof t.avatar_url?d=t.avatar_url.trim():t.avatar&&"string"===typeof t.avatar&&(d=t.avatar.trim()),d){const e=`${c}${d}`;s.src=e,s.style.display="block",s.style.cursor="pointer",s.addEventListener("click",function(){openImagePreview(s.src)}),o.style.display="none"}else{const e=t.nickname?t.nickname.charAt(0).toUpperCase():"U";o.textContent=e,o.style.display="block",s.style.display="none"}n.style.display="block";const u=n.getBoundingClientRect(),p=u.width,m=u.height;let g=e.clientX+window.scrollX,f=e.clientY+window.scrollY;g+p>window.innerWidth+window.scrollX&&(g=window.innerWidth+window.scrollX-p-10),f+m>window.innerHeight+window.scrollY&&(f=window.innerHeight+window.scrollY-m-10),g<window.scrollX&&(g=window.scrollX+10),f<window.scrollY&&(f=window.scrollY+10),n.style.left=`${g}px`,n.style.top=`${f}px`,setTimeout(()=>{document.addEventListener("click",oe)},0)}t.id&&t.username?g(t):u().then(e=>{g(e||t)})}function oe(){const e=document.getElementById("userAvatarPopup");e&&(e.style.display="none"),document.removeEventListener("click",oe)}function ie(){const e=document.querySelectorAll(".friend-item .user-avatar");e.forEach((e,t)=>{e.addEventListener("click",e=>{const n=k[t];n&&se(e,n)})});const t=document.querySelectorAll("#userList .user-avatar");t.forEach((e,t)=>{e.addEventListener("click",e=>{const n=w[t];n&&se(e,n)})});const n=document.querySelectorAll("#offlineUserList .user-avatar");n.forEach((e,t)=>{const n=document.querySelectorAll("#offlineUserList .user-item"),s=n[t].querySelector(".user-name").textContent,o={id:n[t].dataset.userId||"",nickname:s,avatarUrl:""};e.addEventListener("click",e=>{se(e,o)})})}function ae(e){p&&m&&fetch(`${c}/user/add-friend`,{method:"POST",headers:{"user-id":p.id,"session-token":m,"Content-Type":"application/json"},body:JSON.stringify({friendId:e})}).then(e=>e.json()).then(e=>{"success"===e.status?(z(),a.success("æ·»åŠ å¥½å‹æˆåŠŸ")):a.error("æ·»åŠ å¥½å‹å¤±è´¥: "+e.message)}).catch(e=>{a.error("æ·»åŠ å¥½å‹å¤±è´¥: ç½‘ç»œé”™è¯¯")})}function re(){const e=document.getElementById("sendPrivateMessage");e&&e.addEventListener("click",()=>{ce()});const t=document.getElementById("privateMessageInput");t&&t.addEventListener("keydown",e=>{if("Enter"!==e.key||e.shiftKey||e.ctrlKey)if("Enter"===e.key&&e.ctrlKey&&!e.shiftKey)if(e.preventDefault(),"DIV"===t.tagName&&t.isContentEditable){const e=window.getSelection(),t=e.getRangeAt(0),n=document.createElement("br");t.deleteContents(),t.insertNode(n),t.setStartAfter(n),t.setEndAfter(n),e.removeAllRanges(),e.addRange(t)}else{const e=t.selectionStart,n=t.selectionEnd,s=t.value;t.value=s.substring(0,e)+"\n"+s.substring(n);const o=e+1;t.setSelectionRange(o,o),t.focus()}else"Enter"===e.key&&e.shiftKey&&e.ctrlKey;else e.preventDefault(),ce()});const n=document.getElementById("privateMarkdownToolbar");if(n){const e=n.querySelectorAll(".markdown-btn");e.forEach(e=>{e.addEventListener("click",function(t){t.stopPropagation();const n=e.getAttribute("data-prefix")||"",s=e.getAttribute("data-suffix")||"",o=e.getAttribute("data-sample")||"";le(n,s,o)})})}const s=document.getElementById("privateImageUploadButton"),o=document.getElementById("privateImageInput");s&&o&&(s.onclick=null,o.onchange=null,s.onclick=()=>{o.click()},o.onchange=function(){this.files&&this.files[0]&&V(this.files[0])});const i=document.getElementById("privateFileUploadButton"),a=document.getElementById("privateFileInput");i&&a&&(i.onclick=null,a.onchange=null,i.onclick=()=>{a.click()},a.onchange=function(){this.files&&this.files[0]&&(this.files[0].type.startsWith("image/")?V(this.files[0]):K(this.files[0]))}),t&&t.addEventListener("paste",function(e){const t=e.clipboardData.items;for(const n of t){if(n.type.startsWith("image/")){e.preventDefault();const t=n.getAsFile();t&&V(t);break}if("application/octet-stream"===n.type){e.preventDefault();const t=n.getAsFile();t&&K(t);break}}})}function le(e,t,n){let s=null;const o=document.querySelector(".chat-content.active");if(o){const e=o.getAttribute("data-content");switch(e){case"public-chat":s=document.getElementById("messageInput");break;case"group-chat":s=document.getElementById("groupMessageInput");break;case"private-chat":s=document.getElementById("privateMessageInput");break;default:s=document.activeElement}}else s=document.activeElement;if(!s||!s.isContentEditable){const e=document.querySelectorAll('.editable-div, [contenteditable="true"]');for(let t=0;t<e.length;t++)if(null!==e[t].offsetParent){s=e[t];break}if(!s||!s.isContentEditable)return}let i="";if(window.getSelection){const e=window.getSelection();i=e.toString()}else document.selection&&"Control"!==document.selection.type&&(i=document.selection.createRange().text);i||(i=n),s.focus();const a=e+i+t;document.execCommand("insertText",!1,a)}function ce(){if(!p||!m||!h)return;const e=document.getElementById("privateMessageInput");if(!e)return;const t=e.innerText.trim();if(!t)return;const n=k.some(e=>String(e.id)===String(h));if(!n)return void a.error("æ‚¨ä¸è¯¥ç”¨æˆ·ä¸æ˜¯å¥½å‹ï¼Œæ— æ³•å‘é€ç§ä¿¡");const s={userId:p.id,content:t,receiverId:h,sessionToken:m};window.chatSocket&&window.chatSocket.emit("private-message",s),e.innerHTML=""}function de(){const e=document.getElementById("deleteFriendButton");e&&(e.onclick=null,e.onclick=()=>{h&&ue(h)});const t=document.getElementById("privateUserInfoButton");t&&(t.onclick=null,t.onclick=()=>{if(h&&v){const e=document.getElementById("privateUserAvatar");let t="";e&&e.src&&""!==e.src&&(e.src.startsWith(c)?t=e.src.replace(c,""):e.src.startsWith("http")&&(t=e.src));const n={id:h,nickname:b,avatarUrl:t,username:v};te(n)}});const n=document.getElementById("privateMoreButton");n&&(n.onclick=null,n.onclick=e=>{e.stopPropagation();const t=document.getElementById("privateMoreFunctions");t&&t.classList.toggle("show")});const s=document.getElementById("togglePrivateMarkdownToolbar");s&&s.addEventListener("click",()=>{const e=document.getElementById("privateMarkdownToolbar");if(e){e.style.display="flex"===e.style.display?"none":"flex";const t=s.querySelector("i");t&&(t.style.transform="flex"===e.style.display?"rotate(180deg)":"rotate(0deg)")}});const o=document.getElementById("privateChatInterface");o&&o.addEventListener("click",function(){h&&(delete u.private[h],mt(),pt(),window.chatSocket&&window.chatSocket.emit("join-private-chat",{userId:p.id,friendId:h,sessionToken:m,onlyClearUnread:!0}))})}function ue(e){p&&m&&confirm("ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå¥½å‹å—ï¼Ÿ")&&fetch(`${c}/user/remove-friend`,{method:"POST",headers:{"user-id":p.id,"session-token":m,"Content-Type":"application/json"},body:JSON.stringify({friendId:e})}).then(e=>e.json()).then(t=>{if("success"===t.status){if(z(),h===e){const e=document.getElementById("privateChatInterface"),t=document.getElementById("privateEmptyState");e&&t&&(e.style.display="none",t.style.display="flex",h=null,v="")}a.success("åˆ é™¤å¥½å‹æˆåŠŸ")}else a.error("åˆ é™¤å¥½å‹å¤±è´¥: "+t.message)}).catch(e=>{a.error("åˆ é™¤å¥½å‹å¤±è´¥: ç½‘ç»œé”™è¯¯")})}function pe(){window.chatSocket&&(window.chatSocket.disconnect(),window.chatSocket=null),localStorage.removeItem("currentUser"),localStorage.removeItem("currentSessionToken"),localStorage.removeItem("chatUserId"),localStorage.removeItem("chatUserNickname"),localStorage.removeItem("chatSessionToken"),localStorage.removeItem("chatUserAvatar"),localStorage.removeItem("userId"),localStorage.removeItem("nickname"),localStorage.removeItem("avatarUrl"),localStorage.removeItem("sessionToken"),d={currentGroupId:null,currentGroupName:"",currentPrivateChatUserId:null,currentPrivateChatUsername:"",currentPrivateChatNickname:"",currentPrivateChatAvatarUrl:"",currentActiveChat:"main",currentSendChatType:"main",selectedGroupIdForCard:null},p=null,m=null,g=!1,f=null,y="",h=null,v="",b="",$="main",L="main",M=null,w=[],k=[],x=!1,I=!1,E=!1,u.global=0,u.groups={},u.private={},setTimeout(()=>{window.location.hash="#/login",setTimeout(()=>{window.location.reload()},100)},100)}function me(){Me(),_(),xe(),ye(),Nt(),lt(),ve(),dt(),z(),fe()}function ge(e){const t={"Content-Type":"application/json"};m&&(t["session-token"]=m),fetch(`${c}/check-status`,{method:"GET",headers:t}).then(e=>{if(!e.ok)throw new Error(`HTTPé”™è¯¯! çŠ¶æ€ç : ${e.status}`);return e.json()}).then(t=>{if(t.isBanned){const n=`æ‚¨çš„IPå·²è¢«å°ç¦ï¼Œ${t.message||"æ— æ³•è®¿é—®"}`;return a.error(n),pe(),void e(!1)}if(p&&!t.userExists)return a.error("æ‚¨çš„è´¦æˆ·å¯èƒ½å·²è¢«åˆ é™¤æˆ–ç¦ç”¨ï¼Œè¯·è”ç³»ç®¡ç†å‘˜ã€‚"),pe(),void e(!1);e(!0)}).catch(t=>{e(!0)})}function fe(){const e=l(c,{transports:["websocket","polling"],reconnection:!0,reconnectionAttempts:1/0,reconnectionDelay:1e3,reconnectionDelayMax:5e3,timeout:2e4,autoConnect:!0});let t=null;e.on("connect",()=>{g=!0,p&&m&&ge(n=>{if(n){let n="";p.avatarUrl&&"string"===typeof p.avatarUrl?n=p.avatarUrl.trim():p.avatar_url&&"string"===typeof p.avatar_url?n=p.avatar_url.trim():p.avatar&&"string"===typeof p.avatar&&(n=p.avatar.trim());const s={userId:p.id?String(p.id):null,nickname:p.nickname,avatarUrl:n||null,sessionToken:m};if(e.emit("user-joined",s),e.emit("get-online-users"),f){e.emit("join-group",{groupId:f,sessionToken:m,userId:p.id});const t={groupId:f,userId:p.id,sessionToken:m,limit:20};e.emit("get-group-chat-history",t)}ye(),t||(t=setInterval(()=>{g&&p&&m&&e.emit("get-online-users")},3e4))}})}),e.on("reconnect",n=>{g=!0,p&&m&&ge(n=>{if(n){let n="";p.avatarUrl&&"string"===typeof p.avatarUrl?n=p.avatarUrl.trim():p.avatar_url&&"string"===typeof p.avatar_url?n=p.avatar_url.trim():p.avatar&&"string"===typeof p.avatar&&(n=p.avatar.trim());const s={userId:p.id?String(p.id):null,nickname:p.nickname,avatarUrl:n||null,sessionToken:m};if(e.emit("user-joined",s),e.emit("get-online-users"),f){e.emit("join-group",{groupId:f,sessionToken:m,userId:p.id});const t={groupId:f,userId:p.id,sessionToken:m,limit:20};e.emit("get-group-chat-history",t)}ye(),t||(t=setInterval(()=>{g&&p&&m&&e.emit("get-online-users")},3e4))}})}),e.on("disconnect",()=>{g=!1,he(),t&&(clearInterval(t),t=null)}),e.on("message-received",e=>{if(e.sessionToken&&(m=e.sessionToken,localStorage.setItem("currentSessionToken",m)),e.groupId){const t=Date.now(),n=e.timestamp?new Date(e.timestamp).getTime():t,s=t-n<1e4;e.isHistory=e.isHistory||!s,ht(e,!0,e.groupId),ke(e)}else ht(e,!1),we(e)}),e.on("message-sent",e=>{if(e.message){const t=e.message;t.isHistory=!1,t.groupId?(f===String(t.groupId)&&St(t.groupId),ke(t)):we(t)}}),e.on("group-message-received",e=>{e.sessionToken&&(m=e.sessionToken,localStorage.setItem("currentSessionToken",m));const t=Date.now(),n=e.timestamp?new Date(e.timestamp).getTime():t,s=t-n<1e4;e.isHistory=e.isHistory||!s;const o=e.groupId||e.group_id;o&&f===String(o)&&St(o),ke(e)}),e.on("online-users",e=>{ct(e)}),e.on("users-updated",e=>{ct(e),z()}),e.on("group-list",e=>{Ct(e)}),e.on("group-created",()=>{const e=document.getElementById("groupList");e&&dt()}),e.on("group-deleted",()=>{const e=document.getElementById("groupList");e&&dt()}),e.on("group-dissolved",()=>{const e=document.getElementById("groupList");e&&dt()}),e.on("friend-removed",()=>{z()}),e.on("avatar-updated",e=>{if(e.userId&&e.avatarUrl&&(z(),dt(),h)){const t=document.querySelector("#privateChatInterface .chat-avatar img");t&&h===e.userId&&(t.src=`${c}${e.avatarUrl}`)}}),e.on("chat-history",e=>{e.sessionToken&&(m=e.sessionToken,localStorage.setItem("currentSessionToken",m));let t={global:0,groups:{},private:{}};e.unreadMessages&&(e.unreadMessages&&"object"===typeof e.unreadMessages&&!e.unreadMessages.hasOwnProperty("global")?t.groups=e.unreadMessages:(t.groups=e.unreadMessages.groups||{},t.global=e.unreadMessages.global||0)),e.unreadPrivateMessages&&(t.private=e.unreadPrivateMessages),(e.unreadMessages||e.unreadPrivateMessages)&&(void 0!==t.global&&(u.global=t.global),t.groups&&(u.groups=t.groups),t.private&&(u.private=t.private));const n=vt();for(const i in u.groups)u.groups.hasOwnProperty(i)&&n.includes(i)&&(u.groups[i]=0,window.chatSocket&&window.chatSocket.emit("join-group",{groupId:i,sessionToken:m,userId:p.id}));mt(),pt();const s=document.getElementById("messageContainer");if(!s)return;const o=s.querySelector(".empty-state");if(p&&m){if(x||(s.innerHTML="",x=!0),!e.messages||!Array.isArray(e.messages)||0===e.messages.length)return o&&(o.style.display="block"),void(window.resetLoadingState&&window.resetLoadingState());o&&(o.style.display="none");const t=[...e.messages].sort((e,t)=>void 0!==e.sequence&&void 0!==t.sequence?t.sequence-e.sequence:t.timestamp-e.timestamp),n=e.loadMore?t:t.reverse(),i=new Set,a=s.querySelectorAll("[data-id]");let r,l;if(a.forEach(e=>{i.add(e.getAttribute("data-id"))}),e.loadMore&&(r=s.scrollHeight,l=s.scrollTop),n.forEach(t=>{if(t&&t.id&&!i.has(String(t.id)))if(i.add(String(t.id)),e.loadMore){const e=we(t,!0);e&&s.insertBefore(e,s.firstChild)}else we(t)}),e.loadMore&&void 0!==r&&void 0!==l){const e=s.scrollHeight,t=e-r;s.scrollTop=l+t}else e.loadMore||(s.scrollTop=s.scrollHeight)}window.resetLoadingState&&window.resetLoadingState()}),e.on("group-chat-history",e=>{if(e.sessionToken&&(m=e.sessionToken,localStorage.setItem("currentSessionToken",m)),e.unreadMessages){let t=e.unreadMessages;t&&"object"===typeof t&&!t.hasOwnProperty("global")&&(t={global:0,groups:t}),void 0!==t.global&&(u.global=t.global),t.groups&&(u.groups=t.groups),t.private&&(u.private=t.private);const n=vt();for(const e in u.groups)u.groups.hasOwnProperty(e)&&n.includes(e)&&(u.groups[e]=0,window.chatSocket&&window.chatSocket.emit("join-group",{groupId:e,sessionToken:m,userId:p.id}));pt()}const t=document.getElementById("groupMessageContainer");if(!t)return void(window.resetLoadingState&&window.resetLoadingState());const n=t.querySelector(".empty-state");if(p&&m){if(I||(t.innerHTML="",I=!0),e.loadMore&&(!e.messages||!Array.isArray(e.messages)||0===e.messages.length))return void(window.resetLoadingState&&window.resetLoadingState());if(!e.messages||!Array.isArray(e.messages)||0===e.messages.length)return t.innerHTML='\n                    <div class="empty-state">\n                        <h3>æš‚æ— æ¶ˆæ¯</h3>\n                        <p>å‘é€ç¬¬ä¸€æ¡æ¶ˆæ¯å¼€å§‹ç¾¤èŠå§!</p>\n                    </div>\n                ',void(window.resetLoadingState&&window.resetLoadingState());n&&(n.style.display="none");const s=[...e.messages].sort((e,t)=>void 0!==e.sequence&&void 0!==t.sequence?t.sequence-e.sequence:t.timestamp-e.timestamp),o=e.loadMore?s:s.reverse(),i=new Set,a=t.querySelectorAll("[data-id]");let r,l;if(a.forEach(e=>{i.add(e.getAttribute("data-id"))}),e.loadMore&&(r=t.scrollHeight,l=t.scrollTop),e.loadMore?o.forEach(e=>{if(!e||!e.id)return;if(i.has(String(e.id)))return;i.add(String(e.id)),e.isHistory=!0;const n=ke(e,!0);n&&t.insertBefore(n,t.firstChild)}):o.forEach(e=>{e&&e.id&&(i.has(String(e.id))||(i.add(String(e.id)),e.isHistory=!0,ke(e)))}),e.loadMore&&void 0!==r&&void 0!==l){const e=t.scrollHeight,n=e-r;t.scrollTop=n}else setTimeout(()=>{t.scrollTop=t.scrollHeight},0)}window.resetLoadingState&&window.resetLoadingState()}),e.on("user-joined-response",e=>{if(e.sessionToken&&(m=e.sessionToken,localStorage.setItem("currentSessionToken",m)),e.unreadMessages){let t=e.unreadMessages;t&&"object"===typeof t&&!t.hasOwnProperty("global")&&(t={global:0,groups:t}),void 0!==t.global&&(u.global=t.global),t.groups&&(u.groups=t.groups),t.private&&(u.private=t.private);const n=vt();for(const e in u.groups)u.groups.hasOwnProperty(e)&&n.includes(e)&&(u.groups[e]=0,window.chatSocket&&window.chatSocket.emit("join-group",{groupId:e,sessionToken:m,userId:p.id}));pt()}}),e.on("login-success",e=>{e.sessionToken&&(m=e.sessionToken,localStorage.setItem("currentSessionToken",m))}),e.on("disconnect",()=>{g=!1,he()}),e.on("error",e=>{g=!1,he()}),e.on("message",e=>{Array.isArray(e)&&"session-expired"===e[0]&&(a.error("ä¼šè¯å·²è¿‡æœŸæˆ–åœ¨å…¶ä»–è®¾å¤‡ç™»å½•ï¼Œè¯·é‡æ–°ç™»å½•"),pe())}),e.on("session-expired",()=>{a.error("ä¼šè¯å·²è¿‡æœŸæˆ–åœ¨å…¶ä»–è®¾å¤‡ç™»å½•ï¼Œè¯·é‡æ–°ç™»å½•"),pe()}),e.on("account-banned",e=>{const t=`æ‚¨çš„IPå·²è¢«å°ç¦ï¼Œ${e.message||"æ— æ³•è®¿é—®"}`;a.error(t),pe()}),e.on("message-deleted",e=>{const{messageId:t}=e;if(t){const e=document.querySelector(`#messageContainer [data-id="${t}"]`);e&&e.remove();const n=document.querySelector(`#groupMessageContainer [data-id="${t}"]`);if(n&&n.remove(),A)if(11===A.nodeType){const e=A.querySelectorAll(`[data-id="${t}"]`);e.forEach(e=>{e.parentNode===A&&A.removeChild(e)})}else if("string"===typeof A){const e=new RegExp(`<div[^>]*data-id="${t}"[^>]*>.*?</div>`,"s");A=A.replace(e,"")}}}),e.on("group-name-updated",e=>{p&&m&&dt()}),e.on("group-description-updated",e=>{if(p&&m){dt();const t=document.getElementById("groupInfoModal");if(t&&"flex"===t.style.display){const t=document.getElementById("modalGroupNoticeValue");t&&(t.textContent=e.newDescription?ut(e.newDescription):"æš‚æ— ç¾¤ç»„å…¬å‘Š")}}}),e.on("private-message-sent",e=>{if(e.message){const t=e.message;t.isHistory=!1,W(t)}}),e.on("private-message-received",e=>{e.sessionToken&&(m=e.sessionToken,localStorage.setItem("currentSessionToken",m)),e.isHistory=!1;const t=String(e.senderId),n=String(e.receiverId),s=String(p.id)===n?t:n;$===`private_${s}`&&O(s),W(e);const o=$===`private_${t}`;if(!C||!o){const e=String(p.id)===n?t:n;u.private[e]=(u.private[e]||0)+1,mt(),pt()}}),e.on("friend-list-updated",e=>{z()}),e.on("private-message-withdrawn",e=>{if(!e||!e.messageId)return;const t=document.querySelector(`#privateMessageContainer [data-id="${e.messageId}"]`);t&&t.remove()}),e.on("private-chat-history",e=>{e.sessionToken&&(m=e.sessionToken,localStorage.setItem("currentSessionToken",m));const t=document.getElementById("privateMessageContainer");if(t){if(p&&m){if(E&&e.loadMore||(t.innerHTML="",E=!0),e.loadMore&&(!e.messages||!Array.isArray(e.messages)||0===e.messages.length))return void(window.resetLoadingState&&window.resetLoadingState());if(e.messages&&Array.isArray(e.messages))if(0===e.messages.length)t.innerHTML='\n                        <div class="empty-state">\n                            <div class="empty-icon">ğŸ’¬</div>\n                            <h3>æš‚æ— æ¶ˆæ¯</h3>\n                            <p>å‘é€ç¬¬ä¸€æ¡æ¶ˆæ¯å¼€å§‹ä½ ä»¬çš„å¯¹è¯å§!</p>\n                        </div>\n                    ';else{const n=t.querySelector(".empty-state");n&&n.remove();const s=[...e.messages].sort((e,t)=>void 0!==e.sequence&&void 0!==t.sequence?t.sequence-e.sequence:new Date(t.timestampISO||t.created_at||t.timestamp)-new Date(e.timestampISO||e.created_at||e.timestamp)),o=e.loadMore?s:s.reverse(),i=new Set,a=t.querySelectorAll("[data-id]");let r,l;if(a.forEach(e=>{i.add(e.getAttribute("data-id"))}),e.loadMore&&(r=t.scrollHeight,l=t.scrollTop),e.loadMore?o.forEach(e=>{if(!e||!e.id)return;if(i.has(String(e.id)))return;i.add(String(e.id)),e.isHistory=!0;const n=W(e,!0);n&&t.insertBefore(n,t.firstChild)}):o.forEach(e=>{e&&e.id&&(i.has(String(e.id))||(i.add(String(e.id)),e.isHistory=!0,W(e)))}),e.loadMore&&void 0!==r&&void 0!==l){const e=t.scrollHeight,n=e-r;t.scrollTop=l+n}else e.loadMore||(t.scrollTop=t.scrollHeight)}else t.innerHTML='\n                    <div class="empty-state">\n                        <div class="empty-icon">ğŸ’¬</div>\n                        <h3>æš‚æ— æ¶ˆæ¯</h3>\n                        <p>å‘é€ç¬¬ä¸€æ¡æ¶ˆæ¯å¼€å§‹ä½ ä»¬çš„å¯¹è¯å§!</p>\n                    </div>\n                '}window.resetLoadingState&&window.resetLoadingState()}else window.resetLoadingState&&window.resetLoadingState()}),window.chatSocket=e,window.getChatHistory=function(e={}){window.chatSocket&&window.chatSocket.emit("get-chat-history",{userId:p.id,sessionToken:m,loadMore:e.loadMore||!1,olderThan:e.olderThan||null,limit:e.limit||20})},window.getGroupChatHistory=function(e,t={}){if(!window.chatSocket||!e)return void console.warn("âš ï¸  æ— æ³•è·å–ç¾¤ç»„èŠå¤©å†å² - WebSocketæœªè¿æ¥æˆ–ç¾¤ç»„IDæ— æ•ˆ");const n={userId:p.id,sessionToken:m,groupId:e,loadMore:t.loadMore||!1,olderThan:t.olderThan||null,limit:t.limit||20};n.loadMore,window.chatSocket.emit("get-group-chat-history",n)};const n={init:function(){this.initCreateGroupModal(),this.initGroupInfoModal(),this.initAddGroupMemberModal()},showModal:function(e){const t=document.getElementById(e);t&&(t.style.display="flex",t.style.justifyContent="center",t.style.alignItems="center",t.style.zIndex="1000",document.body.style.overflow="hidden","createGroupModal"===e&&this.loadAvailableMembers())},hideModal:function(e){const t=document.getElementById(e);t&&(t.style.display="none",document.body.style.overflow="")},initCreateGroupModal:function(){const e="createGroupModal",t=[document.getElementById("closeCreateGroupModal"),document.getElementById("cancelCreateGroup")];t.forEach(t=>{t&&t.addEventListener("click",()=>{this.hideModal(e)})});const n=document.getElementById(e);n&&n.addEventListener("click",t=>{t.target===n&&this.hideModal(e)});const s=document.getElementById("createGroupButton");s&&s.addEventListener("click",()=>{this.showModal(e),this.loadAvailableMembers()}),n&&n.addEventListener("show",()=>{this.loadAvailableMembers()}),this.bindCreateGroupSubmit()},initGroupInfoModal:function(){const e="groupInfoModal",t=[document.getElementById("closeGroupInfoModal"),document.getElementById("modalCloseButton")];t.forEach(t=>{t&&t.addEventListener("click",()=>{this.hideModal(e)})});const n=document.getElementById(e);n&&n.addEventListener("click",t=>{t.target===n&&this.hideModal(e)})},initAddGroupMemberModal:function(){const e="addGroupMemberModal",t=[document.getElementById("closeAddGroupMemberModal"),document.getElementById("cancelAddMembers")];t.forEach(t=>{t&&t.addEventListener("click",()=>{this.hideModal(e),Ze()})});const n=document.getElementById(e);n&&n.addEventListener("click",t=>{t.target===n&&(this.hideModal(e),Ze())});const s=document.getElementById("confirmAddMembers");s&&s.addEventListener("click",et)},loadAvailableMembers:function(){const e=document.getElementById("groupMembersList");e&&(e.innerHTML='<div class="loading-members">æ­£åœ¨åŠ è½½å¥½å‹åˆ—è¡¨...</div>',p&&m?fetch(`${c}/user/friends`,{headers:{"user-id":p.id,"session-token":m}}).then(e=>e.json()).then(t=>{let n=[];"success"===t.status&&t.friends?n=t.friends:console.error("Failed to get friends:",t.message||"Unknown error");const s=n.filter(e=>e.id!==p.id);0===s.length?e.innerHTML='<div class="loading-members">æ²¡æœ‰å¯ç”¨çš„å¥½å‹</div>':e.innerHTML=s.map(e=>`\n                        <div class="member-item">\n                            <input type="checkbox" class="member-checkbox" id="member-${e.id}" value="${e.id}">\n                            <label for="member-${e.id}" class="member-nickname">${e.nickname||e.username}</label>\n                        </div>\n                    `).join("")}).catch(t=>{console.error("Error loading friends:",t),e.innerHTML='<div class="loading-members">åŠ è½½å¥½å‹åˆ—è¡¨å¤±è´¥</div>'}):e.innerHTML='<div class="loading-members">è¯·å…ˆç™»å½•</div>')},bindCreateGroupSubmit:function(){const e=document.getElementById("submitCreateGroup");e&&e.addEventListener("click",()=>{this.handleCreateGroupSubmit()})},handleCreateGroupSubmit:function(){const e=document.getElementById("newGroupName"),t=document.getElementById("newGroupDescription"),n=document.getElementById("createGroupMessage"),s=e.value.trim(),o=t.value.trim(),i=document.querySelectorAll(".member-checkbox:checked"),a=Array.from(i).map(e=>e.value);s?a.length<0?n&&(n.textContent="è¯·é€‰æ‹©æˆå‘˜",n.className="create-group-message error"):(n&&(n.textContent="",n.className="create-group-message"),fetch(`${c}/create-group`,{method:"POST",headers:{"Content-Type":"application/json","user-id":p.id,"session-token":m},body:JSON.stringify({userId:p.id,groupName:s,description:o,memberIds:a})}).then(e=>e.json()).then(e=>{"success"===e.status?(n&&(n.textContent="ç¾¤ç»„åˆ›å»ºæˆåŠŸ",n.className="create-group-message success"),dt(),setTimeout(()=>{this.hideModal("createGroupModal")},1e3)):n&&(n.textContent=e.message||"ç¾¤ç»„åˆ›å»ºå¤±è´¥",n.className="create-group-message error")}).catch(e=>{n&&(n.textContent="åˆ›å»ºç¾¤ç»„å¤±è´¥ï¼Œç½‘ç»œé”™è¯¯",n.className="create-group-message error")})):n&&(n.textContent="ç¾¤ç»„åç§°ä¸èƒ½ä¸ºç©º",n.className="create-group-message error")}};function s(){const e=document.getElementById("imagePreviewModal");e&&(e.style.display="none",document.body.style.overflow="")}function o(e){const t=document.getElementById("imagePreviewModal");e.target===t&&s()}n.init(),window.ModalManager=n,window.openImagePreview=function(e){const t=document.getElementById("imagePreviewModal"),n=document.getElementById("previewImgElement"),i=document.getElementById("closeImagePreviewModal");if(t&&n&&("flex"===t.style.display&&s(),n.src=e,t.style.display="flex",document.body.style.overflow="hidden"),i)i.removeEventListener("click",s),i.addEventListener("click",s);else if(t){const e=document.createElement("div");e.id="closeImagePreviewModal",e.style.position="absolute",e.style.top="10px",e.style.right="10px",e.style.width="30px",e.style.height="30px",e.style.backgroundColor="rgba(0, 0, 0, 0.5)",e.style.color="white",e.style.borderRadius="50%",e.style.display="flex",e.style.justifyContent="center",e.style.alignItems="center",e.style.cursor="pointer",e.style.zIndex="1001",e.textContent="Ã—",e.style.fontSize="20px",e.style.fontWeight="bold";const n=t.querySelector("#closeImagePreviewModal");n||t.appendChild(e),e.addEventListener("click",s)}t&&(t.removeEventListener("click",o),t.addEventListener("click",o))};const i=document.getElementById("closeImagePreviewModal");i&&i.addEventListener("click",s);const r=document.getElementById("imagePreviewModal");function d(){const e=document.querySelectorAll(".message-image");e.forEach(e=>{e.hasAttribute("data-click-added")||(e.addEventListener("click",()=>{const t=e.getAttribute("src");t&&openImagePreview(t)}),e.setAttribute("data-click-added","true"))})}function y(){const e=document.querySelectorAll(".copy-button");e.forEach(e=>{e.hasAttribute("data-click-added")||(e.addEventListener("click",()=>{const t=decodeURIComponent(e.getAttribute("data-code"));navigator.clipboard.writeText(t).then(()=>{const t=e.parentElement.querySelector(".copy-notice");t&&(t.textContent="å·²å¤åˆ¶",t.style.color="#4CAF50",setTimeout(()=>{t.textContent=""},2e3))}).catch(e=>{console.error("å¤åˆ¶å¤±è´¥:",e)})}),e.setAttribute("data-click-added","true"))})}r&&r.addEventListener("click",o),d(),y();const v=document.getElementById("messageContainer");if(v){const e=new MutationObserver(()=>{d(),y()});e.observe(v,{childList:!0,subtree:!0})}const b=document.getElementById("groupMessageContainer");if(b){const e=new MutationObserver(()=>{d(),y()});e.observe(b,{childList:!0,subtree:!0})}const w=document.getElementById("privateMessageContainer");if(w){const e=new MutationObserver(()=>{d(),y()});e.observe(w,{childList:!0,subtree:!0})}window.updateAllMessagesNickname=function(e,t){if(!e||"string"!==typeof e||!t||"string"!==typeof t)return;const n=document.querySelectorAll(".message");n.forEach(n=>{const s=n.querySelector(".message-header");if(s){const o=n.classList.contains("own-message");if(o&&p&&String(p.id)===String(e)){const e=s.querySelector(".message-sender");e&&(e.textContent=t)}else{const o=n.getAttribute("data-user-id");if(o&&String(o)===String(e)){const e=s.querySelector(".message-sender");e&&(e.textContent=t)}}}})}}function ye(){const e=document.getElementById("messageInput"),t=document.getElementById("sendButton"),n=document.getElementById("imageUploadButton"),s=document.getElementById("fileUploadButton");e&&(e.removeAttribute("disabled"),e.placeholder="è¾“å…¥æ¶ˆæ¯..."),t&&t.removeAttribute("disabled"),n&&n.removeAttribute("disabled"),s&&s.removeAttribute("disabled");const o=document.getElementById("groupMessageInput"),i=document.getElementById("sendGroupMessage"),a=document.getElementById("groupImageUploadButton"),r=document.getElementById("groupFileUploadButton");o&&(o.removeAttribute("disabled"),o.placeholder="è¾“å…¥ç¾¤ç»„æ¶ˆæ¯..."),i&&i.removeAttribute("disabled"),a&&a.removeAttribute("disabled"),r&&r.removeAttribute("disabled")}function he(){if(!p||!m){const e=document.getElementById("messageInput"),t=document.getElementById("sendButton"),n=document.getElementById("imageUploadButton"),s=document.getElementById("fileUploadButton");e&&(e.setAttribute("disabled","disabled"),e.placeholder="è¯·å…ˆç™»å½•"),t&&t.setAttribute("disabled","disabled"),n&&n.setAttribute("disabled","disabled"),s&&s.setAttribute("disabled","disabled");const o=document.getElementById("groupMessageInput"),i=document.getElementById("sendGroupMessage"),a=document.getElementById("groupImageUploadButton"),r=document.getElementById("groupFileUploadButton");o&&(o.setAttribute("disabled","disabled"),o.placeholder="è¯·å…ˆç™»å½•"),i&&i.setAttribute("disabled","disabled"),a&&a.setAttribute("disabled","disabled"),r&&r.setAttribute("disabled","disabled")}}function ve(){p&&m&&fetch(`${c}/offline-users`,{headers:{"user-id":p.id,"session-token":m}}).then(e=>e.json()).then(e=>{"success"===e.status&&be(e.users)}).catch(e=>{})}function be(e){const t=document.getElementById("offlineUserList");if(!t)return;if(t.innerHTML="",!e||0===e.length)return void(t.innerHTML="<li>æš‚æ— ç¦»çº¿ç”¨æˆ·</li>");const n=e.filter(e=>!w.some(t=>t.id==e.id));0!==n.length?(n.forEach(e=>{const n=document.createElement("li");let s="";e.avatarUrl&&"string"===typeof e.avatarUrl?s=e.avatarUrl.trim():e.avatar_url&&"string"===typeof e.avatar_url?s=e.avatar_url.trim():e.avatar&&"string"===typeof e.avatar&&(s=e.avatar.trim());let o="";const i=s&&/\.svg$/i.test(s);if(s&&!i)o=`<span class="user-avatar"><img src="${c}${s}" alt="${e.nickname}"></span>`;else{const t=e.nickname.charAt(0).toUpperCase();o=`<span class="user-avatar">${t}</span>`}n.setAttribute("data-user-id",e.id),n.innerHTML=`\n            ${o}\n            <span class="user-name">${e.nickname}</span>\n            <span class="user-status offline"></span>\n        `,n.style.padding="8px 0",n.style.borderBottom="1px solid #f1f1f1",n.style.display="flex",n.style.alignItems="center",n.className="user-item",t.appendChild(n)}),ie()):t.innerHTML="<li>æš‚æ— ç¦»çº¿ç”¨æˆ·</li>"}function we(e,t=!1){const n=document.getElementById("messageContainer");if(!e)return;if(n&&document.querySelector(`#messageContainer [data-id="${e.id}"]`))return;if(!n&&!A)return;if(!e.messageType&&!e.content&&!e.imageUrl&&!e.fileUrl&&!e.text)return;const s=e.user||{id:e.userId,nickname:e.nickname,avatarUrl:e.avatarUrl},o=s.id,i=s.nickname||"æœªçŸ¥ç”¨æˆ·",a=s.avatarUrl,l=p&&String(p.id)===String(o),d=document.createElement("div");function u(e){if("string"!==typeof e)return e;const t=document.createElement("div");return t.textContent=e,t.innerHTML}d.className="message "+(l?"own-message":"other-message"),d.setAttribute("data-id",e.id),d.setAttribute("data-user-id",o),void 0!==e.sequence&&d.setAttribute("data-sequence",e.sequence),l?(d.style.marginLeft="20%",d.style.marginRight="10px",d.style.backgroundColor="#E8F5E8",d.style.borderRadius="18px",d.style.padding="10px 15px",d.style.maxWidth="80%",d.style.minWidth="70px",d.style.alignSelf="flex-end"):(d.style.marginLeft="10px",d.style.marginRight="20%",d.style.backgroundColor="#FFFFFF",d.style.borderRadius="18px",d.style.padding="10px 15px",d.style.maxWidth="80%",d.style.minWidth="70px",d.style.alignSelf="flex-start",d.style.border="1px solid #E0E0E0"),d.style.display="flex",d.style.flexDirection="column",d.style.marginBottom="10px";let m=e.content||"";if("undefined"!==typeof r)try{const t=new r.Renderer;t.code=function({text:e,lang:t,escaped:n}){const s=t||"code",o=e,i=o.split("\n"),a=i.map((e,t)=>`<span class="line">${t+1}</span>`).join(""),r=encodeURIComponent(o),l=`<figure class="highlight">\n            <div class="highlight-tools">\n                <div class="macStyle">\n                    <div class="mac-close"></div>\n                    <div class="mac-minimize"></div>\n                    <div class="mac-maximize"></div>\n                </div>\n                <div class="code-lang">${s}</div>\n                <div class="copy-notice"></div>\n                <i class="fas fa-paste copy-button" data-code="${r}"></i>\n                <i class="fa-solid fa-up-right-and-down-left-from-center fullpage-button"></i>\n            </div>\n            <table>\n                <tbody>\n                    <tr>\n                        <td class="gutter">\n                            <pre>${a}</pre>\n                        </td>\n                        <td class="code">\n                            <pre><code>${o}</code></pre>\n                        </td>\n                    </tr>\n                </tbody>\n            </table>\n        </figure>`;return l},r.setOptions({breaks:!0,gfm:!0,renderer:t});let n=e.content||"";if(n=u(n),c){n=n.replace(/!\[([^\]]+)\]\(([^)]+)\)/g,(e,t,n)=>{const s=n.trim();return!s||s.startsWith("http")||s.startsWith("//")?e:`![${t}](${c}${s})`}),n=n.replace(/\[([^\]]+)\]\(([^)]+)\)/g,(e,t,n)=>{const s=n.trim();return!s||s.startsWith("http")||s.startsWith("//")?e:/^[a-zA-Z0-9-]+\.[a-zA-Z]{2,}(\.[a-zA-Z]{2,})?(:\d+)?/.test(s)?`[${t}](https://${s})`:`[${t}](${c}${s})`});const e=/(?<!\]\()(?<!\[)(?<!https?:\/\/[^?&"'<>\s]+\?.*)(?<!https?:\/\/[^?&"'<>\s]+&.*)(https?:\/\/(?:[^\s"'<>]+))/g;n=n.replace(e,"[$1]($1)")}m=r.parse(n).trim(),m=m.replace(/<svg[^>]*>.*?<\/svg>/gi,"[SVGå›¾ç‰‡]"),m=m.replace(/<(?!\/?(a|img|div|span|br|p|h[1-6]|strong|em|code|pre|ul|ol|li|blockquote|figure|table|tbody|tr|td|i)\b)[^>]*>/gi,""),m=m.replace(/<a([^>]*)(href="([^"]*)")([^>]*)>([^<]*)<\/a>/g,(e,t,n,s,o,i)=>{const a=e.includes("download"),r=/^https?:\/\//i.test(s),l=/\.(jpg|jpeg|png|gif|bmp|webp)$/i.test(s),c=/\.(pdf|doc|docx|txt|rtf|xls|xlsx|csv|zip|rar|7z|tar|gz|mp3|wav|ogg|flac|mp4|avi|mov|wmv|flv|exe|dll|bat|sh|ppt|pptx|js|ts|html|css|php|py|java|c|cpp|cs|go|rb|swift|kt|svg)$/i,d=c.test(s);if(l)return e;if(a||!r&&d){const e=s.split(".").pop().toLowerCase();let a="ğŸ“„";return/^(pdf|doc|docx|txt|rtf)$/i.test(e)?a="ğŸ“":/^(xls|xlsx|csv)$/i.test(e)?a="ğŸ“Š":/^(zip|rar|7z|tar|gz)$/i.test(e)?a="ğŸ—œï¸":/^(jpg|jpeg|png|gif|bmp|webp)$/i.test(e)?a="ğŸ–¼ï¸":/^(mp3|wav|ogg|flac)$/i.test(e)?a="ğŸµ":/^(mp4|avi|mov|wmv|flv)$/i.test(e)?a="ğŸ¬":/^(exe|dll|bat|sh)$/i.test(e)?a="âš™ï¸":/^(ppt|pptx)$/i.test(e)?a="ğŸ“‹":/^(js|ts|html|css|php|py|java|c|cpp|cs|go|rb|swift|kt)$/i.test(e)&&(a="ğŸ’»"),`<div class="file-link-container"><a${t} ${n}${o} target="_blank"><span class="file-icon">${a}</span><span>${i}</span></a></div>`}return e})}catch(E){m=u(e.content)}else m=u(e.content);m=m.replace(/<img/g,'<img class="message-image" style="max-width: 100%; height: auto; cursor: pointer;"'),m=m.replace(/<a/g,'<a class="message-link" target="_blank" rel="noopener noreferrer" style="color: #3498db; text-decoration: none;"'),m=m.replace(/<a([^>]*)(href="([^"]*)")([^>]*)>([^<]*)<\/a>/g,(e,t,n,s,o,i)=>{const a=e.includes("download"),r=/^https?:\/\//i.test(s),l=/\.(jpg|jpeg|png|gif|bmp|webp)$/i.test(s),c=/\.(pdf|doc|docx|txt|rtf|xls|xlsx|csv|zip|rar|7z|tar|gz|mp3|wav|ogg|flac|mp4|avi|mov|wmv|flv|exe|dll|bat|sh|ppt|pptx|js|ts|html|css|php|py|java|c|cpp|cs|go|rb|swift|kt|svg)$/i,d=c.test(s);if(l)return e;if(a||!r&&d){const e=s.split(".").pop().toLowerCase();let a="ğŸ“„";return/^(pdf|doc|docx|txt|rtf)$/i.test(e)?a="ğŸ“":/^(xls|xlsx|csv)$/i.test(e)?a="ğŸ“Š":/^(zip|rar|7z|tar|gz)$/i.test(e)?a="ğŸ—œï¸":/^(jpg|jpeg|png|gif|bmp|webp)$/i.test(e)?a="ğŸ–¼ï¸":/^(mp3|wav|ogg|flac)$/i.test(e)?a="ğŸµ":/^(mp4|avi|mov|wmv|flv)$/i.test(e)?a="ğŸ¬":/^(exe|dll|bat|sh)$/i.test(e)?a="âš™ï¸":/^(ppt|pptx)$/i.test(e)?a="ğŸ“‹":/^(js|ts|html|css|php|py|java|c|cpp|cs|go|rb|swift|kt)$/i.test(e)&&(a="ğŸ’»"),`<div class="file-link-container"><a${t} ${n}${o} class="file-link" target="_blank"><span class="file-icon">${a}</span><span>${i}</span></a></div>`}return e}),!e.filename||e.fileUrl||e.imageUrl||e.content&&e.content.includes(e.filename)||(m+=`<div class="message-filename" style="margin-top: 5px; color: #666; font-size: 12px;">${u(e.filename)}</div>`);let g="";const f=a&&("string"===typeof a&&/\.svg$/i.test(a)||a.includes(".svg"));a&&!f&&(g=`${c}${a}`);const y=g?`<img src="${g}" alt="${i}" class="user-avatar" style="width: 32px; height: 32px; border-radius: 50%; margin-right: 10px;">`:`<div class="user-avatar default-avatar" style="width: 32px; height: 32px; border-radius: 50%; margin-right: 10px; background-color: #e0e0e0; display: flex; align-items: center; justify-content: center; font-weight: bold; color: #666;">${i.charAt(0).toUpperCase()}</div>`;let h="",v=e.imageUrl,b=e.fileUrl,w=e.filename,k=e.content,x=null;if(void 0!==e.messageType)switch(e.messageType){case 1:try{const t=JSON.parse(e.content);v=t.url,w=t.filename,t.width&&t.height&&(e.width=t.width,e.height=t.height)}catch(E){console.error("è§£æå›¾ç‰‡æ¶ˆæ¯JSONå¤±è´¥:",E)}break;case 2:try{const t=JSON.parse(e.content);b=t.url,w=t.filename}catch(E){console.error("è§£ææ–‡ä»¶æ¶ˆæ¯JSONå¤±è´¥:",E)}break;case 3:try{x=JSON.parse(e.content),"group_card"===x.type&&x.group_id||(x=null)}catch(E){console.error("è§£æç¾¤åç‰‡æ¶ˆæ¯JSONå¤±è´¥:",E),x=null}break;default:k=e.content;break}if(v&&null!==v&&""!==v){const t=v.startsWith("http")?v:`${c}${v}`;let n="",s="";e.width&&e.height&&(n=`width="${e.width}"`,s=`height="${e.height}"`),h+=`<img src="${u(t)}" alt="${u(w||"å›¾ç‰‡")}" ${n} ${s} class="message-image" style="max-width: 100%; height: auto; cursor: pointer;">`}if(b&&null!==b&&""!==b){const e=b.startsWith("http")?b:`${c}${b}`,t=w||"æ–‡ä»¶",n=t.split(".").pop().toLowerCase();let s="ğŸ“„";/^(pdf|doc|docx|txt|rtf)$/i.test(n)?s="ğŸ“":/^(xls|xlsx|csv)$/i.test(n)?s="ğŸ“Š":/^(zip|rar|7z|tar|gz)$/i.test(n)?s="ğŸ—œï¸":/^(jpg|jpeg|png|gif|bmp|webp)$/i.test(n)?s="ğŸ–¼ï¸":/^(mp3|wav|ogg|flac)$/i.test(n)?s="ğŸµ":/^(mp4|avi|mov|wmv|flv)$/i.test(n)?s="ğŸ¬":/^(exe|dll|bat|sh)$/i.test(n)?s="âš™ï¸":/^(ppt|pptx)$/i.test(n)?s="ğŸ“‹":/^(js|ts|html|css|php|py|java|c|cpp|cs|go|rb|swift|kt)$/i.test(n)&&(s="ğŸ’»"),h+=`<div class="file-link-container"><a href="${u(e)}" class="file-link" target="_blank" style="color: #3498db; text-decoration: none;"><span class="file-icon">${s}</span><span>${u(t)}</span></a></div>`}if(x&&(h+=`\n            <div class="group-card-container" data-group-id="${x.group_id}" style="background-color: #f0f8ff; border: 1px solid #3498db; border-radius: 8px; padding: 10px; cursor: pointer; margin-top: 5px;">\n                <div class="group-card-header" style="font-weight: bold; color: #3498db; margin-bottom: 5px; display: flex; align-items: center; gap: 8px;">\n                    ${x.avatar_url?`<img src="${c}${x.avatar_url}" alt="${x.group_name}" style="width: 20px; height: 20px; border-radius: 50%; object-fit: cover; cursor: pointer;" onclick="openImagePreview('${c}${x.avatar_url}')">`:`<div style="width: 20px; height: 20px; border-radius: 50%; background-color: #3498db; color: white; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold;">${x.group_name.charAt(0).toUpperCase()}</div>`}\n                    ${x.group_name}\n                </div>\n                <div class="group-card-description" style="color: #666; font-size: 14px; margin-bottom: 5px;">\n                    ${x.group_description||"æš‚æ— å…¬å‘Š"}\n                </div>\n                <div class="group-card-footer" style="font-size: 12px; color: #999;">\n                    ç‚¹å‡»æŸ¥çœ‹ç¾¤ç»„è¯¦æƒ…\n                </div>\n            </div>\n        `),m&&""!==m.trim()&&!(b||v||x)&&(h+=m),d.innerHTML=`\n        <div class="message-header" style="display: flex; align-items: center; margin-bottom: 5px;">\n            ${y}\n            <div style="flex: 1;">\n                <span class="message-sender" style="font-weight: bold;">${i}</span>\n                <span class="message-time" style="float: right; color: #999; font-size: 12px;">${e.timestamp?new Date(e.timestamp).toLocaleTimeString():(new Date).toLocaleTimeString()}</span>\n            </div>\n            ${l?`<button class="delete-button" data-id="${e.id}" title="æ’¤å›æ¶ˆæ¯" style="background: none; border: none; color: #999; font-size: 16px; cursor: pointer; margin-left: 10px;">Ã—</button>`:""}\n        </div>\n        <div class="message-content">${h}</div>\n    `,l&&N(d),x){const e=d.querySelector(".group-card-container");e&&e.addEventListener("click",function(e){e.stopPropagation(),Te(e,x)})}const I=d.querySelector(".user-avatar");if(I&&I.addEventListener("click",e=>{e.stopPropagation(),se(e,s)}),t)return d;if(n){"undefined"!==typeof renderMathInElement&&renderMathInElement(d,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1}]});const e=n.querySelector(".empty-state");e&&(e.style.display="none"),n.appendChild(d);const t=n.scrollHeight-n.scrollTop-n.clientHeight,s=t<=150;(s||l)&&setTimeout(()=>{n.scrollTop=n.scrollHeight},0)}else A&&(11===A.nodeType?A.appendChild(d.cloneNode(!0)):"string"===typeof A&&(A+=d.outerHTML))}function ke(e,t=!1){const n=document.getElementById("groupMessageContainer");if(!n&&!A)return;if(!e)return;const s=e.groupId,o=t||e.isHistory||!1,i=String($),a=String(s);if(s&&$&&a!==i&&!o){B[a]||(B[a]=[]);const t=B[a].some(t=>t.id===e.id);return void(t||B[a].push(e))}function l(e){const t=e.content||e.text||"empty",n=e.userId||e.senderId||"unknown",s=e.timestamp||e.createdAt||"unknown",o=`${n}-${s}-${JSON.stringify(t)}`;let i=0;for(let a=0;a<o.length;a++){const e=o.charCodeAt(a);i=(i<<5)-i+e,i&=i}return Math.abs(i).toString(16)}const d=e.identifier||l(e);if(document.querySelector(`#groupMessageContainer [data-identifier="${d}"]`))return;if(!e.messageType&&!e.content&&!e.imageUrl&&!e.fileUrl&&!e.text)return;const u=e.user||{id:e.userId,nickname:e.nickname,avatarUrl:e.avatarUrl},g=u.id,f=u.nickname||"æœªçŸ¥ç”¨æˆ·",y=u.avatarUrl,h=p&&String(p.id)===String(g),v=document.createElement("div");function b(e){if("string"!==typeof e)return e;const t=document.createElement("div");return t.textContent=e,t.innerHTML}v.className="message "+(h?"own-message":"other-message"),e.id&&v.setAttribute("data-id",e.id),v.setAttribute("data-identifier",d),void 0!==e.sequence&&v.setAttribute("data-sequence",e.sequence),h?(v.style.marginLeft="20%",v.style.marginRight="10px",v.style.backgroundColor="#E8F5E8",v.style.borderRadius="18px",v.style.padding="10px 15px",v.style.maxWidth="80%",v.style.alignSelf="flex-end"):(v.style.marginLeft="10px",v.style.marginRight="20%",v.style.backgroundColor="#FFFFFF",v.style.borderRadius="18px",v.style.padding="10px 15px",v.style.maxWidth="80%",v.style.alignSelf="flex-start",v.style.border="1px solid #E0E0E0"),v.style.display="flex",v.style.flexDirection="column",v.style.marginBottom="10px";let w=e.content||"";if("undefined"!==typeof r)try{const t=new r.Renderer;t.code=function({text:e,lang:t,escaped:n}){const s=t||"code",o=e,i=o.split("\n"),a=i.map((e,t)=>`<span class="line">${t+1}</span>`).join(""),r=encodeURIComponent(o),l=`<figure class="highlight">\n            <div class="highlight-tools">\n                <div class="macStyle">\n                    <div class="mac-close"></div>\n                    <div class="mac-minimize"></div>\n                    <div class="mac-maximize"></div>\n                </div>\n                <div class="code-lang">${s}</div>\n                <div class="copy-notice"></div>\n                <i class="fas fa-paste copy-button" data-code="${r}"></i>\n                <i class="fa-solid fa-up-right-and-down-left-from-center fullpage-button"></i>\n            </div>\n            <table>\n                <tbody>\n                    <tr>\n                        <td class="gutter">\n                            <pre>${a}</pre>\n                        </td>\n                        <td class="code">\n                            <pre><code>${o}</code></pre>\n                        </td>\n                    </tr>\n                </tbody>\n            </table>\n        </figure>`;return l},r.setOptions({breaks:!0,gfm:!0,renderer:t});let n=e.content||"";if(n=b(n),c){n=n.replace(/!\[([^\]]+)\]\(([^)]+)\)/g,(e,t,n)=>{const s=n.trim();return!s||s.startsWith("http")||s.startsWith("//")?e:`![${t}](${c}${s})`}),n=n.replace(/\[([^\]]+)\]\(([^)]+)\)/g,(e,t,n)=>{const s=n.trim();return!s||s.startsWith("http")||s.startsWith("//")?e:/^[a-zA-Z0-9-]+\.[a-zA-Z]{2,}(\.[a-zA-Z]{2,})?(:\d+)?/.test(s)?`[${t}](https://${s})`:`[${t}](${c}${s})`});const e=/(?<!\]\()(?<!\[)(?<!https?:\/\/[^?&"'<>\s]+\?.*)(?<!https?:\/\/[^?&"'<>\s]+&.*)(https?:\/\/(?:[^\s"'<>]+))/g;n=n.replace(e,"[$1]($1)")}w=r.parse(n).trim(),w=w.replace(/<svg[^>]*>.*?<\/svg>/gi,"[SVGå›¾ç‰‡]"),w=w.replace(/<(?!\/?(a|img|div|span|br|p|h[1-6]|strong|em|code|pre|ul|ol|li|blockquote|figure|table|tbody|tr|td|i)\b)[^>]*>/gi,"")}catch(N){w=b(e.content)}else w=b(e.content);w=w.replace(/<img/g,'<img class="message-image" style="max-width: 100%; height: auto; cursor: pointer;"'),w=w.replace(/<a/g,'<a class="message-link" target="_blank" rel="noopener noreferrer" style="color: #3498db; text-decoration: none;"'),w=w.replace(/<a([^>]*)(href="([^"]*)")([^>]*)>([^<]*)<\/a>/g,(e,t,n,s,o,i)=>{const a=e.includes("download"),r=/^https?:\/\//i.test(s),l=/\.(jpg|jpeg|png|gif|bmp|webp)$/i.test(s),c=/\.(pdf|doc|docx|txt|rtf|xls|xlsx|csv|zip|rar|7z|tar|gz|mp3|wav|ogg|flac|mp4|avi|mov|wmv|flv|exe|dll|bat|sh|ppt|pptx|js|ts|html|css|php|py|java|c|cpp|cs|go|rb|swift|kt|svg)$/i,d=c.test(s);if(l)return e;if(a||!r&&d){const e=s.split(".").pop().toLowerCase();let a="ğŸ“„";return/^(pdf|doc|docx|txt|rtf)$/i.test(e)?a="ğŸ“":/^(xls|xlsx|csv)$/i.test(e)?a="ğŸ“Š":/^(zip|rar|7z|tar|gz)$/i.test(e)?a="ğŸ—œï¸":/^(jpg|jpeg|png|gif|bmp|webp)$/i.test(e)?a="ğŸ–¼ï¸":/^(mp3|wav|ogg|flac)$/i.test(e)?a="ğŸµ":/^(mp4|avi|mov|wmv|flv)$/i.test(e)?a="ğŸ¬":/^(exe|dll|bat|sh)$/i.test(e)?a="âš™ï¸":/^(ppt|pptx)$/i.test(e)?a="ğŸ“‹":/^(js|ts|html|css|php|py|java|c|cpp|cs|go|rb|swift|kt)$/i.test(e)&&(a="ğŸ’»"),`<div class="file-link-container"><a${t} ${n}${o} class="file-link" target="_blank"><span class="file-icon">${a}</span><span>${i}</span></a></div>`}return e}),!e.filename||e.fileUrl||e.imageUrl||e.content&&e.content.includes(e.filename)||(w+=`<div class="message-filename" style="margin-top: 5px; color: #666; font-size: 12px;">${b(e.filename)}</div>`);let k="";const x=y&&("string"===typeof y&&/\.svg$/i.test(y)||y.includes(".svg"));y&&!x&&(k=`${c}${y}`);const I=k?`<img src="${k}" alt="${f}" class="user-avatar" style="width: 32px; height: 32px; border-radius: 50%; margin-right: 10px;">`:`<div class="user-avatar default-avatar" style="width: 32px; height: 32px; border-radius: 50%; margin-right: 10px; background-color: #e0e0e0; display: flex; align-items: center; justify-content: center; font-weight: bold; color: #666;">${f.charAt(0).toUpperCase()}</div>`;let E="",S=e.imageUrl,C=e.fileUrl,L=e.filename,M=e.content,T=null;if(void 0!==e.messageType)switch(e.messageType){case 1:try{const t=JSON.parse(e.content);S=t.url,L=t.filename}catch(N){console.error("è§£æå›¾ç‰‡æ¶ˆæ¯JSONå¤±è´¥:",N)}break;case 2:try{const t=JSON.parse(e.content);C=t.url,L=t.filename}catch(N){console.error("è§£ææ–‡ä»¶æ¶ˆæ¯JSONå¤±è´¥:",N)}break;case 3:try{T=JSON.parse(e.content),"group_card"===T.type&&T.group_id||(T=null)}catch(N){console.error("è§£æç¾¤åç‰‡æ¶ˆæ¯JSONå¤±è´¥:",N),T=null}break;default:M=e.content;break}if(S&&null!==S&&""!==S){const e=S.startsWith("http")?S:`${c}${S}`;E+=`<img src="${b(e)}" alt="${b(L||"å›¾ç‰‡")}" class="message-image" style="max-width: 100%; height: auto; cursor: pointer;">`}if(C&&null!==C&&""!==C){const e=C.startsWith("http")?C:`${c}${C}`,t=L||"æ–‡ä»¶",n=t.split(".").pop().toLowerCase();let s="ğŸ“„";/^(pdf|doc|docx|txt|rtf)$/i.test(n)?s="ğŸ“":/^(xls|xlsx|csv)$/i.test(n)?s="ğŸ“Š":/^(zip|rar|7z|tar|gz)$/i.test(n)?s="ğŸ—œï¸":/^(jpg|jpeg|png|gif|bmp|webp)$/i.test(n)?s="ğŸ–¼ï¸":/^(mp3|wav|ogg|flac)$/i.test(n)?s="ğŸµ":/^(mp4|avi|mov|wmv|flv)$/i.test(n)?s="ğŸ¬":/^(exe|dll|bat|sh)$/i.test(n)?s="âš™ï¸":/^(ppt|pptx)$/i.test(n)?s="ğŸ“‹":/^(js|ts|html|css|php|py|java|c|cpp|cs|go|rb|swift|kt)$/i.test(n)&&(s="ğŸ’»"),E+=`<div class="file-link-container"><a href="${b(e)}" class="file-link" target="_blank" style="color: #3498db; text-decoration: none;"><span class="file-icon">${s}</span><span>${b(t)}</span></a></div>`}if(T&&(E+=`\n            <div class="group-card-container" style="background-color: #f0f8ff; border: 1px solid #3498db; border-radius: 8px; padding: 10px; cursor: pointer; margin-top: 5px;">\n                <div class="group-card-header" style="font-weight: bold; color: #3498db; margin-bottom: 5px; display: flex; align-items: center; gap: 8px;">\n                    ${T.avatar_url?`<img src="${c}${T.avatar_url}" alt="${T.group_name}" style="width: 20px; height: 20px; border-radius: 50%; object-fit: cover; cursor: pointer;" onclick="openImagePreview('${c}${T.avatar_url}')">`:`<div style="width: 20px; height: 20px; border-radius: 50%; background-color: #3498db; color: white; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold;">${T.group_name.charAt(0).toUpperCase()}</div>`}\n                    ${T.group_name}\n                </div>\n                <div class="group-card-description" style="color: #666; font-size: 14px; margin-bottom: 5px;">\n                    ${T.group_description||"æš‚æ— å…¬å‘Š"}\n                </div>\n                <div class="group-card-footer" style="font-size: 12px; color: #999;">\n                    ç‚¹å‡»æŸ¥çœ‹ç¾¤ç»„è¯¦æƒ…\n                </div>\n            </div>\n        `),w&&""!==w.trim()&&!(C||S||T)&&(E+=w),v.innerHTML=`\n        <div class="message-header" style="display: flex; align-items: center; margin-bottom: 5px;">\n            ${I}\n            <div style="flex: 1;">\n                <span class="message-sender" style="font-weight: bold;">${f}</span>\n                <span class="message-time" style="float: right; color: #999; font-size: 12px;">${e.timestamp?new Date(e.timestamp).toLocaleTimeString():(new Date).toLocaleTimeString()}</span>\n            </div>\n            ${h?`<button class="delete-button" data-id="${e.id}" title="æ’¤å›æ¶ˆæ¯" style="background: none; border: none; color: #999; font-size: 16px; cursor: pointer; margin-left: 10px;">Ã—</button>`:""}\n        </div>\n        <div class="message-content">${E}</div>\n    `,h){const e=v.querySelector(".delete-button");e&&e.addEventListener("click",function(e){e.stopPropagation();const t=this.getAttribute("data-id");t&&window.chatSocket.emit("delete-message",{messageId:t,sessionToken:m,userId:p.id})})}if(T){const e=v.querySelector(".group-card-container");e&&e.addEventListener("click",function(e){e.stopPropagation(),Te(e,T)})}const U=v.querySelector(".user-avatar");if(U&&U.addEventListener("click",e=>{e.stopPropagation(),se(e,u)}),t)return v;if(n){"undefined"!==typeof renderMathInElement&&renderMathInElement(v,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1}]});const e=n.querySelector(".empty-state");e&&(e.style.display="none"),n.appendChild(v),setTimeout(()=>{const e=n.scrollHeight-n.scrollTop-n.clientHeight,t=e<=150;(t||h)&&(n.scrollTop=n.scrollHeight)},100)}else A&&(11===A.nodeType?A.appendChild(v.cloneNode(!0)):"string"===typeof A&&(A+=v.outerHTML))}function xe(){document.addEventListener("visibilitychange",gt),window.addEventListener("focus",ft),window.addEventListener("blur",ft)}function Ie(){const e=document.getElementById("moreButton"),t=document.getElementById("mainMoreFunctions"),n=document.getElementById("mainInputContainer");if(e&&t&&n){const s=e.cloneNode(!0);e.parentNode.replaceChild(s,e),s.addEventListener("click",function(){t.classList.toggle("show"),n.classList.toggle("lifted")})}const s=document.getElementById("groupMoreButton"),o=document.getElementById("groupMoreFunctions"),i=document.getElementById("groupInputContainer");if(s&&o&&i){const e=s.cloneNode(!0);s.parentNode.replaceChild(e,s),e.addEventListener("click",function(){o.classList.toggle("show"),i.classList.toggle("lifted")})}const a=document.getElementById("privateMoreButton"),r=document.getElementById("privateMoreFunctions"),l=document.getElementById("privateInputContainer");if(a&&r&&l){const e=a.cloneNode(!0);a.parentNode.replaceChild(e,a),e.addEventListener("click",function(){r.classList.toggle("show"),l.classList.toggle("lifted")})}const c=document.getElementById("sendGroupCardButton"),d=document.getElementById("sendGroupCardButtonGroup"),u=document.getElementById("privateSendGroupCardButton");if(c){const e=c.cloneNode(!0);c.parentNode.replaceChild(e,c),e.addEventListener("click",function(){Ee("main")})}if(d){const e=d.cloneNode(!0);d.parentNode.replaceChild(e,d),e.addEventListener("click",function(){Ee("group")})}if(u){const e=u.cloneNode(!0);u.parentNode.replaceChild(e,u),e.addEventListener("click",function(){Ee("private")})}const p=document.getElementById("closeSendGroupCardModal"),m=document.getElementById("cancelSendGroupCard"),g=document.getElementById("confirmSendGroupCard");if(p){const e=p.cloneNode(!0);p.parentNode.replaceChild(e,p),e.addEventListener("click",function(){const e=document.getElementById("sendGroupCardModal");e&&(e.style.display="none",document.body.style.overflow="")})}if(m){const e=m.cloneNode(!0);m.parentNode.replaceChild(e,m),e.addEventListener("click",function(){const e=document.getElementById("sendGroupCardModal");e&&(e.style.display="none",document.body.style.overflow="")})}if(g){const e=g.cloneNode(!0);g.parentNode.replaceChild(e,g),e.addEventListener("click",function(){Se()})}}function Ee(e){L=e,M=null;const t=document.getElementById("sendGroupCardModal"),n=document.getElementById("sendGroupCardList");t&&(t.style.display="flex",t.style.justifyContent="center",t.style.alignItems="center",t.style.zIndex="1000",document.body.style.overflow="hidden",n.innerHTML="",fetch(`${c}/user-groups/${p.id}`,{headers:{"user-id":p.id,"session-token":m}}).then(e=>e.json()).then(e=>{if("success"===e.status){const t=e.groups;0===t.length?n.innerHTML='<div style="text-align: center; color: #666; padding: 20px;">ä½ è¿˜æ²¡æœ‰åŠ å…¥ä»»ä½•ç¾¤ç»„</div>':t.forEach(e=>{const t=document.createElement("div");t.className="send-group-card-item",t.style.display="flex",t.style.alignItems="center",t.style.margin="10px 0",t.style.padding="10px",t.style.borderRadius="5px",t.style.cursor="pointer",t.style.border="1px solid #ddd",t.style.transition="background-color 0.3s";const s=document.createElement("label");s.setAttribute("for",`group-${e.id}`),s.style.marginLeft="10px",s.style.cursor="pointer",s.style.flex="1";const o=ut(e.group_name||e.name||"æœªå‘½åç¾¤ç»„");s.textContent=o;const i=document.createElement("input");i.setAttribute("type","radio"),i.setAttribute("name","selectedGroup"),i.setAttribute("value",e.id),i.setAttribute("id",`group-${e.id}`),i.className="send-group-card-radio",t.innerHTML="",t.appendChild(i),t.appendChild(s),t.addEventListener("click",function(){document.querySelectorAll(".send-group-card-item").forEach(e=>{e.style.backgroundColor="",e.style.borderColor="#ddd"}),this.style.backgroundColor="#e8f5e8",this.style.borderColor="#3498db",M=e.id,document.getElementById("confirmSendGroupCard").disabled=!1}),n.appendChild(t)})}}).catch(e=>{n.innerHTML='<div style="text-align: center; color: #e74c3c; padding: 20px;">åŠ è½½ç¾¤ç»„åˆ—è¡¨å¤±è´¥</div>'}),t.style.display="flex")}function Se(){M&&fetch(`${c}/generate-group-token`,{method:"POST",headers:{"Content-Type":"application/json","user-id":p.id,"session-token":m},body:JSON.stringify({groupId:M})}).then(e=>e.json()).then(e=>{if("success"===e.status){const t=e.token;fetch(`${c}/group-info/${M}`,{headers:{"user-id":p.id,"session-token":m}}).then(e=>e.json()).then(e=>{if("success"===e.status){const n=e.group,s=JSON.stringify({type:"group_card",group_id:n.id,group_name:n.name,group_description:n.description||"",invite_token:t,avatar_url:n.avatar_url||n.avatarUrl||""});"main"===L?window.chatSocket.emit("send-message",{content:s,messageType:3,sessionToken:m,userId:p.id}):"group"===L?window.chatSocket.emit("send-message",{content:s,messageType:3,groupId:f,sessionToken:m,userId:p.id}):"private"===L&&window.chatSocket.emit("private-message",{content:s,messageType:3,receiverId:h,sessionToken:m,userId:p.id});const o=document.getElementById("sendGroupCardModal");o&&(o.style.display="none",document.body.style.overflow="")}})}else a.error("ç”Ÿæˆé‚€è¯·Tokenå¤±è´¥: "+(e.message||"æœªçŸ¥é”™è¯¯"))}).catch(e=>{console.error("å‘é€ç¾¤åç‰‡å¤±è´¥:",e),a.error("å‘é€ç¾¤åç‰‡å¤±è´¥ï¼Œç½‘ç»œé”™è¯¯")})}function Ce(){const e=document.getElementById("messageInput"),t=document.getElementById("sendButton"),n=document.getElementById("imageUploadButton"),s=document.getElementById("fileUploadButton"),o=document.getElementById("imageInput"),i=document.getElementById("fileInput"),a=document.getElementById("markdownToolbar");e&&(e.removeAttribute("disabled"),e.placeholder="è¾“å…¥æ¶ˆæ¯..."),t&&t.removeAttribute("disabled"),n&&n.removeAttribute("disabled"),s&&s.removeAttribute("disabled"),e&&t&&(t.addEventListener("click",function(){d()}),e.addEventListener("paste",function(e){const t=e.clipboardData.items;for(const n of t){if(n.type.startsWith("image/")){e.preventDefault();const t=n.getAsFile();t&&Be(t);break}if("application/octet-stream"===n.type){e.preventDefault();const t=n.getAsFile();t&&Le(t);break}}}),e.addEventListener("keydown",function(t){if("Enter"!==t.key||t.shiftKey||t.ctrlKey)if("Enter"===t.key&&t.ctrlKey&&!t.shiftKey)if(t.preventDefault(),"DIV"===e.tagName&&e.isContentEditable)try{const e=window.getSelection(),t=e.getRangeAt(0),n=document.createElement("br");t.deleteContents(),t.insertNode(n),t.setStartAfter(n),t.setEndAfter(n),e.removeAllRanges(),e.addRange(t)}catch(n){e.innerHTML+="<br>",e.focus()}else{const t=e.selectionStart,n=e.selectionEnd,s=e.value;e.value=s.substring(0,t)+"\n"+s.substring(n);const o=t+1;e.setSelectionRange(o,o),e.focus()}else"Enter"===t.key&&t.shiftKey&&t.ctrlKey;else t.preventDefault(),d()}));const r=document.getElementById("toggleMarkdownToolbar");if(r&&a&&(a.style.display="none",$e(),r.addEventListener("click",function(){"none"===a.style.display?(a.style.display="flex",this.innerHTML='<i class="fas fa-chevron-up"></i> éšè—Markdownå·¥å…·æ '):(a.style.display="none",this.innerHTML='<i class="fas fa-chevron-down"></i> MD'),$e()})),$e(),a){const t=a.querySelectorAll(".markdown-btn");t.forEach(t=>{t.addEventListener("click",function(t){t.stopPropagation();const n=this.getAttribute("data-prefix")||"",s=this.getAttribute("data-suffix")||"",o=this.getAttribute("data-sample")||"ç¤ºä¾‹æ–‡æœ¬";try{e.focus();const t=window.getSelection(),i=t.getRangeAt(0);if(e.contains(i.commonAncestorContainer)){const e=i.toString(),a=n+(e||o)+s,r=document.createTextNode(a);i.deleteContents(),i.insertNode(r);const l=n.length,c=e?n.length+e.length:n.length+o.length;i.setStart(r,l),i.setEnd(r,c),t.removeAllRanges(),t.addRange(i)}else{e.innerHTML+=n+o+s,e.focus();const t=window.getSelection(),i=document.createRange();i.selectNodeContents(e),i.collapse(!1),t.removeAllRanges(),t.addRange(i)}}catch(i){e.innerHTML+=n+o+s,e.focus();const t=window.getSelection(),a=document.createRange();a.selectNodeContents(e),a.collapse(!1),t.removeAllRanges(),t.addRange(a)}})})}const l=document.getElementById("toggleGroupMarkdownToolbar"),c=document.getElementById("groupMarkdownToolbar");document.getElementById("groupMessageInput");if(l&&c){c.style.display="none",$e(),l.addEventListener("click",function(){"none"===c.style.display?(c.style.display="flex",this.innerHTML='<i class="fas fa-chevron-up"></i> éšè—Markdownå·¥å…·æ '):(c.style.display="none",this.innerHTML='<i class="fas fa-chevron-down"></i> MD')});const e=c.querySelectorAll(".markdown-btn");e.forEach(e=>{e.addEventListener("click",function(){const e=this.getAttribute("data-prefix")||"",t=this.getAttribute("data-suffix")||"",n=this.getAttribute("data-sample")||"ç¤ºä¾‹æ–‡æœ¬",s=document.getElementById("groupMessageInput");if(s){const o=s.selectionStart,i=s.selectionEnd,a=s.value.substring(o,i),r=e+(a||n)+t;s.value=s.value.substring(0,o)+r+s.value.substring(i);const l=o+e.length,c=a?o+e.length+a.length:o+e.length+n.length;s.setSelectionRange(l,c),s.focus()}})})}function d(){const e=document.getElementById("messageInput"),t=e.textContent.trim()||e.innerHTML.trim();if(t&&g&&window.chatSocket){const n={content:t,groupId:"main"===$?null:$,sessionToken:m,userId:p.id};window.chatSocket.emit("send-message",n),e.innerHTML=""}}n&&o&&(n.addEventListener("click",function(){o.click()}),o.addEventListener("change",function(){this.files&&this.files[0]&&Be(this.files[0])})),s&&i&&(s.addEventListener("click",function(){i.click()}),i.addEventListener("change",function(){this.files&&this.files[0]&&Le(this.files[0])}))}function $e(){const e=document.querySelector(".chat-content.active");if(e){if(e.style.marginBottom="0",e.style.paddingBottom="0",e.style.height="100%",e.style.overflow="hidden","public-chat"===e.dataset.content){const t=document.getElementById("markdownToolbar");t&&"none"!==t.style.display?e.style.paddingTop="60px":e.style.paddingTop="0"}else e.dataset.content,e.style.paddingTop="0";e.style.display="none",requestAnimationFrame(()=>{e.style.display="flex"})}}function Be(e){const t=new Image,n=new FileReader;n.onload=function(n){t.onload=function(){const n=t.width,s=t.height,o=new FormData;o.append("image",e),o.append("userId",p.id),o.append("width",n),o.append("height",s);const i="main"!==$&&!$.startsWith("private_");i&&o.append("groupId",$);const a=i?document.getElementById("groupUploadProgress"):document.getElementById("uploadProgress"),r=i?document.getElementById("groupUploadProgressBar"):document.getElementById("uploadProgressBar");a&&r&&(a.style.display="block",r.style.width="0%"),fetch(`${c}/upload`,{method:"POST",headers:{"user-id":p.id,"session-token":m},body:o}).then(e=>{if(413===e.status)throw new Error("æ–‡ä»¶è¿‡å¤§");return e.json()}).then(e=>{"success"===e.status||Bt(e.message||"å›¾ç‰‡ä¸Šä¼ å¤±è´¥")}).catch(e=>{e.message&&e.message.includes("Failed to fetch")?Bt("æ–‡ä»¶è¿‡å¤§"):Bt(e.message||"å›¾ç‰‡ä¸Šä¼ å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•")}).finally(()=>{if(a&&(a.style.display="none"),i){const e=document.getElementById("groupImageInput");e&&(e.value="")}else{const e=document.getElementById("imageInput");e&&(e.value="")}})},t.onerror=function(){const t=new FormData;t.append("image",e),t.append("userId",p.id);const n="main"!==$&&!$.startsWith("private_");n&&t.append("groupId",$),fetch(`${c}/upload`,{method:"POST",headers:{"user-id":p.id,"session-token":m},body:t}).then(e=>e.json()).then(e=>{"success"!==e.status&&Bt(e.message||"å›¾ç‰‡ä¸Šä¼ å¤±è´¥")}).catch(e=>{Bt("å›¾ç‰‡ä¸Šä¼ å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•")})},t.src=n.target.result},n.readAsDataURL(e)}function Le(e){const t=new FormData;t.append("image",e),t.append("userId",p.id);const n="main"!==$&&!$.startsWith("private_");n&&t.append("groupId",$);const s=n?document.getElementById("groupUploadProgress"):document.getElementById("uploadProgress"),o=n?document.getElementById("groupUploadProgressBar"):document.getElementById("uploadProgressBar");s&&o&&(s.style.display="block",o.style.width="0%"),fetch(`${c}/upload`,{method:"POST",headers:{"user-id":p.id,"session-token":m},body:t}).then(e=>{if(413===e.status)throw new Error("æ–‡ä»¶è¿‡å¤§");return e.json()}).then(e=>{"success"===e.status||Bt(e.message||"æ–‡ä»¶ä¸Šä¼ å¤±è´¥")}).catch(e=>{e.message&&e.message.includes("Failed to fetch")?Bt("æ–‡ä»¶è¿‡å¤§"):Bt(e.message||"æ–‡ä»¶ä¸Šä¼ å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•")}).finally(()=>{if(s&&(s.style.display="none"),n){const e=document.getElementById("groupFileInput");e&&(e.value="")}else{const e=document.getElementById("fileInput");e&&(e.value="")}})}function Me(){const e=document.getElementById("groupSearchInput"),t=document.getElementById("clearGroupSearch");e&&t&&(e.addEventListener("input",()=>{const n=e.value.toLowerCase(),s=document.querySelectorAll("#groupList li[data-group-id]");s.forEach(e=>{const t=e.dataset.groupName.toLowerCase();t.includes(n)?e.style.display="flex":e.style.display="none"}),t.style.display=n?"inline":"none"}),t.addEventListener("click",()=>{e.value="",t.style.display="none";const n=document.querySelectorAll("#groupList li[data-group-id]");n.forEach(e=>{e.style.display="flex"})}));const n=document.getElementById("groupMessageInput"),s=document.getElementById("sendGroupMessage"),o=document.getElementById("groupImageUploadButton"),i=document.getElementById("groupFileUploadButton"),a=document.getElementById("groupImageInput"),r=document.getElementById("groupFileInput"),l=document.getElementById("groupChatInterface");function c(){if(!f)return void console.warn("âš ï¸  æ— æ³•å‘é€ç¾¤ç»„æ¶ˆæ¯ - æœªé€‰æ‹©ç¾¤ç»„");const e=document.getElementById("groupMessageInput");if(!e)return void console.error("âŒ æ— æ³•è·å–ç¾¤ç»„æ¶ˆæ¯è¾“å…¥æ¡† - å…ƒç´ ä¸å­˜åœ¨");let t="";if("DIV"===e.tagName&&e.isContentEditable){if(t=e.textContent.trim(),!t){const n=document.createElement("div");n.innerHTML=e.innerHTML,t=n.textContent.trim()}}else t=e.value||e.innerHTML||"",t=t.trim();if(t&&g&&window.chatSocket){const n={groupId:f,content:t,sessionToken:m,userId:p.id};window.chatSocket.emit("send-message",n),e.value=""}else t?g?window.chatSocket||console.warn("âš ï¸  æ— æ³•å‘é€ç¾¤ç»„æ¶ˆæ¯ - WebSocketå®ä¾‹ä¸å­˜åœ¨"):console.warn("âš ï¸  æ— æ³•å‘é€ç¾¤ç»„æ¶ˆæ¯ - æœªè¿æ¥åˆ°æœåŠ¡å™¨"):console.warn("âš ï¸  æ— æ³•å‘é€ç¾¤ç»„æ¶ˆæ¯ - æ¶ˆæ¯å†…å®¹ä¸ºç©º")}l&&l.addEventListener("click",function(){f&&(delete u.groups[f],mt(),pt(),window.chatSocket&&window.chatSocket.emit("join-group",{groupId:parseInt(f),sessionToken:m,userId:p.id,onlyClearUnread:!0}))}),n&&s&&(s.addEventListener("click",function(){c()}),n.addEventListener("paste",function(e){const t=e.clipboardData.items;for(const n of t){if(n.type.startsWith("image/")){e.preventDefault();const t=n.getAsFile();t&&Be(t);break}if("application/octet-stream"===n.type){e.preventDefault();const t=n.getAsFile();t&&Le(t);break}}}),n.addEventListener("keydown",function(e){if("Enter"!==e.key||e.shiftKey||e.ctrlKey)if("Enter"===e.key&&e.ctrlKey&&!e.shiftKey)if(e.preventDefault(),"DIV"===n.tagName&&n.isContentEditable)try{const e=window.getSelection(),t=e.getRangeAt(0),n=document.createElement("br");t.deleteContents(),t.insertNode(n),t.setStartAfter(n),t.setEndAfter(n),e.removeAllRanges(),e.addRange(t)}catch(t){n.innerHTML+="<br>",n.focus()}else{const e=n,t=e.selectionStart,s=e.selectionEnd,o=e.value;e.value=o.substring(0,t)+"\n"+o.substring(s);const i=t+1;e.setSelectionRange(i,i),e.focus()}else"Enter"===e.key&&e.shiftKey&&e.ctrlKey;else e.preventDefault(),c()})),o&&a&&(o.addEventListener("click",function(){a.click()}),a.addEventListener("change",function(){this.files&&this.files[0]&&Be(this.files[0])})),i&&r&&(i.addEventListener("click",function(){r.click()}),r.addEventListener("change",function(){this.files&&this.files[0]&&Le(this.files[0])}))}function Te(e,t){if(!t)return;const n=document.getElementById("groupCardPopup");n&&n.remove();const s=document.createElement("div");s.id="groupCardPopup",s.style.position="fixed",s.style.width="300px",s.style.backgroundColor="white",s.style.border="1px solid #3498db",s.style.borderRadius="8px",s.style.boxShadow="0 4px 12px rgba(0, 0, 0, 0.15)",s.style.zIndex="10000",s.style.padding="15px",s.innerHTML="";const o=document.createElement("div");o.style.display="flex",o.style.justifyContent="space-between",o.style.alignItems="center",o.style.marginBottom="10px";const i=document.createElement("div");if(i.style.display="flex",i.style.alignItems="center",i.style.gap="10px",t.avatar_url){const e=document.createElement("img");e.src=`${c}${t.avatar_url}`,e.alt=t.group_name,e.style.width="40px",e.style.height="40px",e.style.borderRadius="50%",e.style.objectFit="cover",e.style.cursor="pointer",e.addEventListener("click",function(){openImagePreview(e.src)}),i.appendChild(e)}else if(t.avatarUrl){const e=document.createElement("img");e.src=`${c}${t.avatarUrl}`,e.alt=t.group_name,e.style.width="40px",e.style.height="40px",e.style.borderRadius="50%",e.style.objectFit="cover",e.style.cursor="pointer",e.addEventListener("click",function(){openImagePreview(e.src)}),i.appendChild(e)}else{const e=t.group_name?t.group_name.charAt(0).toUpperCase():"G",n=document.createElement("div");n.style.width="40px",n.style.height="40px",n.style.borderRadius="50%",n.style.backgroundColor="#3498db",n.style.color="white",n.style.display="flex",n.style.alignItems="center",n.style.justifyContent="center",n.style.fontSize="18px",n.style.fontWeight="bold",n.textContent=e,i.appendChild(n)}const r=document.createElement("h3");r.style.margin="0",r.style.color="#3498db",r.textContent=ut(t.group_name||"æœªçŸ¥ç¾¤ç»„"),i.appendChild(r);const l=document.createElement("button");l.id="closeGroupCardPopup",l.style.background="none",l.style.border="none",l.style.fontSize="18px",l.style.cursor="pointer",l.style.color="#999",l.textContent="Ã—",o.appendChild(i),o.appendChild(l);const d=document.createElement("div");d.style.marginBottom="15px";const u=document.createElement("p");u.style.margin="8px 0",u.style.color="#666",u.innerHTML=`<strong>ç¾¤ç»„ID:</strong> ${t.group_id||"æœªçŸ¥"}`;const p=document.createElement("p");p.style.margin="8px 0",p.style.color="#666";const m=document.createElement("strong");m.textContent="å…¬å‘Š:",p.appendChild(m),p.appendChild(document.createTextNode(` ${ut(t.group_description)||"æš‚æ— å…¬å‘Š"}`)),d.appendChild(u),d.appendChild(p);const g=document.createElement("div");g.style.display="flex",g.style.gap="10px";const f=document.createElement("button");f.id="joinGroupButton",f.className="save-btn",f.style.flex="1",f.textContent="åŠ å…¥ç¾¤ç»„",g.appendChild(f),s.appendChild(o),s.appendChild(d),s.appendChild(g),document.body.appendChild(s),l.addEventListener("click",function(){s.remove()}),f.addEventListener("click",function(){t.invite_token&&t.group_id?Ae(t.invite_token,t.group_id,t.group_name,s):(console.warn("åŠ å…¥ç¾¤ç»„å¤±è´¥: ç¼ºå°‘å¿…è¦çš„ç¾¤ç»„ä¿¡æ¯"),a.error("åŠ å…¥ç¾¤ç»„å¤±è´¥: ç¼ºå°‘å¿…è¦çš„ç¾¤ç»„ä¿¡æ¯"))}),document.addEventListener("click",function(t){s.contains(t.target)||t.target===e.currentTarget||s.remove()});const y=s.getBoundingClientRect(),h=y.width,v=y.height;let b=e.clientX,w=e.clientY;b+h>window.innerWidth&&(b=window.innerWidth-h-10),w+v>window.innerHeight&&(w=window.innerHeight-v-10),b<0&&(b=10),w<0&&(w=10),s.style.left=`${b}px`,s.style.top=`${w}px`}function Ae(e,t,n,s){fetch(`${c}/join-group-with-token`,{method:"POST",headers:{"Content-Type":"application/json","user-id":p.id,"session-token":m},body:JSON.stringify({token:e})}).then(e=>e.json()).then(e=>{"success"===e.status?(a.success(`æˆåŠŸåŠ å…¥ç¾¤ç»„: ${n}`),s&&s.remove(),dt()):a.error("åŠ å…¥ç¾¤ç»„å¤±è´¥: "+(e.message||"æœªçŸ¥é”™è¯¯"))}).catch(e=>{console.error("åŠ å…¥ç¾¤ç»„å¤±è´¥:",e),a.error("åŠ å…¥ç¾¤ç»„å¤±è´¥ï¼Œç½‘ç»œé”™è¯¯")})}function Ue(){fetch(`${c}/captcha`).then(e=>e.json()).then(e=>{if("success"===e.status){const t=document.getElementById("passwordCaptchaContainer"),n=document.getElementById("passwordCaptchaId");if(t&&n){t.innerHTML=e.captchaSvg;const s=t.querySelector("svg");s&&(s.style.border="1px solid #ddd",s.style.cursor="pointer",s.style.borderRadius="4px",s.addEventListener("click",Ue)),n.value=e.captchaId}}}).catch(e=>{console.error("è·å–éªŒè¯ç å¤±è´¥:",e)})}function Ne(){const e=document.getElementById("settingsContainer");if(e){const t=e.querySelectorAll(".settings-form");t.forEach(e=>{e.addEventListener("submit",function(e){e.preventDefault(),Pe(this)})})}Ue();const t=document.getElementById("selectAvatarButton"),n=document.getElementById("avatarFileInput"),s=document.getElementById("uploadAvatarButton"),o=document.getElementById("avatarPreview");t&&n&&(t.addEventListener("click",function(){n.click()}),n.addEventListener("change",function(e){const t=e.target.files[0];if(t){const e=new FileReader;e.onload=function(e){if(o){o.innerHTML="";const t=document.createElement("img");t.src=e.target.result,t.style.width="100%",t.style.height="100%",t.style.objectFit="cover",t.style.borderRadius="50%",o.appendChild(t)}},e.readAsDataURL(t),s&&(s.disabled=!1)}})),s&&s.addEventListener("click",function(){const e=n.files[0];e&&je(e)})}function je(e){const t=new FormData;t.append("avatar",e),t.append("userId",p.id),fetch(`${c}/upload-avatar`,{method:"POST",headers:{"session-token":m,"user-id":p.id},body:t}).then(e=>e.json()).then(e=>{if("success"===e.status){if(Lt("å¤´åƒä¸Šä¼ æˆåŠŸ"),e.avatarUrl){p.avatarUrl=e.avatarUrl,localStorage.setItem("currentUser",JSON.stringify(p));const t=document.getElementById("currentUserAvatar");t&&(t.src=`${c}${e.avatarUrl}`,t.style.display="block");const n=document.getElementById("currentAvatarImg");n&&(n.src=`${c}${e.avatarUrl}`)}const t=document.getElementById("uploadAvatarButton");t&&(t.disabled=!0)}else Bt(e.message||"å¤´åƒä¸Šä¼ å¤±è´¥")}).catch(e=>{Bt("å¤´åƒä¸Šä¼ å¤±è´¥ï¼Œè¯·é‡è¯•")})}function Pe(e){const t=e.closest(".settings-detail").getAttribute("data-setting"),n=new FormData(e),s={};if(n.forEach((e,t)=>{s[t]=e}),"change-nickname"===t){if(!s.newNickname||""===s.newNickname.trim())return void Bt("æ˜µç§°ä¸èƒ½ä¸ºç©º");window.chatSocket&&(window.chatSocket.emit("update-nickname",{userId:p.id,newNickname:s.newNickname,sessionToken:m}),p.nickname=s.newNickname,localStorage.setItem("currentUser",JSON.stringify(p)),window.chatSocket.emit("broadcast-nickname-change",{userId:p.id,newNickname:s.newNickname,sessionToken:m}),updateAllMessagesNickname(p.id,s.newNickname),Lt("æ˜µç§°ä¿®æ”¹æˆåŠŸ"))}else if("change-signature"===t){const t=document.getElementById("newSignature").value;fetch(`${c}/update-signature`,{method:"POST",headers:{"Content-Type":"application/json","session-token":m,"user-id":p.id},body:JSON.stringify({signature:t})}).then(e=>e.json()).then(n=>{"success"===n.status?(Lt("ä¸ªæ€§ç­¾åä¿®æ”¹æˆåŠŸ"),p&&(p.signature=t,localStorage.setItem("currentUser",JSON.stringify(p))),e.reset()):Bt(n.message||"ä¸ªæ€§ç­¾åä¿®æ”¹å¤±è´¥")}).catch(e=>{console.error("ä¸ªæ€§ç­¾åä¿®æ”¹å¤±è´¥:",e),Bt("ä¸ªæ€§ç­¾åä¿®æ”¹å¤±è´¥")})}else if("change-password"===t){const t=document.getElementById("oldPassword").value,n=document.getElementById("newPassword").value,s=document.getElementById("confirmPassword").value,o=document.getElementById("passwordCaptchaId").value,i=document.getElementById("passwordCaptchaCode").value;if(!t||!n||!s)return void Bt("æ‰€æœ‰å¯†ç å­—æ®µéƒ½ä¸èƒ½ä¸ºç©º");if(n!==s)return void Bt("æ–°å¯†ç å’Œç¡®è®¤å¯†ç ä¸ä¸€è‡´");if(n.length<6)return void Bt("æ–°å¯†ç é•¿åº¦ä¸èƒ½å°‘äº6ä¸ªå­—ç¬¦");if(!o||!i)return void Bt("éªŒè¯ç ä¸èƒ½ä¸ºç©º");window.chatSocket?(window.chatSocket.emit("change-password",{userId:p.id,oldPassword:t,newPassword:n,captchaId:o,captchaCode:i,sessionToken:m}),window.chatSocket.once("password-change-result",t=>{t.success?(Lt("å¯†ç ä¿®æ”¹æˆåŠŸ"),e.reset(),Ue()):(Bt(t.message||"å¯†ç ä¿®æ”¹å¤±è´¥"),Ue())})):Bt("WebSocketè¿æ¥æœªå»ºç«‹ï¼Œæ— æ³•ä¿®æ”¹å¯†ç ")}else{let e="";switch(t){case"shortcut-settings":e="/shortcut-settings";break;case"version-info":e="/version-info";break;case"help-center":e="/help-center";break;default:return}fetch(`${c}${e}`,{method:"POST",headers:{"Content-Type":"application/json","user-id":p.id,"session-token":m},body:JSON.stringify(s)}).then(e=>e.json()).then(e=>{"success"===e.status?Lt("è®¾ç½®ä¿å­˜æˆåŠŸ"):Bt(e.message||"è®¾ç½®ä¿å­˜å¤±è´¥")}).catch(e=>{Bt("è®¾ç½®è¯·æ±‚å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•")})}}function Ge(){const e=document.getElementById("groupInfoButton"),t=document.getElementById("createGroupButton"),n=document.getElementById("leaveGroupButton");qe(t),He(e),Fe(n)}function qe(e){if(!e)return;const t=e.cloneNode(!0);e.parentNode.replaceChild(t,e),t.addEventListener("click",function(){const e=window.ModalManager;if(e&&"function"===typeof e.showModal)e.showModal("createGroupModal");else{const e=document.getElementById("createGroupModal"),t=document.getElementById("newGroupName"),n=document.getElementById("newGroupDescription");t.value="",n.value="",e.style.display="flex",window.ModalManager&&"function"===typeof window.ModalManager.loadAvailableMembers&&window.ModalManager.loadAvailableMembers()}})}function He(e){if(!e)return;const t=e.cloneNode(!0);e.parentNode.replaceChild(t,e),t.addEventListener("click",function(){f?fetch(`${c}/group-info/${f}`,{headers:{"user-id":p.id,"session-token":m}}).then(e=>{if(!e.ok)throw new Error(`HTTPé”™è¯¯! çŠ¶æ€ç : ${e.status}`);return e.json()}).then(e=>{if(!e)throw new Error("è·å–æ•°æ®å¤±è´¥");"success"===e.status?_e(e.group,f):a.error("è·å–ç¾¤ç»„ä¿¡æ¯å¤±è´¥: "+(e.message||"æœªçŸ¥é”™è¯¯"))}).catch(e=>{console.error("è·å–ç¾¤ç»„ä¿¡æ¯é”™è¯¯:",e),e.message&&e.message.includes("HTTPé”™è¯¯")?a.error("è·å–ç¾¤ç»„ä¿¡æ¯å¤±è´¥ï¼ŒæœåŠ¡å™¨è¿”å›é”™è¯¯"):a.error("è·å–ç¾¤ç»„ä¿¡æ¯å¤±è´¥ï¼Œç½‘ç»œé”™è¯¯")}):a.warning("è¯·å…ˆé€‰æ‹©ä¸€ä¸ªç¾¤ç»„")})}function _e(e,t){const n=document.getElementById("groupInfoModal"),s=document.getElementById("modalGroupName"),o=document.getElementById("modalGroupNameValue"),i=document.getElementById("modalGroupIdValue"),a=document.getElementById("modalGroupMemberCount"),r=document.getElementById("modalGroupOwner"),l=document.getElementById("groupManageSection");n&&(n.style.display="flex",n.style.justifyContent="center",n.style.alignItems="center",document.body.style.overflow="hidden");const d=ut(e.name);s.textContent=`${d} - ç¾¤ç»„ä¿¡æ¯`,o.textContent=d,i.textContent=e.id,a.textContent="åŠ è½½ä¸­";const u=e.creator_id||e.ownerId||e.creatorId||e.adminId,m=p.id===String(u),g=document.getElementById("modalGroupNoticeValue");g&&(g.textContent=e.description?ut(e.description):"æš‚æ— ç¾¤ç»„å…¬å‘Š");const f=document.getElementById("modalGroupAvatarValue");f&&f.remove();const y=document.createElement("div");y.id="modalGroupAvatarValue",y.style.marginBottom="15px";const h=document.createElement("div");h.style.display="flex",h.style.alignItems="center",h.style.gap="10px";const v=e.avatar_url||e.avatarUrl||"";let b="";if(v){const e=/\.svg$/i.test(v);if(e){const e=d.charAt(0).toUpperCase();b=`<div class="group-avatar-large" style="width: 80px; height: 80px; border-radius: 50%; background-color: #3498db; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 32px; color: white; cursor: pointer;">${e}</div>`}else{const e=`${c}${v}`;b=`<img src="${e}" alt="${d}" style="width: 80px; height: 80px; border-radius: 50%; object-fit: cover; cursor: pointer;">`}}else{const e=d.charAt(0).toUpperCase();b=`<div class="group-avatar-large" style="width: 80px; height: 80px; border-radius: 50%; background-color: #3498db; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 32px; color: white; cursor: pointer;">${e}</div>`}if(h.innerHTML=b,m){const e=document.createElement("button");e.id="uploadGroupAvatarBtn",e.className="edit-group-avatar-btn",e.style.padding="6px 12px",e.style.backgroundColor="#3498db",e.style.color="white",e.style.border="none",e.style.borderRadius="4px",e.style.cursor="pointer",e.style.fontSize="12px",e.textContent="ä¸Šä¼ ç¾¤å¤´åƒ",e.addEventListener("click",function(e){e.stopPropagation();const n=document.createElement("input");n.type="file",n.accept="image/*",n.style.display="none",document.body.appendChild(n),n.click(),n.addEventListener("change",function(){this.files&&this.files[0]&&ze(t,this.files[0]),document.body.removeChild(n)})}),h.appendChild(e)}y.appendChild(h);const w=n.querySelector(".modal-body");w&&w.firstChild&&w.insertBefore(y,w.firstChild),Oe(m,e.description||"",t),r&&(r.textContent=`ç¾¤ä¸»ID: ${u}`),l&&(l.style.display=m?"block":"none"),De(m,d,t),n.style.display="flex",Ve(t,m);const k=document.getElementById("refreshGroupMembers");k&&(k.onclick=function(){Ve(t,m)});const x=document.getElementById("addMemberToGroup");x&&(x.onclick=function(){Ye(t)})}function ze(e,t){if(!p||!m)return void a.error("è¯·å…ˆç™»å½•");const n=new FormData;n.append("avatar",t),n.append("groupId",e),n.append("userId",p.id),a.info("æ­£åœ¨ä¸Šä¼ ç¾¤å¤´åƒï¼Œè¯·ç¨å€™..."),fetch(`${c}/upload-group-avatar/${e}`,{method:"POST",headers:{"session-token":m,"user-id":p.id},body:n}).then(e=>e.json()).then(t=>{"success"===t.status?(a.success("ç¾¤å¤´åƒä¸Šä¼ æˆåŠŸ"),fetch(`${c}/group-info/${e}`,{headers:{"user-id":p.id,"session-token":m}}).then(e=>e.json()).then(t=>{if("success"===t.status){const n=document.getElementById("groupInfoModal");n&&(n.style.display="none"),setTimeout(()=>{_e(t.group,e),dt()},100)}})):a.error("ä¸Šä¼ ç¾¤å¤´åƒå¤±è´¥: "+(t.message||"æœªçŸ¥é”™è¯¯"))}).catch(e=>{a.error("ä¸Šä¼ ç¾¤å¤´åƒå¤±è´¥ï¼Œç½‘ç»œé”™è¯¯")})}function Oe(e,t,n){const s=document.getElementById("editGroupNoticeBtn");s&&(e?(s.style.display="inline-block",s.onclick=function(){const e=document.getElementById("modalGroupNoticeValue"),o=document.createElement("textarea");o.value=t,o.className="edit-group-notice-textarea",o.style.padding="6px",o.style.border="1px solid #dee2e6",o.style.borderRadius="4px",o.style.fontSize="14px",o.style.flex="1",o.style.minHeight="80px",o.style.resize="vertical";const i=document.createElement("button");i.textContent="ä¿å­˜",i.className="save-group-notice-btn",i.style.marginLeft="5px",i.style.padding="6px 12px",i.style.background="#27ae60",i.style.color="white",i.style.border="none",i.style.borderRadius="4px",i.style.cursor="pointer",i.style.fontSize="12px",i.style.alignSelf="flex-start";const a=document.createElement("button");a.textContent="å–æ¶ˆ",a.className="cancel-group-notice-btn",a.style.marginLeft="5px",a.style.padding="6px 12px",a.style.background="#6c757d",a.style.color="white",a.style.border="none",a.style.borderRadius="4px",a.style.cursor="pointer",a.style.fontSize="12px",a.style.alignSelf="flex-start";const r=e.parentElement;r.innerHTML="",r.appendChild(o),r.appendChild(i),r.appendChild(a),o.focus(),i.onclick=function(){const e=o.value.trim();nt(n,e)},a.onclick=function(){const e=document.createElement("span");e.id="modalGroupNoticeValue",e.style.flex="1",e.style.wordBreak="break-word",e.textContent=t||"æš‚æ— ç¾¤ç»„å…¬å‘Š";const n=document.createElement("button");n.id="editGroupNoticeBtn",n.className="edit-group-notice-btn",n.style.padding="4px 8px",n.style.backgroundColor="#3498db",n.style.color="white",n.style.border="none",n.style.borderRadius="4px",n.style.cursor="pointer",n.style.fontSize="12px",n.textContent="ç¼–è¾‘",r.innerHTML="",r.appendChild(e),r.appendChild(n),n.onclick=s.onclick}}):s.style.display="none")}function De(e,t,n){const s=document.getElementById("editGroupNameBtn");s&&(e?(s.style.display="inline-block",s.onclick=function(){const e=document.getElementById("modalGroupNameValue"),o=document.createElement("input");o.type="text",o.value=t,o.className="edit-group-name-input",o.style.padding="6px",o.style.border="1px solid #dee2e6",o.style.borderRadius="4px",o.style.fontSize="14px";const i=document.createElement("button");i.textContent="ä¿å­˜",i.className="save-group-name-btn",i.style.marginLeft="5px",i.style.padding="6px 12px",i.style.background="#27ae60",i.style.color="white",i.style.border="none",i.style.borderRadius="4px",i.style.cursor="pointer",i.style.fontSize="12px";const a=document.createElement("button");a.textContent="å–æ¶ˆ",a.className="cancel-group-name-btn",a.style.marginLeft="5px",a.style.padding="6px 12px",a.style.background="#6c757d",a.style.color="white",a.style.border="none",a.style.borderRadius="4px",a.style.cursor="pointer",a.style.fontSize="12px";const r=e.parentElement;r.innerHTML="",r.appendChild(o),r.appendChild(i),r.appendChild(a),o.focus(),i.onclick=function(){const e=o.value.trim();e&&e!==t&&tt(n,e)},a.onclick=function(){const e=document.createElement("span");e.id="modalGroupNameValue",e.textContent=t;const n=document.createElement("button");n.id="editGroupNameBtn",n.className="edit-group-name-btn",n.style.padding="4px 8px",n.style.backgroundColor="#3498db",n.style.color="white",n.style.border="none",n.style.borderRadius="4px",n.style.cursor="pointer",n.style.fontSize="12px",n.textContent="ç¼–è¾‘",r.innerHTML="",r.appendChild(e),r.appendChild(n),n.onclick=s.onclick}}):s.style.display="none")}function Fe(e){if(!e)return;const t=e.cloneNode(!0);e.parentNode.replaceChild(t,e),Re(t),t.addEventListener("click",function(){f?fetch(`${c}/group-info/${f}`,{headers:{"user-id":p.id,"session-token":m}}).then(e=>{if(!e.ok)throw new Error(`HTTPé”™è¯¯! çŠ¶æ€ç : ${e.status}`);return e.json()}).then(e=>{if(!e)throw new Error("è·å–æ•°æ®å¤±è´¥");if("success"===e.status){const t=e.group.creator_id||e.group.ownerId||e.group.creatorId||e.group.adminId,n=p.id===String(t);n?We(f):Je(f)}else a.error(e.message||"è·å–ç¾¤ç»„ä¿¡æ¯å¤±è´¥")}).catch(e=>{console.error("è·å–ç¾¤ç»„ä¿¡æ¯é”™è¯¯:",e),e.message&&e.message.includes("HTTPé”™è¯¯")?a.error("è·å–ç¾¤ç»„ä¿¡æ¯å¤±è´¥ï¼ŒæœåŠ¡å™¨è¿”å›é”™è¯¯"):a.error("è·å–ç¾¤ç»„ä¿¡æ¯å¤±è´¥ï¼Œç½‘ç»œé”™è¯¯")}):a.warning("è¯·å…ˆé€‰æ‹©ä¸€ä¸ªç¾¤ç»„")})}function Re(e){e&&f&&fetch(`${c}/group-info/${f}`,{headers:{"user-id":p.id,"session-token":m}}).then(e=>e.json()).then(t=>{if("success"===t.status){const n=t.group.creator_id||t.group.ownerId||t.group.creatorId||t.group.adminId,s=p.id===String(n);e.textContent=s?"è§£æ•£ç¾¤ç»„":"é€€å‡ºç¾¤ç»„"}}).catch(e=>{console.error("è·å–ç¾¤ç»„ä¿¡æ¯å¤±è´¥:",e)})}function We(e){confirm("ç¡®å®šè¦è§£æ•£è¯¥ç¾¤ç»„å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼Œæ‰€æœ‰ç¾¤æ¶ˆæ¯å°†è¢«åˆ é™¤ã€‚")&&it(e)}function Je(e){confirm("ç¡®å®šè¦é€€å‡ºè¯¥ç¾¤ç»„å—ï¼Ÿ")&&fetch(`${c}/leave-group`,{method:"POST",headers:{"Content-Type":"application/json","user-id":p.id,"session-token":m},body:JSON.stringify({groupId:e})}).then(e=>e.json()).then(e=>{if("success"===e.status){a.success("å·²æˆåŠŸé€€å‡ºç¾¤ç»„"),dt(),f=null,y="";const e=document.getElementById("groupEmptyState"),t=document.getElementById("groupChatInterface"),n=document.getElementById("currentGroupName");e&&(e.style.display="flex"),t&&(t.style.display="none"),n&&(n.textContent="ç¾¤ç»„åç§°")}else a.error("é€€å‡ºç¾¤ç»„å¤±è´¥: "+(e.message||"æœªçŸ¥é”™è¯¯"))}).catch(e=>{a.error("é€€å‡ºç¾¤ç»„å¤±è´¥ï¼Œç½‘ç»œé”™è¯¯")})}function Ve(e,t){const n=document.getElementById("groupMembersContainer"),s=document.getElementById("modalGroupMemberCount");n&&(n.innerHTML='<div class="loading-members">æ­£åœ¨åŠ è½½æˆå‘˜åˆ—è¡¨...</div>',fetch(`${c}/group-members/${e}`,{headers:{"user-id":p.id,"session-token":m}}).then(e=>e.json()).then(o=>{if("success"===o.status)Ke(o.members,t,e),s.textContent=o.members.length;else{const e=o.message||"æœªçŸ¥é”™è¯¯";n.innerHTML=`<div class="loading-members">åŠ è½½æˆå‘˜åˆ—è¡¨å¤±è´¥: ${e}</div>`}}).catch(e=>{n.innerHTML='<div class="loading-members">åŠ è½½æˆå‘˜åˆ—è¡¨å¤±è´¥ï¼Œç½‘ç»œé”™è¯¯</div>'}))}function Ke(e,t,n){const s=document.getElementById("groupMembersContainer");if(!s)return;if(!e||!Array.isArray(e)||0===e.length)return void(s.innerHTML='<div class="loading-members">æ²¡æœ‰å¯ç”¨çš„æˆå‘˜</div>');let o="";if(e.forEach((e,s)=>{const i=String(e.id)===String(p.id);o+=`\n            <div class="group-member-item">\n                <div class="group-member-info">\n                    <span class="group-member-name">${e.nickname}</span>\n                    <span class="group-member-id">ID: ${e.id}</span>\n                    ${i?'<span class="group-member-role">ï¼ˆæˆ‘ï¼‰</span>':""}\n                </div>\n                ${t&&!i?`\n                    <button class="kick-member-btn" data-group-id="${n}" data-member-id="${e.id}" data-member-name="${e.nickname}">\n                        è¸¢å‡º\n                    </button>\n                `:""}\n            </div>\n        `}),s.innerHTML=o,t){const e=s.querySelectorAll(".kick-member-btn");e.forEach(e=>{e.addEventListener("click",function(){const e=this.getAttribute("data-group-id"),t=this.getAttribute("data-member-id"),n=this.getAttribute("data-member-name");Xe(e,t,n)})})}}function Xe(e,t,n){confirm(`ç¡®å®šè¦è¸¢å‡ºæˆå‘˜ ${n} å—ï¼Ÿ`)&&(p&&m?fetch(`${c}/remove-group-member`,{method:"POST",headers:{"Content-Type":"application/json","user-id":p.id,"session-token":m},body:JSON.stringify({groupId:e,memberId:t})}).then(e=>e.json()).then(t=>{"success"===t.status||t.message&&t.message.includes("æˆåŠŸ")?(a.success(`å·²æˆåŠŸè¸¢å‡ºæˆå‘˜ ${n}`),Ve(e,!0)):a.error("è¸¢å‡ºæˆå‘˜å¤±è´¥: "+(t.message||"æœªçŸ¥é”™è¯¯"))}).catch(e=>{console.error("è¸¢å‡ºæˆå‘˜å¤±è´¥:",e),a.error("è¸¢å‡ºæˆå‘˜å¤±è´¥ï¼Œç½‘ç»œé”™è¯¯")}):a.error("è¯·å…ˆç™»å½•"))}function Ye(e){if(!e||!p||!m)return;window.currentAddingGroupId=e;const t=document.getElementById("addGroupMemberModal");t&&(t.style.display="flex",t.style.justifyContent="center",t.style.alignItems="center",document.body.style.overflow="hidden"),Qe(e)}function Ze(){const e=document.getElementById("addGroupMemberModal");e&&(e.style.display="none",document.body.style.overflow="");const t=document.getElementById("addMembersMessage");t&&(t.textContent="");const n=document.getElementById("availableMembersList");if(n){const e=n.querySelectorAll(".available-member-checkbox");e.forEach(e=>{e.checked=!1})}delete window.currentAddingGroupId}function Qe(e){if(!e||!p||!m)return;const t=document.getElementById("availableMembersList");t&&(t.innerHTML='<div class="loading-members">æ­£åœ¨åŠ è½½å¥½å‹åˆ—è¡¨...</div>',fetch(`${c}/user/friends`,{method:"GET",headers:{"user-id":p.id,"session-token":m}}).then(e=>e.json()).then(t=>"success"===t.status&&t.friends&&Array.isArray(t.friends)?fetch(`${c}/group-members/${e}`,{method:"GET",headers:{"user-id":p.id,"session-token":m}}).then(e=>e.json()).then(e=>{let n=[];"success"===e.status&&e.members&&Array.isArray(e.members)&&(n=e.members);const s=new Set(n.map(e=>String(e.id))),o=t.friends.filter(e=>{const t=String(e.id),n=t!==String(p.id),o=!s.has(t);return n&&o});return o}):[]).then(e=>{0!==e.length?t.innerHTML=e.map(e=>`\n            <div class="member-item">\n                <input type="checkbox" class="available-member-checkbox" id="available-member-${e.id}" value="${e.id}">\n                <label for="available-member-${e.id}" class="member-nickname">${e.nickname||e.username||"æœªçŸ¥ç”¨æˆ·"}</label>\n            </div>\n        `).join(""):t.innerHTML='<div class="loading-members">æ²¡æœ‰å¯æ·»åŠ çš„å¥½å‹</div>'}).catch(e=>{t.innerHTML='<div class="loading-members">åŠ è½½å¥½å‹åˆ—è¡¨å¤±è´¥</div>'}))}function et(){const e=window.currentAddingGroupId;if(!e||!p||!m)return;const t=document.getElementById("availableMembersList"),n=document.getElementById("addMembersMessage");if(!t||!n)return void console.error("âŒ [æ·»åŠ æˆå‘˜] æ‰¾ä¸åˆ°å¿…è¦çš„DOMå…ƒç´ ");const s=t.querySelectorAll(".available-member-checkbox:checked"),o=Array.from(s).map(e=>e.value);if(0===o.length)return n.textContent="è¯·é€‰æ‹©è‡³å°‘1åæˆå‘˜",void(n.className="create-group-message error");n.textContent="",n.className="create-group-message",fetch(`${c}/add-group-members`,{method:"POST",headers:{"Content-Type":"application/json","user-id":p.id,"session-token":m},body:JSON.stringify({groupId:e,memberIds:o})}).then(e=>e.json()).then(t=>{"success"===t.status||t.message&&t.message.includes("æˆåŠŸ")?(n.textContent="æˆå‘˜æ·»åŠ æˆåŠŸ",n.className="create-group-message success",setTimeout(()=>{Ze(),Ve(e,!0)},1e3)):(n.textContent=t.message||"æ·»åŠ æˆå‘˜å¤±è´¥",n.className="create-group-message error")}).catch(t=>{console.error(`âŒ [æ·»åŠ æˆå‘˜] æ·»åŠ æˆå‘˜åˆ°ç¾¤ç»„ ${e} å¤±è´¥:`,t),n.textContent="æ·»åŠ æˆå‘˜å¤±è´¥ï¼Œç½‘ç»œé”™è¯¯",n.className="create-group-message error"})}function tt(e,t){p&&m?fetch(`${c}/update-group-name`,{method:"POST",headers:{"Content-Type":"application/json","user-id":p.id,"session-token":m},body:JSON.stringify({groupId:e,newGroupName:t})}).then(e=>e.json()).then(t=>{if("success"===t.status){const n=ut(t.newGroupName);y=n;const s=document.getElementById("currentGroupName");s&&(s.textContent=n),ot(e,n);const o=document.querySelector(".group-info-item:nth-of-type(1) > div");o&&(o.innerHTML=`\n                    <span id="modalGroupNameValue">${n}</span>\n                    <button id="editGroupNameBtn" class="edit-group-name-btn" style="padding: 4px 8px; background-color: #3498db; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">\n                        ç¼–è¾‘\n                    </button>\n                `,De(!0,n,e));const i=document.getElementById("modalGroupName");i&&(i.textContent=`${n} - ç¾¤ç»„ä¿¡æ¯`),a.success("ç¾¤ç»„åç§°å·²æˆåŠŸæ›´æ–°");const r=document.getElementById("manageGroupModal");r&&"none"!==r.style.display&&(r.style.display="none")}else a.error("ä¿®æ”¹ç¾¤ç»„åç§°å¤±è´¥: "+(t.message||"æœªçŸ¥é”™è¯¯"))}).catch(e=>{a.error("ä¿®æ”¹ç¾¤ç»„åç§°å¤±è´¥ï¼Œç½‘ç»œé”™è¯¯")}):a.error("è¯·å…ˆç™»å½•")}function nt(e,t){p&&m?fetch(`${c}/update-group-description`,{method:"POST",headers:{"Content-Type":"application/json","user-id":p.id,"session-token":m},body:JSON.stringify({groupId:e,newDescription:t})}).then(e=>{if(!e.ok)throw new Error(`HTTPé”™è¯¯! çŠ¶æ€ç : ${e.status}`);return e.json()}).then(n=>{if("success"===n.status){st(e,t);const n=document.querySelector(".group-info-item:nth-of-type(3) > div");n&&(n.innerHTML=`\n                    <span id="modalGroupNoticeValue" style="flex: 1; word-break: break-word;">${t||"æš‚æ— ç¾¤ç»„å…¬å‘Š"}</span>\n                    <button id="editGroupNoticeBtn" class="edit-group-notice-btn" style="padding: 4px 8px; background-color: #3498db; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">\n                        ç¼–è¾‘\n                    </button>\n                `,Oe(!0,t,e)),a.success("ç¾¤ç»„å…¬å‘Šå·²æˆåŠŸæ›´æ–°")}else a.error("ä¿®æ”¹ç¾¤ç»„å…¬å‘Šå¤±è´¥: "+(n.message||"æœªçŸ¥é”™è¯¯"))}).catch(e=>{console.error("ä¿®æ”¹ç¾¤ç»„å…¬å‘Šå¤±è´¥:",e),a.error("ä¿®æ”¹ç¾¤ç»„å…¬å‘Šå¤±è´¥ï¼Œç½‘ç»œé”™è¯¯: "+e.message)}):a.error("è¯·å…ˆç™»å½•")}function st(e,t){}function ot(e,t){const n=document.getElementById("groupList");if(!n)return;const s=n.querySelectorAll(`li[data-group-id="${e}"]`);s.forEach(e=>{const n=e.querySelector(".group-name");n&&(n.textContent=t)})}function it(e){p&&m?confirm("ç¡®å®šè¦è§£æ•£æœ¬ç¾¤ç»„å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼Œæ‰€æœ‰ç¾¤æ¶ˆæ¯å°†è¢«åˆ é™¤ã€‚")&&fetch(`${c}/dissolve-group`,{method:"POST",headers:{"Content-Type":"application/json","user-id":p.id,"session-token":m},body:JSON.stringify({userId:p.id,groupId:e})}).then(e=>e.json()).then(e=>{"success"===e.status?(a.success("ç¾¤ç»„å·²æˆåŠŸè§£æ•£ï¼Œæ‰€æœ‰ç¾¤æ¶ˆæ¯å·²åˆ é™¤"),at(),dt()):a.error("è§£æ•£ç¾¤ç»„å¤±è´¥: "+(e.message||"æœªçŸ¥é”™è¯¯"))}).catch(e=>{a.error("è§£æ•£ç¾¤ç»„å¤±è´¥ï¼Œç½‘ç»œé”™è¯¯")}):a.error("è¯·å…ˆç™»å½•")}function at(){const e=document.querySelector('.chat-content[data-content="public-chat"]'),t=document.getElementById("groupChatInterface"),n=document.getElementById("groupEmptyState"),s=document.getElementById("currentGroupName");e&&e.classList.add("active"),t&&(t.style.display="none"),n&&(n.style.display="flex"),s&&(s.textContent="ç¾¤ç»„åç§°"),f=null,y="",yt("main",null,!0)}function rt(){Ge();const e=document.getElementById("groupChatInterface");if(e){const t=new MutationObserver(t=>{t.forEach(t=>{"style"===t.attributeName&&"none"!==e.style.display&&Ge()})});t.observe(e,{attributes:!0})}const t=document.getElementById("groupList");t&&t.addEventListener("click",()=>{setTimeout(()=>{Ge()},50)})}function lt(){g&&window.chatSocket&&window.chatSocket.emit("get-online-users")}function ct(e){const t=document.getElementById("userList");if(!t)return void console.error("User list element not found");if(Array.isArray(e)||(console.error("Invalid users data:",e),e=[]),w=e,onlineCount&&(onlineCount.textContent=`(${e.length})`),D(k),t.innerHTML="",0===e.length)return void(t.innerHTML="<li>æš‚æ— åœ¨çº¿ç”¨æˆ·</li>");e.forEach(e=>{if(!e||!e.id)return void console.error("Invalid user object:",e);const n=document.createElement("li");let s="";e.avatarUrl&&"string"===typeof e.avatarUrl?s=e.avatarUrl.trim():e.avatar_url&&"string"===typeof e.avatar_url?s=e.avatar_url.trim():e.avatar&&"string"===typeof e.avatar&&(s=e.avatar.trim());let o="";if(s){const t=/\.svg$/i.test(s);if(t){const t=e.nickname?e.nickname.charAt(0).toUpperCase():"U";o=`<span class="user-avatar">${t}</span>`}else{const t=`${c}${s}`;o=`<span class="user-avatar"><img src="${t}" alt="${e.nickname}"></span>`}}else{const t=e.nickname?e.nickname.charAt(0).toUpperCase():"U";o=`<span class="user-avatar">${t}</span>`}const i=p&&String(p.id)===String(e.id),a=i?`${e.nickname} (æˆ‘)`:e.nickname;n.setAttribute("data-user-id",e.id),n.innerHTML=`\n            ${o}\n            <span class="user-name">${a}</span>\n            <span class="user-status online"></span>\n        `,n.style.padding="8px 0",n.style.borderBottom="1px solid #f1f1f1",n.style.display="flex",n.style.alignItems="center",n.className="user-item",i&&(n.style.fontWeight="bold"),t.appendChild(n)}),ve();const n=document.querySelectorAll(".friend-item");n.forEach(e=>{const t=e.dataset.userId,n=w.some(e=>String(e.id)===String(t)),s=e.querySelector(".friend-status");s&&(s.className="friend-status "+(n?"online":"offline"))}),ie()}function dt(){p&&m&&fetch(`${c}/user-groups/${p.id}`,{headers:{"user-id":p.id,"session-token":m}}).then(e=>e.json()).then(e=>{if("success"===e.status)Ct(e.groups);else{const t=document.getElementById("groupList");t&&(t.innerHTML="<li>åŠ è½½å¤±è´¥: "+e.message+"</li>")}}).catch(e=>{const t=document.getElementById("groupList");t&&(t.innerHTML="<li>åŠ è½½å¤±è´¥: ç½‘ç»œé”™è¯¯</li>")})}function ut(e){const t=document.createElement("textarea");return t.innerHTML=e,t.value}function pt(){let e=u.global;for(const t in u.groups){const n=u.groups[t]||0;e+=n}for(const t in u.private){const n=u.private[t]||0;e+=n}document.title=e>0?`ï¼ˆ${e}æ¡æœªè¯»ï¼‰${S}`:S,mt()}function mt(){const e=document.getElementById("publicChatUnreadCount");e&&(u.global>0?e.textContent=u.global:e.textContent="");const t=document.getElementById("groupChatUnreadCount");if(t){let e=0;Object.keys(u.groups).forEach(t=>{const n=u.groups[t]||0;e+=n}),t.textContent=e>0?e:""}const n=document.getElementById("privateChatUnreadCount");if(n){let e=0;Object.keys(u.private).forEach(t=>{const n=u.private[t]||0;e+=n}),n.textContent=e>0?e:""}const s=document.querySelectorAll("#groupList li[data-group-id]");s.forEach(e=>{const t=e.getAttribute("data-group-id"),n=u.groups[t]||0,s=e.querySelector(".group-unread-count");s&&(s.textContent=n>0?n:"")});const o=document.querySelectorAll("#friendsList li.friend-item");o.forEach(e=>{const t=e.getAttribute("data-user-id"),n=u.private[t]||0,s=e.querySelector(".private-unread-count");s&&(s.textContent=n>0?n:"")})}function gt(){if(C=!document.hidden,C)if("main"===$)u.global>0&&(u.global=0,pt());else if($.startsWith("private_")){const e=$.replace("private_","");u.private[e]>0&&(u.private[e]=0,pt())}else u.groups[$]>0&&(u.groups[$]=0,pt())}function ft(){if(C=document.hasFocus(),C)if("main"===$)u.global>0&&(u.global=0,pt());else if($.startsWith("private_")){const e=$.replace("private_","");u.private[e]>0&&(u.private[e]=0,pt())}else u.groups[$]>0&&(u.groups[$]=0,pt())}function yt(e,t=null,n=!1){"main"===e?($="main",n&&u.global>0&&(u.global=0,pt())):"group"===e&&t?($=t,n&&u.groups[t]>0&&(u.groups[t]=0,pt())):"private"===e&&t&&($=`private_${t}`,n&&u.private[t]>0&&(u.private[t]=0,pt()))}function ht(e,t=!1,n=null){if(!e)return;if(e.senderId===p.id||e.userId===p.id)return;let s=!C;C&&(s=t&&n?$!==n:"main"!==$),s&&(t&&n?bt(n)||(u.groups[n]=(u.groups[n]||0)+1):u.global++,pt())}function vt(){const e=localStorage.getItem("mutedGroups");return e?JSON.parse(e):[]}function bt(e){const t=vt();return t.includes(e.toString())}function wt(e){const t=vt(),n=e.toString();let s;return t.includes(n)?(s=t.filter(e=>e!==n),console.log(`ğŸ”” å–æ¶ˆç¾¤ç»„å…æ‰“æ‰° - ç¾¤ç»„ID: ${e}`)):(s=[...t,n],console.log(`ğŸ”• è®¾ç½®ç¾¤ç»„å…æ‰“æ‰° - ç¾¤ç»„ID: ${e}`)),localStorage.setItem("mutedGroups",JSON.stringify(s)),kt(),mt(),!t.includes(n)}function kt(){const e=document.getElementById("groupList");if(!e)return;const t=e.querySelectorAll("li");t.forEach(e=>{const t=e.getAttribute("data-group-id");xt(e,t)})}function xt(e,t){let n=e.querySelector(".mute-icon");n&&n.remove(),bt(t)&&(n=document.createElement("span"),n.className="mute-icon",n.textContent="ğŸ”•",n.style.marginLeft="5px",n.style.fontSize="12px",n.title="å·²å…æ‰“æ‰°",e.appendChild(n))}function It(e,t,n){Et();const s=document.createElement("div");s.className="context-menu",s.style.position="fixed",s.style.left=e.clientX+"px",s.style.top=e.clientY+"px",s.style.backgroundColor="white",s.style.border="1px solid #ddd",s.style.borderRadius="4px",s.style.boxShadow="0 2px 10px rgba(0,0,0,0.1)",s.style.zIndex="1000",s.style.padding="5px 0";const o=bt(t),i=document.createElement("div");i.className="context-menu-item",i.textContent=o?"å–æ¶ˆå…æ‰“æ‰°":"å…æ‰“æ‰°",i.style.padding="8px 15px",i.style.cursor="pointer",i.style.fontSize="14px",i.style.whiteSpace="nowrap",i.addEventListener("click",()=>{wt(t),Et()}),s.appendChild(i),document.body.appendChild(s),window.currentContextMenu=s,setTimeout(()=>{document.addEventListener("click",Et)},0)}function Et(){window.currentContextMenu&&(document.body.removeChild(window.currentContextMenu),window.currentContextMenu=null),document.removeEventListener("click",Et)}function St(e){const t=document.getElementById("groupList");if(!t)return;const n=t.querySelectorAll("li[data-group-id]");for(const s of n)if(String(s.getAttribute("data-group-id"))===String(e)){t.insertBefore(s,t.firstChild);const n=U.findIndex(t=>String(t.id)===String(e));if(n>0){const e=U.splice(n,1)[0];U.unshift(e)}break}}function Ct(e){const t=document.getElementById("groupList");if(t&&(t.innerHTML="",e.forEach(e=>{const n=ut(e.name),s=document.createElement("li");s.setAttribute("data-group-id",e.id),s.setAttribute("data-group-name",n);let o="";const i=e.avatar_url||e.avatarUrl||"";if(i){const e=/\.svg$/i.test(i);if(e){const e=n.charAt(0).toUpperCase();o=`<span class="group-avatar">${e}</span>`}else{const e=`${c}${i}`;o=`<span class="group-avatar"><img src="${e}" alt="${n}"></span>`}}else{const e=n.charAt(0).toUpperCase();o=`<span class="group-avatar">${e}</span>`}const a=document.createElement("span");a.className="group-name",a.textContent=n,s.innerHTML=`\n            ${o}\n            ${a.outerHTML}\n            <div class="unread-count group-unread-count"></div>\n        `,s.addEventListener("click",function(){const e=this.getAttribute("data-group-id"),t=n;f=e,y=t,$=`group_${e}`,L="group",M=e,d.currentGroupId=f,d.currentGroupName=y,d.currentActiveChat=$,d.currentSendChatType=L,d.selectedGroupIdForCard=M,yt("group",e,!0);const s=document.getElementById("groupEmptyState"),o=document.getElementById("groupChatInterface"),i=document.getElementById("currentGroupName");s&&(s.style.display="none"),o&&(o.style.display="flex",o.style.flexDirection="column"),i&&(i.textContent=y),$t(e,!0)}),s.addEventListener("contextmenu",function(e){e.preventDefault();const t=this.getAttribute("data-group-id"),n=this.getAttribute("data-group-name");It(e,t,n)}),xt(s,e.id),t.appendChild(s)}),mt(),f)){const e=document.getElementById("groupEmptyState"),t=document.getElementById("groupChatInterface"),n=document.getElementById("currentGroupName");e&&(e.style.display="none"),t&&(t.style.display="flex",t.style.flexDirection="column"),n&&(n.textContent=y)}}function $t(e,t=!1){const n=document.getElementById("groupMessageContainer");n&&(n.style.flex="1",n.style.overflowY="auto",n.style.padding="10px",t&&(n.innerHTML=""));const s=Date.now();if(g&&window.chatSocket){const t={groupId:parseInt(e),sessionToken:m,userId:p.id,loadTime:s};window.chatSocket.emit("join-group",t)}else fetch(`${c}/group-chat-history/${e}`,{headers:{"user-id":p.id,"session-token":m}}).then(e=>e.json()).then(e=>{"success"===e.status&&e.messages&&n&&e.messages.forEach(e=>{function t(e){const t=e.content||e.text||"empty",n=e.userId||e.senderId||"unknown",s=e.timestamp||e.createdAt||"unknown",o=`${n}-${s}-${JSON.stringify(t)}`;let i=0;for(let a=0;a<o.length;a++){const e=o.charCodeAt(a);i=(i<<5)-i+e,i&=i}return Math.abs(i).toString(16)}e.isHistory=!0;const n=t(e);document.querySelector(`#groupMessageContainer [data-identifier="${n}"]`)||(e.identifier=n,ke(e))})}).catch(e=>{});const o=String(e);function i(){const e=document.getElementById("groupMessageContainer");if(e){const t=e.scrollHeight;e.scrollTop=t,setTimeout(()=>{e.scrollHeight>t&&(e.scrollTop=e.scrollHeight,setTimeout(()=>{e.scrollTop=e.scrollHeight},200))},300)}}B[o]&&B[o].length>0&&setTimeout(()=>{const e=document.getElementById("groupMessageContainer");e&&(B[o].forEach(e=>{function t(e){const t=e.content||e.text||"empty",n=e.userId||e.senderId||"unknown",s=e.timestamp||e.createdAt||"unknown",o=`${n}-${s}-${JSON.stringify(t)}`;let i=0;for(let a=0;a<o.length;a++){const e=o.charCodeAt(a);i=(i<<5)-i+e,i&=i}return Math.abs(i).toString(16)}const n=t(e);document.querySelector(`#groupMessageContainer [data-identifier="${n}"]`)||(e.identifier=n,ke(e))}),B[o]=[])},100),setTimeout(i,800)}function Bt(e){a.error(e)}function Lt(e){a.success(e)}function Mt(){const e=document.querySelectorAll(".menu-item"),t=document.querySelectorAll(".secondary-content"),n=document.querySelectorAll(".chat-content"),s=document.getElementById("switchToOldUI");s&&s.addEventListener("click",()=>{window.location.href="/oldUI/"}),e.forEach(s=>{s.addEventListener("click",()=>{const o=s.getAttribute("data-section");if("logout"===o)return void(confirm("ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ")&&pe());e.forEach(e=>{e.classList.remove("active")}),t.forEach(e=>{e.classList.remove("active")}),n.forEach(e=>{e.classList.remove("active"),e.style.display="none"}),s.classList.add("active");const i=document.querySelector(`.secondary-content[data-content="${o}"]`);i&&i.classList.add("active");const a=document.querySelector(`.chat-content[data-content="${o}"]`);a&&(a.classList.add("active"),a.style.display="flex",$e());const r=document.getElementById("markdownToolbar"),l=document.getElementById("toggleMarkdownToolbar"),d=document.getElementById("toggleGroupMarkdownToolbar");if(r&&("public-chat"===o||(r.style.display="none")),l&&("public-chat"===o?(l.style.display="inline-block",r&&("none"===r.style.display?l.innerHTML='<i class="fas fa-chevron-down"></i> MD':l.innerHTML='<i class="fas fa-chevron-up"></i> éšè—Markdownå·¥å…·æ ')):l.style.display="none"),d&&(d.style.display="group-chat"===o?"inline-block":"none"),"public-chat"===o)yt("main",null,!0),Nt();else if("group-chat"===o){dt(),f&&yt("group",f,!0);const e=window.loadGroupList;window.loadGroupList=function(){fetch(`${c}/user-groups/${p.id}`,{headers:{"user-id":p.id,"session-token":m}}).then(e=>e.json()).then(e=>{if("success"===e.status&&(Ct(e.groups),f)){yt("group",f,!0);const e=document.getElementById("groupEmptyState"),t=document.getElementById("groupChatInterface"),n=document.getElementById("currentGroupName");e&&(e.style.display="none"),t&&(t.style.display="flex",t.style.flexDirection="column"),n&&(n.textContent=y),$t(f,!1)}}).catch(e=>{const t=document.getElementById("groupList");t&&(t.innerHTML="<li>åŠ è½½å¤±è´¥: ç½‘ç»œé”™è¯¯</li>")})},dt(),setTimeout(()=>{window.loadGroupList=e},1e3)}})})}function Tt(){const e=document.querySelectorAll(".settings-item"),t=document.querySelectorAll(".settings-detail"),n=document.getElementById("settingsEmptyState"),s=document.getElementById("settingsContainer");e.forEach(e=>{e.addEventListener("click",()=>{const o=e.getAttribute("data-setting-id");n.style.display="none",s.style.display="block",t.forEach(e=>{e.style.display="none"});const i=document.querySelector(`.settings-detail[data-setting="${o}"]`);i&&(i.style.display="block")})})}function At(){const e=document.querySelectorAll("#groupList li[data-group-id]"),t=document.getElementById("groupEmptyState"),n=document.getElementById("groupChatInterface"),s=document.getElementById("currentGroupName");e.forEach(e=>{const o=e.getAttribute("data-group-id"),i=e.querySelector(".group-name");e.addEventListener("click",()=>{t&&(t.style.display="none"),n&&(n.style.display="flex");const e=i?i.textContent:"ç¾¤ç»„åç§°";s&&(s.textContent=e),f=o,y=e,yt("group",o,!0)})})}function Ut(){const e=document.querySelectorAll(".cancel-btn"),t=document.getElementById("settingsEmptyState"),n=document.getElementById("settingsContainer");e.forEach(e=>{e.addEventListener("click",()=>{t.style.display="flex",n.style.display="none"})})}function Nt(){Mt(),H(),At(),Ut(),jt(),rt()}function jt(){const e=document.getElementById("messageContainer"),t=document.getElementById("groupMessageContainer"),n=document.getElementById("privateMessageContainer");function s(e,t,n,s=!1){if(t.scrollTop<50&&!window.isLoadingMoreMessages){window.isLoadingMoreMessages=!0;t.scrollHeight,t.scrollTop;const e=t.querySelectorAll(".message");let o=null;if(e.length>0){let t=null;for(let n=0;n<e.length;n++){const s=e[n],o=s.getAttribute("data-sequence");if(null!==o){const e=parseInt(o);isNaN(e)||(null===t||e<t)&&(t=e)}}o=t}if(p&&m){if(n&&f){const e={groupId:f,sessionToken:m,userId:p.id,limit:20,loadMore:!0,olderThan:o};window.chatSocket.emit("get-group-chat-history",e)}else if(s&&h){const e={userId:p.id,friendId:h,sessionToken:m,limit:20,loadMore:!0,olderThan:o};window.chatSocket.emit("get-private-chat-history",e)}else window.chatSocket.emit("get-chat-history",{userId:p.id,sessionToken:m,limit:20,loadMore:!0,olderThan:o});window.loadingIndicatorTimeout=setTimeout(()=>{if(window.isLoadingMoreMessages){const e=document.createElement("div");e.className="loading-indicator",e.textContent="åŠ è½½ä¸­...",e.style.textAlign="center",e.style.padding="10px",e.style.color="#666",e.style.fontSize="14px",t.insertBefore(e,t.firstChild)}},500)}else window.isLoadingMoreMessages=!1}}window.isLoadingMoreMessages=!1,window.loadingIndicatorTimeout=null,e&&e.addEventListener("scroll",function(e){s(e,this,!1)}),t&&t.addEventListener("scroll",function(e){s(e,this,!0)}),n&&n.addEventListener("scroll",function(e){s(e,this,!1,!0)}),window.resetLoadingState=function(){window.isLoadingMoreMessages=!1,window.loadingIndicatorTimeout&&(clearTimeout(window.loadingIndicatorTimeout),window.loadingIndicatorTimeout=null);const e=document.querySelectorAll(".loading-indicator");e.forEach(e=>e.remove())}}function Pt(){const e=document.getElementById("avatarPreviewModal");e&&(e.style.display="none",document.body.style.overflow="")}function Gt(e){const t=document.getElementById("avatarPreviewModal");e.target===t&&Pt()}window.withdrawPrivateMessage=function(e){p&&m&&window.chatSocket&&window.chatSocket.emit("withdraw-private-message",{userId:p.id,messageId:e,sessionToken:m})},T=null;const qt=document.getElementById("closeAvatarPreviewModal");qt&&qt.addEventListener("click",Pt);const Ht=document.getElementById("avatarPreviewModal");function _t(){const e=document.querySelectorAll(".message-image");e.forEach(e=>{e.hasAttribute("data-click-added")||(e.addEventListener("click",function(){const e=this.getAttribute("src");e&&openImagePreview(e)}),e.setAttribute("data-click-added","true"))})}function zt(){const e=document.querySelectorAll(".user-avatar");e.forEach(e=>{e.hasAttribute("data-click-added")||(e.addEventListener("click",function(e){let t;if(e.preventDefault(),e.stopPropagation(),this.closest("[data-user-id]")?t=this.closest("[data-user-id]").getAttribute("data-user-id"):this.closest(".user-item")?t=this.closest(".user-item").getAttribute("data-user-id"):this.closest(".message-item")?t=this.closest(".message-item").getAttribute("data-user-id"):this.closest(".search-result-item")&&(t=this.closest(".search-result-item").querySelector(".add-friend-btn")?.getAttribute("data-user-id")),t){let n="";const s=this.closest("[data-user-id]");if(s)if(s.hasAttribute("data-user-nickname"))n=s.getAttribute("data-user-nickname");else{const e=s.querySelector(".friend-name, .user-name, .message-nickname");e&&(n=e.textContent)}else if(this.closest(".user-item")){const e=this.closest(".user-item"),t=e.querySelector(".user-name");t&&(n=t.textContent)}else if(this.closest(".message-item")){const e=this.closest(".message-item"),t=e.querySelector(".message-nickname");t&&(n=t.textContent)}se(e,{id:t,nickname:n})}}),e.setAttribute("data-click-added","true"))});const t=document.querySelectorAll(".user-avatar-img");t.forEach(e=>{e.hasAttribute("data-click-added")||(e.addEventListener("click",function(e){let t;if(e.preventDefault(),e.stopPropagation(),this.closest("[data-user-id]"))t=this.closest("[data-user-id]").getAttribute("data-user-id");else if("currentUserAvatar"===this.id)return;if(t){let n="";const s=this.closest("[data-user-id]");if(s)if(s.hasAttribute("data-user-nickname"))n=s.getAttribute("data-user-nickname");else{const e=s.querySelector(".friend-name, .user-name, .message-nickname");e&&(n=e.textContent)}se(e,{id:t,nickname:n})}}),e.setAttribute("data-click-added","true"))})}function Ot(){const e=document.getElementById("messageContainer"),t=document.getElementById("groupMessageContainer"),n=document.getElementById("privateMessageContainer");function s(e){let t,n="";const s=e.target.closest(".message-item");if(s){t=s.getAttribute("data-user-id");const e=s.querySelector(".message-nickname");e&&(n=e.textContent)}else{const s=e.target.closest(".friend-item");if(s){const e=s.querySelector(".friend-name");if(e){n=e.textContent;for(const s of k)if(s.nickname===n||e.textContent.includes(s.nickname)){t=s.id;break}}}if(!t){const s=e.target.closest("[data-user-id]");if(s)if(t=s.getAttribute("data-user-id"),s.hasAttribute("data-user-nickname"))n=s.getAttribute("data-user-nickname");else{const e=s.querySelector(".friend-name, .user-name, .message-nickname");e&&(n=e.textContent)}}}if(t){let s=null;for(const e of w)if(String(e.id)===String(t)){s=e;break}if(!s)for(const e of k)if(String(e.id)===String(t)){s=e;break}se(e,s||{id:t,nickname:n})}}e&&e.addEventListener("click",function(e){if(e.target.classList.contains("message-image")){const t=e.target.getAttribute("src");t&&openImagePreview(t)}else(e.target.classList.contains("user-avatar")||"IMG"===e.target.tagName&&e.target.parentElement.classList.contains("user-avatar"))&&s(e)}),t&&t.addEventListener("click",function(e){if(e.target.classList.contains("message-image")){const t=e.target.getAttribute("src");t&&openImagePreview(t)}else(e.target.classList.contains("user-avatar")||"IMG"===e.target.tagName&&e.target.parentElement.classList.contains("user-avatar"))&&s(e)}),n&&n.addEventListener("click",function(e){const t=e.target.closest(".user-avatar");if(t)return e.stopPropagation(),void s(e);if(e.target.classList.contains("message-image")){const t=e.target.getAttribute("src");t&&openImagePreview(t)}});const o=document.getElementById("userList");o&&o.addEventListener("click",function(e){const t=e.target.closest(".user-avatar");t&&(e.stopPropagation(),s(e))});const i=document.getElementById("offlineUserList");i&&i.addEventListener("click",function(e){const t=e.target.closest(".user-avatar");t&&(e.stopPropagation(),s(e))});const a=document.getElementById("friendsList");a&&a.addEventListener("click",function(e){const t=e.target.closest(".user-avatar");t&&(e.stopPropagation(),s(e))})}function Dt(){const e=document.getElementById("groupList");e&&e.addEventListener("click",function(e){if(e.target.closest(".group-avatar")){const t=e.target.closest(".group-avatar"),n=t.querySelector("img");n&&n.src&&openImagePreview(n.src)}});const t=document.getElementById("groupInfoModal");t&&t.addEventListener("click",function(e){if(e.target.closest("#modalGroupAvatarValue")){const t=e.target.closest("#modalGroupAvatarValue"),n=t.querySelector("img");n&&n.src&&openImagePreview(n.src)}})}function Ft(){const e=localStorage.getItem("currentUser"),t=localStorage.getItem("currentSessionToken"),n=localStorage.getItem("chatUserId"),s=localStorage.getItem("chatSessionToken"),o=localStorage.getItem("chatUserNickname"),i=localStorage.getItem("chatUserAvatar");if(!p&&(e||n))if(e)try{p=JSON.parse(e)}catch(a){console.warn("è§£æcurrentUserå¤±è´¥:",a)}else n&&(p={id:n,nickname:o,avatarUrl:i});m||!t&&!s||(m=t||s),window.location.hash="#/chat",setTimeout(()=>{q();const e=window.location.hash;window.location.hash="",setTimeout(()=>{window.location.hash=e},50)},100)}function Rt(e){const t=document.getElementById("messageContainer");if(t)if("save"===e){const e=document.createDocumentFragment(),n=t.children;for(let t=0;t<n.length;t++)e.appendChild(n[t].cloneNode(!0));A=e}else if("pull"===e){if(!A)return void(p&&m&&window.chatSocket&&window.chatSocket.emit("get-chat-history",{userId:p.id,sessionToken:m,limit:50,loadMore:!1}));t.innerHTML="",A&&(11===A.nodeType?t.appendChild(A.cloneNode(!0)):"string"===typeof A&&(t.innerHTML=A)),t.scrollTop=t.scrollHeight}}Ht&&Ht.addEventListener("click",Gt),document.addEventListener("DOMContentLoaded",function(){window.addEventListener("load",function(){"#/login"!==window.location.hash&&"#/register"!==window.location.hash&&(Ot(),_t(),zt(),Dt())})})},7079:function(e,t,n){var s=n(5130),o=n(1346),i=(n(4114),n(6768)),a=n(144),r=n(7507),l=(n(8111),n(7588),n(9112),n(4232)),c=n(302);const d={id:"sidebar"},u={class:"menu-section"},p={class:"menu-list"},m={class:"menu-section"},g={class:"menu-list"},f={class:"menu-section"},y={class:"menu-list"},h={class:"menu-section"},v={class:"menu-list"};var b={__name:"ChatSidebar",setup(e){const t=(0,r.n)(),s=(0,i.EW)(()=>{const e=window.location.hash;return"#/chat"===e?"public-chat":"#/chat/group"===e?"group-chat":"#/chat/private"===e?"private-chat":"#/settings"===e?"user-settings":"public-chat"});function o(){const e=document.getElementById("currentUserAvatar"),t=document.getElementById("userInitials");if(!e||!t)return;let n=null;const s=localStorage.getItem("currentUser");if(s)try{n=JSON.parse(s)}catch(a){console.warn("è§£æcurrentUserå¤±è´¥ï¼Œå°è¯•ä»å…¶ä»–localStorageé¡¹è·å–")}if(!n){const e=localStorage.getItem("chatUserId"),t=localStorage.getItem("chatUserNickname"),s=localStorage.getItem("chatUserAvatar");e&&(n={id:e,nickname:t,avatarUrl:s})}if(!n){const e=localStorage.getItem("userId"),t=localStorage.getItem("nickname"),s=localStorage.getItem("avatarUrl");e&&(n={id:e,nickname:t,avatarUrl:s})}if(!n)return;let o="";n.avatar&&"string"===typeof n.avatar?o=n.avatar.trim():n.avatarUrl&&"string"===typeof n.avatarUrl&&(o=n.avatarUrl.trim());const i=o&&/\.svg$/i.test(o);if(o&&!i){const n=`https://back.hs.airoe.cn${o}`;e.src=n,e.style.display="block",t.style.display="none"}else{const s=n.nickname?n.nickname.charAt(0).toUpperCase():"U";t.textContent=s,t.style.display="block",e.style.display="none"}}function a(){const e=document.querySelectorAll(".menu-item"),t=document.querySelectorAll(".secondary-content"),s=document.querySelectorAll(".chat-content"),o=document.getElementById("switchToOldUI");o&&o.addEventListener("click",()=>{window.location.href="/oldUI/"}),e.forEach(o=>{o.addEventListener("click",()=>{const i=o.getAttribute("data-section");if("logout"===i)return void(confirm("ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ")&&b());e.forEach(e=>{e.classList.remove("active")}),t.forEach(e=>{e.classList.remove("active")}),s.forEach(e=>{e.classList.remove("active"),e.style.display="none"}),o.classList.add("active");const a=document.querySelector(`.secondary-content[data-content="${i}"]`);a&&a.classList.add("active");const r=document.querySelector(`.chat-content[data-content="${i}"]`);r&&(r.classList.add("active"),r.style.display="flex",w());const l=document.getElementById("markdownToolbar"),c=document.getElementById("toggleMarkdownToolbar"),d=document.getElementById("toggleGroupMarkdownToolbar");l&&("public-chat"===i||(l.style.display="none")),c&&("public-chat"===i?(c.style.display="inline-block",l&&("none"===l.style.display?c.innerHTML='<i class="fas fa-chevron-down"></i> MD':c.innerHTML='<i class="fas fa-chevron-up"></i> éšè—Markdownå·¥å…·æ ')):c.style.display="none"),d&&(d.style.display="group-chat"===i?"inline-block":"none"),"public-chat"===i&&Promise.resolve().then(n.bind(n,302)).then(({setActiveChat:e,updateUnreadCountsDisplay:t})=>{e("main",null,!0),t()}),"group-chat"===i&&Promise.resolve().then(n.bind(n,302)).then(({updateUnreadCountsDisplay:e})=>{setTimeout(()=>{e()},100)}),"private-chat"===i&&Promise.resolve().then(n.bind(n,302)).then(({updateUnreadCountsDisplay:e})=>{setTimeout(()=>{e()},100)}),k(i)})})}function b(){localStorage.removeItem("currentUser"),localStorage.removeItem("currentSessionToken"),localStorage.removeItem("chatUserId"),localStorage.removeItem("chatUserNickname"),localStorage.removeItem("chatSessionToken"),localStorage.removeItem("chatUserAvatar"),localStorage.removeItem("userId"),localStorage.removeItem("nickname"),localStorage.removeItem("avatarUrl"),localStorage.removeItem("sessionToken"),t.push("/login")}function w(){console.log("Adjusting chat layout")}function k(e){let t="";switch("#/chat"===window.location.hash&&(0,c.qR)("save"),e){case"public-chat":t="#/chat";break;case"group-chat":t="#/chat/group";break;case"private-chat":t="#/chat/private";break;case"user-settings":t="#/settings";break;default:t="#/chat"}window.location.hash=t}return(0,i.sV)(()=>{a(),o()}),(e,t)=>((0,i.uX)(),(0,i.CE)("div",d,[t[4]||(t[4]=(0,i.Fv)('<div class="sidebar-header"><div id="userProfile" class="user-profile"><div id="userAvatar" class="user-avatar"><img id="currentUserAvatar" src="" alt="ç”¨æˆ·å¤´åƒ" class="user-avatar-img" loading="lazy" width="60" height="60" style="aspect-ratio:1/1;object-fit:cover;"><span id="userInitials" class="user-initials"></span></div></div></div>',1)),(0,i.Lk)("div",u,[(0,i.Lk)("ul",p,[(0,i.Lk)("li",{class:(0,l.C4)(["menu-item",{active:"public-chat"===s.value}]),"data-section":"public-chat"},[...t[0]||(t[0]=[(0,i.Lk)("div",{class:"chat-avatar"},"ğŸ’¬",-1),(0,i.Lk)("div",{class:"unread-count",id:"publicChatUnreadCount"},null,-1)])],2)])]),(0,i.Lk)("div",m,[(0,i.Lk)("ul",g,[(0,i.Lk)("li",{class:(0,l.C4)(["menu-item",{active:"group-chat"===s.value}]),"data-section":"group-chat"},[...t[1]||(t[1]=[(0,i.Lk)("div",{class:"chat-avatar"},[(0,i.Lk)("img",{src:"icon/User-Group-256.ico",alt:"ç¾¤ç»„èŠå¤©",style:{width:"24px",height:"24px"}})],-1),(0,i.Lk)("div",{class:"unread-count",id:"groupChatUnreadCount"},null,-1)])],2)])]),(0,i.Lk)("div",f,[(0,i.Lk)("ul",y,[(0,i.Lk)("li",{class:(0,l.C4)(["menu-item",{active:"private-chat"===s.value}]),"data-section":"private-chat"},[...t[2]||(t[2]=[(0,i.Lk)("div",{class:"chat-avatar"},[(0,i.Lk)("img",{src:"icon/User-Profile-256.ico",alt:"ç§ä¿¡èŠå¤©",style:{width:"24px",height:"24px"}})],-1),(0,i.Lk)("div",{class:"unread-count",id:"privateChatUnreadCount"},null,-1)])],2)])]),(0,i.Lk)("div",h,[(0,i.Lk)("ul",v,[(0,i.Lk)("li",{class:(0,l.C4)(["menu-item",{active:"user-settings"===s.value}]),"data-section":"user-settings"},[...t[3]||(t[3]=[(0,i.Lk)("div",{class:"chat-avatar"},[(0,i.Lk)("img",{src:"icon/Settings-01-256.ico",alt:"ç”¨æˆ·è®¾ç½®",style:{width:"24px",height:"24px"}})],-1)])],2)])]),t[5]||(t[5]=(0,i.Fv)('<div class="menu-section" style="margin-top:auto;margin-bottom:20px;"><ul class="menu-list"><li class="menu-item" id="switchToOldUI"><div class="chat-avatar" title="åˆ‡æ¢åˆ°æ—§UI">â¬…ï¸</div></li></ul><ul class="menu-list"><li class="menu-item" data-section="logout"><div class="chat-avatar">â»</div></li></ul></div>',1))]))}};const w=b;var k=w;const x={id:"secondary-sidebar"};var I={__name:"ChatSecondarySidebar",setup(e){const t=(0,i.EW)(()=>{const e=window.location.hash;return"#/chat"===e?"public-chat":"#/chat/group"===e?"group-chat":"#/chat/private"===e?"private-chat":"#/settings"===e?"user-settings":"public-chat"});return(e,n)=>((0,i.uX)(),(0,i.CE)("div",x,[(0,i.Lk)("div",{class:(0,l.C4)(["secondary-content",{active:"public-chat"===t.value}]),"data-content":"public-chat"},[...n[0]||(n[0]=[(0,i.Fv)('<div class="sidebar-section"><h3>åœ¨çº¿ç”¨æˆ· <span id="onlineCount">(0)</span></h3><ul class="user-list" id="userList"><li>æš‚æ— åœ¨çº¿ç”¨æˆ·</li></ul></div><div class="sidebar-section"><div class="section-header"><h3>ç¦»çº¿ç”¨æˆ·</h3></div><ul class="user-list" id="offlineUserList"><li>æš‚æ— ç¦»çº¿ç”¨æˆ·</li></ul></div>',2)])],2),(0,i.Lk)("div",{class:(0,l.C4)(["secondary-content",{active:"group-chat"===t.value}]),"data-content":"group-chat"},[...n[1]||(n[1]=[(0,i.Fv)('<div class="sidebar-section"><div class="section-header"><div class="search-container"><input type="text" id="groupSearchInput" placeholder="æœç´¢ç¾¤ç»„..." class="search-input"><button id="clearGroupSearch" class="clear-search-btn" style="display:none;">Ã—</button><button id="createGroupButton" class="create-group-btn" title="åˆ›å»ºç¾¤ç»„">+</button></div></div><ul class="user-list" id="groupList"><li class="loading-item"><span class="loading-text">æ­£åœ¨åŠ è½½ç¾¤ç»„åˆ—è¡¨...</span></li></ul></div>',1)])],2),(0,i.Lk)("div",{class:(0,l.C4)(["secondary-content",{active:"private-chat"===t.value}]),"data-content":"private-chat"},[...n[2]||(n[2]=[(0,i.Fv)('<div class="sidebar-section"><div class="section-header"><div class="search-container"><input type="text" id="privateChatSearchInput" placeholder="æœç´¢å¥½å‹..." class="search-input"><button id="clearPrivateChatSearch" class="clear-search-btn" style="display:none;">Ã—</button><button id="searchUserButton" class="create-group-btn" style="background-color:#3498db;" title="æœç´¢ç”¨æˆ·">+</button></div></div><ul class="user-list" id="friendsList"><li class="empty-friends">æš‚æ— å¥½å‹ï¼Œè¯·å…ˆæ·»åŠ å¥½å‹</li></ul></div>',1)])],2),(0,i.Lk)("div",{class:(0,l.C4)(["secondary-content",{active:"user-settings"===t.value}]),"data-content":"user-settings"},[...n[3]||(n[3]=[(0,i.Fv)('<div class="sidebar-section"><h3>è´¦æˆ·è®¾ç½®</h3><ul class="settings-list"><li class="settings-item" data-setting-id="change-password">ä¿®æ”¹å¯†ç </li><li class="settings-item" data-setting-id="change-nickname">ä¿®æ”¹æ˜µç§°</li><li class="settings-item" data-setting-id="change-signature">ä¸ªæ€§ç­¾å</li><li class="settings-item" data-setting-id="upload-avatar">ä¸Šä¼ å¤´åƒ</li></ul></div><div class="sidebar-section"><h3>èŠå¤©è®¾ç½®</h3><ul class="settings-list"><li class="settings-item" data-setting-id="theme-settings" style="color:#999;">ä¸»é¢˜è®¾ç½® <span style="color:#ff6b6b;">(æœªå®ç°)</span></li><li class="settings-item" data-setting-id="shortcut-settings">å¿«æ·é”®</li></ul></div><div class="sidebar-section"><h3>å…³äº</h3><ul class="settings-list"><li class="settings-item" data-setting-id="version-info">ç‰ˆæœ¬ä¿¡æ¯</li><li class="settings-item" data-setting-id="help-center">å¸®åŠ©ä¸­å¿ƒ</li></ul></div>',3)])],2)]))}};const E=I;var S=E,C={__name:"ChatModal",setup(e){return window.addEventListener("click",function(e){if(e.target.classList.contains("modal")){const e=document.querySelectorAll(".modal");e.forEach(e=>{e.style.display="none"})}}),(e,t)=>t[0]||(t[0]=(0,i.Fv)('<div id="groupInfoModal" class="modal" style="display:none;"><div class="modal-content"><div class="modal-header"><h2 id="modalGroupName">ç¾¤ç»„ä¿¡æ¯</h2><span class="close" id="closeGroupInfoModal">Ã—</span></div><div class="modal-body"><div class="group-info-item"><label>ç¾¤ç»„åç§°:</label><div style="display:flex;align-items:center;gap:10px;"><span id="modalGroupNameValue"></span><button id="editGroupNameBtn" class="edit-group-name-btn" style="padding:4px 8px;background-color:#3498db;color:white;border:none;border-radius:4px;cursor:pointer;font-size:12px;"> ç¼–è¾‘ </button></div></div><div class="group-info-item"><label>ç¾¤ç»„ID:</label><span id="modalGroupIdValue"></span></div><div class="group-info-item"><label>ç¾¤ç»„å…¬å‘Š:</label><div style="display:flex;align-items:flex-start;gap:10px;"><span id="modalGroupNoticeValue" style="flex:1;word-break:break-word;"></span><button id="editGroupNoticeBtn" class="edit-group-notice-btn" style="padding:4px 8px;background-color:#3498db;color:white;border:none;border-radius:4px;cursor:pointer;font-size:12px;"> ç¼–è¾‘ </button></div></div><div class="group-info-item"><label>æˆå‘˜æ•°é‡:</label><span id="modalGroupMemberCount"></span></div><div class="group-info-item"><label>ç¾¤ä¸»:</label><span id="modalGroupOwner">åŠ è½½ä¸­...</span></div><div class="group-members-section"><h3>ç¾¤ç»„æˆå‘˜</h3><div id="groupMembersContainer" class="group-members-container" style="max-height:300px;overflow-y:auto;"><div class="loading-members">æ­£åœ¨åŠ è½½æˆå‘˜åˆ—è¡¨...</div></div></div><div id="groupManageSection" class="group-manage-section" style="display:none;"><h3>ç¾¤ç»„ç®¡ç†</h3><div class="group-manage-buttons"><button id="addMemberToGroup" class="save-btn">æ·»åŠ æˆå‘˜</button><button id="refreshGroupMembers" class="save-btn">åˆ·æ–°æˆå‘˜åˆ—è¡¨</button></div></div></div><div class="modal-footer"><button id="modalCloseButton" class="cancel-btn">å…³é—­</button></div></div></div><div id="shareGroupCardModal" class="modal" style="display:none;"><div class="modal-content" style="width:500px;"><div class="modal-header"><h2>åˆ†äº«ç¾¤åç‰‡</h2><span class="close" id="closeShareGroupCardModal">Ã—</span></div><div class="modal-body"><p>é€‰æ‹©è¦åˆ†äº«çš„ç¾¤ç»„æˆ–ä¸»èŠå¤©å®¤ï¼š</p><div class="share-targets-container" style="max-height:300px;overflow-y:auto;margin:15px 0;"><div class="share-target-item" style="display:flex;align-items:center;margin:10px 0;"><input type="checkbox" id="target-main-chat" value="main" class="share-target-checkbox"><label for="target-main-chat" style="margin-left:10px;cursor:pointer;">ä¸»èŠå¤©å®¤</label></div><div id="shareGroupList" style="margin-top:15px;"></div></div></div><div class="modal-footer"><button id="cancelShareGroupCard" class="cancel-btn">å–æ¶ˆ</button><button id="confirmShareGroupCard" class="save-btn">å‘é€</button></div></div></div><div id="sendGroupCardModal" class="modal" style="display:none;"><div class="modal-content" style="width:400px;"><div class="modal-header"><h2>é€‰æ‹©ç¾¤åç‰‡</h2><span class="close" id="closeSendGroupCardModal">Ã—</span></div><div class="modal-body"><p>é€‰æ‹©è¦å‘é€çš„ç¾¤åç‰‡ï¼š</p><div class="send-group-card-container" style="max-height:300px;overflow-y:auto;margin:15px 0;"><div id="sendGroupCardList"></div></div></div><div class="modal-footer"><button id="cancelSendGroupCard" class="cancel-btn">å–æ¶ˆ</button><button id="confirmSendGroupCard" class="save-btn" disabled>å‘é€</button></div></div></div><div id="createGroupModal" class="modal" style="display:none;"><div class="modal-content"><div class="modal-header"><h2>åˆ›å»ºæ–°ç¾¤ç»„</h2><span class="close" id="closeCreateGroupModal">Ã—</span></div><div class="modal-body"><form id="createGroupForm" class="settings-form"><div class="form-group"><label for="newGroupName">ç¾¤ç»„åç§° *</label><input type="text" id="newGroupName" placeholder="è¯·è¾“å…¥ç¾¤ç»„åç§°" maxlength="50" required></div><div class="form-group"><label for="newGroupDescription">ç¾¤ç»„å…¬å‘Š</label><textarea id="newGroupDescription" placeholder="è¯·è¾“å…¥ç¾¤ç»„å…¬å‘Šï¼ˆå¯é€‰ï¼‰" rows="3" maxlength="200"></textarea></div><div class="form-group"><label>é€‰æ‹©å…¶ä»–ç¾¤æˆå‘˜</label><div id="groupMembersList" class="group-members-list"><div class="loading-members">æ­£åœ¨åŠ è½½æˆå‘˜åˆ—è¡¨...</div></div></div><div id="createGroupMessage" class="create-group-message"></div></form></div><div class="modal-footer"><button id="cancelCreateGroup" class="cancel-btn">å–æ¶ˆ</button><button id="submitCreateGroup" class="save-btn">åˆ›å»ºç¾¤ç»„</button></div></div></div><div id="addGroupMemberModal" class="modal" style="display:none;"><div class="modal-content"><div class="modal-header"><h2>æ·»åŠ ç¾¤ç»„æˆå‘˜</h2><span class="close" id="closeAddGroupMemberModal">Ã—</span></div><div class="modal-body"><div class="form-group"><label>é€‰æ‹©è¦æ·»åŠ çš„æˆå‘˜</label><div id="availableMembersList" class="group-members-list"><div class="loading-members">æ­£åœ¨åŠ è½½å¯ç”¨æˆå‘˜...</div></div></div><div id="addMembersMessage" class="create-group-message"></div></div><div class="modal-footer"><button id="cancelAddMembers" class="cancel-btn">å–æ¶ˆ</button><button id="confirmAddMembers" class="save-btn">ç¡®è®¤æ·»åŠ </button></div></div></div><div id="userProfileModal" class="modal" style="display:none;"><div class="modal-content"><div class="modal-header"><h2>ç”¨æˆ·èµ„æ–™</h2><span class="close" id="closeUserProfileModal">Ã—</span></div><div class="modal-body"><div class="user-profile-container"><div class="user-profile-avatar"><img id="modalUserAvatar" src="" alt="ç”¨æˆ·å¤´åƒ" class="user-avatar-img" loading="lazy" width="120" height="120" style="aspect-ratio:1/1;object-fit:cover;border-radius:50%;"><span id="modalUserInitials" class="user-initials"></span></div><div class="user-profile-info"><div class="user-profile-item"><label>æ˜µç§°:</label><span id="modalUserNickname"></span></div><div class="user-profile-item"><label>ç”¨æˆ·å:</label><span id="modalUsername"></span></div><div class="user-profile-item"><label>ç”¨æˆ·ID:</label><span id="modalUserId"></span></div><div class="user-profile-item"><label>çŠ¶æ€:</label><span id="modalUserStatus" class="user-status"></span></div><div class="signature-section" style="display:none;"><div class="signature-label">ä¸ªæ€§ç­¾å</div><div id="modalUserSignature" class="signature-content"></div></div></div></div></div><div class="modal-footer"><button id="closeUserProfileButton" class="cancel-btn">å…³é—­</button></div></div></div><div id="userAvatarPopup" style="display:none;position:absolute;background:white;border:1px solid #ddd;border-radius:8px;padding:15px;box-shadow:0 2px 10px rgba(0,0,0,0.1);z-index:1000;min-width:250px;"><div class="popup-header" style="display:flex;align-items:center;gap:10px;margin-bottom:10px;"><div class="popup-avatar" style="width:40px;height:40px;border-radius:50%;overflow:hidden;display:flex;align-items:center;justify-content:center;background:#3498db;color:white;font-weight:bold;"><img id="popupAvatarImg" src="" alt="ç”¨æˆ·å¤´åƒ" style="width:100%;height:100%;object-fit:cover;"><span id="popupInitials" style="display:none;font-size:18px;"></span></div><div class="popup-info"><div id="popupNickname" style="font-weight:bold;font-size:16px;"></div><div id="popupUsername" style="font-size:14px;color:#666;"></div></div></div><div class="popup-signature-section" id="popupSignatureSection" style="display:none;margin-top:10px;padding-top:10px;border-top:1px solid #eee;"><div class="signature-label" style="font-size:12px;color:#999;margin-bottom:4px;">ä¸ªæ€§ç­¾å</div><div id="popupSignature" class="signature-content" style="font-size:13px;color:#666;word-break:break-word;"></div></div><div class="popup-actions" style="margin-top:10px;display:flex;gap:10px;"><button id="popupAddFriend" style="flex:1;padding:8px;background:#3498db;color:white;border:none;border-radius:4px;cursor:pointer;">æ·»åŠ å¥½å‹</button></div></div><div id="userSearchModal" class="modal" style="display:none;"><div class="modal-content"><div class="modal-header"><h2>æœç´¢ç”¨æˆ·</h2><span class="close" id="closeUserSearchModal">Ã—</span></div><div class="modal-body"><div class="form-group"><label for="searchKeyword">æœç´¢å…³é”®è¯:</label><input type="text" id="searchKeyword" placeholder="è¾“å…¥ç”¨æˆ·åæˆ–æ˜µç§°" required></div><div id="searchResults" class="search-results" style="max-height:300px;overflow-y:auto;margin-top:15px;"></div></div><div class="modal-footer"><button id="cancelUserSearch" class="cancel-btn">å–æ¶ˆ</button><button id="confirmUserSearch" class="save-btn">æœç´¢</button></div></div></div><div id="imagePreviewModal" class="modal" style="display:none;position:fixed;z-index:10001;left:0;top:0;width:100%;height:100%;overflow:auto;background-color:rgba(0,0,0,0.9);justify-content:center;align-items:center;"><div style="position:relative;max-width:90%;max-height:90%;"><img id="previewImgElement" src="" alt="å›¾ç‰‡é¢„è§ˆ" style="width:100%;height:auto;max-width:90vw;max-height:90vh;aspect-ratio:16/9;object-fit:contain;" loading="lazy"><span class="close" id="closeImagePreviewModal" style="position:absolute;top:-30px;right:-30px;color:#f1f1f1;font-size:40px;font-weight:bold;cursor:pointer;">Ã—</span></div></div><div id="avatarPreviewModal" class="modal" style="display:none;position:fixed;z-index:10001;left:0;top:0;width:100%;height:100%;overflow:auto;background-color:rgba(0,0,0,0.9);justify-content:center;align-items:center;"><div style="position:relative;max-width:300px;max-height:300px;"><img id="previewAvatarElement" src="" alt="å¤´åƒé¢„è§ˆ" style="width:300px;height:300px;border-radius:50%;object-fit:cover;"><span class="close" id="closeAvatarPreviewModal" style="position:absolute;top:-30px;right:-30px;color:#f1f1f1;font-size:40px;font-weight:bold;cursor:pointer;">Ã—</span></div></div>',10))}};const $=C;var B=$;const L={key:0,id:"main-chat"},M={id:"chat-main"},T={id:"modal"};var A={__name:"App",setup(e){const t=(0,r.n)(),n=(0,r.t)(),s=(0,a.KR)(!1);function o(){const e=localStorage.getItem("currentUser"),t=localStorage.getItem("currentSessionToken"),n=localStorage.getItem("chatUserId"),o=localStorage.getItem("chatSessionToken"),i=localStorage.getItem("userId"),a=localStorage.getItem("sessionToken"),r=!!e&&(!!t||!!o)||!!n&&!!o||!!i&&!!a;return s.value=r,r}const l=(0,i.EW)(()=>s.value),d=(0,i.EW)(()=>n.path),u=(0,i.EW)(()=>["/chat","/chat/group","/chat/private","/settings"].includes(d.value)),p=()=>{const e=["public","group","private","settings"].includes(n.name),s=o();e&&!s&&t.push("/login"),s&&["/chat","/chat/group","/chat/private","/settings"].includes(d.value)};return(0,i.sV)(async()=>{o(),t.afterEach(()=>{o(),p()}),await t.isReady(),l.value&&(0,c.JA)()}),(e,t)=>{const n=(0,i.g2)("router-view");return l.value&&u.value?((0,i.uX)(),(0,i.CE)("div",L,[(0,i.bF)(k),(0,i.bF)(S),(0,i.Lk)("div",M,[(0,i.bF)(n)]),(0,i.Lk)("div",T,[(0,i.bF)(B)])])):((0,i.uX)(),(0,i.Wv)(n,{key:1}))}}};const U=A;var N=U;const j=(0,o.aE)({history:(0,o.Bt)(),routes:[{path:"/login",name:"login",component:()=>n.e(192).then(n.bind(n,192))},{path:"/register",name:"register",component:()=>n.e(461).then(n.bind(n,7461))},{path:"/chat",name:"public",component:()=>n.e(595).then(n.bind(n,8595))},{path:"/chat/group",name:"group",component:()=>n.e(942).then(n.bind(n,8942))},{path:"/chat/private",name:"private",component:()=>n.e(762).then(n.bind(n,5762))},{path:"/settings",name:"settings",component:()=>n.e(318).then(n.bind(n,5318))},{path:"/",redirect:"/chat"},{path:"/:pathMatch(.*)*",redirect:"/chat"}]}),P=(0,s.Ef)(N);P.use(j),P.mount("#app")}},t={};function n(s){var o=t[s];if(void 0!==o)return o.exports;var i=t[s]={exports:{}};return e[s].call(i.exports,i,i.exports,n),i.exports}n.m=e,function(){var e=[];n.O=function(t,s,o,i){if(!s){var a=1/0;for(d=0;d<e.length;d++){s=e[d][0],o=e[d][1],i=e[d][2];for(var r=!0,l=0;l<s.length;l++)(!1&i||a>=i)&&Object.keys(n.O).every(function(e){return n.O[e](s[l])})?s.splice(l--,1):(r=!1,i<a&&(a=i));if(r){e.splice(d--,1);var c=o();void 0!==c&&(t=c)}}return t}i=i||0;for(var d=e.length;d>0&&e[d-1][2]>i;d--)e[d]=e[d-1];e[d]=[s,o,i]}}(),function(){n.n=function(e){var t=e&&e.__esModule?function(){return e["default"]}:function(){return e};return n.d(t,{a:t}),t}}(),function(){n.d=function(e,t){for(var s in t)n.o(t,s)&&!n.o(e,s)&&Object.defineProperty(e,s,{enumerable:!0,get:t[s]})}}(),function(){n.f={},n.e=function(e){return Promise.all(Object.keys(n.f).reduce(function(t,s){return n.f[s](e,t),t},[]))}}(),function(){n.u=function(e){return"js/"+e+"."+{192:"8facb577",318:"eb6f8ecb",461:"c4091337",595:"a9d10e54",762:"5d451aa2",942:"fb204c91"}[e]+".js"}}(),function(){n.miniCssF=function(e){return"css/"+e+"."+{192:"fa82ba64",461:"ac915a3d"}[e]+".css"}}(),function(){n.g=function(){if("object"===typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"===typeof window)return window}}()}(),function(){n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)}}(),function(){var e={},t="vue-chat:";n.l=function(s,o,i,a){if(e[s])e[s].push(o);else{var r,l;if(void 0!==i)for(var c=document.getElementsByTagName("script"),d=0;d<c.length;d++){var u=c[d];if(u.getAttribute("src")==s||u.getAttribute("data-webpack")==t+i){r=u;break}}r||(l=!0,r=document.createElement("script"),r.charset="utf-8",n.nc&&r.setAttribute("nonce",n.nc),r.setAttribute("data-webpack",t+i),r.src=s),e[s]=[o];var p=function(t,n){r.onerror=r.onload=null,clearTimeout(m);var o=e[s];if(delete e[s],r.parentNode&&r.parentNode.removeChild(r),o&&o.forEach(function(e){return e(n)}),t)return t(n)},m=setTimeout(p.bind(null,void 0,{type:"timeout",target:r}),12e4);r.onerror=p.bind(null,r.onerror),r.onload=p.bind(null,r.onload),l&&document.head.appendChild(r)}}}(),function(){n.r=function(e){"undefined"!==typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}}(),function(){n.p="/"}(),function(){if("undefined"!==typeof document){var e=function(e,t,s,o,i){var a=document.createElement("link");a.rel="stylesheet",a.type="text/css",n.nc&&(a.nonce=n.nc);var r=function(n){if(a.onerror=a.onload=null,"load"===n.type)o();else{var s=n&&n.type,r=n&&n.target&&n.target.href||t,l=new Error("Loading CSS chunk "+e+" failed.\n("+s+": "+r+")");l.name="ChunkLoadError",l.code="CSS_CHUNK_LOAD_FAILED",l.type=s,l.request=r,a.parentNode&&a.parentNode.removeChild(a),i(l)}};return a.onerror=a.onload=r,a.href=t,s?s.parentNode.insertBefore(a,s.nextSibling):document.head.appendChild(a),a},t=function(e,t){for(var n=document.getElementsByTagName("link"),s=0;s<n.length;s++){var o=n[s],i=o.getAttribute("data-href")||o.getAttribute("href");if("stylesheet"===o.rel&&(i===e||i===t))return o}var a=document.getElementsByTagName("style");for(s=0;s<a.length;s++){o=a[s],i=o.getAttribute("data-href");if(i===e||i===t)return o}},s=function(s){return new Promise(function(o,i){var a=n.miniCssF(s),r=n.p+a;if(t(a,r))return o();e(s,r,null,o,i)})},o={524:0};n.f.miniCss=function(e,t){var n={192:1,461:1};o[e]?t.push(o[e]):0!==o[e]&&n[e]&&t.push(o[e]=s(e).then(function(){o[e]=0},function(t){throw delete o[e],t}))}}}(),function(){var e={524:0};n.f.j=function(t,s){var o=n.o(e,t)?e[t]:void 0;if(0!==o)if(o)s.push(o[2]);else{var i=new Promise(function(n,s){o=e[t]=[n,s]});s.push(o[2]=i);var a=n.p+n.u(t),r=new Error,l=function(s){if(n.o(e,t)&&(o=e[t],0!==o&&(e[t]=void 0),o)){var i=s&&("load"===s.type?"missing":s.type),a=s&&s.target&&s.target.src;r.message="Loading chunk "+t+" failed.\n("+i+": "+a+")",r.name="ChunkLoadError",r.type=i,r.request=a,o[1](r)}};n.l(a,l,"chunk-"+t,t)}},n.O.j=function(t){return 0===e[t]};var t=function(t,s){var o,i,a=s[0],r=s[1],l=s[2],c=0;if(a.some(function(t){return 0!==e[t]})){for(o in r)n.o(r,o)&&(n.m[o]=r[o]);if(l)var d=l(n)}for(t&&t(s);c<a.length;c++)i=a[c],n.o(e,i)&&e[i]&&e[i][0](),e[i]=0;return n.O(d)},s=self["webpackChunkvue_chat"]=self["webpackChunkvue_chat"]||[];s.forEach(t.bind(null,0)),s.push=t.bind(null,s.push.bind(s))}();var s=n.O(void 0,[504],function(){return n(7079)});s=n.O(s)})();