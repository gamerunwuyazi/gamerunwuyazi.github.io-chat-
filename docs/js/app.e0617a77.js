(function(){var e={302:function(e,t,n){"use strict";n.d(t,{oj:function(){return Me},hf:function(){return xt},JA:function(){return U},v8:function(){return xe},aS:function(){return be},hT:function(){return ye},NV:function(){return se},fz:function(){return ee},uD:function(){return $t},jC:function(){return $e},K9:function(){return R},QF:function(){return bt},Sf:function(){return H},iD:function(){return Gt},qR:function(){return Pt},eA:function(){return d},J5:function(){return ct}});n(4114),n(8111),n(2489),n(7588),n(1701),n(3579),n(9112),n(3110),n(7642),n(8004),n(3853),n(5876),n(2475),n(5024),n(1698);function s(){let e=document.getElementById("toast-container");return e||(e=document.createElement("div"),e.id="toast-container",e.style.position="fixed",e.style.top="20px",e.style.right="20px",e.style.zIndex="9999",e.style.display="flex",e.style.flexDirection="column",e.style.alignItems="flex-end",e.style.gap="10px",document.body.appendChild(e)),e}function o(e,t="info",n=3e3){const o=s(),a=document.createElement("div");switch(a.className=`toast toast-${t}`,a.style.padding="10px 15px",a.style.borderRadius="4px",a.style.color="white",a.style.fontSize="14px",a.style.fontWeight="500",a.style.boxShadow="0 2px 8px rgba(0, 0, 0, 0.15)",a.style.transition="all 0.3s ease",a.style.transform="translateX(100%)",a.style.opacity="0",t){case"success":a.style.backgroundColor="#52c41a";break;case"error":a.style.backgroundColor="#f5222d";break;case"warning":a.style.backgroundColor="#faad14";break;default:a.style.backgroundColor="#1890ff"}return a.textContent=e,o.appendChild(a),setTimeout(()=>{a.style.transform="translateX(0)",a.style.opacity="1"},10),setTimeout(()=>{a.style.transform="translateX(100%)",a.style.opacity="0",setTimeout(()=>{a.parentNode===o&&o.removeChild(a)},300)},n),a}const a={success:(e,t)=>o(e,"success",t),error:(e,t)=>o(e,"error",t),warning:(e,t)=>o(e,"warning",t),info:(e,t)=>o(e,"info",t)};var i=a;const r=n(357),l=n(6226),c="https://back.hs.airoe.cn";let d={currentGroupId:null,currentGroupName:"",currentPrivateChatUserId:null,currentPrivateChatUsername:"",currentPrivateChatNickname:"",currentPrivateChatAvatarUrl:"",currentActiveChat:"main",currentSendChatType:"main",selectedGroupIdForCard:null},u=null,p=localStorage.getItem("currentSessionToken")||null;window.currentUser=u,window.currentSessionToken=p;let m=!1,g=d.currentGroupId,f=d.currentGroupName,y=d.currentPrivateChatUserId,h=d.currentPrivateChatUsername,v=d.currentPrivateChatNickname,b=[],w=[],k=!1,I=!1,x=!1,E=document.title,S={global:0,groups:{},private:{}},C=!0,$=d.currentActiveChat,L={},B=d.currentSendChatType,M=d.selectedGroupIdForCard,T=null,A=null;function U(){if(!u||!p){const e=localStorage.getItem("chatUserId"),t=localStorage.getItem("chatSessionToken"),n=localStorage.getItem("chatUserNickname"),s=localStorage.getItem("chatUserAvatar");if(!e||!t)return void console.warn("æœªæ‰¾åˆ°ç”¨æˆ·ä¿¡æ¯ï¼Œåˆå§‹åŒ–èŠå¤©å¤±è´¥");u={id:e,nickname:n,avatarUrl:s},p=t,window.currentUser=u,window.currentSessionToken=p}try{"function"===typeof ie?ie():(console.warn("å†…éƒ¨åˆå§‹åŒ–å‡½æ•°ä¸å­˜åœ¨ï¼Œæ‰§è¡ŒåŸºæœ¬åˆå§‹åŒ–"),"function"===typeof le&&le(),"function"===typeof be&&be(),"function"===typeof ce&&ce()),setTimeout(()=>{if(y){console.log("è‡ªåŠ¨åº”ç”¨ä¿å­˜çš„ç§ä¿¡ä¼šè¯çŠ¶æ€:",{userId:y,username:h,nickname:v,activeChat:$}),ct("private",y);const e=document.getElementById("privateEmptyState"),t=document.getElementById("privateChatInterface"),n=document.getElementById("privateUserName");e&&(e.style.display="none"),t&&(t.style.display="flex",t.style.flexDirection="column"),n&&(n.textContent=v),H(y)}},500)}catch(e){console.error("åˆå§‹åŒ–èŠå¤©å¤±è´¥:",e)}}function N(){const e=document.getElementById("currentUserAvatar"),t=document.getElementById("userInitials");if(!u||!e||!t)return;let n="";u.avatar&&"string"===typeof u.avatar?n=u.avatar.trim():u.avatarUrl&&"string"===typeof u.avatarUrl&&(n=u.avatarUrl.trim());const s=n&&/\.svg$/i.test(n);if(n&&!s){const s=`${c}${n}`;e.src=s,e.style.display="block",t.style.display="none"}else{const n=u.nickname?u.nickname.charAt(0).toUpperCase():"U";t.textContent=n,t.style.display="block",e.style.display="none"}}function j(){D(),R(),W(),ee(),se()}function G(){u&&p&&fetch(`${c}/user/friends`,{headers:{"user-id":u.id,"session-token":p}}).then(e=>e.json()).then(e=>{if("success"===e.status)P(e.friends);else{const t=document.getElementById("friendsList");t&&(t.innerHTML="<li>åŠ è½½å¥½å‹åˆ—è¡¨å¤±è´¥: "+e.message+"</li>")}}).catch(()=>{const e=document.getElementById("friendsList");e&&(e.innerHTML="<li>åŠ è½½å¥½å‹åˆ—è¡¨å¤±è´¥: ç½‘ç»œé”™è¯¯</li>")})}function P(e){const t=document.getElementById("friendsList");t&&(t.innerHTML="",w=e,0!==e.length?(e.forEach(e=>{const n=document.createElement("li");n.className="friend-item",n.dataset.userId=e.id,n.dataset.userNickname=e.nickname;let s,o="";if(e.avatarUrl&&"string"===typeof e.avatarUrl?o=e.avatarUrl.trim():e.avatar_url&&"string"===typeof e.avatar_url&&(o=e.avatar_url.trim()),o){const t=/\.svg$/i.test(o);if(t){const t=e.nickname?e.nickname.charAt(0).toUpperCase():"U";s=`<span class="user-avatar">${t}</span>`}else{const t=`${c}${o}`;s=`<span class="user-avatar"><img src="${t}" alt="${e.nickname}"></span>`}}else{const t=e.nickname?e.nickname.charAt(0).toUpperCase():"U";s=`<span class="user-avatar">${t}</span>`}const a=b.some(t=>String(t.id)===String(e.id));n.innerHTML=`\n            ${s}\n            <span class="friend-name">${e.nickname}</span>\n            <span class="friend-status ${a?"online":"offline"}"></span>\n            <div class="unread-count private-unread-count" id="privateUnreadCount_${e.id}"></div>\n        `,n.addEventListener("click",()=>{q(e.id,e.nickname,e.username,o)}),t.appendChild(n)}),it(),Z()):t.innerHTML='<li class="empty-friends">æš‚æ— å¥½å‹ï¼Œè¯·å…ˆæ·»åŠ å¥½å‹</li>')}function q(e,t,n,s){y=e,h=n,v=t,$=`private_${e}`,d.currentPrivateChatUserId=y,d.currentPrivateChatUsername=h,d.currentPrivateChatNickname=v,d.currentPrivateChatAvatarUrl=s,d.currentActiveChat=$;const o=document.getElementById("privateChatInterface"),a=document.getElementById("privateEmptyState"),i=document.getElementById("privateUserName"),r=document.getElementById("privateUserAvatar"),l=document.getElementById("privateUserInitials"),u=document.getElementById("privateUserStatus");if(o&&a&&i&&r&&l){if(o.style.display="flex",o.style.flexDirection="column",a.style.display="none",i.textContent=t?ot(t):"",s){const e=`${c}${s}`;r.src=e,r.style.display="block",r.style.visibility="visible",l.style.display="none",l.style.visibility="hidden"}else{const e=t?t.charAt(0).toUpperCase():"U";l.textContent=e,l.style.display="flex",l.style.visibility="visible",r.style.display="none",r.style.visibility="hidden",r.src=""}if(u){const t=b.some(t=>String(t.id)===String(e));u.textContent=t?"åœ¨çº¿":"ç¦»çº¿",u.className="user-status "+(t?"online":"offline")}}H(e),ct("private",e),se()}function H(e){if(!u||!p)return;const t=document.getElementById("privateMessageContainer");t&&(t.innerHTML='\n            <div class="loading-messages">\n                <div class="loading-spinner"></div>\n                <div class="loading-text">æ­£åœ¨åŠ è½½èŠå¤©è®°å½•...</div>\n            </div>\n        ',window.chatSocket?window.chatSocket.emit("join-private-chat",{userId:u.id,friendId:e,sessionToken:p}):t.innerHTML=`\n                <div class="empty-state error-state">\n                    <div class="error-icon">âŒ</div>\n                    <h3>è¿æ¥å¤±è´¥</h3>\n                    <p>æ— æ³•è¿æ¥åˆ°èŠå¤©æœåŠ¡å™¨ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥åé‡è¯•</p>\n                    <button class="retry-button" onclick="loadPrivateChatHistory(${e})">é‡è¯•</button>\n                </div>\n            `)}function _(e,t=!1){const n=document.getElementById("privateMessageContainer");if(!n)return;if(!e)return;const s=String(e.senderId),o=String(e.receiverId),a=String(y);if(s!==a&&o!==a)return;if(document.querySelector(`#privateMessageContainer [data-id="${e.id}"]`))return;const i=n.querySelector(".loading-messages");i&&i.remove();const r=n.querySelector(".empty-state");if(r&&r.remove(),!e.messageType&&!e.content&&!e.imageUrl&&!e.fileUrl&&!e.text)return;const l={id:e.senderId,nickname:e.senderNickname||e.sender||"æœªçŸ¥ç”¨æˆ·",avatarUrl:e.senderAvatarUrl||e.avatarUrl},d=l.id,p=u&&String(u.id)===String(d),m=document.createElement("div");function g(e){if("string"!==typeof e)return e;const t=document.createElement("div");return t.textContent=e,t.innerHTML}m.className="message "+(p?"own-message":"other-message"),m.setAttribute("data-id",e.id),m.setAttribute("data-user-id",d),void 0!==e.sequence&&m.setAttribute("data-sequence",e.sequence),p?(m.style.marginLeft="20%",m.style.marginRight="10px",m.style.backgroundColor="#E8F5E8",m.style.borderRadius="18px",m.style.padding="10px 15px",m.style.maxWidth="80%",m.style.minWidth="70px",m.style.alignSelf="flex-end",m.style.position="relative",m.style.transition="all 0.2s"):(m.style.marginLeft="10px",m.style.marginRight="20%",m.style.backgroundColor="#FFFFFF",m.style.borderRadius="18px",m.style.padding="10px 15px",m.style.maxWidth="80%",m.style.minWidth="70px",m.style.alignSelf="flex-start",m.style.border="1px solid #E0E0E0",m.style.position="relative"),m.style.display="flex",m.style.flexDirection="column",m.style.marginBottom="10px";let f="";const h=new Date(e.timestampISO||e.created_at||e.timestamp).toLocaleTimeString();switch(p?(f+='<div class="message-header" style="display: flex; justify-content: flex-end; margin-bottom: 5px;">',f+=`<span class="message-time" style="color: #999; font-size: 12px;">${h}</span>`,f+="</div>"):(f+='<div class="message-header" style="display: flex; justify-content: flex-start; margin-bottom: 5px;">',f+=`<span class="message-time" style="color: #999; font-size: 12px;">${h}</span>`,f+="</div>"),m.style.minWidth="70px",f+='<div class="message-content">',e.messageType){case 1:if(e.imageUrl){const t=e.imageUrl.startsWith("http")?e.imageUrl:`${c}${e.imageUrl}`;let n="",s="";e.width&&e.height&&(n=`width="${e.width}"`,s=`height="${e.height}"`),f+=`<img src="${t}" alt="å›¾ç‰‡" ${n} ${s} class="message-image" onclick="openImagePreview('${t}')" style="max-width: 100%; height: auto; border-radius: 10px; cursor: pointer;">`}else try{const t=JSON.parse(e.content);if(t&&t.url){const e=t.url.startsWith("http")?t.url:`${c}${t.url}`;let n="",s="";t.width&&t.height&&(n=`width="${t.width}"`,s=`height="${t.height}"`),f+=`<img src="${e}" alt="å›¾ç‰‡" ${n} ${s} class="message-image" onclick="openImagePreview('${e}')" style="max-width: 100%; height: auto; border-radius: 10px; cursor: pointer;">`}}catch(v){f+=`<div class="message-text">${g(e.content)}</div>`}break;case 2:if(e.fileUrl){const t=e.fileUrl.startsWith("http")?e.fileUrl:`${c}${e.fileUrl}`;f+='<div class="file-link-container" style="display: flex; align-items: center; gap: 10px; padding: 10px; background: #f5f5f5; border-radius: 8px;">',f+='<span class="file-icon" style="font-size: 20px;">ğŸ“</span>',f+=`<a href="${t}" target="_blank" class="message-link" style="text-decoration: none; color: #0d6efd; word-break: break-all;">${e.fileName||"æ–‡ä»¶"}</a>`,e.fileSize&&(f+=`<span class="file-size" style="color: #666; font-size: 12px;">(${z(e.fileSize)})</span>`),f+="</div>"}else try{const t=JSON.parse(e.content);if(t&&t.url&&t.name){const e=t.url.startsWith("http")?t.url:`${c}${t.url}`;f+='<div class="file-link-container" style="display: flex; align-items: center; gap: 10px; padding: 10px; background: #f5f5f5; border-radius: 8px;">',f+='<span class="file-icon" style="font-size: 20px;">ğŸ“</span>',f+=`<a href="${e}" target="_blank" class="message-link" style="text-decoration: none; color: #0d6efd; word-break: break-all;">${t.name}</a>`,t.size&&(f+=`<span class="file-size" style="color: #666; font-size: 12px;">(${z(t.size)})</span>`),f+="</div>"}}catch(v){f+=`<div class="message-text">${g(e.content)}</div>`}break;case 3:try{const t=JSON.parse(e.content);f+=`\n                        <div class="group-card-container" style="background-color: #f0f8ff; border: 1px solid #3498db; border-radius: 8px; padding: 10px; cursor: pointer; margin-top: 5px;">\n                            <div class="group-card-header" style="font-weight: bold; color: #3498db; margin-bottom: 5px; display: flex; align-items: center; gap: 8px;">\n                                ${t.avatar_url?`<img src="${c}${t.avatar_url}" alt="${t.group_name}" style="width: 20px; height: 20px; border-radius: 50%; object-fit: cover; cursor: pointer;">`:`<div style="width: 20px; height: 20px; border-radius: 50%; background-color: #3498db; color: white; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold;">${t.group_name.charAt(0).toUpperCase()}</div>`}\n                                ${g(t.group_name)}\n                            </div>\n                            <div class="group-card-description" style="color: #666; font-size: 14px; margin-bottom: 5px;">\n                                ${t.group_description||"æš‚æ— å…¬å‘Š"}\n                            </div>\n                            <div class="group-card-footer" style="font-size: 12px; color: #999;">\n                                ç‚¹å‡»æŸ¥çœ‹ç¾¤ç»„è¯¦æƒ…\n                            </div>\n                        </div>\n                    `}catch(v){f+=`<div class="message-text">${g(e.content)}</div>`}break;default:{let t=e.content||e.text||"";if(t=g(t),window.marked&&"function"===typeof window.marked.parse)try{window.marked.setOptions({breaks:!0,gfm:!0}),t=window.marked.parse(t)}catch(b){t=g(t)}else t=g(t);f+=`<div class="message-text" style="word-break: break-word;">${t}</div>`}break}if(f+="</div>",p&&(f+=`<button class="message-action-button withdraw-button" onclick="withdrawPrivateMessage(${e.id})" style="position: absolute; top: 8px; right: 8px; background: transparent; border: none; color: #666; font-size: 16px; cursor: pointer; padding: 0; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; border-radius: 50%; opacity: 1;">Ã—</button>`),m.innerHTML=f,3===e.messageType){const t=m.querySelector(".group-card-container");if(t)try{const n=JSON.parse(e.content);t.addEventListener("click",function(e){e.stopPropagation(),Ee(e,n)})}catch(v){console.error("è§£æç¾¤åç‰‡æ•°æ®å¤±è´¥:",v)}}if(t)return m;n.appendChild(m),n.scrollTop=n.scrollHeight}function z(e){return e<1024?e+" B":e<1048576?(e/1024).toFixed(2)+" KB":e<1073741824?(e/1048576).toFixed(2)+" MB":(e/1073741824).toFixed(2)+" GB"}function O(e){if(!u||!p||!y)return;const t=w.some(e=>String(e.id)===String(y));if(!t)return void i.error("æ‚¨ä¸è¯¥ç”¨æˆ·ä¸æ˜¯å¥½å‹ï¼Œæ— æ³•å‘é€ç§ä¿¡");const n=new FormData;n.append("image",e),n.append("userId",u.id),n.append("privateChat",!0);const s=document.getElementById("privateUploadProgress"),o=document.getElementById("privateUploadProgressBar");s&&o&&(s.style.display="block",o.style.width="0%"),fetch(`${c}/upload`,{method:"POST",headers:{"user-id":u.id,"session-token":p},body:n}).then(e=>e.json()).then(t=>{if("success"===t.status){const n={userId:u.id,content:JSON.stringify({url:t.url,name:e.name}),receiverId:y,sessionToken:p,messageType:1};window.chatSocket&&window.chatSocket.emit("private-message",n)}else wt(t.message||"å›¾ç‰‡ä¸Šä¼ å¤±è´¥")}).catch(()=>{wt("å›¾ç‰‡ä¸Šä¼ å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•")}).finally(()=>{s&&(s.style.display="none");const e=document.getElementById("privateImageInput");e&&(e.value="")})}function F(e){if(!u||!p||!y)return;const t=w.some(e=>String(e.id)===String(y));if(!t)return void i.error("æ‚¨ä¸è¯¥ç”¨æˆ·ä¸æ˜¯å¥½å‹ï¼Œæ— æ³•å‘é€ç§ä¿¡");const n=new FormData;n.append("image",e),n.append("userId",u.id),n.append("privateChat",!0);const s=document.getElementById("privateUploadProgress"),o=document.getElementById("privateUploadProgressBar");s&&o&&(s.style.display="block",o.style.width="0%"),fetch(`${c}/upload`,{method:"POST",headers:{"user-id":u.id,"session-token":p},body:n}).then(e=>e.json()).then(t=>{if("success"===t.status){const n={userId:u.id,content:JSON.stringify({url:t.url,name:e.name,size:e.size}),receiverId:y,sessionToken:p,messageType:2};window.chatSocket&&window.chatSocket.emit("private-message",n)}else wt(t.message||"æ–‡ä»¶ä¸Šä¼ å¤±è´¥")}).catch(()=>{wt("æ–‡ä»¶ä¸Šä¼ å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•")}).finally(()=>{s&&(s.style.display="none");const e=document.getElementById("privateFileInput");e&&(e.value="")})}function D(){const e=document.getElementById("privateChatSearchInput"),t=document.getElementById("clearPrivateChatSearch");e&&t&&(e.addEventListener("input",()=>{const n=e.value.toLowerCase(),s=document.querySelectorAll(".friend-item");s.forEach(e=>{const t=e.dataset.userNickname.toLowerCase();t.includes(n)?e.style.display="flex":e.style.display="none"}),t.style.display=n?"inline":"none"}),t.addEventListener("click",()=>{e.value="",t.style.display="none";const n=document.querySelectorAll(".friend-item");n.forEach(e=>{e.style.display="flex"})}));const n=document.getElementById("searchUserButton");n&&n.addEventListener("click",()=>{document.getElementById("userSearchModal").style.display="flex"})}function R(){const e=document.getElementById("closeUserProfileModal"),t=document.getElementById("closeUserProfileButton");e&&e.addEventListener("click",()=>{document.getElementById("userProfileModal").style.display="none"}),t&&t.addEventListener("click",()=>{document.getElementById("userProfileModal").style.display="none"})}function W(){const e=document.getElementById("closeUserSearchModal"),t=document.getElementById("cancelUserSearch");e&&e.addEventListener("click",()=>{document.getElementById("userSearchModal").style.display="none"}),t&&t.addEventListener("click",()=>{document.getElementById("userSearchModal").style.display="none"});const n=document.getElementById("confirmUserSearch");n&&n.addEventListener("click",()=>{const e=document.getElementById("searchKeyword").value;e.trim()&&J(e.trim())})}function J(e){u&&p&&fetch(`${c}/user/search?keyword=${encodeURIComponent(e)}`,{headers:{"user-id":u.id,"session-token":p}}).then(e=>e.json()).then(e=>{if("success"===e.status)K(e.users);else{const t=document.getElementById("searchResults");t&&(t.innerHTML='<div class="search-result-item">æœç´¢å¤±è´¥: '+e.message+"</div>")}}).catch(()=>{const e=document.getElementById("searchResults");e&&(e.innerHTML='<div class="search-result-item">æœç´¢å¤±è´¥: ç½‘ç»œé”™è¯¯</div>')})}function K(e){const t=document.getElementById("searchResults");t&&(t.innerHTML="",0!==e.length?e.forEach(e=>{const n=document.createElement("div");n.className="search-result-item";let s="";if(e.avatarUrl&&"string"===typeof e.avatarUrl?s=e.avatarUrl.trim():e.avatar_url&&"string"===typeof e.avatar_url?s=e.avatar_url.trim():e.avatar&&"string"===typeof e.avatar&&(s=e.avatar.trim()),s){const e=/\.(jpg|jpeg|png|gif|webp|bmp)$/i;s.match(e)||s.includes("/avatar/")||s.includes("/upload/")||(s="")}if(s){const e=/\.(jpg|jpeg|png|gif|webp|bmp)$/i;s.match(e)||s.includes("/avatar/")||s.includes("/upload/")||(s="")}let o="";if(s){const t=/\.svg$/i.test(s);if(t){const t=e.nickname?e.nickname.charAt(0).toUpperCase():"U";o=`<span class="user-avatar">${t}</span>`}else{const t=`${c}${s}`;o=`<span class="user-avatar"><img src="${t}" alt="${e.nickname}"></span>`}}else{const t=e.nickname?e.nickname.charAt(0).toUpperCase():"U";o=`<span class="user-avatar">${t}</span>`}n.innerHTML=`\n            ${o}\n            <div class="search-result-info">\n                <div class="search-result-nickname">${e.nickname}</div>\n                <div class="search-result-username">@${e.username}</div>\n            </div>\n            <button class="add-friend-btn" data-user-id="${e.id}" data-user-nickname="${e.nickname}" data-user-avatar="${s}">+</button>\n        `;const a=n.querySelector(".add-friend-btn");a.addEventListener("click",()=>{Q(e.id)});const i=n.querySelector(".user-avatar");i.addEventListener("click",t=>{t.stopPropagation(),X(t,e)}),n.addEventListener("click",t=>{t.target.classList.contains("add-friend-btn")||t.target.closest(".user-avatar")||V(e)}),t.appendChild(n)}):t.innerHTML='<div class="search-result-item">æœªæ‰¾åˆ°åŒ¹é…çš„ç”¨æˆ·</div>')}function V(e){const t=document.getElementById("userProfileModal"),n=document.getElementById("modalUserAvatar"),s=document.getElementById("modalUserInitials"),o=document.getElementById("modalUserNickname"),a=document.getElementById("modalUsername"),i=document.getElementById("modalUserId"),r=document.getElementById("modalUserStatus");if(!t||!n||!s||!o||!a||!i||!r)return;let l="";if(e.avatarUrl&&"string"===typeof e.avatarUrl?l=e.avatarUrl.trim():e.avatar_url&&"string"===typeof e.avatar_url?l=e.avatar_url.trim():e.avatar&&"string"===typeof e.avatar&&(l=e.avatar.trim()),l){const e=/\.(jpg|jpeg|png|gif|webp|bmp)$/i;l.match(e)||l.includes("/avatar/")||l.includes("/upload/")||(l="")}const d=/\.svg$/i.test(l);if(l&&!d){let e="";e=l.startsWith("http://")||l.startsWith("https://")?l:`${c}${l}`,n.src=e,n.style.display="block",n.style.width="120px",n.style.height="120px",n.style.visibility="visible",s.style.display="none",s.style.visibility="hidden"}else{const t=e.nickname?e.nickname.charAt(0).toUpperCase():"U";s.textContent=t,s.style.display="flex",s.style.alignItems="center",s.style.justifyContent="center",s.style.width="80px",s.style.height="80px",s.style.fontSize="32px",s.style.borderRadius="50%",s.style.backgroundColor="#f0f0f0",s.style.color="#333",s.style.border="2px solid #e0e0e0",s.style.visibility="visible",s.style.position="relative",s.style.zIndex="1",n.style.display="none",n.style.visibility="hidden",n.src=""}o.textContent=e.nickname?ot(e.nickname):"æœªçŸ¥æ˜µç§°";const u=e.username||e.name||"æœªçŸ¥ç”¨æˆ·å";a.textContent="string"===typeof u?ot(u):u,i.textContent=e.id;const p=b.some(t=>String(t.id)===String(e.id));r.textContent=p?"åœ¨çº¿":"ç¦»çº¿",t.style.display="flex";const m=t.querySelector(".modal-content");m&&m.addEventListener("click",e=>{e.stopPropagation()}),t.addEventListener("click",()=>{t.style.display="none"})}function X(e,t){e.stopPropagation();const n=document.getElementById("userAvatarPopup"),s=document.getElementById("popupAvatarImg"),o=document.getElementById("popupInitials"),a=document.getElementById("popupNickname"),i=document.getElementById("popupUsername"),r=document.getElementById("popupAddFriend");if(!n||!s||!o||!a||!i||!r)return;n.style.display="none",n.dataset.userId=t.id;const l=w.some(e=>String(e.id)===String(t.id)),d=u&&String(u.id)===String(t.id);l||d?(r.textContent="å·²æ·»åŠ ",r.style.backgroundColor="#ccc",r.style.cursor="not-allowed",r.disabled=!0,r.onclick=null):(r.textContent="æ·»åŠ å¥½å‹",r.style.backgroundColor="#3498db",r.style.cursor="pointer",r.disabled=!1,r.onclick=function(){Q(t.id),Y()});const m=()=>fetch(`${c}/user/${t.id}`,{headers:{"user-id":u.id,"session-token":p}}).then(e=>e.json()).then(e=>{if("success"===e.status)return e.user;throw new Error("è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥")}).catch(e=>(console.error("è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥:",e),null));function g(t){a.textContent=t.nickname||"æœªçŸ¥æ˜µç§°",t.username?(i.textContent=t.username,i.style.display="block"):(i.textContent="",i.style.display="none");let r="";if(t.avatarUrl&&"string"===typeof t.avatarUrl?r=t.avatarUrl.trim():t.avatar_url&&"string"===typeof t.avatar_url?r=t.avatar_url.trim():t.avatar&&"string"===typeof t.avatar&&(r=t.avatar.trim()),r){const e=`${c}${r}`;s.src=e,s.style.display="block",s.style.cursor="pointer",s.addEventListener("click",function(){openImagePreview(s.src)}),o.style.display="none"}else{const e=t.nickname?t.nickname.charAt(0).toUpperCase():"U";o.textContent=e,o.style.display="block",s.style.display="none"}n.style.display="block";const l=n.getBoundingClientRect(),d=l.width,u=l.height;let p=e.clientX+window.scrollX,m=e.clientY+window.scrollY;p+d>window.innerWidth+window.scrollX&&(p=window.innerWidth+window.scrollX-d-10),m+u>window.innerHeight+window.scrollY&&(m=window.innerHeight+window.scrollY-u-10),p<window.scrollX&&(p=window.scrollX+10),m<window.scrollY&&(m=window.scrollY+10),n.style.left=`${p}px`,n.style.top=`${m}px`,setTimeout(()=>{document.addEventListener("click",Y)},0)}t.id&&t.username?g(t):m().then(e=>{g(e||t)})}function Y(){const e=document.getElementById("userAvatarPopup");e&&(e.style.display="none"),document.removeEventListener("click",Y)}function Z(){const e=document.querySelectorAll(".friend-item .user-avatar");e.forEach((e,t)=>{e.addEventListener("click",e=>{const n=w[t];n&&X(e,n)})});const t=document.querySelectorAll("#userList .user-avatar");t.forEach((e,t)=>{e.addEventListener("click",e=>{const n=b[t];n&&X(e,n)})});const n=document.querySelectorAll("#offlineUserList .user-avatar");n.forEach((e,t)=>{const n=document.querySelectorAll("#offlineUserList .user-item"),s=n[t].querySelector(".user-name").textContent,o={id:n[t].dataset.userId||"",nickname:s,avatarUrl:""};e.addEventListener("click",e=>{X(e,o)})})}function Q(e){u&&p&&fetch(`${c}/user/add-friend`,{method:"POST",headers:{"user-id":u.id,"session-token":p,"Content-Type":"application/json"},body:JSON.stringify({friendId:e})}).then(e=>e.json()).then(e=>{"success"===e.status?(G(),i.success("æ·»åŠ å¥½å‹æˆåŠŸ")):i.error("æ·»åŠ å¥½å‹å¤±è´¥: "+e.message)}).catch(e=>{i.error("æ·»åŠ å¥½å‹å¤±è´¥: ç½‘ç»œé”™è¯¯")})}function ee(){const e=document.getElementById("sendPrivateMessage");e&&e.addEventListener("click",()=>{ne()});const t=document.getElementById("privateMessageInput");t&&t.addEventListener("keydown",e=>{if("Enter"!==e.key||e.shiftKey||e.ctrlKey)if("Enter"===e.key&&e.ctrlKey&&!e.shiftKey)if(e.preventDefault(),"DIV"===t.tagName&&t.isContentEditable){const e=window.getSelection(),t=e.getRangeAt(0),n=document.createElement("br");t.deleteContents(),t.insertNode(n),t.setStartAfter(n),t.setEndAfter(n),e.removeAllRanges(),e.addRange(t)}else{const e=t.selectionStart,n=t.selectionEnd,s=t.value;t.value=s.substring(0,e)+"\n"+s.substring(n);const o=e+1;t.setSelectionRange(o,o),t.focus()}else"Enter"===e.key&&e.shiftKey&&e.ctrlKey;else e.preventDefault(),ne()});const n=document.getElementById("privateMarkdownToolbar");if(n){const e=n.querySelectorAll(".markdown-btn");e.forEach(e=>{e.addEventListener("click",function(t){t.stopPropagation();const n=e.getAttribute("data-prefix")||"",s=e.getAttribute("data-suffix")||"",o=e.getAttribute("data-sample")||"";te(n,s,o)})})}const s=document.getElementById("privateImageUploadButton"),o=document.getElementById("privateImageInput");s&&o&&(s.onclick=null,o.onchange=null,s.onclick=()=>{o.click()},o.onchange=function(){this.files&&this.files[0]&&O(this.files[0])});const a=document.getElementById("privateFileUploadButton"),i=document.getElementById("privateFileInput");a&&i&&(a.onclick=null,i.onchange=null,a.onclick=()=>{i.click()},i.onchange=function(){this.files&&this.files[0]&&(this.files[0].type.startsWith("image/")?O(this.files[0]):F(this.files[0]))}),t&&t.addEventListener("paste",function(e){const t=e.clipboardData.items;for(const n of t){if(n.type.startsWith("image/")){e.preventDefault();const t=n.getAsFile();t&&O(t);break}if("application/octet-stream"===n.type){e.preventDefault();const t=n.getAsFile();t&&F(t);break}}})}function te(e,t,n){let s=null;const o=document.querySelector(".chat-content.active");if(o){const e=o.getAttribute("data-content");switch(e){case"public-chat":s=document.getElementById("messageInput");break;case"group-chat":s=document.getElementById("groupMessageInput");break;case"private-chat":s=document.getElementById("privateMessageInput");break;default:s=document.activeElement}}else s=document.activeElement;if(!s||!s.isContentEditable){const e=document.querySelectorAll('.editable-div, [contenteditable="true"]');for(let t=0;t<e.length;t++)if(null!==e[t].offsetParent){s=e[t];break}if(!s||!s.isContentEditable)return}let a="";if(window.getSelection){const e=window.getSelection();a=e.toString()}else document.selection&&"Control"!==document.selection.type&&(a=document.selection.createRange().text);a||(a=n),s.focus();const i=e+a+t;document.execCommand("insertText",!1,i)}function ne(){if(!u||!p||!y)return;const e=document.getElementById("privateMessageInput");if(!e)return;const t=e.innerText.trim();if(!t)return;const n=w.some(e=>String(e.id)===String(y));if(!n)return void i.error("æ‚¨ä¸è¯¥ç”¨æˆ·ä¸æ˜¯å¥½å‹ï¼Œæ— æ³•å‘é€ç§ä¿¡");const s={userId:u.id,content:t,receiverId:y,sessionToken:p};window.chatSocket&&window.chatSocket.emit("private-message",s),e.innerHTML=""}function se(){const e=document.getElementById("deleteFriendButton");e&&(e.onclick=null,e.onclick=()=>{y&&oe(y)});const t=document.getElementById("privateUserInfoButton");t&&(t.onclick=null,t.onclick=()=>{if(y&&h){const e=document.getElementById("privateUserAvatar");let t="";e&&e.src&&""!==e.src&&(e.src.startsWith(c)?t=e.src.replace(c,""):e.src.startsWith("http")&&(t=e.src));const n={id:y,nickname:v,avatarUrl:t,username:h};V(n)}});const n=document.getElementById("privateMoreButton");n&&(n.onclick=null,n.onclick=e=>{e.stopPropagation();const t=document.getElementById("privateMoreFunctions");t&&t.classList.toggle("show")});const s=document.getElementById("togglePrivateMarkdownToolbar");s&&s.addEventListener("click",()=>{const e=document.getElementById("privateMarkdownToolbar");if(e){e.style.display="flex"===e.style.display?"none":"flex";const t=s.querySelector("i");t&&(t.style.transform="flex"===e.style.display?"rotate(180deg)":"rotate(0deg)")}});const o=document.getElementById("privateChatInterface");o&&o.addEventListener("click",function(){y&&(delete S.private[y],it(),at(),window.chatSocket&&window.chatSocket.emit("join-private-chat",{userId:u.id,friendId:y,sessionToken:p,onlyClearUnread:!0}))})}function oe(e){u&&p&&confirm("ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå¥½å‹å—ï¼Ÿ")&&fetch(`${c}/user/remove-friend`,{method:"POST",headers:{"user-id":u.id,"session-token":p,"Content-Type":"application/json"},body:JSON.stringify({friendId:e})}).then(e=>e.json()).then(t=>{if("success"===t.status){if(G(),y===e){const e=document.getElementById("privateChatInterface"),t=document.getElementById("privateEmptyState");e&&t&&(e.style.display="none",t.style.display="flex",y=null,h="")}i.success("åˆ é™¤å¥½å‹æˆåŠŸ")}else i.error("åˆ é™¤å¥½å‹å¤±è´¥: "+t.message)}).catch(e=>{i.error("åˆ é™¤å¥½å‹å¤±è´¥: ç½‘ç»œé”™è¯¯")})}function ae(){window.chatSocket&&(window.chatSocket.disconnect(),window.chatSocket=null),localStorage.removeItem("currentUser"),localStorage.removeItem("currentSessionToken"),localStorage.removeItem("chatUserId"),localStorage.removeItem("chatUserNickname"),localStorage.removeItem("chatSessionToken"),localStorage.removeItem("chatUserAvatar"),localStorage.removeItem("userId"),localStorage.removeItem("nickname"),localStorage.removeItem("avatarUrl"),localStorage.removeItem("sessionToken"),d={currentGroupId:null,currentGroupName:"",currentPrivateChatUserId:null,currentPrivateChatUsername:"",currentPrivateChatNickname:"",currentPrivateChatAvatarUrl:"",currentActiveChat:"main",currentSendChatType:"main",selectedGroupIdForCard:null},u=null,p=null,m=!1,g=null,f="",y=null,h="",v="",$="main",B="main",M=null,b=[],w=[],k=!1,I=!1,x=!1,S={global:0,groups:{},private:{}},setTimeout(()=>{window.location.hash="#/login",setTimeout(()=>{window.location.reload()},100)},100)}function ie(){xe(),j(),fe(),ce(),Ct(),tt(),ue(),st(),G(),le()}function re(e){fetch(`${c}/check-status`,{method:"GET",headers:{"Content-Type":"application/json"}}).then(e=>{if(!e.ok)throw new Error(`HTTPé”™è¯¯! çŠ¶æ€ç : ${e.status}`);return e.json()}).then(t=>{if(t.isBanned){const n=`æ‚¨çš„IPå·²è¢«å°ç¦ï¼Œ${t.message||"æ— æ³•è®¿é—®"}`;return i.error(n),ae(),void e(!1)}if(u&&!t.userExists)return i.error("æ‚¨çš„è´¦æˆ·å¯èƒ½å·²è¢«åˆ é™¤æˆ–ç¦ç”¨ï¼Œè¯·è”ç³»ç®¡ç†å‘˜ã€‚"),ae(),void e(!1);e(!0)}).catch(t=>{e(!0)})}function le(){const e=l(c,{transports:["websocket","polling"],reconnection:!0,reconnectionAttempts:1/0,reconnectionDelay:1e3,reconnectionDelayMax:5e3,timeout:2e4,autoConnect:!0});let t=null;e.on("connect",()=>{m=!0,u&&p&&re(n=>{if(n){let n="";u.avatarUrl&&"string"===typeof u.avatarUrl?n=u.avatarUrl.trim():u.avatar_url&&"string"===typeof u.avatar_url?n=u.avatar_url.trim():u.avatar&&"string"===typeof u.avatar&&(n=u.avatar.trim());const s={userId:u.id?String(u.id):null,nickname:u.nickname,avatarUrl:n||null,sessionToken:p};if(e.emit("user-joined",s),e.emit("get-online-users"),g){e.emit("join-group",{groupId:g,sessionToken:p,userId:u.id});const t={groupId:g,userId:u.id,sessionToken:p,limit:20};e.emit("get-group-chat-history",t)}ce(),t||(t=setInterval(()=>{m&&u&&p&&e.emit("get-online-users")},3e4))}})}),e.on("reconnect",n=>{m=!0,u&&p&&re(n=>{if(n){let n="";u.avatarUrl&&"string"===typeof u.avatarUrl?n=u.avatarUrl.trim():u.avatar_url&&"string"===typeof u.avatar_url?n=u.avatar_url.trim():u.avatar&&"string"===typeof u.avatar&&(n=u.avatar.trim());const s={userId:u.id?String(u.id):null,nickname:u.nickname,avatarUrl:n||null,sessionToken:p};if(e.emit("user-joined",s),e.emit("get-online-users"),g){e.emit("join-group",{groupId:g,sessionToken:p,userId:u.id});const t={groupId:g,userId:u.id,sessionToken:p,limit:20};e.emit("get-group-chat-history",t)}ce(),t||(t=setInterval(()=>{m&&u&&p&&e.emit("get-online-users")},3e4))}})}),e.on("disconnect",()=>{m=!1,de(),t&&(clearInterval(t),t=null)}),e.on("message-received",e=>{if(e.sessionToken&&(p=e.sessionToken,localStorage.setItem("currentSessionToken",p)),e.groupId){const t=Date.now(),n=e.timestamp?new Date(e.timestamp).getTime():t,s=t-n<1e4;e.isHistory=e.isHistory||!s,dt(e,!0,e.groupId),ge(e)}else dt(e,!1),me(e)}),e.on("message-sent",e=>{if(e.message){const t=e.message;t.isHistory=!1,t.groupId?ge(t):me(t)}}),e.on("group-message-received",e=>{e.sessionToken&&(p=e.sessionToken,localStorage.setItem("currentSessionToken",p));const t=Date.now(),n=e.timestamp?new Date(e.timestamp).getTime():t,s=t-n<1e4;e.isHistory=e.isHistory||!s,ge(e)}),e.on("online-users",e=>{nt(e)}),e.on("users-updated",e=>{nt(e),G()}),e.on("group-list",e=>{vt(e)}),e.on("group-created",()=>{const e=document.getElementById("groupList");e&&st()}),e.on("group-deleted",()=>{const e=document.getElementById("groupList");e&&st()}),e.on("group-dissolved",()=>{const e=document.getElementById("groupList");e&&st()}),e.on("friend-removed",()=>{G()}),e.on("avatar-updated",e=>{if(e.userId&&e.avatarUrl&&(G(),st(),y)){const t=document.querySelector("#privateChatInterface .chat-avatar img");t&&y===e.userId&&(t.src=`${c}${e.avatarUrl}`)}}),e.on("chat-history",e=>{e.sessionToken&&(p=e.sessionToken,localStorage.setItem("currentSessionToken",p));let t={global:0,groups:{},private:{}};e.unreadMessages&&(e.unreadMessages&&"object"===typeof e.unreadMessages&&!e.unreadMessages.hasOwnProperty("global")?t.groups=e.unreadMessages:(t.groups=e.unreadMessages.groups||{},t.global=e.unreadMessages.global||0)),e.unreadPrivateMessages&&(t.private=e.unreadPrivateMessages),S=t;const n=ut();for(const a in S.groups)S.groups.hasOwnProperty(a)&&n.includes(a)&&(S.groups[a]=0,window.chatSocket&&window.chatSocket.emit("join-group",{groupId:a,sessionToken:p,userId:u.id}));it(),at();const s=document.getElementById("messageContainer");if(!s)return;const o=s.querySelector(".empty-state");if(u&&p){if(k||(s.innerHTML="",k=!0),!e.messages||!Array.isArray(e.messages)||0===e.messages.length)return o&&(o.style.display="block"),void(window.resetLoadingState&&window.resetLoadingState());o&&(o.style.display="none");const t=[...e.messages].sort((e,t)=>void 0!==e.sequence&&void 0!==t.sequence?t.sequence-e.sequence:t.timestamp-e.timestamp),n=e.loadMore?t:t.reverse(),a=new Set,i=s.querySelectorAll("[data-id]");let r,l;if(i.forEach(e=>{a.add(e.getAttribute("data-id"))}),e.loadMore&&(r=s.scrollHeight,l=s.scrollTop),n.forEach(t=>{if(t&&t.id&&!a.has(String(t.id)))if(a.add(String(t.id)),e.loadMore){const e=me(t,!0);e&&s.insertBefore(e,s.firstChild)}else me(t)}),e.loadMore&&void 0!==r&&void 0!==l){const e=s.scrollHeight,t=e-r;s.scrollTop=l+t}else e.loadMore||(s.scrollTop=s.scrollHeight)}window.resetLoadingState&&window.resetLoadingState()}),e.on("group-chat-history",e=>{if(e.sessionToken&&(p=e.sessionToken,localStorage.setItem("currentSessionToken",p)),e.unreadMessages){let t=e.unreadMessages;t&&"object"===typeof t&&!t.hasOwnProperty("global")&&(t={global:0,groups:t}),S={global:t.global||0,groups:t.groups||{},private:t.private||{}};const n=ut();for(const e in S.groups)S.groups.hasOwnProperty(e)&&n.includes(e)&&(S.groups[e]=0,window.chatSocket&&window.chatSocket.emit("join-group",{groupId:e,sessionToken:p,userId:u.id}));at()}const t=document.getElementById("groupMessageContainer");if(!t)return void(window.resetLoadingState&&window.resetLoadingState());const n=t.querySelector(".empty-state");if(u&&p){if(I||(t.innerHTML="",I=!0),e.loadMore&&(!e.messages||!Array.isArray(e.messages)||0===e.messages.length))return void(window.resetLoadingState&&window.resetLoadingState());if(!e.messages||!Array.isArray(e.messages)||0===e.messages.length)return t.innerHTML='\n                    <div class="empty-state">\n                        <h3>æš‚æ— æ¶ˆæ¯</h3>\n                        <p>å‘é€ç¬¬ä¸€æ¡æ¶ˆæ¯å¼€å§‹ç¾¤èŠå§!</p>\n                    </div>\n                ',void(window.resetLoadingState&&window.resetLoadingState());n&&(n.style.display="none");const s=[...e.messages].sort((e,t)=>void 0!==e.sequence&&void 0!==t.sequence?t.sequence-e.sequence:t.timestamp-e.timestamp),o=e.loadMore?s:s.reverse(),a=new Set,i=t.querySelectorAll("[data-id]");let r,l;if(i.forEach(e=>{a.add(e.getAttribute("data-id"))}),e.loadMore&&(r=t.scrollHeight,l=t.scrollTop),e.loadMore?o.forEach(e=>{if(!e||!e.id)return;if(a.has(String(e.id)))return;a.add(String(e.id)),e.isHistory=!0;const n=ge(e,!0);n&&t.insertBefore(n,t.firstChild)}):o.forEach(e=>{e&&e.id&&(a.has(String(e.id))||(a.add(String(e.id)),e.isHistory=!0,ge(e)))}),e.loadMore&&void 0!==r&&void 0!==l){const e=t.scrollHeight,n=e-r;t.scrollTop=n}else setTimeout(()=>{t.scrollTop=t.scrollHeight},0)}window.resetLoadingState&&window.resetLoadingState()}),e.on("user-joined-response",e=>{if(e.sessionToken&&(p=e.sessionToken,localStorage.setItem("currentSessionToken",p)),e.unreadMessages){let t=e.unreadMessages;t&&"object"===typeof t&&!t.hasOwnProperty("global")&&(t={global:0,groups:t}),S={global:t.global||0,groups:t.groups||{},private:t.private||{}};const n=ut();for(const e in S.groups)S.groups.hasOwnProperty(e)&&n.includes(e)&&(S.groups[e]=0,window.chatSocket&&window.chatSocket.emit("join-group",{groupId:e,sessionToken:p,userId:u.id}));at()}}),e.on("login-success",e=>{e.sessionToken&&(p=e.sessionToken,localStorage.setItem("currentSessionToken",p))}),e.on("disconnect",()=>{m=!1,de()}),e.on("error",e=>{m=!1,de()}),e.on("message",e=>{Array.isArray(e)&&"session-expired"===e[0]&&(i.error("ä¼šè¯å·²è¿‡æœŸæˆ–åœ¨å…¶ä»–è®¾å¤‡ç™»å½•ï¼Œè¯·é‡æ–°ç™»å½•"),ae())}),e.on("session-expired",()=>{i.error("ä¼šè¯å·²è¿‡æœŸæˆ–åœ¨å…¶ä»–è®¾å¤‡ç™»å½•ï¼Œè¯·é‡æ–°ç™»å½•"),ae()}),e.on("account-banned",e=>{const t=`æ‚¨çš„IPå·²è¢«å°ç¦ï¼Œ${e.message||"æ— æ³•è®¿é—®"}`;i.error(t),ae()}),e.on("message-deleted",e=>{const{messageId:t}=e;if(t){const e=document.querySelector(`#messageContainer [data-id="${t}"]`);e&&e.remove();const n=document.querySelector(`#groupMessageContainer [data-id="${t}"]`);if(n&&n.remove(),A)if(11===A.nodeType){const e=A.querySelectorAll(`[data-id="${t}"]`);e.forEach(e=>{e.parentNode===A&&A.removeChild(e)})}else if("string"===typeof A){const e=new RegExp(`<div[^>]*data-id="${t}"[^>]*>.*?</div>`,"s");A=A.replace(e,"")}}}),e.on("group-name-updated",e=>{u&&p&&st()}),e.on("group-description-updated",e=>{if(u&&p){st();const t=document.getElementById("groupInfoModal");if(t&&"flex"===t.style.display){const t=document.getElementById("modalGroupNoticeValue");t&&(t.textContent=e.newDescription?ot(e.newDescription):"æš‚æ— ç¾¤ç»„å…¬å‘Š")}}}),e.on("private-message-sent",e=>{if(e.message){const t=e.message;t.isHistory=!1,_(t)}}),e.on("private-message-received",e=>{if(e.sessionToken&&(p=e.sessionToken,localStorage.setItem("currentSessionToken",p)),e.senderId===u.id||e.userId===u.id)return;e.isHistory=!1;const t=String(e.senderId),n=String(e.receiverId);_(e);const s=$===`private_${t}`;if(!C||!s){const e=String(u.id)===n?t:n;S.private[e]=(S.private[e]||0)+1,it(),at()}}),e.on("friend-list-updated",e=>{G()}),e.on("private-message-withdrawn",e=>{if(!e||!e.messageId)return;const t=document.querySelector(`#privateMessageContainer [data-id="${e.messageId}"]`);t&&t.remove()}),e.on("private-chat-history",e=>{e.sessionToken&&(p=e.sessionToken,localStorage.setItem("currentSessionToken",p));const t=document.getElementById("privateMessageContainer");if(t){if(u&&p){if(x&&e.loadMore||(t.innerHTML="",x=!0),e.loadMore&&(!e.messages||!Array.isArray(e.messages)||0===e.messages.length))return void(window.resetLoadingState&&window.resetLoadingState());if(e.messages&&Array.isArray(e.messages))if(0===e.messages.length)t.innerHTML='\n                        <div class="empty-state">\n                            <div class="empty-icon">ğŸ’¬</div>\n                            <h3>æš‚æ— æ¶ˆæ¯</h3>\n                            <p>å‘é€ç¬¬ä¸€æ¡æ¶ˆæ¯å¼€å§‹ä½ ä»¬çš„å¯¹è¯å§!</p>\n                        </div>\n                    ';else{const n=t.querySelector(".empty-state");n&&n.remove();const s=[...e.messages].sort((e,t)=>void 0!==e.sequence&&void 0!==t.sequence?t.sequence-e.sequence:new Date(t.timestampISO||t.created_at||t.timestamp)-new Date(e.timestampISO||e.created_at||e.timestamp)),o=e.loadMore?s:s.reverse(),a=new Set,i=t.querySelectorAll("[data-id]");let r,l;if(i.forEach(e=>{a.add(e.getAttribute("data-id"))}),e.loadMore&&(r=t.scrollHeight,l=t.scrollTop),e.loadMore?o.forEach(e=>{if(!e||!e.id)return;if(a.has(String(e.id)))return;a.add(String(e.id)),e.isHistory=!0;const n=_(e,!0);n&&t.insertBefore(n,t.firstChild)}):o.forEach(e=>{e&&e.id&&(a.has(String(e.id))||(a.add(String(e.id)),e.isHistory=!0,_(e)))}),e.loadMore&&void 0!==r&&void 0!==l){const e=t.scrollHeight,n=e-r;t.scrollTop=l+n}else e.loadMore||(t.scrollTop=t.scrollHeight)}else t.innerHTML='\n                    <div class="empty-state">\n                        <div class="empty-icon">ğŸ’¬</div>\n                        <h3>æš‚æ— æ¶ˆæ¯</h3>\n                        <p>å‘é€ç¬¬ä¸€æ¡æ¶ˆæ¯å¼€å§‹ä½ ä»¬çš„å¯¹è¯å§!</p>\n                    </div>\n                '}window.resetLoadingState&&window.resetLoadingState()}else window.resetLoadingState&&window.resetLoadingState()}),window.chatSocket=e,window.getChatHistory=function(e={}){window.chatSocket&&window.chatSocket.emit("get-chat-history",{userId:u.id,sessionToken:p,loadMore:e.loadMore||!1,olderThan:e.olderThan||null,limit:e.limit||20})},window.getGroupChatHistory=function(e,t={}){if(!window.chatSocket||!e)return void console.warn("âš ï¸  æ— æ³•è·å–ç¾¤ç»„èŠå¤©å†å² - WebSocketæœªè¿æ¥æˆ–ç¾¤ç»„IDæ— æ•ˆ");const n={userId:u.id,sessionToken:p,groupId:e,loadMore:t.loadMore||!1,olderThan:t.olderThan||null,limit:t.limit||20};n.loadMore,window.chatSocket.emit("get-group-chat-history",n)};const n={init:function(){this.initCreateGroupModal(),this.initGroupInfoModal(),this.initAddGroupMemberModal()},showModal:function(e){const t=document.getElementById(e);t&&(t.style.display="flex",t.style.justifyContent="center",t.style.alignItems="center",t.style.zIndex="1000",document.body.style.overflow="hidden","createGroupModal"===e&&this.loadAvailableMembers())},hideModal:function(e){const t=document.getElementById(e);t&&(t.style.display="none",document.body.style.overflow="")},initCreateGroupModal:function(){const e="createGroupModal",t=[document.getElementById("closeCreateGroupModal"),document.getElementById("cancelCreateGroup")];t.forEach(t=>{t&&t.addEventListener("click",()=>{this.hideModal(e)})});const n=document.getElementById(e);n&&n.addEventListener("click",t=>{t.target===n&&this.hideModal(e)});const s=document.getElementById("createGroupButton");s&&s.addEventListener("click",()=>{this.showModal(e),this.loadAvailableMembers()}),n&&n.addEventListener("show",()=>{this.loadAvailableMembers()}),this.bindCreateGroupSubmit()},initGroupInfoModal:function(){const e="groupInfoModal",t=[document.getElementById("closeGroupInfoModal"),document.getElementById("modalCloseButton")];t.forEach(t=>{t&&t.addEventListener("click",()=>{this.hideModal(e)})});const n=document.getElementById(e);n&&n.addEventListener("click",t=>{t.target===n&&this.hideModal(e)})},initAddGroupMemberModal:function(){const e="addGroupMemberModal",t=[document.getElementById("closeAddGroupMemberModal"),document.getElementById("cancelAddMembers")];t.forEach(t=>{t&&t.addEventListener("click",()=>{this.hideModal(e),Re()})});const n=document.getElementById(e);n&&n.addEventListener("click",t=>{t.target===n&&(this.hideModal(e),Re())});const s=document.getElementById("confirmAddMembers");s&&s.addEventListener("click",Je)},loadAvailableMembers:function(){const e=document.getElementById("groupMembersList");e&&(e.innerHTML='<div class="loading-members">æ­£åœ¨åŠ è½½å¥½å‹åˆ—è¡¨...</div>',u&&p?fetch(`${c}/user/friends`,{headers:{"user-id":u.id,"session-token":p}}).then(e=>e.json()).then(t=>{let n=[];"success"===t.status&&t.friends?n=t.friends:console.error("Failed to get friends:",t.message||"Unknown error");const s=n.filter(e=>e.id!==u.id);0===s.length?e.innerHTML='<div class="loading-members">æ²¡æœ‰å¯ç”¨çš„å¥½å‹</div>':e.innerHTML=s.map(e=>`\n                        <div class="member-item">\n                            <input type="checkbox" class="member-checkbox" id="member-${e.id}" value="${e.id}">\n                            <label for="member-${e.id}" class="member-nickname">${e.nickname||e.username}</label>\n                        </div>\n                    `).join("")}).catch(t=>{console.error("Error loading friends:",t),e.innerHTML='<div class="loading-members">åŠ è½½å¥½å‹åˆ—è¡¨å¤±è´¥</div>'}):e.innerHTML='<div class="loading-members">è¯·å…ˆç™»å½•</div>')},bindCreateGroupSubmit:function(){const e=document.getElementById("submitCreateGroup");e&&e.addEventListener("click",()=>{this.handleCreateGroupSubmit()})},handleCreateGroupSubmit:function(){const e=document.getElementById("newGroupName"),t=document.getElementById("newGroupDescription"),n=document.getElementById("createGroupMessage"),s=e.value.trim(),o=t.value.trim(),a=document.querySelectorAll(".member-checkbox:checked"),i=Array.from(a).map(e=>e.value);s?i.length<0?n&&(n.textContent="è¯·é€‰æ‹©æˆå‘˜",n.className="create-group-message error"):(n&&(n.textContent="",n.className="create-group-message"),fetch(`${c}/create-group`,{method:"POST",headers:{"Content-Type":"application/json","user-id":u.id,"session-token":p},body:JSON.stringify({userId:u.id,groupName:s,description:o,memberIds:i})}).then(e=>e.json()).then(e=>{"success"===e.status?(n&&(n.textContent="ç¾¤ç»„åˆ›å»ºæˆåŠŸ",n.className="create-group-message success"),st(),setTimeout(()=>{this.hideModal("createGroupModal")},1e3)):n&&(n.textContent=e.message||"ç¾¤ç»„åˆ›å»ºå¤±è´¥",n.className="create-group-message error")}).catch(e=>{n&&(n.textContent="åˆ›å»ºç¾¤ç»„å¤±è´¥ï¼Œç½‘ç»œé”™è¯¯",n.className="create-group-message error")})):n&&(n.textContent="ç¾¤ç»„åç§°ä¸èƒ½ä¸ºç©º",n.className="create-group-message error")}};function s(){const e=document.getElementById("imagePreviewModal");e&&(e.style.display="none",document.body.style.overflow="")}function o(e){const t=document.getElementById("imagePreviewModal");e.target===t&&s()}n.init(),window.ModalManager=n,window.openImagePreview=function(e){const t=document.getElementById("imagePreviewModal"),n=document.getElementById("previewImgElement"),a=document.getElementById("closeImagePreviewModal");if(t&&n&&("flex"===t.style.display&&s(),n.src=e,t.style.display="flex",document.body.style.overflow="hidden"),a)a.removeEventListener("click",s),a.addEventListener("click",s);else if(t){const e=document.createElement("div");e.id="closeImagePreviewModal",e.style.position="absolute",e.style.top="10px",e.style.right="10px",e.style.width="30px",e.style.height="30px",e.style.backgroundColor="rgba(0, 0, 0, 0.5)",e.style.color="white",e.style.borderRadius="50%",e.style.display="flex",e.style.justifyContent="center",e.style.alignItems="center",e.style.cursor="pointer",e.style.zIndex="1001",e.textContent="Ã—",e.style.fontSize="20px",e.style.fontWeight="bold";const n=t.querySelector("#closeImagePreviewModal");n||t.appendChild(e),e.addEventListener("click",s)}t&&(t.removeEventListener("click",o),t.addEventListener("click",o))};const a=document.getElementById("closeImagePreviewModal");a&&a.addEventListener("click",s);const r=document.getElementById("imagePreviewModal");function d(){const e=document.querySelectorAll(".message-image");e.forEach(e=>{e.hasAttribute("data-click-added")||(e.addEventListener("click",()=>{const t=e.getAttribute("src");t&&openImagePreview(t)}),e.setAttribute("data-click-added","true"))})}function f(){const e=document.querySelectorAll(".copy-button");e.forEach(e=>{e.hasAttribute("data-click-added")||(e.addEventListener("click",()=>{const t=decodeURIComponent(e.getAttribute("data-code"));navigator.clipboard.writeText(t).then(()=>{const t=e.parentElement.querySelector(".copy-notice");t&&(t.textContent="å·²å¤åˆ¶",t.style.color="#4CAF50",setTimeout(()=>{t.textContent=""},2e3))}).catch(e=>{console.error("å¤åˆ¶å¤±è´¥:",e)})}),e.setAttribute("data-click-added","true"))})}r&&r.addEventListener("click",o),d(),f();const h=document.getElementById("messageContainer");if(h){const e=new MutationObserver(()=>{d(),f()});e.observe(h,{childList:!0,subtree:!0})}const v=document.getElementById("groupMessageContainer");if(v){const e=new MutationObserver(()=>{d(),f()});e.observe(v,{childList:!0,subtree:!0})}const b=document.getElementById("privateMessageContainer");if(b){const e=new MutationObserver(()=>{d(),f()});e.observe(b,{childList:!0,subtree:!0})}window.updateAllMessagesNickname=function(e,t){if(!e||"string"!==typeof e||!t||"string"!==typeof t)return;const n=document.querySelectorAll(".message");n.forEach(n=>{const s=n.querySelector(".message-header");if(s){const o=n.classList.contains("own-message");if(o&&u&&String(u.id)===String(e)){const e=s.querySelector(".message-sender");e&&(e.textContent=t)}else{const o=n.getAttribute("data-user-id");if(o&&String(o)===String(e)){const e=s.querySelector(".message-sender");e&&(e.textContent=t)}}}})}}function ce(){const e=document.getElementById("messageInput"),t=document.getElementById("sendButton"),n=document.getElementById("imageUploadButton"),s=document.getElementById("fileUploadButton");e&&(e.removeAttribute("disabled"),e.placeholder="è¾“å…¥æ¶ˆæ¯..."),t&&t.removeAttribute("disabled"),n&&n.removeAttribute("disabled"),s&&s.removeAttribute("disabled");const o=document.getElementById("groupMessageInput"),a=document.getElementById("sendGroupMessage"),i=document.getElementById("groupImageUploadButton"),r=document.getElementById("groupFileUploadButton");o&&(o.removeAttribute("disabled"),o.placeholder="è¾“å…¥ç¾¤ç»„æ¶ˆæ¯..."),a&&a.removeAttribute("disabled"),i&&i.removeAttribute("disabled"),r&&r.removeAttribute("disabled")}function de(){if(!u||!p){const e=document.getElementById("messageInput"),t=document.getElementById("sendButton"),n=document.getElementById("imageUploadButton"),s=document.getElementById("fileUploadButton");e&&(e.setAttribute("disabled","disabled"),e.placeholder="è¯·å…ˆç™»å½•"),t&&t.setAttribute("disabled","disabled"),n&&n.setAttribute("disabled","disabled"),s&&s.setAttribute("disabled","disabled");const o=document.getElementById("groupMessageInput"),a=document.getElementById("sendGroupMessage"),i=document.getElementById("groupImageUploadButton"),r=document.getElementById("groupFileUploadButton");o&&(o.setAttribute("disabled","disabled"),o.placeholder="è¯·å…ˆç™»å½•"),a&&a.setAttribute("disabled","disabled"),i&&i.setAttribute("disabled","disabled"),r&&r.setAttribute("disabled","disabled")}}function ue(){u&&p&&fetch(`${c}/offline-users`,{headers:{"user-id":u.id,"session-token":p}}).then(e=>e.json()).then(e=>{"success"===e.status&&pe(e.users)}).catch(e=>{})}function pe(e){const t=document.getElementById("offlineUserList");if(!t)return;if(t.innerHTML="",!e||0===e.length)return void(t.innerHTML="<li>æš‚æ— ç¦»çº¿ç”¨æˆ·</li>");const n=e.filter(e=>!b.some(t=>t.id==e.id));0!==n.length?(n.forEach(e=>{const n=document.createElement("li");let s="";e.avatarUrl&&"string"===typeof e.avatarUrl?s=e.avatarUrl.trim():e.avatar_url&&"string"===typeof e.avatar_url?s=e.avatar_url.trim():e.avatar&&"string"===typeof e.avatar&&(s=e.avatar.trim());let o="";const a=s&&/\.svg$/i.test(s);if(s&&!a)o=`<span class="user-avatar"><img src="${c}${s}" alt="${e.nickname}"></span>`;else{const t=e.nickname.charAt(0).toUpperCase();o=`<span class="user-avatar">${t}</span>`}n.setAttribute("data-user-id",e.id),n.innerHTML=`\n            ${o}\n            <span class="user-name">${e.nickname}</span>\n            <span class="user-status offline"></span>\n        `,n.style.padding="8px 0",n.style.borderBottom="1px solid #f1f1f1",n.style.display="flex",n.style.alignItems="center",n.className="user-item",t.appendChild(n)}),Z()):t.innerHTML="<li>æš‚æ— ç¦»çº¿ç”¨æˆ·</li>"}function me(e,t=!1){const n=document.getElementById("messageContainer");if(!e)return;if(n&&document.querySelector(`#messageContainer [data-id="${e.id}"]`))return;if(!n&&!A)return;if(!e.messageType&&!e.content&&!e.imageUrl&&!e.fileUrl&&!e.text)return;const s=e.user||{id:e.userId,nickname:e.nickname,avatarUrl:e.avatarUrl},o=s.id,a=s.nickname||"æœªçŸ¥ç”¨æˆ·",i=s.avatarUrl,l=u&&String(u.id)===String(o),d=document.createElement("div");function m(e){if("string"!==typeof e)return e;const t=document.createElement("div");return t.textContent=e,t.innerHTML}d.className="message "+(l?"own-message":"other-message"),d.setAttribute("data-id",e.id),void 0!==e.sequence&&d.setAttribute("data-sequence",e.sequence),l?(d.style.marginLeft="20%",d.style.marginRight="10px",d.style.backgroundColor="#E8F5E8",d.style.borderRadius="18px",d.style.padding="10px 15px",d.style.maxWidth="80%",d.style.minWidth="70px",d.style.alignSelf="flex-end"):(d.style.marginLeft="10px",d.style.marginRight="20%",d.style.backgroundColor="#FFFFFF",d.style.borderRadius="18px",d.style.padding="10px 15px",d.style.maxWidth="80%",d.style.minWidth="70px",d.style.alignSelf="flex-start",d.style.border="1px solid #E0E0E0"),d.style.display="flex",d.style.flexDirection="column",d.style.marginBottom="10px";let g=e.content||"";if("undefined"!==typeof r)try{const t=new r.Renderer;t.code=function({text:e,lang:t,escaped:n}){const s=t||"code",o=e,a=o.split("\n"),i=a.map((e,t)=>`<span class="line">${t+1}</span>`).join(""),r=encodeURIComponent(o),l=`<figure class="highlight">\n            <div class="highlight-tools">\n                <div class="macStyle">\n                    <div class="mac-close"></div>\n                    <div class="mac-minimize"></div>\n                    <div class="mac-maximize"></div>\n                </div>\n                <div class="code-lang">${s}</div>\n                <div class="copy-notice"></div>\n                <i class="fas fa-paste copy-button" data-code="${r}"></i>\n                <i class="fa-solid fa-up-right-and-down-left-from-center fullpage-button"></i>\n            </div>\n            <table>\n                <tbody>\n                    <tr>\n                        <td class="gutter">\n                            <pre>${i}</pre>\n                        </td>\n                        <td class="code">\n                            <pre><code>${o}</code></pre>\n                        </td>\n                    </tr>\n                </tbody>\n            </table>\n        </figure>`;return l},r.setOptions({breaks:!0,gfm:!0,renderer:t});let n=e.content||"";if(n=m(n),c){n=n.replace(/!\[([^\]]+)\]\(([^)]+)\)/g,(e,t,n)=>{const s=n.trim();return!s||s.startsWith("http")||s.startsWith("//")?e:`![${t}](${c}${s})`}),n=n.replace(/\[([^\]]+)\]\(([^)]+)\)/g,(e,t,n)=>{const s=n.trim();return!s||s.startsWith("http")||s.startsWith("//")?e:/^[a-zA-Z0-9-]+\.[a-zA-Z]{2,}(\.[a-zA-Z]{2,})?(:\d+)?/.test(s)?`[${t}](https://${s})`:`[${t}](${c}${s})`});const e=/(?<!\]\()(?<!\[)(?<!https?:\/\/[^?&"'<>\s]+\?.*)(?<!https?:\/\/[^?&"'<>\s]+&.*)(https?:\/\/(?:[^\s"'<>]+))/g;n=n.replace(e,"[$1]($1)")}g=r.parse(n).trim(),g=g.replace(/<svg[^>]*>.*?<\/svg>/gi,"[SVGå›¾ç‰‡]"),g=g.replace(/<(?!\/?(a|img|div|span|br|p|h[1-6]|strong|em|code|pre|ul|ol|li|blockquote|figure|table|tbody|tr|td|i)\b)[^>]*>/gi,""),g=g.replace(/<a([^>]*)(href="([^"]*)")([^>]*)>([^<]*)<\/a>/g,(e,t,n,s,o,a)=>{const i=e.includes("download"),r=/^https?:\/\//i.test(s),l=/\.(jpg|jpeg|png|gif|bmp|webp)$/i.test(s),c=/\.(pdf|doc|docx|txt|rtf|xls|xlsx|csv|zip|rar|7z|tar|gz|mp3|wav|ogg|flac|mp4|avi|mov|wmv|flv|exe|dll|bat|sh|ppt|pptx|js|ts|html|css|php|py|java|c|cpp|cs|go|rb|swift|kt|svg)$/i,d=c.test(s);if(l)return e;if(i||!r&&d){const e=s.split(".").pop().toLowerCase();let i="ğŸ“„";return/^(pdf|doc|docx|txt|rtf)$/i.test(e)?i="ğŸ“":/^(xls|xlsx|csv)$/i.test(e)?i="ğŸ“Š":/^(zip|rar|7z|tar|gz)$/i.test(e)?i="ğŸ—œï¸":/^(jpg|jpeg|png|gif|bmp|webp)$/i.test(e)?i="ğŸ–¼ï¸":/^(mp3|wav|ogg|flac)$/i.test(e)?i="ğŸµ":/^(mp4|avi|mov|wmv|flv)$/i.test(e)?i="ğŸ¬":/^(exe|dll|bat|sh)$/i.test(e)?i="âš™ï¸":/^(ppt|pptx)$/i.test(e)?i="ğŸ“‹":/^(js|ts|html|css|php|py|java|c|cpp|cs|go|rb|swift|kt)$/i.test(e)&&(i="ğŸ’»"),`<div class="file-link-container"><a${t} ${n}${o} target="_blank"><span class="file-icon">${i}</span><span>${a}</span></a></div>`}return e})}catch(S){g=m(e.content)}else g=m(e.content);g=g.replace(/<img/g,'<img class="message-image" style="max-width: 100%; height: auto; cursor: pointer;"'),g=g.replace(/<a/g,'<a class="message-link" target="_blank" rel="noopener noreferrer" style="color: #3498db; text-decoration: none;"'),g=g.replace(/<a([^>]*)(href="([^"]*)")([^>]*)>([^<]*)<\/a>/g,(e,t,n,s,o,a)=>{const i=e.includes("download"),r=/^https?:\/\//i.test(s),l=/\.(jpg|jpeg|png|gif|bmp|webp)$/i.test(s),c=/\.(pdf|doc|docx|txt|rtf|xls|xlsx|csv|zip|rar|7z|tar|gz|mp3|wav|ogg|flac|mp4|avi|mov|wmv|flv|exe|dll|bat|sh|ppt|pptx|js|ts|html|css|php|py|java|c|cpp|cs|go|rb|swift|kt|svg)$/i,d=c.test(s);if(l)return e;if(i||!r&&d){const e=s.split(".").pop().toLowerCase();let i="ğŸ“„";return/^(pdf|doc|docx|txt|rtf)$/i.test(e)?i="ğŸ“":/^(xls|xlsx|csv)$/i.test(e)?i="ğŸ“Š":/^(zip|rar|7z|tar|gz)$/i.test(e)?i="ğŸ—œï¸":/^(jpg|jpeg|png|gif|bmp|webp)$/i.test(e)?i="ğŸ–¼ï¸":/^(mp3|wav|ogg|flac)$/i.test(e)?i="ğŸµ":/^(mp4|avi|mov|wmv|flv)$/i.test(e)?i="ğŸ¬":/^(exe|dll|bat|sh)$/i.test(e)?i="âš™ï¸":/^(ppt|pptx)$/i.test(e)?i="ğŸ“‹":/^(js|ts|html|css|php|py|java|c|cpp|cs|go|rb|swift|kt)$/i.test(e)&&(i="ğŸ’»"),`<div class="file-link-container"><a${t} ${n}${o} class="file-link" target="_blank"><span class="file-icon">${i}</span><span>${a}</span></a></div>`}return e}),!e.filename||e.fileUrl||e.imageUrl||e.content&&e.content.includes(e.filename)||(g+=`<div class="message-filename" style="margin-top: 5px; color: #666; font-size: 12px;">${m(e.filename)}</div>`);let f="";const y=i&&("string"===typeof i&&/\.svg$/i.test(i)||i.includes(".svg"));i&&!y&&(f=`${c}${i}`);const h=f?`<img src="${f}" alt="${a}" class="user-avatar" style="width: 32px; height: 32px; border-radius: 50%; margin-right: 10px;">`:`<div class="user-avatar default-avatar" style="width: 32px; height: 32px; border-radius: 50%; margin-right: 10px; background-color: #e0e0e0; display: flex; align-items: center; justify-content: center; font-weight: bold; color: #666;">${a.charAt(0).toUpperCase()}</div>`;let v="",b=e.imageUrl,w=e.fileUrl,k=e.filename,I=e.content,x=null;if(void 0!==e.messageType)switch(e.messageType){case 1:try{const t=JSON.parse(e.content);b=t.url,k=t.filename,t.width&&t.height&&(e.width=t.width,e.height=t.height)}catch(S){console.error("è§£æå›¾ç‰‡æ¶ˆæ¯JSONå¤±è´¥:",S)}break;case 2:try{const t=JSON.parse(e.content);w=t.url,k=t.filename}catch(S){console.error("è§£ææ–‡ä»¶æ¶ˆæ¯JSONå¤±è´¥:",S)}break;case 3:try{x=JSON.parse(e.content),"group_card"===x.type&&x.group_id||(x=null)}catch(S){console.error("è§£æç¾¤åç‰‡æ¶ˆæ¯JSONå¤±è´¥:",S),x=null}break;default:I=e.content;break}if(b&&null!==b&&""!==b){const t=b.startsWith("http")?b:`${c}${b}`;let n="",s="";e.width&&e.height&&(n=`width="${e.width}"`,s=`height="${e.height}"`),v+=`<img src="${m(t)}" alt="${m(k||"å›¾ç‰‡")}" ${n} ${s} class="message-image" style="max-width: 100%; height: auto; cursor: pointer;">`}if(w&&null!==w&&""!==w){const e=w.startsWith("http")?w:`${c}${w}`,t=k||"æ–‡ä»¶",n=t.split(".").pop().toLowerCase();let s="ğŸ“„";/^(pdf|doc|docx|txt|rtf)$/i.test(n)?s="ğŸ“":/^(xls|xlsx|csv)$/i.test(n)?s="ğŸ“Š":/^(zip|rar|7z|tar|gz)$/i.test(n)?s="ğŸ—œï¸":/^(jpg|jpeg|png|gif|bmp|webp)$/i.test(n)?s="ğŸ–¼ï¸":/^(mp3|wav|ogg|flac)$/i.test(n)?s="ğŸµ":/^(mp4|avi|mov|wmv|flv)$/i.test(n)?s="ğŸ¬":/^(exe|dll|bat|sh)$/i.test(n)?s="âš™ï¸":/^(ppt|pptx)$/i.test(n)?s="ğŸ“‹":/^(js|ts|html|css|php|py|java|c|cpp|cs|go|rb|swift|kt)$/i.test(n)&&(s="ğŸ’»"),v+=`<div class="file-link-container"><a href="${m(e)}" class="file-link" target="_blank" style="color: #3498db; text-decoration: none;"><span class="file-icon">${s}</span><span>${m(t)}</span></a></div>`}if(x&&(v+=`\n            <div class="group-card-container" style="background-color: #f0f8ff; border: 1px solid #3498db; border-radius: 8px; padding: 10px; cursor: pointer; margin-top: 5px;">\n                <div class="group-card-header" style="font-weight: bold; color: #3498db; margin-bottom: 5px; display: flex; align-items: center; gap: 8px;">\n                    ${x.avatar_url?`<img src="${c}${x.avatar_url}" alt="${x.group_name}" style="width: 20px; height: 20px; border-radius: 50%; object-fit: cover; cursor: pointer;" onclick="openImagePreview('${c}${x.avatar_url}')">`:`<div style="width: 20px; height: 20px; border-radius: 50%; background-color: #3498db; color: white; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold;">${x.group_name.charAt(0).toUpperCase()}</div>`}\n                    ${x.group_name}\n                </div>\n                <div class="group-card-description" style="color: #666; font-size: 14px; margin-bottom: 5px;">\n                    ${x.group_description||"æš‚æ— å…¬å‘Š"}\n                </div>\n                <div class="group-card-footer" style="font-size: 12px; color: #999;">\n                    ç‚¹å‡»æŸ¥çœ‹ç¾¤ç»„è¯¦æƒ…\n                </div>\n            </div>\n        `),g&&""!==g.trim()&&!(w||b||x)&&(v+=g),d.innerHTML=`\n        <div class="message-header" style="display: flex; align-items: center; margin-bottom: 5px;">\n            ${h}\n            <div style="flex: 1;">\n                <span class="message-sender" style="font-weight: bold;">${a}</span>\n                <span class="message-time" style="float: right; color: #999; font-size: 12px;">${e.timestamp?new Date(e.timestamp).toLocaleTimeString():(new Date).toLocaleTimeString()}</span>\n            </div>\n            ${l?`<button class="delete-button" data-id="${e.id}" title="æ’¤å›æ¶ˆæ¯" style="background: none; border: none; color: #999; font-size: 16px; cursor: pointer; margin-left: 10px;">Ã—</button>`:""}\n        </div>\n        <div class="message-content">${v}</div>\n    `,l){const e=d.querySelector(".delete-button");e&&e.addEventListener("click",function(e){e.stopPropagation();const t=this.getAttribute("data-id");t&&window.chatSocket.emit("delete-message",{messageId:t,sessionToken:p,userId:u.id})})}if(x){const e=d.querySelector(".group-card-container");e&&e.addEventListener("click",function(e){e.stopPropagation(),Ee(e,x)})}const E=d.querySelector(".user-avatar");if(E&&E.addEventListener("click",e=>{e.stopPropagation(),X(e,s)}),t)return d;if(n){"undefined"!==typeof renderMathInElement&&renderMathInElement(d,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1}]});const e=n.querySelector(".empty-state");e&&(e.style.display="none"),n.appendChild(d);const t=n.scrollHeight-n.scrollTop-n.clientHeight,s=t<=150;(s||l)&&setTimeout(()=>{n.scrollTop=n.scrollHeight},0)}else A&&(11===A.nodeType?A.appendChild(d.cloneNode(!0)):"string"===typeof A&&(A+=d.outerHTML))}function ge(e,t=!1){const n=document.getElementById("groupMessageContainer");if(!n&&!A)return;if(!e)return;const s=e.groupId,o=t||e.isHistory||!1,a=String($),i=String(s);if(s&&$&&i!==a&&!o){L[i]||(L[i]=[]);const t=L[i].some(t=>t.id===e.id);return void(t||L[i].push(e))}function l(e){const t=e.content||e.text||"empty",n=e.userId||e.senderId||"unknown",s=e.timestamp||e.createdAt||"unknown",o=`${n}-${s}-${JSON.stringify(t)}`;let a=0;for(let i=0;i<o.length;i++){const e=o.charCodeAt(i);a=(a<<5)-a+e,a&=a}return Math.abs(a).toString(16)}const d=e.identifier||l(e);if(document.querySelector(`#groupMessageContainer [data-identifier="${d}"]`))return;if(!e.messageType&&!e.content&&!e.imageUrl&&!e.fileUrl&&!e.text)return;const m=e.user||{id:e.userId,nickname:e.nickname,avatarUrl:e.avatarUrl},g=m.id,f=m.nickname||"æœªçŸ¥ç”¨æˆ·",y=m.avatarUrl,h=u&&String(u.id)===String(g),v=document.createElement("div");function b(e){if("string"!==typeof e)return e;const t=document.createElement("div");return t.textContent=e,t.innerHTML}v.className="message "+(h?"own-message":"other-message"),e.id&&v.setAttribute("data-id",e.id),v.setAttribute("data-identifier",d),void 0!==e.sequence&&v.setAttribute("data-sequence",e.sequence),h?(v.style.marginLeft="20%",v.style.marginRight="10px",v.style.backgroundColor="#E8F5E8",v.style.borderRadius="18px",v.style.padding="10px 15px",v.style.maxWidth="80%",v.style.alignSelf="flex-end"):(v.style.marginLeft="10px",v.style.marginRight="20%",v.style.backgroundColor="#FFFFFF",v.style.borderRadius="18px",v.style.padding="10px 15px",v.style.maxWidth="80%",v.style.alignSelf="flex-start",v.style.border="1px solid #E0E0E0"),v.style.display="flex",v.style.flexDirection="column",v.style.marginBottom="10px";let w=e.content||"";if("undefined"!==typeof r)try{const t=new r.Renderer;t.code=function({text:e,lang:t,escaped:n}){const s=t||"code",o=e,a=o.split("\n"),i=a.map((e,t)=>`<span class="line">${t+1}</span>`).join(""),r=encodeURIComponent(o),l=`<figure class="highlight">\n            <div class="highlight-tools">\n                <div class="macStyle">\n                    <div class="mac-close"></div>\n                    <div class="mac-minimize"></div>\n                    <div class="mac-maximize"></div>\n                </div>\n                <div class="code-lang">${s}</div>\n                <div class="copy-notice"></div>\n                <i class="fas fa-paste copy-button" data-code="${r}"></i>\n                <i class="fa-solid fa-up-right-and-down-left-from-center fullpage-button"></i>\n            </div>\n            <table>\n                <tbody>\n                    <tr>\n                        <td class="gutter">\n                            <pre>${i}</pre>\n                        </td>\n                        <td class="code">\n                            <pre><code>${o}</code></pre>\n                        </td>\n                    </tr>\n                </tbody>\n            </table>\n        </figure>`;return l},r.setOptions({breaks:!0,gfm:!0,renderer:t});let n=e.content||"";if(n=b(n),c){n=n.replace(/!\[([^\]]+)\]\(([^)]+)\)/g,(e,t,n)=>{const s=n.trim();return!s||s.startsWith("http")||s.startsWith("//")?e:`![${t}](${c}${s})`}),n=n.replace(/\[([^\]]+)\]\(([^)]+)\)/g,(e,t,n)=>{const s=n.trim();return!s||s.startsWith("http")||s.startsWith("//")?e:/^[a-zA-Z0-9-]+\.[a-zA-Z]{2,}(\.[a-zA-Z]{2,})?(:\d+)?/.test(s)?`[${t}](https://${s})`:`[${t}](${c}${s})`});const e=/(?<!\]\()(?<!\[)(?<!https?:\/\/[^?&"'<>\s]+\?.*)(?<!https?:\/\/[^?&"'<>\s]+&.*)(https?:\/\/(?:[^\s"'<>]+))/g;n=n.replace(e,"[$1]($1)")}w=r.parse(n).trim(),w=w.replace(/<svg[^>]*>.*?<\/svg>/gi,"[SVGå›¾ç‰‡]"),w=w.replace(/<(?!\/?(a|img|div|span|br|p|h[1-6]|strong|em|code|pre|ul|ol|li|blockquote|figure|table|tbody|tr|td|i)\b)[^>]*>/gi,"")}catch(N){w=b(e.content)}else w=b(e.content);w=w.replace(/<img/g,'<img class="message-image" style="max-width: 100%; height: auto; cursor: pointer;"'),w=w.replace(/<a/g,'<a class="message-link" target="_blank" rel="noopener noreferrer" style="color: #3498db; text-decoration: none;"'),w=w.replace(/<a([^>]*)(href="([^"]*)")([^>]*)>([^<]*)<\/a>/g,(e,t,n,s,o,a)=>{const i=e.includes("download"),r=/^https?:\/\//i.test(s),l=/\.(jpg|jpeg|png|gif|bmp|webp)$/i.test(s),c=/\.(pdf|doc|docx|txt|rtf|xls|xlsx|csv|zip|rar|7z|tar|gz|mp3|wav|ogg|flac|mp4|avi|mov|wmv|flv|exe|dll|bat|sh|ppt|pptx|js|ts|html|css|php|py|java|c|cpp|cs|go|rb|swift|kt|svg)$/i,d=c.test(s);if(l)return e;if(i||!r&&d){const e=s.split(".").pop().toLowerCase();let i="ğŸ“„";return/^(pdf|doc|docx|txt|rtf)$/i.test(e)?i="ğŸ“":/^(xls|xlsx|csv)$/i.test(e)?i="ğŸ“Š":/^(zip|rar|7z|tar|gz)$/i.test(e)?i="ğŸ—œï¸":/^(jpg|jpeg|png|gif|bmp|webp)$/i.test(e)?i="ğŸ–¼ï¸":/^(mp3|wav|ogg|flac)$/i.test(e)?i="ğŸµ":/^(mp4|avi|mov|wmv|flv)$/i.test(e)?i="ğŸ¬":/^(exe|dll|bat|sh)$/i.test(e)?i="âš™ï¸":/^(ppt|pptx)$/i.test(e)?i="ğŸ“‹":/^(js|ts|html|css|php|py|java|c|cpp|cs|go|rb|swift|kt)$/i.test(e)&&(i="ğŸ’»"),`<div class="file-link-container"><a${t} ${n}${o} class="file-link" target="_blank"><span class="file-icon">${i}</span><span>${a}</span></a></div>`}return e}),!e.filename||e.fileUrl||e.imageUrl||e.content&&e.content.includes(e.filename)||(w+=`<div class="message-filename" style="margin-top: 5px; color: #666; font-size: 12px;">${b(e.filename)}</div>`);let k="";const I=y&&("string"===typeof y&&/\.svg$/i.test(y)||y.includes(".svg"));y&&!I&&(k=`${c}${y}`);const x=k?`<img src="${k}" alt="${f}" class="user-avatar" style="width: 32px; height: 32px; border-radius: 50%; margin-right: 10px;">`:`<div class="user-avatar default-avatar" style="width: 32px; height: 32px; border-radius: 50%; margin-right: 10px; background-color: #e0e0e0; display: flex; align-items: center; justify-content: center; font-weight: bold; color: #666;">${f.charAt(0).toUpperCase()}</div>`;let E="",S=e.imageUrl,C=e.fileUrl,B=e.filename,M=e.content,T=null;if(void 0!==e.messageType)switch(e.messageType){case 1:try{const t=JSON.parse(e.content);S=t.url,B=t.filename}catch(N){console.error("è§£æå›¾ç‰‡æ¶ˆæ¯JSONå¤±è´¥:",N)}break;case 2:try{const t=JSON.parse(e.content);C=t.url,B=t.filename}catch(N){console.error("è§£ææ–‡ä»¶æ¶ˆæ¯JSONå¤±è´¥:",N)}break;case 3:try{T=JSON.parse(e.content),"group_card"===T.type&&T.group_id||(T=null)}catch(N){console.error("è§£æç¾¤åç‰‡æ¶ˆæ¯JSONå¤±è´¥:",N),T=null}break;default:M=e.content;break}if(S&&null!==S&&""!==S){const e=S.startsWith("http")?S:`${c}${S}`;E+=`<img src="${b(e)}" alt="${b(B||"å›¾ç‰‡")}" class="message-image" style="max-width: 100%; height: auto; cursor: pointer;">`}if(C&&null!==C&&""!==C){const e=C.startsWith("http")?C:`${c}${C}`,t=B||"æ–‡ä»¶",n=t.split(".").pop().toLowerCase();let s="ğŸ“„";/^(pdf|doc|docx|txt|rtf)$/i.test(n)?s="ğŸ“":/^(xls|xlsx|csv)$/i.test(n)?s="ğŸ“Š":/^(zip|rar|7z|tar|gz)$/i.test(n)?s="ğŸ—œï¸":/^(jpg|jpeg|png|gif|bmp|webp)$/i.test(n)?s="ğŸ–¼ï¸":/^(mp3|wav|ogg|flac)$/i.test(n)?s="ğŸµ":/^(mp4|avi|mov|wmv|flv)$/i.test(n)?s="ğŸ¬":/^(exe|dll|bat|sh)$/i.test(n)?s="âš™ï¸":/^(ppt|pptx)$/i.test(n)?s="ğŸ“‹":/^(js|ts|html|css|php|py|java|c|cpp|cs|go|rb|swift|kt)$/i.test(n)&&(s="ğŸ’»"),E+=`<div class="file-link-container"><a href="${b(e)}" class="file-link" target="_blank" style="color: #3498db; text-decoration: none;"><span class="file-icon">${s}</span><span>${b(t)}</span></a></div>`}if(T&&(E+=`\n            <div class="group-card-container" style="background-color: #f0f8ff; border: 1px solid #3498db; border-radius: 8px; padding: 10px; cursor: pointer; margin-top: 5px;">\n                <div class="group-card-header" style="font-weight: bold; color: #3498db; margin-bottom: 5px; display: flex; align-items: center; gap: 8px;">\n                    ${T.avatar_url?`<img src="${c}${T.avatar_url}" alt="${T.group_name}" style="width: 20px; height: 20px; border-radius: 50%; object-fit: cover; cursor: pointer;" onclick="openImagePreview('${c}${T.avatar_url}')">`:`<div style="width: 20px; height: 20px; border-radius: 50%; background-color: #3498db; color: white; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold;">${T.group_name.charAt(0).toUpperCase()}</div>`}\n                    ${T.group_name}\n                </div>\n                <div class="group-card-description" style="color: #666; font-size: 14px; margin-bottom: 5px;">\n                    ${T.group_description||"æš‚æ— å…¬å‘Š"}\n                </div>\n                <div class="group-card-footer" style="font-size: 12px; color: #999;">\n                    ç‚¹å‡»æŸ¥çœ‹ç¾¤ç»„è¯¦æƒ…\n                </div>\n            </div>\n        `),w&&""!==w.trim()&&!(C||S||T)&&(E+=w),v.innerHTML=`\n        <div class="message-header" style="display: flex; align-items: center; margin-bottom: 5px;">\n            ${x}\n            <div style="flex: 1;">\n                <span class="message-sender" style="font-weight: bold;">${f}</span>\n                <span class="message-time" style="float: right; color: #999; font-size: 12px;">${e.timestamp?new Date(e.timestamp).toLocaleTimeString():(new Date).toLocaleTimeString()}</span>\n            </div>\n            ${h?`<button class="delete-button" data-id="${e.id}" title="æ’¤å›æ¶ˆæ¯" style="background: none; border: none; color: #999; font-size: 16px; cursor: pointer; margin-left: 10px;">Ã—</button>`:""}\n        </div>\n        <div class="message-content">${E}</div>\n    `,h){const e=v.querySelector(".delete-button");e&&e.addEventListener("click",function(e){e.stopPropagation();const t=this.getAttribute("data-id");t&&window.chatSocket.emit("delete-message",{messageId:t,sessionToken:p,userId:u.id})})}if(T){const e=v.querySelector(".group-card-container");e&&e.addEventListener("click",function(e){e.stopPropagation(),Ee(e,T)})}const U=v.querySelector(".user-avatar");if(U&&U.addEventListener("click",e=>{e.stopPropagation(),X(e,m)}),t)return v;if(n){"undefined"!==typeof renderMathInElement&&renderMathInElement(v,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1}]});const e=n.querySelector(".empty-state");e&&(e.style.display="none"),n.appendChild(v)}else A&&(11===A.nodeType?A.appendChild(v.cloneNode(!0)):"string"===typeof A&&(A+=v.outerHTML))}function fe(){document.addEventListener("visibilitychange",rt),window.addEventListener("focus",lt),window.addEventListener("blur",lt)}function ye(){const e=document.getElementById("moreButton"),t=document.getElementById("mainMoreFunctions"),n=document.getElementById("mainInputContainer");if(e&&t&&n){const s=e.cloneNode(!0);e.parentNode.replaceChild(s,e),s.addEventListener("click",function(){t.classList.toggle("show"),n.classList.toggle("lifted")})}const s=document.getElementById("groupMoreButton"),o=document.getElementById("groupMoreFunctions"),a=document.getElementById("groupInputContainer");if(s&&o&&a){const e=s.cloneNode(!0);s.parentNode.replaceChild(e,s),e.addEventListener("click",function(){o.classList.toggle("show"),a.classList.toggle("lifted")})}const i=document.getElementById("privateMoreButton"),r=document.getElementById("privateMoreFunctions"),l=document.getElementById("privateInputContainer");if(i&&r&&l){const e=i.cloneNode(!0);i.parentNode.replaceChild(e,i),e.addEventListener("click",function(){r.classList.toggle("show"),l.classList.toggle("lifted")})}const c=document.getElementById("sendGroupCardButton"),d=document.getElementById("sendGroupCardButtonGroup"),u=document.getElementById("privateSendGroupCardButton");if(c){const e=c.cloneNode(!0);c.parentNode.replaceChild(e,c),e.addEventListener("click",function(){he("main")})}if(d){const e=d.cloneNode(!0);d.parentNode.replaceChild(e,d),e.addEventListener("click",function(){he("group")})}if(u){const e=u.cloneNode(!0);u.parentNode.replaceChild(e,u),e.addEventListener("click",function(){he("private")})}const p=document.getElementById("closeSendGroupCardModal"),m=document.getElementById("cancelSendGroupCard"),g=document.getElementById("confirmSendGroupCard");if(p){const e=p.cloneNode(!0);p.parentNode.replaceChild(e,p),e.addEventListener("click",function(){const e=document.getElementById("sendGroupCardModal");e&&(e.style.display="none",document.body.style.overflow="")})}if(m){const e=m.cloneNode(!0);m.parentNode.replaceChild(e,m),e.addEventListener("click",function(){const e=document.getElementById("sendGroupCardModal");e&&(e.style.display="none",document.body.style.overflow="")})}if(g){const e=g.cloneNode(!0);g.parentNode.replaceChild(e,g),e.addEventListener("click",function(){ve()})}}function he(e){B=e,M=null;const t=document.getElementById("sendGroupCardModal"),n=document.getElementById("sendGroupCardList");t&&(t.style.display="flex",t.style.justifyContent="center",t.style.alignItems="center",t.style.zIndex="1000",document.body.style.overflow="hidden",n.innerHTML="",fetch(`${c}/user-groups/${u.id}`,{headers:{"user-id":u.id,"session-token":p}}).then(e=>e.json()).then(e=>{if("success"===e.status){const t=e.groups;0===t.length?n.innerHTML='<div style="text-align: center; color: #666; padding: 20px;">ä½ è¿˜æ²¡æœ‰åŠ å…¥ä»»ä½•ç¾¤ç»„</div>':t.forEach(e=>{const t=document.createElement("div");t.className="send-group-card-item",t.style.display="flex",t.style.alignItems="center",t.style.margin="10px 0",t.style.padding="10px",t.style.borderRadius="5px",t.style.cursor="pointer",t.style.border="1px solid #ddd",t.style.transition="background-color 0.3s";const s=document.createElement("label");s.setAttribute("for",`group-${e.id}`),s.style.marginLeft="10px",s.style.cursor="pointer",s.style.flex="1";const o=ot(e.group_name||e.name||"æœªå‘½åç¾¤ç»„");s.textContent=o;const a=document.createElement("input");a.setAttribute("type","radio"),a.setAttribute("name","selectedGroup"),a.setAttribute("value",e.id),a.setAttribute("id",`group-${e.id}`),a.className="send-group-card-radio",t.innerHTML="",t.appendChild(a),t.appendChild(s),t.addEventListener("click",function(){document.querySelectorAll(".send-group-card-item").forEach(e=>{e.style.backgroundColor="",e.style.borderColor="#ddd"}),this.style.backgroundColor="#e8f5e8",this.style.borderColor="#3498db",M=e.id,document.getElementById("confirmSendGroupCard").disabled=!1}),n.appendChild(t)})}}).catch(e=>{n.innerHTML='<div style="text-align: center; color: #e74c3c; padding: 20px;">åŠ è½½ç¾¤ç»„åˆ—è¡¨å¤±è´¥</div>'}),t.style.display="flex")}function ve(){M&&fetch(`${c}/generate-group-token`,{method:"POST",headers:{"Content-Type":"application/json","user-id":u.id,"session-token":p},body:JSON.stringify({groupId:M})}).then(e=>e.json()).then(e=>{if("success"===e.status){const t=e.token;fetch(`${c}/group-info/${M}`,{headers:{"user-id":u.id,"session-token":p}}).then(e=>e.json()).then(e=>{if("success"===e.status){const n=e.group,s=JSON.stringify({type:"group_card",group_id:n.id,group_name:n.name,group_description:n.description||"",invite_token:t,avatar_url:n.avatar_url||n.avatarUrl||""});"main"===B?window.chatSocket.emit("send-message",{content:s,messageType:3,sessionToken:p,userId:u.id}):"group"===B?window.chatSocket.emit("send-message",{content:s,messageType:3,groupId:g,sessionToken:p,userId:u.id}):"private"===B&&window.chatSocket.emit("private-message",{content:s,messageType:3,receiverId:y,sessionToken:p,userId:u.id});const o=document.getElementById("sendGroupCardModal");o&&(o.style.display="none",document.body.style.overflow="")}})}else i.error("ç”Ÿæˆé‚€è¯·Tokenå¤±è´¥: "+(e.message||"æœªçŸ¥é”™è¯¯"))}).catch(e=>{console.error("å‘é€ç¾¤åç‰‡å¤±è´¥:",e),i.error("å‘é€ç¾¤åç‰‡å¤±è´¥ï¼Œç½‘ç»œé”™è¯¯")})}function be(){const e=document.getElementById("messageInput"),t=document.getElementById("sendButton"),n=document.getElementById("imageUploadButton"),s=document.getElementById("fileUploadButton"),o=document.getElementById("imageInput"),a=document.getElementById("fileInput"),i=document.getElementById("markdownToolbar");e&&(e.removeAttribute("disabled"),e.placeholder="è¾“å…¥æ¶ˆæ¯..."),t&&t.removeAttribute("disabled"),n&&n.removeAttribute("disabled"),s&&s.removeAttribute("disabled"),e&&t&&(t.addEventListener("click",function(){d()}),e.addEventListener("paste",function(e){const t=e.clipboardData.items;for(const n of t){if(n.type.startsWith("image/")){e.preventDefault();const t=n.getAsFile();t&&ke(t);break}if("application/octet-stream"===n.type){e.preventDefault();const t=n.getAsFile();t&&Ie(t);break}}}),e.addEventListener("keydown",function(t){if("Enter"!==t.key||t.shiftKey||t.ctrlKey)if("Enter"===t.key&&t.ctrlKey&&!t.shiftKey)if(t.preventDefault(),"DIV"===e.tagName&&e.isContentEditable)try{const e=window.getSelection(),t=e.getRangeAt(0),n=document.createElement("br");t.deleteContents(),t.insertNode(n),t.setStartAfter(n),t.setEndAfter(n),e.removeAllRanges(),e.addRange(t)}catch(n){e.innerHTML+="<br>",e.focus()}else{const t=e.selectionStart,n=e.selectionEnd,s=e.value;e.value=s.substring(0,t)+"\n"+s.substring(n);const o=t+1;e.setSelectionRange(o,o),e.focus()}else"Enter"===t.key&&t.shiftKey&&t.ctrlKey;else t.preventDefault(),d()}));const r=document.getElementById("toggleMarkdownToolbar");if(r&&i&&(i.style.display="none",we(),r.addEventListener("click",function(){"none"===i.style.display?(i.style.display="flex",this.innerHTML='<i class="fas fa-chevron-up"></i> éšè—Markdownå·¥å…·æ '):(i.style.display="none",this.innerHTML='<i class="fas fa-chevron-down"></i> MD'),we()})),we(),i){const t=i.querySelectorAll(".markdown-btn");t.forEach(t=>{t.addEventListener("click",function(t){t.stopPropagation();const n=this.getAttribute("data-prefix")||"",s=this.getAttribute("data-suffix")||"",o=this.getAttribute("data-sample")||"ç¤ºä¾‹æ–‡æœ¬";try{e.focus();const t=window.getSelection(),a=t.getRangeAt(0);if(e.contains(a.commonAncestorContainer)){const e=a.toString(),i=n+(e||o)+s,r=document.createTextNode(i);a.deleteContents(),a.insertNode(r);const l=n.length,c=e?n.length+e.length:n.length+o.length;a.setStart(r,l),a.setEnd(r,c),t.removeAllRanges(),t.addRange(a)}else{e.innerHTML+=n+o+s,e.focus();const t=window.getSelection(),a=document.createRange();a.selectNodeContents(e),a.collapse(!1),t.removeAllRanges(),t.addRange(a)}}catch(a){e.innerHTML+=n+o+s,e.focus();const t=window.getSelection(),i=document.createRange();i.selectNodeContents(e),i.collapse(!1),t.removeAllRanges(),t.addRange(i)}})})}const l=document.getElementById("toggleGroupMarkdownToolbar"),c=document.getElementById("groupMarkdownToolbar");document.getElementById("groupMessageInput");if(l&&c){c.style.display="none",we(),l.addEventListener("click",function(){"none"===c.style.display?(c.style.display="flex",this.innerHTML='<i class="fas fa-chevron-up"></i> éšè—Markdownå·¥å…·æ '):(c.style.display="none",this.innerHTML='<i class="fas fa-chevron-down"></i> MD')});const e=c.querySelectorAll(".markdown-btn");e.forEach(e=>{e.addEventListener("click",function(){const e=this.getAttribute("data-prefix")||"",t=this.getAttribute("data-suffix")||"",n=this.getAttribute("data-sample")||"ç¤ºä¾‹æ–‡æœ¬",s=document.getElementById("groupMessageInput");if(s){const o=s.selectionStart,a=s.selectionEnd,i=s.value.substring(o,a),r=e+(i||n)+t;s.value=s.value.substring(0,o)+r+s.value.substring(a);const l=o+e.length,c=i?o+e.length+i.length:o+e.length+n.length;s.setSelectionRange(l,c),s.focus()}})})}function d(){const e=document.getElementById("messageInput"),t=e.textContent.trim()||e.innerHTML.trim();if(t&&m&&window.chatSocket){const n={content:t,groupId:"main"===$?null:$,sessionToken:p,userId:u.id};window.chatSocket.emit("send-message",n),e.innerHTML=""}}n&&o&&(n.addEventListener("click",function(){o.click()}),o.addEventListener("change",function(){this.files&&this.files[0]&&ke(this.files[0])})),s&&a&&(s.addEventListener("click",function(){a.click()}),a.addEventListener("change",function(){this.files&&this.files[0]&&Ie(this.files[0])}))}function we(){const e=document.querySelector(".chat-content.active");if(e){if(e.style.marginBottom="0",e.style.paddingBottom="0",e.style.height="100%",e.style.overflow="hidden","public-chat"===e.dataset.content){const t=document.getElementById("markdownToolbar");t&&"none"!==t.style.display?e.style.paddingTop="60px":e.style.paddingTop="0"}else e.dataset.content,e.style.paddingTop="0";e.style.display="none",requestAnimationFrame(()=>{e.style.display="flex"})}}function ke(e){const t=new Image,n=new FileReader;n.onload=function(n){t.onload=function(){const n=t.width,s=t.height,o=new FormData;o.append("image",e),o.append("userId",u.id),o.append("width",n),o.append("height",s);const a="main"!==$&&!$.startsWith("private_");a&&o.append("groupId",$);const i=a?document.getElementById("groupUploadProgress"):document.getElementById("uploadProgress"),r=a?document.getElementById("groupUploadProgressBar"):document.getElementById("uploadProgressBar");i&&r&&(i.style.display="block",r.style.width="0%"),fetch(`${c}/upload`,{method:"POST",headers:{"user-id":u.id,"session-token":p},body:o}).then(e=>{if(413===e.status)throw new Error("æ–‡ä»¶è¿‡å¤§");return e.json()}).then(e=>{"success"===e.status||wt(e.message||"å›¾ç‰‡ä¸Šä¼ å¤±è´¥")}).catch(e=>{e.message&&e.message.includes("Failed to fetch")?wt("æ–‡ä»¶è¿‡å¤§"):wt(e.message||"å›¾ç‰‡ä¸Šä¼ å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•")}).finally(()=>{if(i&&(i.style.display="none"),a){const e=document.getElementById("groupImageInput");e&&(e.value="")}else{const e=document.getElementById("imageInput");e&&(e.value="")}})},t.onerror=function(){const t=new FormData;t.append("image",e),t.append("userId",u.id);const n="main"!==$&&!$.startsWith("private_");n&&t.append("groupId",$),fetch(`${c}/upload`,{method:"POST",headers:{"user-id":u.id,"session-token":p},body:t}).then(e=>e.json()).then(e=>{"success"!==e.status&&wt(e.message||"å›¾ç‰‡ä¸Šä¼ å¤±è´¥")}).catch(e=>{wt("å›¾ç‰‡ä¸Šä¼ å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•")})},t.src=n.target.result},n.readAsDataURL(e)}function Ie(e){const t=new FormData;t.append("image",e),t.append("userId",u.id);const n="main"!==$&&!$.startsWith("private_");n&&t.append("groupId",$);const s=n?document.getElementById("groupUploadProgress"):document.getElementById("uploadProgress"),o=n?document.getElementById("groupUploadProgressBar"):document.getElementById("uploadProgressBar");s&&o&&(s.style.display="block",o.style.width="0%"),fetch(`${c}/upload`,{method:"POST",headers:{"user-id":u.id,"session-token":p},body:t}).then(e=>{if(413===e.status)throw new Error("æ–‡ä»¶è¿‡å¤§");return e.json()}).then(e=>{"success"===e.status||wt(e.message||"æ–‡ä»¶ä¸Šä¼ å¤±è´¥")}).catch(e=>{e.message&&e.message.includes("Failed to fetch")?wt("æ–‡ä»¶è¿‡å¤§"):wt(e.message||"æ–‡ä»¶ä¸Šä¼ å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•")}).finally(()=>{if(s&&(s.style.display="none"),n){const e=document.getElementById("groupFileInput");e&&(e.value="")}else{const e=document.getElementById("fileInput");e&&(e.value="")}})}function xe(){const e=document.getElementById("groupSearchInput"),t=document.getElementById("clearGroupSearch");e&&t&&(e.addEventListener("input",()=>{const n=e.value.toLowerCase(),s=document.querySelectorAll("#groupList li[data-group-id]");s.forEach(e=>{const t=e.dataset.groupName.toLowerCase();t.includes(n)?e.style.display="flex":e.style.display="none"}),t.style.display=n?"inline":"none"}),t.addEventListener("click",()=>{e.value="",t.style.display="none";const n=document.querySelectorAll("#groupList li[data-group-id]");n.forEach(e=>{e.style.display="flex"})}));const n=document.getElementById("groupMessageInput"),s=document.getElementById("sendGroupMessage"),o=document.getElementById("groupImageUploadButton"),a=document.getElementById("groupFileUploadButton"),i=document.getElementById("groupImageInput"),r=document.getElementById("groupFileInput"),l=document.getElementById("groupChatInterface");function c(){if(!g)return void console.warn("âš ï¸  æ— æ³•å‘é€ç¾¤ç»„æ¶ˆæ¯ - æœªé€‰æ‹©ç¾¤ç»„");const e=document.getElementById("groupMessageInput");if(!e)return void console.error("âŒ æ— æ³•è·å–ç¾¤ç»„æ¶ˆæ¯è¾“å…¥æ¡† - å…ƒç´ ä¸å­˜åœ¨");let t="";if("DIV"===e.tagName&&e.isContentEditable){if(t=e.textContent.trim(),!t){const n=document.createElement("div");n.innerHTML=e.innerHTML,t=n.textContent.trim()}}else t=e.value||e.innerHTML||"",t=t.trim();if(t&&m&&window.chatSocket){const n={groupId:g,content:t,sessionToken:p,userId:u.id};window.chatSocket.emit("send-message",n),e.value=""}else t?m?window.chatSocket||console.warn("âš ï¸  æ— æ³•å‘é€ç¾¤ç»„æ¶ˆæ¯ - WebSocketå®ä¾‹ä¸å­˜åœ¨"):console.warn("âš ï¸  æ— æ³•å‘é€ç¾¤ç»„æ¶ˆæ¯ - æœªè¿æ¥åˆ°æœåŠ¡å™¨"):console.warn("âš ï¸  æ— æ³•å‘é€ç¾¤ç»„æ¶ˆæ¯ - æ¶ˆæ¯å†…å®¹ä¸ºç©º")}l&&l.addEventListener("click",function(){g&&(delete S.groups[g],it(),at(),window.chatSocket&&window.chatSocket.emit("join-group",{groupId:parseInt(g),sessionToken:p,userId:u.id,onlyClearUnread:!0}))}),n&&s&&(s.addEventListener("click",function(){c()}),n.addEventListener("paste",function(e){const t=e.clipboardData.items;for(const n of t){if(n.type.startsWith("image/")){e.preventDefault();const t=n.getAsFile();t&&ke(t);break}if("application/octet-stream"===n.type){e.preventDefault();const t=n.getAsFile();t&&Ie(t);break}}}),n.addEventListener("keydown",function(e){if("Enter"!==e.key||e.shiftKey||e.ctrlKey)if("Enter"===e.key&&e.ctrlKey&&!e.shiftKey)if(e.preventDefault(),"DIV"===n.tagName&&n.isContentEditable)try{const e=window.getSelection(),t=e.getRangeAt(0),n=document.createElement("br");t.deleteContents(),t.insertNode(n),t.setStartAfter(n),t.setEndAfter(n),e.removeAllRanges(),e.addRange(t)}catch(t){n.innerHTML+="<br>",n.focus()}else{const e=n,t=e.selectionStart,s=e.selectionEnd,o=e.value;e.value=o.substring(0,t)+"\n"+o.substring(s);const a=t+1;e.setSelectionRange(a,a),e.focus()}else"Enter"===e.key&&e.shiftKey&&e.ctrlKey;else e.preventDefault(),c()})),o&&i&&(o.addEventListener("click",function(){i.click()}),i.addEventListener("change",function(){this.files&&this.files[0]&&ke(this.files[0])})),a&&r&&(a.addEventListener("click",function(){r.click()}),r.addEventListener("change",function(){this.files&&this.files[0]&&Ie(this.files[0])}))}function Ee(e,t){const n=document.getElementById("groupCardPopup");n&&n.remove();const s=document.createElement("div");s.id="groupCardPopup",s.style.position="fixed",s.style.width="300px",s.style.backgroundColor="white",s.style.border="1px solid #3498db",s.style.borderRadius="8px",s.style.boxShadow="0 4px 12px rgba(0, 0, 0, 0.15)",s.style.zIndex="10000",s.style.padding="15px",s.innerHTML="";const o=document.createElement("div");o.style.display="flex",o.style.justifyContent="space-between",o.style.alignItems="center",o.style.marginBottom="10px";const a=document.createElement("div");if(a.style.display="flex",a.style.alignItems="center",a.style.gap="10px",t.avatar_url){const e=document.createElement("img");e.src=`${c}${t.avatar_url}`,e.alt=t.group_name,e.style.width="40px",e.style.height="40px",e.style.borderRadius="50%",e.style.objectFit="cover",e.style.cursor="pointer",e.addEventListener("click",function(){openImagePreview(e.src)}),a.appendChild(e)}else if(t.avatarUrl){const e=document.createElement("img");e.src=`${c}${t.avatarUrl}`,e.alt=t.group_name,e.style.width="40px",e.style.height="40px",e.style.borderRadius="50%",e.style.objectFit="cover",e.style.cursor="pointer",e.addEventListener("click",function(){openImagePreview(e.src)}),a.appendChild(e)}else{const e=t.group_name.charAt(0).toUpperCase(),n=document.createElement("div");n.style.width="40px",n.style.height="40px",n.style.borderRadius="50%",n.style.backgroundColor="#3498db",n.style.color="white",n.style.display="flex",n.style.alignItems="center",n.style.justifyContent="center",n.style.fontSize="18px",n.style.fontWeight="bold",n.textContent=e,a.appendChild(n)}const i=document.createElement("h3");i.style.margin="0",i.style.color="#3498db",i.textContent=ot(t.group_name),a.appendChild(i);const r=document.createElement("button");r.id="closeGroupCardPopup",r.style.background="none",r.style.border="none",r.style.fontSize="18px",r.style.cursor="pointer",r.style.color="#999",r.textContent="Ã—",o.appendChild(a),o.appendChild(r);const l=document.createElement("div");l.style.marginBottom="15px";const d=document.createElement("p");d.style.margin="8px 0",d.style.color="#666",d.innerHTML=`<strong>ç¾¤ç»„ID:</strong> ${t.group_id}`;const u=document.createElement("p");u.style.margin="8px 0",u.style.color="#666";const p=document.createElement("strong");p.textContent="å…¬å‘Š:",u.appendChild(p),u.appendChild(document.createTextNode(` ${ot(t.group_description)||"æš‚æ— å…¬å‘Š"}`)),l.appendChild(d),l.appendChild(u);const m=document.createElement("div");m.style.display="flex",m.style.gap="10px";const g=document.createElement("button");g.id="joinGroupButton",g.className="save-btn",g.style.flex="1",g.textContent="åŠ å…¥ç¾¤ç»„",m.appendChild(g),s.appendChild(o),s.appendChild(l),s.appendChild(m),document.body.appendChild(s),r.addEventListener("click",function(){s.remove()}),g.addEventListener("click",function(){Se(t.invite_token,t.group_id,t.group_name,s)}),document.addEventListener("click",function(t){s.contains(t.target)||t.target===e.currentTarget||s.remove()});const f=s.getBoundingClientRect(),y=f.width,h=f.height;let v=e.clientX,b=e.clientY;v+y>window.innerWidth&&(v=window.innerWidth-y-10),b+h>window.innerHeight&&(b=window.innerHeight-h-10),v<0&&(v=10),b<0&&(b=10),s.style.left=`${v}px`,s.style.top=`${b}px`}function Se(e,t,n,s){fetch(`${c}/join-group-with-token`,{method:"POST",headers:{"Content-Type":"application/json","user-id":u.id,"session-token":p},body:JSON.stringify({token:e})}).then(e=>e.json()).then(e=>{"success"===e.status?(i.success(`æˆåŠŸåŠ å…¥ç¾¤ç»„: ${n}`),s&&s.remove(),st()):i.error("åŠ å…¥ç¾¤ç»„å¤±è´¥: "+(e.message||"æœªçŸ¥é”™è¯¯"))}).catch(e=>{console.error("åŠ å…¥ç¾¤ç»„å¤±è´¥:",e),i.error("åŠ å…¥ç¾¤ç»„å¤±è´¥ï¼Œç½‘ç»œé”™è¯¯")})}function Ce(){fetch(`${c}/captcha`).then(e=>e.json()).then(e=>{if("success"===e.status){const t=document.getElementById("passwordCaptchaContainer"),n=document.getElementById("passwordCaptchaId");if(t&&n){t.innerHTML=e.captchaSvg;const s=t.querySelector("svg");s&&(s.style.border="1px solid #ddd",s.style.cursor="pointer",s.style.borderRadius="4px",s.addEventListener("click",Ce)),n.value=e.captchaId}}}).catch(e=>{console.error("è·å–éªŒè¯ç å¤±è´¥:",e)})}function $e(){const e=document.getElementById("settingsContainer");if(e){const t=e.querySelectorAll(".settings-form");t.forEach(e=>{e.addEventListener("submit",function(e){e.preventDefault(),Be(this)})})}Ce();const t=document.getElementById("selectAvatarButton"),n=document.getElementById("avatarFileInput"),s=document.getElementById("uploadAvatarButton"),o=document.getElementById("avatarPreview");t&&n&&(t.addEventListener("click",function(){n.click()}),n.addEventListener("change",function(e){const t=e.target.files[0];if(t){const e=new FileReader;e.onload=function(e){if(o){o.innerHTML="";const t=document.createElement("img");t.src=e.target.result,t.style.width="100%",t.style.height="100%",t.style.objectFit="cover",t.style.borderRadius="50%",o.appendChild(t)}},e.readAsDataURL(t),s&&(s.disabled=!1)}})),s&&s.addEventListener("click",function(){const e=n.files[0];e&&Le(e)})}function Le(e){const t=new FormData;t.append("avatar",e),t.append("userId",u.id),fetch(`${c}/upload-avatar`,{method:"POST",headers:{"session-token":p,"user-id":u.id},body:t}).then(e=>e.json()).then(e=>{if("success"===e.status){if(kt("å¤´åƒä¸Šä¼ æˆåŠŸ"),e.avatarUrl){u.avatarUrl=e.avatarUrl,localStorage.setItem("currentUser",JSON.stringify(u));const t=document.getElementById("currentUserAvatar");t&&(t.src=`${c}${e.avatarUrl}`,t.style.display="block");const n=document.getElementById("currentAvatarImg");n&&(n.src=`${c}${e.avatarUrl}`)}const t=document.getElementById("uploadAvatarButton");t&&(t.disabled=!0)}else wt(e.message||"å¤´åƒä¸Šä¼ å¤±è´¥")}).catch(e=>{wt("å¤´åƒä¸Šä¼ å¤±è´¥ï¼Œè¯·é‡è¯•")})}function Be(e){const t=e.closest(".settings-detail").getAttribute("data-setting"),n=new FormData(e),s={};if(n.forEach((e,t)=>{s[t]=e}),"change-nickname"===t){if(!s.newNickname||""===s.newNickname.trim())return void wt("æ˜µç§°ä¸èƒ½ä¸ºç©º");window.chatSocket&&(window.chatSocket.emit("update-nickname",{userId:u.id,newNickname:s.newNickname,sessionToken:p}),u.nickname=s.newNickname,localStorage.setItem("currentUser",JSON.stringify(u)),window.chatSocket.emit("broadcast-nickname-change",{userId:u.id,newNickname:s.newNickname,sessionToken:p}),updateAllMessagesNickname(u.id,s.newNickname),kt("æ˜µç§°ä¿®æ”¹æˆåŠŸ"))}else if("change-password"===t){const t=document.getElementById("oldPassword").value,n=document.getElementById("newPassword").value,s=document.getElementById("confirmPassword").value,o=document.getElementById("passwordCaptchaId").value,a=document.getElementById("passwordCaptchaCode").value;if(!t||!n||!s)return void wt("æ‰€æœ‰å¯†ç å­—æ®µéƒ½ä¸èƒ½ä¸ºç©º");if(n!==s)return void wt("æ–°å¯†ç å’Œç¡®è®¤å¯†ç ä¸ä¸€è‡´");if(n.length<6)return void wt("æ–°å¯†ç é•¿åº¦ä¸èƒ½å°‘äº6ä¸ªå­—ç¬¦");if(!o||!a)return void wt("éªŒè¯ç ä¸èƒ½ä¸ºç©º");window.chatSocket?(window.chatSocket.emit("change-password",{userId:u.id,oldPassword:t,newPassword:n,captchaId:o,captchaCode:a,sessionToken:p}),window.chatSocket.once("password-change-result",t=>{t.success?(kt("å¯†ç ä¿®æ”¹æˆåŠŸ"),e.reset(),Ce()):(wt(t.message||"å¯†ç ä¿®æ”¹å¤±è´¥"),Ce())})):wt("WebSocketè¿æ¥æœªå»ºç«‹ï¼Œæ— æ³•ä¿®æ”¹å¯†ç ")}else{let e="";switch(t){case"shortcut-settings":e="/shortcut-settings";break;case"version-info":e="/version-info";break;case"help-center":e="/help-center";break;default:return}fetch(`${c}${e}`,{method:"POST",headers:{"Content-Type":"application/json","user-id":u.id,"session-token":p},body:JSON.stringify(s)}).then(e=>e.json()).then(e=>{"success"===e.status?kt("è®¾ç½®ä¿å­˜æˆåŠŸ"):wt(e.message||"è®¾ç½®ä¿å­˜å¤±è´¥")}).catch(e=>{wt("è®¾ç½®è¯·æ±‚å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•")})}}function Me(){const e=document.getElementById("groupInfoButton"),t=document.getElementById("createGroupButton"),n=document.getElementById("leaveGroupButton");Te(t),Ae(e),Pe(n)}function Te(e){if(!e)return;const t=e.cloneNode(!0);e.parentNode.replaceChild(t,e),t.addEventListener("click",function(){const e=window.ModalManager;if(e&&"function"===typeof e.showModal)e.showModal("createGroupModal");else{const e=document.getElementById("createGroupModal"),t=document.getElementById("newGroupName"),n=document.getElementById("newGroupDescription");t.value="",n.value="",e.style.display="flex",window.ModalManager&&"function"===typeof window.ModalManager.loadAvailableMembers&&window.ModalManager.loadAvailableMembers()}})}function Ae(e){if(!e)return;const t=e.cloneNode(!0);e.parentNode.replaceChild(t,e),t.addEventListener("click",function(){g?fetch(`${c}/group-info/${g}`,{headers:{"user-id":u.id,"session-token":p}}).then(e=>{if(!e.ok)throw new Error(`HTTPé”™è¯¯! çŠ¶æ€ç : ${e.status}`);return e.json()}).then(e=>{if(!e)throw new Error("è·å–æ•°æ®å¤±è´¥");"success"===e.status?Ue(e.group,g):i.error("è·å–ç¾¤ç»„ä¿¡æ¯å¤±è´¥: "+(e.message||"æœªçŸ¥é”™è¯¯"))}).catch(e=>{console.error("è·å–ç¾¤ç»„ä¿¡æ¯é”™è¯¯:",e),e.message&&e.message.includes("HTTPé”™è¯¯")?i.error("è·å–ç¾¤ç»„ä¿¡æ¯å¤±è´¥ï¼ŒæœåŠ¡å™¨è¿”å›é”™è¯¯"):i.error("è·å–ç¾¤ç»„ä¿¡æ¯å¤±è´¥ï¼Œç½‘ç»œé”™è¯¯")}):i.warning("è¯·å…ˆé€‰æ‹©ä¸€ä¸ªç¾¤ç»„")})}function Ue(e,t){const n=document.getElementById("groupInfoModal"),s=document.getElementById("modalGroupName"),o=document.getElementById("modalGroupNameValue"),a=document.getElementById("modalGroupIdValue"),i=document.getElementById("modalGroupMemberCount"),r=document.getElementById("modalGroupOwner"),l=document.getElementById("groupManageSection");n&&(n.style.display="flex",n.style.justifyContent="center",n.style.alignItems="center",document.body.style.overflow="hidden");const d=ot(e.name);s.textContent=`${d} - ç¾¤ç»„ä¿¡æ¯`,o.textContent=d,a.textContent=e.id,i.textContent="åŠ è½½ä¸­";const p=e.creator_id||e.ownerId||e.creatorId||e.adminId,m=u.id===String(p),g=document.getElementById("modalGroupNoticeValue");g&&(g.textContent=e.description?ot(e.description):"æš‚æ— ç¾¤ç»„å…¬å‘Š");const f=document.getElementById("modalGroupAvatarValue");f&&f.remove();const y=document.createElement("div");y.id="modalGroupAvatarValue",y.style.marginBottom="15px";const h=document.createElement("div");h.style.display="flex",h.style.alignItems="center",h.style.gap="10px";const v=e.avatar_url||e.avatarUrl||"";let b="";if(v){const e=/\.svg$/i.test(v);if(e){const e=d.charAt(0).toUpperCase();b=`<div class="group-avatar-large" style="width: 80px; height: 80px; border-radius: 50%; background-color: #3498db; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 32px; color: white; cursor: pointer;">${e}</div>`}else{const e=`${c}${v}`;b=`<img src="${e}" alt="${d}" style="width: 80px; height: 80px; border-radius: 50%; object-fit: cover; cursor: pointer;">`}}else{const e=d.charAt(0).toUpperCase();b=`<div class="group-avatar-large" style="width: 80px; height: 80px; border-radius: 50%; background-color: #3498db; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 32px; color: white; cursor: pointer;">${e}</div>`}if(h.innerHTML=b,m){const e=document.createElement("button");e.id="uploadGroupAvatarBtn",e.className="edit-group-avatar-btn",e.style.padding="6px 12px",e.style.backgroundColor="#3498db",e.style.color="white",e.style.border="none",e.style.borderRadius="4px",e.style.cursor="pointer",e.style.fontSize="12px",e.textContent="ä¸Šä¼ ç¾¤å¤´åƒ",e.addEventListener("click",function(e){e.stopPropagation();const n=document.createElement("input");n.type="file",n.accept="image/*",n.style.display="none",document.body.appendChild(n),n.click(),n.addEventListener("change",function(){this.files&&this.files[0]&&Ne(t,this.files[0]),document.body.removeChild(n)})}),h.appendChild(e)}y.appendChild(h);const w=n.querySelector(".modal-body");w&&w.firstChild&&w.insertBefore(y,w.firstChild),je(m,e.description||"",t),r&&(r.textContent=`ç¾¤ä¸»ID: ${p}`),l&&(l.style.display=m?"block":"none"),Ge(m,d,t),n.style.display="flex",ze(t,m);const k=document.getElementById("refreshGroupMembers");k&&(k.onclick=function(){ze(t,m)});const I=document.getElementById("addMemberToGroup");I&&(I.onclick=function(){De(t)})}function Ne(e,t){if(!u||!p)return void i.error("è¯·å…ˆç™»å½•");const n=new FormData;n.append("avatar",t),n.append("groupId",e),n.append("userId",u.id),i.info("æ­£åœ¨ä¸Šä¼ ç¾¤å¤´åƒï¼Œè¯·ç¨å€™..."),fetch(`${c}/upload-group-avatar/${e}`,{method:"POST",headers:{"session-token":p,"user-id":u.id},body:n}).then(e=>e.json()).then(t=>{"success"===t.status?(i.success("ç¾¤å¤´åƒä¸Šä¼ æˆåŠŸ"),fetch(`${c}/group-info/${e}`,{headers:{"user-id":u.id,"session-token":p}}).then(e=>e.json()).then(t=>{if("success"===t.status){const n=document.getElementById("groupInfoModal");n&&(n.style.display="none"),setTimeout(()=>{Ue(t.group,e),st()},100)}})):i.error("ä¸Šä¼ ç¾¤å¤´åƒå¤±è´¥: "+(t.message||"æœªçŸ¥é”™è¯¯"))}).catch(e=>{i.error("ä¸Šä¼ ç¾¤å¤´åƒå¤±è´¥ï¼Œç½‘ç»œé”™è¯¯")})}function je(e,t,n){const s=document.getElementById("editGroupNoticeBtn");s&&(e?(s.style.display="inline-block",s.onclick=function(){const e=document.getElementById("modalGroupNoticeValue"),o=document.createElement("textarea");o.value=t,o.className="edit-group-notice-textarea",o.style.padding="6px",o.style.border="1px solid #dee2e6",o.style.borderRadius="4px",o.style.fontSize="14px",o.style.flex="1",o.style.minHeight="80px",o.style.resize="vertical";const a=document.createElement("button");a.textContent="ä¿å­˜",a.className="save-group-notice-btn",a.style.marginLeft="5px",a.style.padding="6px 12px",a.style.background="#27ae60",a.style.color="white",a.style.border="none",a.style.borderRadius="4px",a.style.cursor="pointer",a.style.fontSize="12px",a.style.alignSelf="flex-start";const i=document.createElement("button");i.textContent="å–æ¶ˆ",i.className="cancel-group-notice-btn",i.style.marginLeft="5px",i.style.padding="6px 12px",i.style.background="#6c757d",i.style.color="white",i.style.border="none",i.style.borderRadius="4px",i.style.cursor="pointer",i.style.fontSize="12px",i.style.alignSelf="flex-start";const r=e.parentElement;r.innerHTML="",r.appendChild(o),r.appendChild(a),r.appendChild(i),o.focus(),a.onclick=function(){const e=o.value.trim();Ve(n,e)},i.onclick=function(){const e=document.createElement("span");e.id="modalGroupNoticeValue",e.style.flex="1",e.style.wordBreak="break-word",e.textContent=t||"æš‚æ— ç¾¤ç»„å…¬å‘Š";const n=document.createElement("button");n.id="editGroupNoticeBtn",n.className="edit-group-notice-btn",n.style.padding="4px 8px",n.style.backgroundColor="#3498db",n.style.color="white",n.style.border="none",n.style.borderRadius="4px",n.style.cursor="pointer",n.style.fontSize="12px",n.textContent="ç¼–è¾‘",r.innerHTML="",r.appendChild(e),r.appendChild(n),n.onclick=s.onclick}}):s.style.display="none")}function Ge(e,t,n){const s=document.getElementById("editGroupNameBtn");s&&(e?(s.style.display="inline-block",s.onclick=function(){const e=document.getElementById("modalGroupNameValue"),o=document.createElement("input");o.type="text",o.value=t,o.className="edit-group-name-input",o.style.padding="6px",o.style.border="1px solid #dee2e6",o.style.borderRadius="4px",o.style.fontSize="14px";const a=document.createElement("button");a.textContent="ä¿å­˜",a.className="save-group-name-btn",a.style.marginLeft="5px",a.style.padding="6px 12px",a.style.background="#27ae60",a.style.color="white",a.style.border="none",a.style.borderRadius="4px",a.style.cursor="pointer",a.style.fontSize="12px";const i=document.createElement("button");i.textContent="å–æ¶ˆ",i.className="cancel-group-name-btn",i.style.marginLeft="5px",i.style.padding="6px 12px",i.style.background="#6c757d",i.style.color="white",i.style.border="none",i.style.borderRadius="4px",i.style.cursor="pointer",i.style.fontSize="12px";const r=e.parentElement;r.innerHTML="",r.appendChild(o),r.appendChild(a),r.appendChild(i),o.focus(),a.onclick=function(){const e=o.value.trim();e&&e!==t&&Ke(n,e)},i.onclick=function(){const e=document.createElement("span");e.id="modalGroupNameValue",e.textContent=t;const n=document.createElement("button");n.id="editGroupNameBtn",n.className="edit-group-name-btn",n.style.padding="4px 8px",n.style.backgroundColor="#3498db",n.style.color="white",n.style.border="none",n.style.borderRadius="4px",n.style.cursor="pointer",n.style.fontSize="12px",n.textContent="ç¼–è¾‘",r.innerHTML="",r.appendChild(e),r.appendChild(n),n.onclick=s.onclick}}):s.style.display="none")}function Pe(e){if(!e)return;const t=e.cloneNode(!0);e.parentNode.replaceChild(t,e),qe(t),t.addEventListener("click",function(){g?fetch(`${c}/group-info/${g}`,{headers:{"user-id":u.id,"session-token":p}}).then(e=>{if(!e.ok)throw new Error(`HTTPé”™è¯¯! çŠ¶æ€ç : ${e.status}`);return e.json()}).then(e=>{if(!e)throw new Error("è·å–æ•°æ®å¤±è´¥");if("success"===e.status){const t=e.group.creator_id||e.group.ownerId||e.group.creatorId||e.group.adminId,n=u.id===String(t);n?He(g):_e(g)}else i.error(e.message||"è·å–ç¾¤ç»„ä¿¡æ¯å¤±è´¥")}).catch(e=>{console.error("è·å–ç¾¤ç»„ä¿¡æ¯é”™è¯¯:",e),e.message&&e.message.includes("HTTPé”™è¯¯")?i.error("è·å–ç¾¤ç»„ä¿¡æ¯å¤±è´¥ï¼ŒæœåŠ¡å™¨è¿”å›é”™è¯¯"):i.error("è·å–ç¾¤ç»„ä¿¡æ¯å¤±è´¥ï¼Œç½‘ç»œé”™è¯¯")}):i.warning("è¯·å…ˆé€‰æ‹©ä¸€ä¸ªç¾¤ç»„")})}function qe(e){e&&g&&fetch(`${c}/group-info/${g}`,{headers:{"user-id":u.id,"session-token":p}}).then(e=>e.json()).then(t=>{if("success"===t.status){const n=t.group.creator_id||t.group.ownerId||t.group.creatorId||t.group.adminId,s=u.id===String(n);e.textContent=s?"è§£æ•£ç¾¤ç»„":"é€€å‡ºç¾¤ç»„"}}).catch(e=>{console.error("è·å–ç¾¤ç»„ä¿¡æ¯å¤±è´¥:",e)})}function He(e){confirm("ç¡®å®šè¦è§£æ•£è¯¥ç¾¤ç»„å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼Œæ‰€æœ‰ç¾¤æ¶ˆæ¯å°†è¢«åˆ é™¤ã€‚")&&Ze(e)}function _e(e){confirm("ç¡®å®šè¦é€€å‡ºè¯¥ç¾¤ç»„å—ï¼Ÿ")&&fetch(`${c}/leave-group`,{method:"POST",headers:{"Content-Type":"application/json","user-id":u.id,"session-token":p},body:JSON.stringify({groupId:e})}).then(e=>e.json()).then(e=>{if("success"===e.status){i.success("å·²æˆåŠŸé€€å‡ºç¾¤ç»„"),st(),g=null,f="";const e=document.getElementById("groupEmptyState"),t=document.getElementById("groupChatInterface"),n=document.getElementById("currentGroupName");e&&(e.style.display="flex"),t&&(t.style.display="none"),n&&(n.textContent="ç¾¤ç»„åç§°")}else i.error("é€€å‡ºç¾¤ç»„å¤±è´¥: "+(e.message||"æœªçŸ¥é”™è¯¯"))}).catch(e=>{i.error("é€€å‡ºç¾¤ç»„å¤±è´¥ï¼Œç½‘ç»œé”™è¯¯")})}function ze(e,t){const n=document.getElementById("groupMembersContainer"),s=document.getElementById("modalGroupMemberCount");n&&(n.innerHTML='<div class="loading-members">æ­£åœ¨åŠ è½½æˆå‘˜åˆ—è¡¨...</div>',fetch(`${c}/group-members/${e}`,{headers:{"user-id":u.id,"session-token":p}}).then(e=>e.json()).then(o=>{if("success"===o.status)Oe(o.members,t,e),s.textContent=o.members.length;else{const e=o.message||"æœªçŸ¥é”™è¯¯";n.innerHTML=`<div class="loading-members">åŠ è½½æˆå‘˜åˆ—è¡¨å¤±è´¥: ${e}</div>`}}).catch(e=>{n.innerHTML='<div class="loading-members">åŠ è½½æˆå‘˜åˆ—è¡¨å¤±è´¥ï¼Œç½‘ç»œé”™è¯¯</div>'}))}function Oe(e,t,n){const s=document.getElementById("groupMembersContainer");if(!s)return;if(!e||!Array.isArray(e)||0===e.length)return void(s.innerHTML='<div class="loading-members">æ²¡æœ‰å¯ç”¨çš„æˆå‘˜</div>');let o="";if(e.forEach((e,s)=>{const a=String(e.id)===String(u.id);o+=`\n            <div class="group-member-item">\n                <div class="group-member-info">\n                    <span class="group-member-name">${e.nickname}</span>\n                    <span class="group-member-id">ID: ${e.id}</span>\n                    ${a?'<span class="group-member-role">ï¼ˆæˆ‘ï¼‰</span>':""}\n                </div>\n                ${t&&!a?`\n                    <button class="kick-member-btn" data-group-id="${n}" data-member-id="${e.id}" data-member-name="${e.nickname}">\n                        è¸¢å‡º\n                    </button>\n                `:""}\n            </div>\n        `}),s.innerHTML=o,t){const e=s.querySelectorAll(".kick-member-btn");e.forEach(e=>{e.addEventListener("click",function(){const e=this.getAttribute("data-group-id"),t=this.getAttribute("data-member-id"),n=this.getAttribute("data-member-name");Fe(e,t,n)})})}}function Fe(e,t,n){confirm(`ç¡®å®šè¦è¸¢å‡ºæˆå‘˜ ${n} å—ï¼Ÿ`)&&(u&&p?fetch(`${c}/remove-group-member`,{method:"POST",headers:{"Content-Type":"application/json","user-id":u.id,"session-token":p},body:JSON.stringify({groupId:e,memberId:t})}).then(e=>e.json()).then(t=>{"success"===t.status||t.message&&t.message.includes("æˆåŠŸ")?(i.success(`å·²æˆåŠŸè¸¢å‡ºæˆå‘˜ ${n}`),ze(e,!0)):i.error("è¸¢å‡ºæˆå‘˜å¤±è´¥: "+(t.message||"æœªçŸ¥é”™è¯¯"))}).catch(e=>{console.error("è¸¢å‡ºæˆå‘˜å¤±è´¥:",e),i.error("è¸¢å‡ºæˆå‘˜å¤±è´¥ï¼Œç½‘ç»œé”™è¯¯")}):i.error("è¯·å…ˆç™»å½•"))}function De(e){if(!e||!u||!p)return;window.currentAddingGroupId=e;const t=document.getElementById("addGroupMemberModal");t&&(t.style.display="flex",t.style.justifyContent="center",t.style.alignItems="center",document.body.style.overflow="hidden"),We(e)}function Re(){const e=document.getElementById("addGroupMemberModal");e&&(e.style.display="none",document.body.style.overflow="");const t=document.getElementById("addMembersMessage");t&&(t.textContent="");const n=document.getElementById("availableMembersList");if(n){const e=n.querySelectorAll(".available-member-checkbox");e.forEach(e=>{e.checked=!1})}delete window.currentAddingGroupId}function We(e){if(!e||!u||!p)return;const t=document.getElementById("availableMembersList");t&&(t.innerHTML='<div class="loading-members">æ­£åœ¨åŠ è½½å¥½å‹åˆ—è¡¨...</div>',fetch(`${c}/user/friends`,{method:"GET",headers:{"user-id":u.id,"session-token":p}}).then(e=>e.json()).then(t=>"success"===t.status&&t.friends&&Array.isArray(t.friends)?fetch(`${c}/group-members/${e}`,{method:"GET",headers:{"user-id":u.id,"session-token":p}}).then(e=>e.json()).then(e=>{let n=[];"success"===e.status&&e.members&&Array.isArray(e.members)&&(n=e.members);const s=new Set(n.map(e=>String(e.id))),o=t.friends.filter(e=>{const t=String(e.id),n=t!==String(u.id),o=!s.has(t);return n&&o});return o}):[]).then(e=>{0!==e.length?t.innerHTML=e.map(e=>`\n            <div class="member-item">\n                <input type="checkbox" class="available-member-checkbox" id="available-member-${e.id}" value="${e.id}">\n                <label for="available-member-${e.id}" class="member-nickname">${e.nickname||e.username||"æœªçŸ¥ç”¨æˆ·"}</label>\n            </div>\n        `).join(""):t.innerHTML='<div class="loading-members">æ²¡æœ‰å¯æ·»åŠ çš„å¥½å‹</div>'}).catch(e=>{t.innerHTML='<div class="loading-members">åŠ è½½å¥½å‹åˆ—è¡¨å¤±è´¥</div>'}))}function Je(){const e=window.currentAddingGroupId;if(!e||!u||!p)return;const t=document.getElementById("availableMembersList"),n=document.getElementById("addMembersMessage");if(!t||!n)return void console.error("âŒ [æ·»åŠ æˆå‘˜] æ‰¾ä¸åˆ°å¿…è¦çš„DOMå…ƒç´ ");const s=t.querySelectorAll(".available-member-checkbox:checked"),o=Array.from(s).map(e=>e.value);if(0===o.length)return n.textContent="è¯·é€‰æ‹©è‡³å°‘1åæˆå‘˜",void(n.className="create-group-message error");n.textContent="",n.className="create-group-message",fetch(`${c}/add-group-members`,{method:"POST",headers:{"Content-Type":"application/json","user-id":u.id,"session-token":p},body:JSON.stringify({groupId:e,memberIds:o})}).then(e=>e.json()).then(t=>{"success"===t.status||t.message&&t.message.includes("æˆåŠŸ")?(n.textContent="æˆå‘˜æ·»åŠ æˆåŠŸ",n.className="create-group-message success",setTimeout(()=>{Re(),ze(e,!0)},1e3)):(n.textContent=t.message||"æ·»åŠ æˆå‘˜å¤±è´¥",n.className="create-group-message error")}).catch(t=>{console.error(`âŒ [æ·»åŠ æˆå‘˜] æ·»åŠ æˆå‘˜åˆ°ç¾¤ç»„ ${e} å¤±è´¥:`,t),n.textContent="æ·»åŠ æˆå‘˜å¤±è´¥ï¼Œç½‘ç»œé”™è¯¯",n.className="create-group-message error"})}function Ke(e,t){u&&p?fetch(`${c}/update-group-name`,{method:"POST",headers:{"Content-Type":"application/json","user-id":u.id,"session-token":p},body:JSON.stringify({groupId:e,newGroupName:t})}).then(e=>e.json()).then(t=>{if("success"===t.status){const n=ot(t.newGroupName);f=n;const s=document.getElementById("currentGroupName");s&&(s.textContent=n),Ye(e,n);const o=document.querySelector(".group-info-item:nth-of-type(1) > div");o&&(o.innerHTML=`\n                    <span id="modalGroupNameValue">${n}</span>\n                    <button id="editGroupNameBtn" class="edit-group-name-btn" style="padding: 4px 8px; background-color: #3498db; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">\n                        ç¼–è¾‘\n                    </button>\n                `,Ge(!0,n,e));const a=document.getElementById("modalGroupName");a&&(a.textContent=`${n} - ç¾¤ç»„ä¿¡æ¯`),i.success("ç¾¤ç»„åç§°å·²æˆåŠŸæ›´æ–°");const r=document.getElementById("manageGroupModal");r&&"none"!==r.style.display&&(r.style.display="none")}else i.error("ä¿®æ”¹ç¾¤ç»„åç§°å¤±è´¥: "+(t.message||"æœªçŸ¥é”™è¯¯"))}).catch(e=>{i.error("ä¿®æ”¹ç¾¤ç»„åç§°å¤±è´¥ï¼Œç½‘ç»œé”™è¯¯")}):i.error("è¯·å…ˆç™»å½•")}function Ve(e,t){u&&p?fetch(`${c}/update-group-description`,{method:"POST",headers:{"Content-Type":"application/json","user-id":u.id,"session-token":p},body:JSON.stringify({groupId:e,newDescription:t})}).then(e=>{if(!e.ok)throw new Error(`HTTPé”™è¯¯! çŠ¶æ€ç : ${e.status}`);return e.json()}).then(n=>{if("success"===n.status){Xe(e,t);const n=document.querySelector(".group-info-item:nth-of-type(3) > div");n&&(n.innerHTML=`\n                    <span id="modalGroupNoticeValue" style="flex: 1; word-break: break-word;">${t||"æš‚æ— ç¾¤ç»„å…¬å‘Š"}</span>\n                    <button id="editGroupNoticeBtn" class="edit-group-notice-btn" style="padding: 4px 8px; background-color: #3498db; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">\n                        ç¼–è¾‘\n                    </button>\n                `,je(!0,t,e)),i.success("ç¾¤ç»„å…¬å‘Šå·²æˆåŠŸæ›´æ–°")}else i.error("ä¿®æ”¹ç¾¤ç»„å…¬å‘Šå¤±è´¥: "+(n.message||"æœªçŸ¥é”™è¯¯"))}).catch(e=>{console.error("ä¿®æ”¹ç¾¤ç»„å…¬å‘Šå¤±è´¥:",e),i.error("ä¿®æ”¹ç¾¤ç»„å…¬å‘Šå¤±è´¥ï¼Œç½‘ç»œé”™è¯¯: "+e.message)}):i.error("è¯·å…ˆç™»å½•")}function Xe(e,t){}function Ye(e,t){const n=document.getElementById("groupList");if(!n)return;const s=n.querySelectorAll(`li[data-group-id="${e}"]`);s.forEach(e=>{const n=e.querySelector(".group-name");n&&(n.textContent=t)})}function Ze(e){u&&p?confirm("ç¡®å®šè¦è§£æ•£æœ¬ç¾¤ç»„å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼Œæ‰€æœ‰ç¾¤æ¶ˆæ¯å°†è¢«åˆ é™¤ã€‚")&&fetch(`${c}/dissolve-group`,{method:"POST",headers:{"Content-Type":"application/json","user-id":u.id,"session-token":p},body:JSON.stringify({userId:u.id,groupId:e})}).then(e=>e.json()).then(e=>{"success"===e.status?(i.success("ç¾¤ç»„å·²æˆåŠŸè§£æ•£ï¼Œæ‰€æœ‰ç¾¤æ¶ˆæ¯å·²åˆ é™¤"),Qe(),st()):i.error("è§£æ•£ç¾¤ç»„å¤±è´¥: "+(e.message||"æœªçŸ¥é”™è¯¯"))}).catch(e=>{i.error("è§£æ•£ç¾¤ç»„å¤±è´¥ï¼Œç½‘ç»œé”™è¯¯")}):i.error("è¯·å…ˆç™»å½•")}function Qe(){const e=document.querySelector('.chat-content[data-content="public-chat"]'),t=document.getElementById("groupChatInterface"),n=document.getElementById("groupEmptyState"),s=document.getElementById("currentGroupName");e&&e.classList.add("active"),t&&(t.style.display="none"),n&&(n.style.display="flex"),s&&(s.textContent="ç¾¤ç»„åç§°"),g=null,f="",ct("main")}function et(){Me();const e=document.getElementById("groupChatInterface");if(e){const t=new MutationObserver(t=>{t.forEach(t=>{"style"===t.attributeName&&"none"!==e.style.display&&Me()})});t.observe(e,{attributes:!0})}const t=document.getElementById("groupList");t&&t.addEventListener("click",()=>{setTimeout(()=>{Me()},50)})}function tt(){m&&window.chatSocket&&window.chatSocket.emit("get-online-users")}function nt(e){const t=document.getElementById("userList"),n=document.getElementById("onlineCount");if(!t)return void console.error("User list element not found");if(Array.isArray(e)||(console.error("Invalid users data:",e),e=[]),b=e,n&&(n.textContent=`(${e.length})`),P(w),t.innerHTML="",0===e.length)return void(t.innerHTML="<li>æš‚æ— åœ¨çº¿ç”¨æˆ·</li>");e.forEach(e=>{if(!e||!e.id)return void console.error("Invalid user object:",e);const n=document.createElement("li");let s="";e.avatarUrl&&"string"===typeof e.avatarUrl?s=e.avatarUrl.trim():e.avatar_url&&"string"===typeof e.avatar_url?s=e.avatar_url.trim():e.avatar&&"string"===typeof e.avatar&&(s=e.avatar.trim());let o="";if(s){const t=/\.svg$/i.test(s);if(t){const t=e.nickname?e.nickname.charAt(0).toUpperCase():"U";o=`<span class="user-avatar">${t}</span>`}else{const t=`${c}${s}`;o=`<span class="user-avatar"><img src="${t}" alt="${e.nickname}"></span>`}}else{const t=e.nickname?e.nickname.charAt(0).toUpperCase():"U";o=`<span class="user-avatar">${t}</span>`}const a=u&&String(u.id)===String(e.id),i=a?`${e.nickname} (æˆ‘)`:e.nickname;n.setAttribute("data-user-id",e.id),n.innerHTML=`\n            ${o}\n            <span class="user-name">${i}</span>\n            <span class="user-status online"></span>\n        `,n.style.padding="8px 0",n.style.borderBottom="1px solid #f1f1f1",n.style.display="flex",n.style.alignItems="center",n.className="user-item",a&&(n.style.fontWeight="bold"),t.appendChild(n)}),ue();const s=document.querySelectorAll(".friend-item");s.forEach(e=>{const t=e.dataset.userId,n=b.some(e=>String(e.id)===String(t)),s=e.querySelector(".friend-status");s&&(s.className="friend-status "+(n?"online":"offline"))}),Z()}function st(){u&&p&&fetch(`${c}/user-groups/${u.id}`,{headers:{"user-id":u.id,"session-token":p}}).then(e=>e.json()).then(e=>{if("success"===e.status)vt(e.groups);else{const t=document.getElementById("groupList");t&&(t.innerHTML="<li>åŠ è½½å¤±è´¥: "+e.message+"</li>")}}).catch(e=>{const t=document.getElementById("groupList");t&&(t.innerHTML="<li>åŠ è½½å¤±è´¥: ç½‘ç»œé”™è¯¯</li>")})}function ot(e){const t=document.createElement("textarea");return t.innerHTML=e,t.value}function at(){let e=S.global;for(const t in S.groups){const n=S.groups[t]||0;e+=n}for(const t in S.private){const n=S.private[t]||0;e+=n}document.title=e>0?`ï¼ˆ${e}æ¡æœªè¯»ï¼‰${E}`:E,it()}function it(){const e=document.getElementById("publicChatUnreadCount");e&&(S.global>0?e.textContent=S.global:e.textContent="");const t=document.getElementById("groupChatUnreadCount");if(t){let e=0;Object.keys(S.groups).forEach(t=>{const n=S.groups[t]||0;e+=n}),t.textContent=e>0?e:""}const n=document.getElementById("privateChatUnreadCount");if(n){let e=0;Object.keys(S.private).forEach(t=>{const n=S.private[t]||0;e+=n}),n.textContent=e>0?e:""}const s=document.querySelectorAll("#groupList li[data-group-id]");s.forEach(e=>{const t=e.getAttribute("data-group-id"),n=S.groups[t]||0,s=e.querySelector(".group-unread-count");s&&(s.textContent=n>0?n:"")});const o=document.querySelectorAll("#friendsList li.friend-item");o.forEach(e=>{const t=e.getAttribute("data-user-id"),n=S.private[t]||0,s=e.querySelector(".private-unread-count");s&&(s.textContent=n>0?n:"")})}function rt(){if(C=!document.hidden,C)if("main"===$)S.global>0&&(S.global=0,at());else if($.startsWith("private_")){const e=$.replace("private_","");S.private[e]>0&&(S.private[e]=0,at())}else S.groups[$]>0&&(S.groups[$]=0,at())}function lt(){if(C=document.hasFocus(),C)if("main"===$)S.global>0&&(S.global=0,at());else if($.startsWith("private_")){const e=$.replace("private_","");S.private[e]>0&&(S.private[e]=0,at())}else S.groups[$]>0&&(S.groups[$]=0,at())}function ct(e,t=null){"main"===e?($="main",S.global>0&&(S.global=0,at())):"group"===e&&t?($=t,S.groups[t]>0&&(S.groups[t]=0,at())):"private"===e&&t&&($=`private_${t}`,S.private[t]>0&&(S.private[t]=0,at()))}function dt(e,t=!1,n=null){if(!e)return;if(e.senderId===u.id||e.userId===u.id)return;let s=!C;C&&(s=t&&n?$!==n:"main"!==$),s&&(t&&n?pt(n)||(S.groups[n]=(S.groups[n]||0)+1):S.global++,at())}function ut(){const e=localStorage.getItem("mutedGroups");return e?JSON.parse(e):[]}function pt(e){const t=ut();return t.includes(e.toString())}function mt(e){const t=ut(),n=e.toString();let s;return t.includes(n)?(s=t.filter(e=>e!==n),console.log(`ğŸ”” å–æ¶ˆç¾¤ç»„å…æ‰“æ‰° - ç¾¤ç»„ID: ${e}`)):(s=[...t,n],console.log(`ğŸ”• è®¾ç½®ç¾¤ç»„å…æ‰“æ‰° - ç¾¤ç»„ID: ${e}`)),localStorage.setItem("mutedGroups",JSON.stringify(s)),gt(),it(),!t.includes(n)}function gt(){const e=document.getElementById("groupList");if(!e)return;const t=e.querySelectorAll("li");t.forEach(e=>{const t=e.getAttribute("data-group-id");ft(e,t)})}function ft(e,t){let n=e.querySelector(".mute-icon");n&&n.remove(),pt(t)&&(n=document.createElement("span"),n.className="mute-icon",n.textContent="ğŸ”•",n.style.marginLeft="5px",n.style.fontSize="12px",n.title="å·²å…æ‰“æ‰°",e.appendChild(n))}function yt(e,t,n){ht();const s=document.createElement("div");s.className="context-menu",s.style.position="fixed",s.style.left=e.clientX+"px",s.style.top=e.clientY+"px",s.style.backgroundColor="white",s.style.border="1px solid #ddd",s.style.borderRadius="4px",s.style.boxShadow="0 2px 10px rgba(0,0,0,0.1)",s.style.zIndex="1000",s.style.padding="5px 0";const o=pt(t),a=document.createElement("div");a.className="context-menu-item",a.textContent=o?"å–æ¶ˆå…æ‰“æ‰°":"å…æ‰“æ‰°",a.style.padding="8px 15px",a.style.cursor="pointer",a.style.fontSize="14px",a.style.whiteSpace="nowrap",a.addEventListener("click",()=>{mt(t),ht()}),s.appendChild(a),document.body.appendChild(s),window.currentContextMenu=s,setTimeout(()=>{document.addEventListener("click",ht)},0)}function ht(){window.currentContextMenu&&(document.body.removeChild(window.currentContextMenu),window.currentContextMenu=null),document.removeEventListener("click",ht)}function vt(e){const t=document.getElementById("groupList");if(t&&(t.innerHTML="",e.forEach(e=>{const n=ot(e.name),s=document.createElement("li");s.setAttribute("data-group-id",e.id),s.setAttribute("data-group-name",n);let o="";const a=e.avatar_url||e.avatarUrl||"";if(a){const e=/\.svg$/i.test(a);if(e){const e=n.charAt(0).toUpperCase();o=`<span class="group-avatar">${e}</span>`}else{const e=`${c}${a}`;o=`<span class="group-avatar"><img src="${e}" alt="${n}"></span>`}}else{const e=n.charAt(0).toUpperCase();o=`<span class="group-avatar">${e}</span>`}const i=document.createElement("span");i.className="group-name",i.textContent=n,s.innerHTML=`\n            ${o}\n            ${i.outerHTML}\n            <div class="unread-count group-unread-count"></div>\n        `,s.addEventListener("click",function(){const e=this.getAttribute("data-group-id"),t=n;g=e,f=t,$=`group_${e}`,B="group",M=e,d.currentGroupId=g,d.currentGroupName=f,d.currentActiveChat=$,d.currentSendChatType=B,d.selectedGroupIdForCard=M,ct("group",e);const s=document.getElementById("groupEmptyState"),o=document.getElementById("groupChatInterface"),a=document.getElementById("currentGroupName");s&&(s.style.display="none"),o&&(o.style.display="flex",o.style.flexDirection="column"),a&&(a.textContent=f),bt(e,!0)}),s.addEventListener("contextmenu",function(e){e.preventDefault();const t=this.getAttribute("data-group-id"),n=this.getAttribute("data-group-name");yt(e,t,n)}),ft(s,e.id),t.appendChild(s)}),it(),g)){const e=document.getElementById("groupEmptyState"),t=document.getElementById("groupChatInterface"),n=document.getElementById("currentGroupName");e&&(e.style.display="none"),t&&(t.style.display="flex",t.style.flexDirection="column"),n&&(n.textContent=f)}}function bt(e,t=!1){const n=document.getElementById("groupMessageContainer");n&&(n.style.flex="1",n.style.overflowY="auto",n.style.padding="10px",t&&(n.innerHTML=""));const s=Date.now();if(m&&window.chatSocket){const t={groupId:parseInt(e),sessionToken:p,userId:u.id,loadTime:s};window.chatSocket.emit("join-group",t)}else fetch(`${c}/group-chat-history/${e}`,{headers:{"user-id":u.id,"session-token":p}}).then(e=>e.json()).then(e=>{"success"===e.status&&e.messages&&n&&e.messages.forEach(e=>{function t(e){const t=e.content||e.text||"empty",n=e.userId||e.senderId||"unknown",s=e.timestamp||e.createdAt||"unknown",o=`${n}-${s}-${JSON.stringify(t)}`;let a=0;for(let i=0;i<o.length;i++){const e=o.charCodeAt(i);a=(a<<5)-a+e,a&=a}return Math.abs(a).toString(16)}e.isHistory=!0;const n=t(e);document.querySelector(`#groupMessageContainer [data-identifier="${n}"]`)||(e.identifier=n,ge(e))})}).catch(e=>{});const o=String(e);function a(){const e=document.getElementById("groupMessageContainer");if(e){const t=e.scrollHeight;e.scrollTop=t,setTimeout(()=>{e.scrollHeight>t&&(e.scrollTop=e.scrollHeight,setTimeout(()=>{e.scrollTop=e.scrollHeight},200))},300)}}L[o]&&L[o].length>0&&setTimeout(()=>{const e=document.getElementById("groupMessageContainer");e&&(L[o].forEach(e=>{function t(e){const t=e.content||e.text||"empty",n=e.userId||e.senderId||"unknown",s=e.timestamp||e.createdAt||"unknown",o=`${n}-${s}-${JSON.stringify(t)}`;let a=0;for(let i=0;i<o.length;i++){const e=o.charCodeAt(i);a=(a<<5)-a+e,a&=a}return Math.abs(a).toString(16)}const n=t(e);document.querySelector(`#groupMessageContainer [data-identifier="${n}"]`)||(e.identifier=n,ge(e))}),L[o]=[])},100),setTimeout(a,800)}function wt(e){i.error(e)}function kt(e){i.success(e)}function It(){const e=document.querySelectorAll(".menu-item"),t=document.querySelectorAll(".secondary-content"),n=document.querySelectorAll(".chat-content"),s=document.getElementById("switchToOldUI");s&&s.addEventListener("click",()=>{window.location.href="/oldUI/"}),e.forEach(s=>{s.addEventListener("click",()=>{const o=s.getAttribute("data-section");if("logout"===o)return void(confirm("ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ")&&ae());e.forEach(e=>{e.classList.remove("active")}),t.forEach(e=>{e.classList.remove("active")}),n.forEach(e=>{e.classList.remove("active"),e.style.display="none"}),s.classList.add("active");const a=document.querySelector(`.secondary-content[data-content="${o}"]`);a&&a.classList.add("active");const i=document.querySelector(`.chat-content[data-content="${o}"]`);i&&(i.classList.add("active"),i.style.display="flex",we());const r=document.getElementById("markdownToolbar"),l=document.getElementById("toggleMarkdownToolbar"),d=document.getElementById("toggleGroupMarkdownToolbar");if(r&&("public-chat"===o||(r.style.display="none")),l&&("public-chat"===o?(l.style.display="inline-block",r&&("none"===r.style.display?l.innerHTML='<i class="fas fa-chevron-down"></i> MD':l.innerHTML='<i class="fas fa-chevron-up"></i> éšè—Markdownå·¥å…·æ ')):l.style.display="none"),d&&(d.style.display="group-chat"===o?"inline-block":"none"),"public-chat"===o)ct("main");else if("group-chat"===o){st(),g&&ct("group",g);const e=window.loadGroupList;window.loadGroupList=function(){fetch(`${c}/user-groups/${u.id}`,{headers:{"user-id":u.id,"session-token":p}}).then(e=>e.json()).then(e=>{if("success"===e.status&&(vt(e.groups),g)){ct("group",g);const e=document.getElementById("groupEmptyState"),t=document.getElementById("groupChatInterface"),n=document.getElementById("currentGroupName");e&&(e.style.display="none"),t&&(t.style.display="flex",t.style.flexDirection="column"),n&&(n.textContent=f),bt(g,!1)}}).catch(e=>{const t=document.getElementById("groupList");t&&(t.innerHTML="<li>åŠ è½½å¤±è´¥: ç½‘ç»œé”™è¯¯</li>")})},st(),setTimeout(()=>{window.loadGroupList=e},1e3)}})})}function xt(){const e=document.querySelectorAll(".settings-item"),t=document.querySelectorAll(".settings-detail"),n=document.getElementById("settingsEmptyState"),s=document.getElementById("settingsContainer");e.forEach(e=>{e.addEventListener("click",()=>{const o=e.getAttribute("data-setting-id");n.style.display="none",s.style.display="block",t.forEach(e=>{e.style.display="none"});const a=document.querySelector(`.settings-detail[data-setting="${o}"]`);a&&(a.style.display="block")})})}function Et(){const e=document.querySelectorAll("#groupList li[data-group-id]"),t=document.getElementById("groupEmptyState"),n=document.getElementById("groupChatInterface"),s=document.getElementById("currentGroupName");e.forEach(e=>{const o=e.getAttribute("data-group-id"),a=e.querySelector(".group-name");e.addEventListener("click",()=>{t.style.display="none",n.style.display="flex";const e=a?a.textContent:"ç¾¤ç»„åç§°";s.textContent=e,g=o,f=e,ct("group",o)})})}function St(){const e=document.querySelectorAll(".cancel-btn"),t=document.getElementById("settingsEmptyState"),n=document.getElementById("settingsContainer");e.forEach(e=>{e.addEventListener("click",()=>{t.style.display="flex",n.style.display="none"})})}function Ct(){It(),N(),Et(),St(),$t(),et()}function $t(){const e=document.getElementById("messageContainer"),t=document.getElementById("groupMessageContainer"),n=document.getElementById("privateMessageContainer");function s(e,t,n,s=!1){if(t.scrollTop<50&&!window.isLoadingMoreMessages){window.isLoadingMoreMessages=!0;t.scrollHeight,t.scrollTop;const e=t.querySelectorAll(".message");let o=null;if(e.length>0){let t=null;for(let n=0;n<e.length;n++){const s=e[n],o=s.getAttribute("data-sequence");if(null!==o){const e=parseInt(o);isNaN(e)||(null===t||e<t)&&(t=e)}}o=t}if(u&&p){if(n&&g){const e={groupId:g,sessionToken:p,userId:u.id,limit:20,loadMore:!0,olderThan:o};window.chatSocket.emit("get-group-chat-history",e)}else if(s&&y){const e={userId:u.id,friendId:y,sessionToken:p,limit:20,loadMore:!0,olderThan:o};window.chatSocket.emit("get-private-chat-history",e)}else window.chatSocket.emit("get-chat-history",{userId:u.id,sessionToken:p,limit:20,loadMore:!0,olderThan:o});window.loadingIndicatorTimeout=setTimeout(()=>{if(window.isLoadingMoreMessages){const e=document.createElement("div");e.className="loading-indicator",e.textContent="åŠ è½½ä¸­...",e.style.textAlign="center",e.style.padding="10px",e.style.color="#666",e.style.fontSize="14px",t.insertBefore(e,t.firstChild)}},500)}else window.isLoadingMoreMessages=!1}}window.isLoadingMoreMessages=!1,window.loadingIndicatorTimeout=null,e&&e.addEventListener("scroll",function(e){s(e,this,!1)}),t&&t.addEventListener("scroll",function(e){s(e,this,!0)}),n&&n.addEventListener("scroll",function(e){s(e,this,!1,!0)}),window.resetLoadingState=function(){window.isLoadingMoreMessages=!1,window.loadingIndicatorTimeout&&(clearTimeout(window.loadingIndicatorTimeout),window.loadingIndicatorTimeout=null);const e=document.querySelectorAll(".loading-indicator");e.forEach(e=>e.remove())}}function Lt(){const e=document.getElementById("avatarPreviewModal");e&&(e.style.display="none",document.body.style.overflow="")}function Bt(e){const t=document.getElementById("avatarPreviewModal");e.target===t&&Lt()}window.withdrawPrivateMessage=function(e){u&&p&&window.chatSocket&&window.chatSocket.emit("withdraw-private-message",{userId:u.id,messageId:e,sessionToken:p})},T=null;const Mt=document.getElementById("closeAvatarPreviewModal");Mt&&Mt.addEventListener("click",Lt);const Tt=document.getElementById("avatarPreviewModal");function At(){const e=document.querySelectorAll(".message-image");e.forEach(e=>{e.hasAttribute("data-click-added")||(e.addEventListener("click",function(){const e=this.getAttribute("src");e&&openImagePreview(e)}),e.setAttribute("data-click-added","true"))})}function Ut(){const e=document.querySelectorAll(".user-avatar");e.forEach(e=>{e.hasAttribute("data-click-added")||(e.addEventListener("click",function(e){let t;if(e.preventDefault(),e.stopPropagation(),this.closest("[data-user-id]")?t=this.closest("[data-user-id]").getAttribute("data-user-id"):this.closest(".user-item")?t=this.closest(".user-item").getAttribute("data-user-id"):this.closest(".message-item")?t=this.closest(".message-item").getAttribute("data-user-id"):this.closest(".search-result-item")&&(t=this.closest(".search-result-item").querySelector(".add-friend-btn")?.getAttribute("data-user-id")),t){let n="";const s=this.closest("[data-user-id]");if(s)if(s.hasAttribute("data-user-nickname"))n=s.getAttribute("data-user-nickname");else{const e=s.querySelector(".friend-name, .user-name, .message-nickname");e&&(n=e.textContent)}else if(this.closest(".user-item")){const e=this.closest(".user-item"),t=e.querySelector(".user-name");t&&(n=t.textContent)}else if(this.closest(".message-item")){const e=this.closest(".message-item"),t=e.querySelector(".message-nickname");t&&(n=t.textContent)}X(e,{id:t,nickname:n})}}),e.setAttribute("data-click-added","true"))});const t=document.querySelectorAll(".user-avatar-img");t.forEach(e=>{e.hasAttribute("data-click-added")||(e.addEventListener("click",function(e){let t;if(e.preventDefault(),e.stopPropagation(),this.closest("[data-user-id]"))t=this.closest("[data-user-id]").getAttribute("data-user-id");else if("currentUserAvatar"===this.id)return;if(t){let n="";const s=this.closest("[data-user-id]");if(s)if(s.hasAttribute("data-user-nickname"))n=s.getAttribute("data-user-nickname");else{const e=s.querySelector(".friend-name, .user-name, .message-nickname");e&&(n=e.textContent)}X(e,{id:t,nickname:n})}}),e.setAttribute("data-click-added","true"))})}function Nt(){const e=document.getElementById("messageContainer"),t=document.getElementById("groupMessageContainer"),n=document.getElementById("privateMessageContainer");function s(e){let t,n="";const s=e.target.closest(".message-item");if(s){t=s.getAttribute("data-user-id");const e=s.querySelector(".message-nickname");e&&(n=e.textContent)}else{const s=e.target.closest("[data-user-id]");if(s)if(t=s.getAttribute("data-user-id"),s.hasAttribute("data-user-nickname"))n=s.getAttribute("data-user-nickname");else{const e=s.querySelector(".friend-name, .user-name, .message-nickname");e&&(n=e.textContent)}}t&&X(e,{id:t,nickname:n})}e&&e.addEventListener("click",function(e){if(e.target.classList.contains("message-image")){const t=e.target.getAttribute("src");t&&openImagePreview(t)}else(e.target.classList.contains("user-avatar")||"IMG"===e.target.tagName&&e.target.parentElement.classList.contains("user-avatar"))&&s(e)}),t&&t.addEventListener("click",function(e){if(e.target.classList.contains("message-image")){const t=e.target.getAttribute("src");t&&openImagePreview(t)}else(e.target.classList.contains("user-avatar")||"IMG"===e.target.tagName&&e.target.parentElement.classList.contains("user-avatar"))&&s(e)}),n&&n.addEventListener("click",function(e){if(e.target.classList.contains("message-image")){const t=e.target.getAttribute("src");t&&openImagePreview(t)}else(e.target.classList.contains("user-avatar")||"IMG"===e.target.tagName&&e.target.parentElement.classList.contains("user-avatar"))&&s(e)});const o=document.getElementById("userList");o&&o.addEventListener("click",function(e){(e.target.classList.contains("user-avatar")||"IMG"===e.target.tagName&&e.target.parentElement.classList.contains("user-avatar"))&&s(e)});const a=document.getElementById("offlineUserList");a&&a.addEventListener("click",function(e){(e.target.classList.contains("user-avatar")||"IMG"===e.target.tagName&&e.target.parentElement.classList.contains("user-avatar"))&&s(e)});const i=document.getElementById("friendsList");i&&i.addEventListener("click",function(e){(e.target.classList.contains("user-avatar")||"IMG"===e.target.tagName&&e.target.parentElement.classList.contains("user-avatar"))&&!e.target.closest(".friend-item")&&s(e)})}function jt(){const e=document.getElementById("groupList");e&&e.addEventListener("click",function(e){if(e.target.closest(".group-avatar")){const t=e.target.closest(".group-avatar"),n=t.querySelector("img");n&&n.src&&openImagePreview(n.src)}});const t=document.getElementById("groupInfoModal");t&&t.addEventListener("click",function(e){if(e.target.closest("#modalGroupAvatarValue")){const t=e.target.closest("#modalGroupAvatarValue"),n=t.querySelector("img");n&&n.src&&openImagePreview(n.src)}})}function Gt(){const e=localStorage.getItem("currentUser"),t=localStorage.getItem("currentSessionToken"),n=localStorage.getItem("chatUserId"),s=localStorage.getItem("chatSessionToken"),o=localStorage.getItem("chatUserNickname"),a=localStorage.getItem("chatUserAvatar");if(!u&&(e||n))if(e)try{u=JSON.parse(e)}catch(i){console.warn("è§£æcurrentUserå¤±è´¥:",i)}else n&&(u={id:n,nickname:o,avatarUrl:a});p||!t&&!s||(p=t||s),window.location.hash="#/chat",setTimeout(()=>{U();const e=window.location.hash;window.location.hash="",setTimeout(()=>{window.location.hash=e},50)},100)}function Pt(e){const t=document.getElementById("messageContainer");if(t)if("save"===e){const e=document.createDocumentFragment(),n=t.children;for(let t=0;t<n.length;t++)e.appendChild(n[t].cloneNode(!0));A=e}else if("pull"===e){if(!A)return void(u&&p&&window.chatSocket&&window.chatSocket.emit("get-chat-history",{userId:u.id,sessionToken:p,limit:50,loadMore:!1}));t.innerHTML="",A&&(11===A.nodeType?t.appendChild(A.cloneNode(!0)):"string"===typeof A&&(t.innerHTML=A)),t.scrollTop=t.scrollHeight}}Tt&&Tt.addEventListener("click",Bt),document.addEventListener("DOMContentLoaded",function(){window.addEventListener("load",function(){"#/login"!==window.location.hash&&"#/register"!==window.location.hash&&(Nt(),At(),Ut(),jt())})})},4810:function(e,t,n){n(8111),n(7588),window.addEventListener("click",function(e){if(e.target.classList.contains("modal")){const e=document.querySelectorAll(".modal");e.forEach(e=>{e.style.display="none"})}})},6002:function(e,t,n){"use strict";var s=n(5130),o=n(1346),a=(n(4114),n(6768)),i=n(144),r=n(7507),l=(n(8111),n(7588),n(9112),n(4232)),c=n(302);const d={id:"sidebar"},u={class:"menu-section"},p={class:"menu-list"},m={class:"menu-section"},g={class:"menu-list"},f={class:"menu-section"},y={class:"menu-list"},h={class:"menu-section"},v={class:"menu-list"};var b={__name:"ChatSidebar",setup(e){const t=(0,r.n)(),n=(0,a.EW)(()=>{const e=window.location.hash;return"#/chat"===e?"public-chat":"#/chat/group"===e?"group-chat":"#/chat/private"===e?"private-chat":"#/settings"===e?"user-settings":"public-chat"});let s={global:0,groups:{},private:{}},o=document.title;function i(){const e=document.getElementById("currentUserAvatar"),t=document.getElementById("userInitials");if(!e||!t)return;let n=null;const s=localStorage.getItem("currentUser");if(s)try{n=JSON.parse(s)}catch(i){console.warn("è§£æcurrentUserå¤±è´¥ï¼Œå°è¯•ä»å…¶ä»–localStorageé¡¹è·å–")}if(!n){const e=localStorage.getItem("chatUserId"),t=localStorage.getItem("chatUserNickname"),s=localStorage.getItem("chatUserAvatar");e&&(n={id:e,nickname:t,avatarUrl:s})}if(!n){const e=localStorage.getItem("userId"),t=localStorage.getItem("nickname"),s=localStorage.getItem("avatarUrl");e&&(n={id:e,nickname:t,avatarUrl:s})}if(!n)return;let o="";n.avatar&&"string"===typeof n.avatar?o=n.avatar.trim():n.avatarUrl&&"string"===typeof n.avatarUrl&&(o=n.avatarUrl.trim());const a=o&&/\.svg$/i.test(o);if(o&&!a){const n=`https://back.hs.airoe.cn${o}`;e.src=n,e.style.display="block",t.style.display="none"}else{const s=n.nickname?n.nickname.charAt(0).toUpperCase():"U";t.textContent=s,t.style.display="block",e.style.display="none"}}function b(){const e=document.querySelectorAll(".menu-item"),t=document.querySelectorAll(".secondary-content"),n=document.querySelectorAll(".chat-content"),a=document.getElementById("switchToOldUI");a&&a.addEventListener("click",()=>{window.location.href="/oldUI/"}),e.forEach(a=>{a.addEventListener("click",()=>{const i=a.getAttribute("data-section");if("logout"===i)return void(confirm("ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ")&&w());e.forEach(e=>{e.classList.remove("active")}),t.forEach(e=>{e.classList.remove("active")}),n.forEach(e=>{e.classList.remove("active"),e.style.display="none"}),a.classList.add("active");const r=document.querySelector(`.secondary-content[data-content="${i}"]`);r&&r.classList.add("active");const l=document.querySelector(`.chat-content[data-content="${i}"]`);l&&(l.classList.add("active"),l.style.display="flex",k());const c=document.getElementById("markdownToolbar"),d=document.getElementById("toggleMarkdownToolbar"),u=document.getElementById("toggleGroupMarkdownToolbar");c&&("public-chat"===i||(c.style.display="none")),d&&("public-chat"===i?(d.style.display="inline-block",c&&("none"===c.style.display?d.innerHTML='<i class="fas fa-chevron-down"></i> MD':d.innerHTML='<i class="fas fa-chevron-up"></i> éšè—Markdownå·¥å…·æ ')):d.style.display="none"),u&&(u.style.display="group-chat"===i?"inline-block":"none"),"public-chat"===i&&(s.global=0,I(),document.getElementById("publicChatUnreadCount").textContent="",document.title=o),"group-chat"===i&&(document.getElementById("groupChatUnreadCount").textContent=""),"private-chat"===i&&(document.getElementById("privateChatUnreadCount").textContent=""),x(i)})})}function w(){localStorage.removeItem("currentUser"),localStorage.removeItem("currentSessionToken"),localStorage.removeItem("chatUserId"),localStorage.removeItem("chatUserNickname"),localStorage.removeItem("chatSessionToken"),localStorage.removeItem("chatUserAvatar"),localStorage.removeItem("userId"),localStorage.removeItem("nickname"),localStorage.removeItem("avatarUrl"),localStorage.removeItem("sessionToken"),t.push("/login")}function k(){console.log("Adjusting chat layout")}function I(){console.log("Updating unread count")}function x(e){let t="";switch("#/chat"===window.location.hash&&(0,c.qR)("save"),e){case"public-chat":t="#/chat";break;case"group-chat":t="#/chat/group";break;case"private-chat":t="#/chat/private";break;case"user-settings":t="#/settings";break;default:t="#/chat"}window.location.hash=t}return(0,a.sV)(()=>{b(),i()}),(e,t)=>((0,a.uX)(),(0,a.CE)("div",d,[t[4]||(t[4]=(0,a.Fv)('<div class="sidebar-header"><div id="userProfile" class="user-profile"><div id="userAvatar" class="user-avatar"><img id="currentUserAvatar" src="" alt="ç”¨æˆ·å¤´åƒ" class="user-avatar-img" loading="lazy" width="60" height="60" style="aspect-ratio:1/1;object-fit:cover;"><span id="userInitials" class="user-initials"></span></div></div></div>',1)),(0,a.Lk)("div",u,[(0,a.Lk)("ul",p,[(0,a.Lk)("li",{class:(0,l.C4)(["menu-item",{active:"public-chat"===n.value}]),"data-section":"public-chat"},[...t[0]||(t[0]=[(0,a.Lk)("div",{class:"chat-avatar"},"ğŸ’¬",-1),(0,a.Lk)("div",{class:"unread-count",id:"publicChatUnreadCount"},null,-1)])],2)])]),(0,a.Lk)("div",m,[(0,a.Lk)("ul",g,[(0,a.Lk)("li",{class:(0,l.C4)(["menu-item",{active:"group-chat"===n.value}]),"data-section":"group-chat"},[...t[1]||(t[1]=[(0,a.Lk)("div",{class:"chat-avatar"},[(0,a.Lk)("img",{src:"icon/User-Group-256.ico",alt:"ç¾¤ç»„èŠå¤©",style:{width:"24px",height:"24px"}})],-1),(0,a.Lk)("div",{class:"unread-count",id:"groupChatUnreadCount"},null,-1)])],2)])]),(0,a.Lk)("div",f,[(0,a.Lk)("ul",y,[(0,a.Lk)("li",{class:(0,l.C4)(["menu-item",{active:"private-chat"===n.value}]),"data-section":"private-chat"},[...t[2]||(t[2]=[(0,a.Lk)("div",{class:"chat-avatar"},[(0,a.Lk)("img",{src:"icon/User-Profile-256.ico",alt:"ç§ä¿¡èŠå¤©",style:{width:"24px",height:"24px"}})],-1),(0,a.Lk)("div",{class:"unread-count",id:"privateChatUnreadCount"},null,-1)])],2)])]),(0,a.Lk)("div",h,[(0,a.Lk)("ul",v,[(0,a.Lk)("li",{class:(0,l.C4)(["menu-item",{active:"user-settings"===n.value}]),"data-section":"user-settings"},[...t[3]||(t[3]=[(0,a.Lk)("div",{class:"chat-avatar"},[(0,a.Lk)("img",{src:"icon/Settings-01-256.ico",alt:"ç”¨æˆ·è®¾ç½®",style:{width:"24px",height:"24px"}})],-1)])],2)])]),t[5]||(t[5]=(0,a.Fv)('<div class="menu-section" style="margin-top:auto;margin-bottom:20px;"><ul class="menu-list"><li class="menu-item" id="switchToOldUI"><div class="chat-avatar" title="åˆ‡æ¢åˆ°æ—§UI">â¬…ï¸</div></li></ul><ul class="menu-list"><li class="menu-item" data-section="logout"><div class="chat-avatar">â»</div></li></ul></div>',1))]))}};const w=b;var k=w;const I={id:"secondary-sidebar"};var x={__name:"ChatSecondarySidebar",setup(e){const t=(0,a.EW)(()=>{const e=window.location.hash;return"#/chat"===e?"public-chat":"#/chat/group"===e?"group-chat":"#/chat/private"===e?"private-chat":"#/settings"===e?"user-settings":"public-chat"});return(e,n)=>((0,a.uX)(),(0,a.CE)("div",I,[(0,a.Lk)("div",{class:(0,l.C4)(["secondary-content",{active:"public-chat"===t.value}]),"data-content":"public-chat"},[...n[0]||(n[0]=[(0,a.Fv)('<div class="sidebar-section"><h3>åœ¨çº¿ç”¨æˆ· <span id="onlineCount">(0)</span></h3><ul class="user-list" id="userList"><li>æš‚æ— åœ¨çº¿ç”¨æˆ·</li></ul></div><div class="sidebar-section"><div class="section-header"><h3>ç¦»çº¿ç”¨æˆ·</h3></div><ul class="user-list" id="offlineUserList"><li>æš‚æ— ç¦»çº¿ç”¨æˆ·</li></ul></div>',2)])],2),(0,a.Lk)("div",{class:(0,l.C4)(["secondary-content",{active:"group-chat"===t.value}]),"data-content":"group-chat"},[...n[1]||(n[1]=[(0,a.Fv)('<div class="sidebar-section"><div class="section-header"><div class="search-container"><input type="text" id="groupSearchInput" placeholder="æœç´¢ç¾¤ç»„..." class="search-input"><button id="clearGroupSearch" class="clear-search-btn" style="display:none;">Ã—</button><button id="createGroupButton" class="create-group-btn" title="åˆ›å»ºç¾¤ç»„">+</button></div></div><ul class="user-list" id="groupList"><li class="loading-item"><span class="loading-text">æ­£åœ¨åŠ è½½ç¾¤ç»„åˆ—è¡¨...</span></li></ul></div>',1)])],2),(0,a.Lk)("div",{class:(0,l.C4)(["secondary-content",{active:"private-chat"===t.value}]),"data-content":"private-chat"},[...n[2]||(n[2]=[(0,a.Fv)('<div class="sidebar-section"><div class="section-header"><div class="search-container"><input type="text" id="privateChatSearchInput" placeholder="æœç´¢å¥½å‹..." class="search-input"><button id="clearPrivateChatSearch" class="clear-search-btn" style="display:none;">Ã—</button><button id="searchUserButton" class="create-group-btn" style="background-color:#3498db;" title="æœç´¢ç”¨æˆ·">+</button></div></div><ul class="user-list" id="friendsList"><li class="empty-friends">æš‚æ— å¥½å‹ï¼Œè¯·å…ˆæ·»åŠ å¥½å‹</li></ul></div>',1)])],2),(0,a.Lk)("div",{class:(0,l.C4)(["secondary-content",{active:"user-settings"===t.value}]),"data-content":"user-settings"},[...n[3]||(n[3]=[(0,a.Fv)('<div class="sidebar-section"><h3>è´¦æˆ·è®¾ç½®</h3><ul class="settings-list"><li class="settings-item" data-setting-id="change-password">ä¿®æ”¹å¯†ç </li><li class="settings-item" data-setting-id="change-nickname">ä¿®æ”¹æ˜µç§°</li><li class="settings-item" data-setting-id="upload-avatar">ä¸Šä¼ å¤´åƒ</li></ul></div><div class="sidebar-section"><h3>èŠå¤©è®¾ç½®</h3><ul class="settings-list"><li class="settings-item" data-setting-id="theme-settings" style="color:#999;">ä¸»é¢˜è®¾ç½® <span style="color:#ff6b6b;">(æœªå®ç°)</span></li><li class="settings-item" data-setting-id="shortcut-settings">å¿«æ·é”®</li></ul></div><div class="sidebar-section"><h3>å…³äº</h3><ul class="settings-list"><li class="settings-item" data-setting-id="version-info">ç‰ˆæœ¬ä¿¡æ¯</li><li class="settings-item" data-setting-id="help-center">å¸®åŠ©ä¸­å¿ƒ</li></ul></div>',3)])],2)]))}};const E=x;var S=E;function C(e,t,n,s,o,i){return t[0]||(t[0]=(0,a.Fv)('<div id="groupInfoModal" class="modal" style="display:none;"><div class="modal-content"><div class="modal-header"><h2 id="modalGroupName">ç¾¤ç»„ä¿¡æ¯</h2><span class="close" id="closeGroupInfoModal">Ã—</span></div><div class="modal-body"><div class="group-info-item"><label>ç¾¤ç»„åç§°:</label><div style="display:flex;align-items:center;gap:10px;"><span id="modalGroupNameValue"></span><button id="editGroupNameBtn" class="edit-group-name-btn" style="padding:4px 8px;background-color:#3498db;color:white;border:none;border-radius:4px;cursor:pointer;font-size:12px;"> ç¼–è¾‘ </button></div></div><div class="group-info-item"><label>ç¾¤ç»„ID:</label><span id="modalGroupIdValue"></span></div><div class="group-info-item"><label>ç¾¤ç»„å…¬å‘Š:</label><div style="display:flex;align-items:flex-start;gap:10px;"><span id="modalGroupNoticeValue" style="flex:1;word-break:break-word;"></span><button id="editGroupNoticeBtn" class="edit-group-notice-btn" style="padding:4px 8px;background-color:#3498db;color:white;border:none;border-radius:4px;cursor:pointer;font-size:12px;"> ç¼–è¾‘ </button></div></div><div class="group-info-item"><label>æˆå‘˜æ•°é‡:</label><span id="modalGroupMemberCount"></span></div><div class="group-info-item"><label>ç¾¤ä¸»:</label><span id="modalGroupOwner">åŠ è½½ä¸­...</span></div><div class="group-members-section"><h3>ç¾¤ç»„æˆå‘˜</h3><div id="groupMembersContainer" class="group-members-container"><div class="loading-members">æ­£åœ¨åŠ è½½æˆå‘˜åˆ—è¡¨...</div></div></div><div id="groupManageSection" class="group-manage-section" style="display:none;"><h3>ç¾¤ç»„ç®¡ç†</h3><div class="group-manage-buttons"><button id="addMemberToGroup" class="save-btn">æ·»åŠ æˆå‘˜</button><button id="refreshGroupMembers" class="save-btn">åˆ·æ–°æˆå‘˜åˆ—è¡¨</button></div></div></div><div class="modal-footer"><button id="modalCloseButton" class="cancel-btn">å…³é—­</button></div></div></div><div id="shareGroupCardModal" class="modal" style="display:none;"><div class="modal-content" style="width:500px;"><div class="modal-header"><h2>åˆ†äº«ç¾¤åç‰‡</h2><span class="close" id="closeShareGroupCardModal">Ã—</span></div><div class="modal-body"><p>é€‰æ‹©è¦åˆ†äº«çš„ç¾¤ç»„æˆ–ä¸»èŠå¤©å®¤ï¼š</p><div class="share-targets-container" style="max-height:300px;overflow-y:auto;margin:15px 0;"><div class="share-target-item" style="display:flex;align-items:center;margin:10px 0;"><input type="checkbox" id="target-main-chat" value="main" class="share-target-checkbox"><label for="target-main-chat" style="margin-left:10px;cursor:pointer;">ä¸»èŠå¤©å®¤</label></div><div id="shareGroupList" style="margin-top:15px;"></div></div></div><div class="modal-footer"><button id="cancelShareGroupCard" class="cancel-btn">å–æ¶ˆ</button><button id="confirmShareGroupCard" class="save-btn">å‘é€</button></div></div></div><div id="sendGroupCardModal" class="modal" style="display:none;"><div class="modal-content" style="width:400px;"><div class="modal-header"><h2>é€‰æ‹©ç¾¤åç‰‡</h2><span class="close" id="closeSendGroupCardModal">Ã—</span></div><div class="modal-body"><p>é€‰æ‹©è¦å‘é€çš„ç¾¤åç‰‡ï¼š</p><div class="send-group-card-container" style="max-height:300px;overflow-y:auto;margin:15px 0;"><div id="sendGroupCardList"></div></div></div><div class="modal-footer"><button id="cancelSendGroupCard" class="cancel-btn">å–æ¶ˆ</button><button id="confirmSendGroupCard" class="save-btn" disabled>å‘é€</button></div></div></div><div id="createGroupModal" class="modal" style="display:none;"><div class="modal-content"><div class="modal-header"><h2>åˆ›å»ºæ–°ç¾¤ç»„</h2><span class="close" id="closeCreateGroupModal">Ã—</span></div><div class="modal-body"><form id="createGroupForm" class="settings-form"><div class="form-group"><label for="newGroupName">ç¾¤ç»„åç§° *</label><input type="text" id="newGroupName" placeholder="è¯·è¾“å…¥ç¾¤ç»„åç§°" maxlength="50" required></div><div class="form-group"><label for="newGroupDescription">ç¾¤ç»„å…¬å‘Š</label><textarea id="newGroupDescription" placeholder="è¯·è¾“å…¥ç¾¤ç»„å…¬å‘Šï¼ˆå¯é€‰ï¼‰" rows="3" maxlength="200"></textarea></div><div class="form-group"><label>é€‰æ‹©å…¶ä»–ç¾¤æˆå‘˜</label><div id="groupMembersList" class="group-members-list"><div class="loading-members">æ­£åœ¨åŠ è½½æˆå‘˜åˆ—è¡¨...</div></div></div><div id="createGroupMessage" class="create-group-message"></div></form></div><div class="modal-footer"><button id="cancelCreateGroup" class="cancel-btn">å–æ¶ˆ</button><button id="submitCreateGroup" class="save-btn">åˆ›å»ºç¾¤ç»„</button></div></div></div><div id="addGroupMemberModal" class="modal" style="display:none;"><div class="modal-content"><div class="modal-header"><h2>æ·»åŠ ç¾¤ç»„æˆå‘˜</h2><span class="close" id="closeAddGroupMemberModal">Ã—</span></div><div class="modal-body"><div class="form-group"><label>é€‰æ‹©è¦æ·»åŠ çš„æˆå‘˜</label><div id="availableMembersList" class="group-members-list"><div class="loading-members">æ­£åœ¨åŠ è½½å¯ç”¨æˆå‘˜...</div></div></div><div id="addMembersMessage" class="create-group-message"></div></div><div class="modal-footer"><button id="cancelAddMembers" class="cancel-btn">å–æ¶ˆ</button><button id="confirmAddMembers" class="save-btn">ç¡®è®¤æ·»åŠ </button></div></div></div><div id="userProfileModal" class="modal" style="display:none;"><div class="modal-content"><div class="modal-header"><h2>ç”¨æˆ·èµ„æ–™</h2><span class="close" id="closeUserProfileModal">Ã—</span></div><div class="modal-body"><div class="user-profile-container"><div class="user-profile-avatar"><img id="modalUserAvatar" src="" alt="ç”¨æˆ·å¤´åƒ" class="user-avatar-img" loading="lazy" width="120" height="120" style="aspect-ratio:1/1;object-fit:cover;border-radius:50%;"><span id="modalUserInitials" class="user-initials"></span></div><div class="user-profile-info"><div class="user-profile-item"><label>æ˜µç§°:</label><span id="modalUserNickname"></span></div><div class="user-profile-item"><label>ç”¨æˆ·å:</label><span id="modalUsername"></span></div><div class="user-profile-item"><label>ç”¨æˆ·ID:</label><span id="modalUserId"></span></div><div class="user-profile-item"><label>çŠ¶æ€:</label><span id="modalUserStatus" class="user-status"></span></div></div></div></div><div class="modal-footer"><button id="closeUserProfileButton" class="cancel-btn">å…³é—­</button></div></div></div><div id="userAvatarPopup" style="display:none;position:absolute;background:white;border:1px solid #ddd;border-radius:8px;padding:15px;box-shadow:0 2px 10px rgba(0,0,0,0.1);z-index:1000;min-width:250px;"><div class="popup-header" style="display:flex;align-items:center;gap:10px;margin-bottom:10px;"><div class="popup-avatar" style="width:40px;height:40px;border-radius:50%;overflow:hidden;display:flex;align-items:center;justify-content:center;background:#3498db;color:white;font-weight:bold;"><img id="popupAvatarImg" src="" alt="ç”¨æˆ·å¤´åƒ" style="width:100%;height:100%;object-fit:cover;"><span id="popupInitials" style="display:none;font-size:18px;"></span></div><div class="popup-info"><div id="popupNickname" style="font-weight:bold;font-size:16px;"></div><div id="popupUsername" style="font-size:14px;color:#666;"></div></div></div><div class="popup-actions" style="margin-top:10px;display:flex;gap:10px;"><button id="popupAddFriend" style="flex:1;padding:8px;background:#3498db;color:white;border:none;border-radius:4px;cursor:pointer;">æ·»åŠ å¥½å‹</button></div></div><div id="userSearchModal" class="modal" style="display:none;"><div class="modal-content"><div class="modal-header"><h2>æœç´¢ç”¨æˆ·</h2><span class="close" id="closeUserSearchModal">Ã—</span></div><div class="modal-body"><div class="form-group"><label for="searchKeyword">æœç´¢å…³é”®è¯:</label><input type="text" id="searchKeyword" placeholder="è¾“å…¥ç”¨æˆ·åæˆ–æ˜µç§°" required></div><div id="searchResults" class="search-results"></div></div><div class="modal-footer"><button id="cancelUserSearch" class="cancel-btn">å–æ¶ˆ</button><button id="confirmUserSearch" class="save-btn">æœç´¢</button></div></div></div><div id="imagePreviewModal" class="modal" style="display:none;position:fixed;z-index:10001;left:0;top:0;width:100%;height:100%;overflow:auto;background-color:rgba(0,0,0,0.9);justify-content:center;align-items:center;"><div style="position:relative;max-width:90%;max-height:90%;"><img id="previewImgElement" src="" alt="å›¾ç‰‡é¢„è§ˆ" style="width:100%;height:auto;max-width:90vw;max-height:90vh;aspect-ratio:16/9;object-fit:contain;" loading="lazy"><span class="close" id="closeImagePreviewModal" style="position:absolute;top:-30px;right:-30px;color:#f1f1f1;font-size:40px;font-weight:bold;cursor:pointer;">Ã—</span></div></div><div id="avatarPreviewModal" class="modal" style="display:none;position:fixed;z-index:10001;left:0;top:0;width:100%;height:100%;overflow:auto;background-color:rgba(0,0,0,0.9);justify-content:center;align-items:center;"><div style="position:relative;max-width:300px;max-height:300px;"><img id="previewAvatarElement" src="" alt="å¤´åƒé¢„è§ˆ" style="width:300px;height:300px;border-radius:50%;object-fit:cover;"><span class="close" id="closeAvatarPreviewModal" style="position:absolute;top:-30px;right:-30px;color:#f1f1f1;font-size:40px;font-weight:bold;cursor:pointer;">Ã—</span></div></div>',10))}var $=n(4810),L=n.n($),B=n(1241);const M=(0,B.A)(L(),[["render",C]]);var T=M;const A={key:0,id:"main-chat"},U={id:"chat-main"};var N={__name:"App",setup(e){const t=(0,r.n)(),n=(0,r.t)(),s=(0,i.KR)(!1);function o(){const e=localStorage.getItem("currentUser"),t=localStorage.getItem("currentSessionToken"),n=localStorage.getItem("chatUserId"),o=localStorage.getItem("chatSessionToken"),a=localStorage.getItem("userId"),i=localStorage.getItem("sessionToken"),r=!!e&&(!!t||!!o)||!!n&&!!o||!!a&&!!i;return s.value=r,r}const l=(0,a.EW)(()=>s.value),d=(0,a.EW)(()=>{const e=n.path;return["/chat","/chat/group","/chat/private","/settings"].includes(e)}),u=()=>{const e=["public","group","private","settings"].includes(n.name),s=o();if(e&&!s&&t.push("/login"),s){const e=n.path;["/chat","/chat/group","/chat/private","/settings"].includes(e)}};return(0,a.sV)(async()=>{o(),t.afterEach(()=>{o(),u()}),await t.isReady(),l.value&&(0,c.JA)()}),(e,t)=>{const n=(0,a.g2)("router-view");return(0,a.uX)(),(0,a.CE)(a.FK,null,[l.value&&d.value?((0,a.uX)(),(0,a.CE)("div",A,[(0,a.bF)(k),(0,a.bF)(S),(0,a.Lk)("div",U,[(0,a.bF)(n)])])):(0,a.Q3)("",!0),l.value&&d.value?((0,a.uX)(),(0,a.Wv)(T,{key:1})):((0,a.uX)(),(0,a.Wv)(n,{key:2}))],64)}}};const j=N;var G=j;const P=(0,o.aE)({history:(0,o.Bt)(),routes:[{path:"/login",name:"login",component:()=>n.e(192).then(n.bind(n,192))},{path:"/register",name:"register",component:()=>n.e(663).then(n.bind(n,4663))},{path:"/chat",name:"public",component:()=>n.e(595).then(n.bind(n,8595))},{path:"/chat/group",name:"group",component:()=>n.e(942).then(n.bind(n,8942))},{path:"/chat/private",name:"private",component:()=>n.e(762).then(n.bind(n,5762))},{path:"/settings",name:"settings",component:()=>n.e(318).then(n.bind(n,5318))},{path:"/",redirect:"/chat"},{path:"/:pathMatch(.*)*",redirect:"/chat"}]}),q=(0,s.Ef)(G);q.use(P),q.mount("#app")}},t={};function n(s){var o=t[s];if(void 0!==o)return o.exports;var a=t[s]={exports:{}};return e[s].call(a.exports,a,a.exports,n),a.exports}n.m=e,function(){var e=[];n.O=function(t,s,o,a){if(!s){var i=1/0;for(d=0;d<e.length;d++){s=e[d][0],o=e[d][1],a=e[d][2];for(var r=!0,l=0;l<s.length;l++)(!1&a||i>=a)&&Object.keys(n.O).every(function(e){return n.O[e](s[l])})?s.splice(l--,1):(r=!1,a<i&&(i=a));if(r){e.splice(d--,1);var c=o();void 0!==c&&(t=c)}}return t}a=a||0;for(var d=e.length;d>0&&e[d-1][2]>a;d--)e[d]=e[d-1];e[d]=[s,o,a]}}(),function(){n.n=function(e){var t=e&&e.__esModule?function(){return e["default"]}:function(){return e};return n.d(t,{a:t}),t}}(),function(){n.d=function(e,t){for(var s in t)n.o(t,s)&&!n.o(e,s)&&Object.defineProperty(e,s,{enumerable:!0,get:t[s]})}}(),function(){n.f={},n.e=function(e){return Promise.all(Object.keys(n.f).reduce(function(t,s){return n.f[s](e,t),t},[]))}}(),function(){n.u=function(e){return"js/"+e+"."+{192:"62591ff9",318:"6a09c342",595:"3fb574af",663:"09a96f22",762:"38f401e8",942:"83b0dd71"}[e]+".js"}}(),function(){n.miniCssF=function(e){return"css/"+e+"."+{192:"fa82ba64",663:"bb36ba2d"}[e]+".css"}}(),function(){n.g=function(){if("object"===typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"===typeof window)return window}}()}(),function(){n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)}}(),function(){var e={},t="vue-chat:";n.l=function(s,o,a,i){if(e[s])e[s].push(o);else{var r,l;if(void 0!==a)for(var c=document.getElementsByTagName("script"),d=0;d<c.length;d++){var u=c[d];if(u.getAttribute("src")==s||u.getAttribute("data-webpack")==t+a){r=u;break}}r||(l=!0,r=document.createElement("script"),r.charset="utf-8",n.nc&&r.setAttribute("nonce",n.nc),r.setAttribute("data-webpack",t+a),r.src=s),e[s]=[o];var p=function(t,n){r.onerror=r.onload=null,clearTimeout(m);var o=e[s];if(delete e[s],r.parentNode&&r.parentNode.removeChild(r),o&&o.forEach(function(e){return e(n)}),t)return t(n)},m=setTimeout(p.bind(null,void 0,{type:"timeout",target:r}),12e4);r.onerror=p.bind(null,r.onerror),r.onload=p.bind(null,r.onload),l&&document.head.appendChild(r)}}}(),function(){n.r=function(e){"undefined"!==typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}}(),function(){n.p="/"}(),function(){if("undefined"!==typeof document){var e=function(e,t,s,o,a){var i=document.createElement("link");i.rel="stylesheet",i.type="text/css",n.nc&&(i.nonce=n.nc);var r=function(n){if(i.onerror=i.onload=null,"load"===n.type)o();else{var s=n&&n.type,r=n&&n.target&&n.target.href||t,l=new Error("Loading CSS chunk "+e+" failed.\n("+s+": "+r+")");l.name="ChunkLoadError",l.code="CSS_CHUNK_LOAD_FAILED",l.type=s,l.request=r,i.parentNode&&i.parentNode.removeChild(i),a(l)}};return i.onerror=i.onload=r,i.href=t,s?s.parentNode.insertBefore(i,s.nextSibling):document.head.appendChild(i),i},t=function(e,t){for(var n=document.getElementsByTagName("link"),s=0;s<n.length;s++){var o=n[s],a=o.getAttribute("data-href")||o.getAttribute("href");if("stylesheet"===o.rel&&(a===e||a===t))return o}var i=document.getElementsByTagName("style");for(s=0;s<i.length;s++){o=i[s],a=o.getAttribute("data-href");if(a===e||a===t)return o}},s=function(s){return new Promise(function(o,a){var i=n.miniCssF(s),r=n.p+i;if(t(i,r))return o();e(s,r,null,o,a)})},o={524:0};n.f.miniCss=function(e,t){var n={192:1,663:1};o[e]?t.push(o[e]):0!==o[e]&&n[e]&&t.push(o[e]=s(e).then(function(){o[e]=0},function(t){throw delete o[e],t}))}}}(),function(){var e={524:0};n.f.j=function(t,s){var o=n.o(e,t)?e[t]:void 0;if(0!==o)if(o)s.push(o[2]);else{var a=new Promise(function(n,s){o=e[t]=[n,s]});s.push(o[2]=a);var i=n.p+n.u(t),r=new Error,l=function(s){if(n.o(e,t)&&(o=e[t],0!==o&&(e[t]=void 0),o)){var a=s&&("load"===s.type?"missing":s.type),i=s&&s.target&&s.target.src;r.message="Loading chunk "+t+" failed.\n("+a+": "+i+")",r.name="ChunkLoadError",r.type=a,r.request=i,o[1](r)}};n.l(i,l,"chunk-"+t,t)}},n.O.j=function(t){return 0===e[t]};var t=function(t,s){var o,a,i=s[0],r=s[1],l=s[2],c=0;if(i.some(function(t){return 0!==e[t]})){for(o in r)n.o(r,o)&&(n.m[o]=r[o]);if(l)var d=l(n)}for(t&&t(s);c<i.length;c++)a=i[c],n.o(e,a)&&e[a]&&e[a][0](),e[a]=0;return n.O(d)},s=self["webpackChunkvue_chat"]=self["webpackChunkvue_chat"]||[];s.forEach(t.bind(null,0)),s.push=t.bind(null,s.push.bind(s))}();var s=n.O(void 0,[504],function(){return n(6002)});s=n.O(s)})();
//# sourceMappingURL=app.e0617a77.js.map